import{r as s}from"./vendor-radix-CDHcN1cP.js";import{u as _}from"./vendor-query-DyYoeD25.js";import{z as F,g as L,v as o,f as d}from"./index-Dt6uKTGi.js";import{g as V,a as j,c as B,s as G,u as H}from"./assessmentStorage-BtF7XoQl.js";import{e as J}from"./vendor-react-D0zZO7ze.js";function Z({assessmentType:u,totalSteps:S,profileId:P}){const D=J(),{currentProfileId:E}=F(),M=_(),[c,m]=s.useState(null),[h,g]=s.useState(!1),[i,b]=s.useState(null),[C,v]=s.useState(1),[w,A]=s.useState(new Map),[k,y]=s.useState(!0);s.useEffect(()=>{let e=!1;async function n(){const r=P||D.profileId||E;if(u==="parent"||u==="family")try{const t=await L();if(e)return;const l=t.find(a=>a.type==="parent");if(l){m(l.id),g(!0);return}}catch(t){o.error("Error loading profiles:",t),e||(m(r||null),g(!0));return}e||(m(r||null),g(!0))}return n(),()=>{e=!0}},[P,D.profileId,E,u]),s.useEffect(()=>{async function e(){if(!h)return;if(!c){o.warn("Profile ID not found"),y(!1);return}const n=c;try{y(!0);const{id:r,assessment:t}=await V(n,u,S);b(r),v(t.current_step||1);const l=await j(t.id),a=new Map;l.forEach(f=>{a.set(f.question_id,f.value)}),A(a)}catch(r){o.error("Error initializing assessment:",r),d.error("Ошибка при загрузке оценки. Попробуйте обновить страницу.")}finally{y(!1)}}e()},[c,h,u,S]);const x=async(e,n,r,t,l,a)=>{if(!i){o.warn("Assessment ID not available - answer will NOT be saved!");return}const f=w.get(e),O=C;A(p=>new Map(p).set(e,t)),v(a);try{await G(i,{questionId:e,questionCode:n,category:r,value:t,answerType:l,stepNumber:a}),await H(i,a)}catch(p){throw o.error("Error saving answer:",p),A(Q=>{const I=new Map(Q);return f!==void 0?I.set(e,f):I.delete(e),I}),v(O),d.error("Ошибка при сохранении ответа. Попробуйте еще раз."),p}},z=async()=>{if(!i||!c)return o.warn("Assessment ID or Profile ID not available"),null;try{const e=await B(i);return await M.invalidateQueries({predicate:n=>{const r=n.queryKey[0];return["assessments","active-assessments","profiles","appointments","appointments-with-type","active-free-consultation"].includes(r)||r==="assessment"&&n.queryKey[1]===c}}),d.success("Оценка завершена!"),e}catch(e){return o.error("Error completing assessment:",e),d.error("Ошибка при завершении оценки"),null}},K=s.useCallback(e=>w.get(e)??null,[w]);return{assessmentId:i,currentStep:C,savedAnswers:w,loading:k,saveAnswer:x,complete:z,getSavedAnswer:K}}export{Z as u};
