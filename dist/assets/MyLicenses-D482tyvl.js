import{r,j as e}from"./vendor-radix-J7BmBqsC.js";import{g as X,i as P,u as ie,Z as ae,aA as Ne,bc as W,B as I,L as ke,r as Ce,o as Se,a9 as Ee,a6 as Le,aa as Me,S as oe,C as Y,t as de,U as Z,a5 as Ue,E as ue,a4 as Ae,G as me,J as xe,$ as he,a1 as fe,V as ge,X as pe,D as Te,f as J,bd as $e}from"./index-CsvxaYtI.js";import{u as Oe}from"./useProfiles-Bh4H3Y1m.js";import{u as Pe}from"./useDevice-1x5MqRfq.js";import{S as ce}from"./smartphone-BOhANp-S.js";import{T as Re}from"./trash-2-BiEfhxdN.js";import{S as Ie}from"./shield-DlVB15hX.js";import{M as He}from"./monitor-9G4TNKAU.js";import{u as ze}from"./vendor-react-CI1J5nwZ.js";import{P as be}from"./plus-CNlpg7MV.js";import"./vendor-charts-CkgrveCd.js";import"./vendor-query-Bb981xLV.js";import"./profileStorage-CU3CxDLE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=X("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=X("Crown",[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=X("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=X("ShieldCheck",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=X("Tablet",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["line",{x1:"12",x2:"12.01",y1:"18",y2:"18",key:"1dp563"}]]);function ve({isOpen:s,onClose:c,title:i,children:u,size:t="md",showCloseButton:m=!0,className:b}){if(r.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),r.useEffect(()=>{const k=T=>{T.key==="Escape"&&s&&c()};return window.addEventListener("keydown",k),()=>window.removeEventListener("keydown",k)},[s,c]),!s)return null;const w={sm:"max-w-md",md:"max-w-lg",lg:"max-w-2xl",xl:"max-w-4xl"};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute right-0 bottom-0 bg-black/50 backdrop-blur-sm",onClick:c}),e.jsxs("div",{className:P("relative w-full bg-white rounded-3xl shadow-2xl","animate-in fade-in zoom-in-95 duration-200",w[t],b),children:[(i||m)&&e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-border",children:[i&&e.jsx("h2",{className:"text-xl font-medium",children:i}),m&&e.jsx("button",{onClick:c,className:"ml-auto p-2 rounded-full hover:bg-cloud transition-colors",children:e.jsx("svg",{className:"w-5 h-5 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"p-6",children:u})]})]})}async function Ve(s){const{email:c,code:i,deviceName:u,type:t}=s;try{const m=await fetch("/api/send-verification-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:c,code:i,deviceName:u,type:t})});return m.ok?{success:!0}:{success:!1,error:await m.text()}}catch(m){return console.error("Failed to send verification code:",m),{success:!1,error:m instanceof Error?m.message:"Network error"}}}const Ge={new:{level:"new",maxDevices:3,unbindsPerMonth:1,cooldownHours:24,requiresEmailCode:!0},standard:{level:"standard",maxDevices:3,unbindsPerMonth:1,cooldownHours:24,requiresEmailCode:!0},trusted:{level:"trusted",maxDevices:3,unbindsPerMonth:2,cooldownHours:12,requiresEmailCode:!0}},Q={monthsToTrusted:3,suspiciousActivity:{maxRegionsPerWeek:3,maxUnbindsAtLimit:3}},We={new:"Новый",standard:"Стандартный",trusted:"Доверенный"};function _e(s){const c=new Date(s),i=new Date,u=c.getTime()-i.getTime();if(u<=0)return"сейчас";const t=Math.floor(u/(1e3*60*60)),m=Math.floor(u%(1e3*60*60)/(1e3*60));if(t>24){const b=Math.floor(t/24);return`${b} ${ee(b,"день","дня","дней")}`}return t>0?`${t} ${ee(t,"час","часа","часов")}`:`${m} ${ee(m,"минута","минуты","минут")}`}function ee(s,c,i,u){const t=s%10,m=s%100;return m>=11&&m<=19?u:t===1?c:t>=2&&t<=4?i:u}function Ye(s){const c=new Date(s);return new Date(c.getTime()+30*24*60*60*1e3)}const se="waves_seat_devices",te="waves_seat_email_binding",ne="waves_seat_unbind_history";function Xe(){return Math.floor(1e5+Math.random()*9e5).toString()}function je(){const s=typeof navigator<"u"?navigator:null,c=typeof window<"u"?window.screen:null,i=[(s==null?void 0:s.userAgent)||"unknown",(s==null?void 0:s.language)||"unknown",(c==null?void 0:c.width)||0,(c==null?void 0:c.height)||0,Intl.DateTimeFormat().resolvedOptions().timeZone].join("|");let u=0;for(let t=0;t<i.length;t++){const m=i.charCodeAt(t);u=(u<<5)-u+m,u=u&u}return"fp_"+Math.abs(u).toString(36)}function Ze(){if(typeof navigator>"u")return"desktop";const s=navigator.userAgent.toLowerCase();return/tablet|ipad|playbook|silk/i.test(s)?"tablet":/mobile|iphone|ipod|android|blackberry|opera mini|iemobile/i.test(s)?"mobile":"desktop"}function Qe(){if(typeof navigator>"u")return"Unknown Device";const s=navigator.userAgent;if(/iPhone/.test(s))return"iPhone";if(/iPad/.test(s))return"iPad";const c=s.match(/Android.*;\s*([^;)]+)/);return c?c[1].trim():/Mac/.test(s)?"Mac":/Windows/.test(s)?"Windows PC":/Linux/.test(s)?"Linux PC":"Unknown Device"}function ye({seatId:s}){const{user:c}=ie(),[i,u]=r.useState([]),[t,m]=r.useState(null),[b,w]=r.useState([]),[k,T]=r.useState(!0),[L,H]=r.useState(null),[C,$]=r.useState(null),[x,h]=r.useState(null);r.useEffect(()=>{if(!(c!=null&&c.id)||!s){u([]),m(null),T(!1);return}try{const l=localStorage.getItem(`${se}_${s}`);l&&u(JSON.parse(l));const d=localStorage.getItem(`${te}_${s}`);d&&m(JSON.parse(d));const p=localStorage.getItem(`${ne}_${s}`);p&&w(JSON.parse(p))}catch(l){console.error("Error loading seat devices:",l),H(l instanceof Error?l:new Error("Failed to load devices"))}T(!1)},[c==null?void 0:c.id,s]);const a=r.useCallback(l=>{s&&(localStorage.setItem(`${se}_${s}`,JSON.stringify(l)),u(l))},[s]),o=r.useCallback(l=>{s&&(localStorage.setItem(`${te}_${s}`,JSON.stringify(l)),m(l))},[s]),j=r.useCallback(l=>{s&&(localStorage.setItem(`${ne}_${s}`,JSON.stringify(l)),w(l))},[s]),g=r.useMemo(()=>Ge[(t==null?void 0:t.trust_level)||"new"],[t==null?void 0:t.trust_level]),N=r.useMemo(()=>{const l=new Date;return l.setDate(l.getDate()-30),b.filter(d=>d.reason==="user_request"&&new Date(d.unbound_at)>l).length},[b]),n=r.useMemo(()=>i.filter(l=>l.status==="active"||l.status==="pending_unbind"),[i]),S=r.useMemo(()=>{const l=je();return i.find(d=>d.device_fingerprint===l&&d.status==="active")},[i]),D=r.useMemo(()=>n.length<g.maxDevices,[n.length,g.maxDevices]),M=r.useMemo(()=>!!(t!=null&&t.email),[t==null?void 0:t.email]),O=r.useCallback(async l=>{if(!s)return{success:!1,error:"Seat ID не указан"};if(t!=null&&t.email)return{success:!1,error:"Email уже привязан к этому месту"};const d={seat_id:s,email:l.toLowerCase().trim(),email_verified:!1,bound_at:new Date().toISOString(),trust_level:"new",trust_level_updated_at:new Date().toISOString(),total_unbinds_count:0,consecutive_limit_hits:0,recent_regions:[]};return o(d),{success:!0}},[s,t==null?void 0:t.email,o]),U=r.useCallback(async()=>t?(o({...t,email_verified:!0}),{success:!0}):{success:!1,error:"Email не привязан"},[t,o]),v=r.useCallback(async()=>{if(!M)throw new Error("Сначала укажите email для этого места в лицензии");if(!D)throw new Error("Достигнут лимит устройств");const l=je(),d=i.find(f=>f.device_fingerprint===l&&f.status==="active");if(d)return d;const p={id:`sd_${Date.now()}`,seat_id:s,device_fingerprint:l,device_name:Qe(),device_type:Ze(),status:"active",last_active_at:new Date().toISOString(),created_at:new Date().toISOString()},y=[...i,p];return a(y),p},[M,D,i,s,a]),A=r.useCallback(l=>{if(!M)return{canUnbind:!1,reason:"no_email"};const d=i.find(p=>p.id===l);if(!d)return{canUnbind:!1,reason:"last_device"};if(d.status==="pending_unbind")return{canUnbind:!1,reason:"pending_unbind",cooldownEndsAt:d.unbind_available_at};if(n.length<=1)return{canUnbind:!1,reason:"last_device"};if(N>=g.unbindsPerMonth){const p=b.filter(f=>f.reason==="user_request").sort((f,z)=>new Date(f.unbound_at).getTime()-new Date(z.unbound_at).getTime())[0];return{canUnbind:!1,reason:"limit_reached",unbindsRemaining:0,unbindsResetAt:(p?Ye(p.unbound_at):new Date).toISOString()}}return{canUnbind:!0,unbindsRemaining:g.unbindsPerMonth-N}},[M,i,n.length,N,g.unbindsPerMonth,b]),q=r.useCallback(async l=>{const d=A(l);if(!d.canUnbind)return{success:!1,error:{no_email:"Email не привязан к этому месту",limit_reached:"Достигнут лимит отвязок в этом месяце",last_device:"Нельзя отвязать последнее устройство",pending_unbind:"Устройство уже в процессе отвязки"}[d.reason||""]||"Невозможно отвязать устройство"};const p=i.find(le=>le.id===l);if(!p||!(t!=null&&t.email))return{success:!1,error:"Устройство или email не найдены"};const y=Xe(),f=new Date;f.setMinutes(f.getMinutes()+10);const z=await Ve({email:t.email,code:y,deviceName:p.device_name,type:"unbind_device"});return z.success?($(y),h(l),{success:!0,codeExpiresAt:f.toISOString()}):{success:!1,error:z.error||"Ошибка отправки кода"}},[A,i,t==null?void 0:t.email]),B=r.useCallback(async l=>{if(!x||!C)return{success:!1,error:"Нет активного запроса на отвязку"};if(l!==C)return{success:!1,error:"Неверный код подтверждения"};if(!i.find(f=>f.id===x))return{success:!1,error:"Устройство не найдено"};const p=new Date;p.setHours(p.getHours()+g.cooldownHours);const y=i.map(f=>f.id===x?{...f,status:"pending_unbind",unbind_requested_at:new Date().toISOString(),unbind_available_at:p.toISOString()}:f);return a(y),$(null),h(null),{success:!0,unbindAvailableAt:p.toISOString()}},[x,C,i,g.cooldownHours,a]),K=r.useCallback(async l=>{const d=i.find(y=>y.id===l);if(!d||d.status!=="pending_unbind")return!1;const p=i.map(y=>y.id===l?{...y,status:"active",unbind_requested_at:void 0,unbind_available_at:void 0}:y);return a(p),!0},[i,a]),V=r.useCallback(async l=>{const d=i.find(f=>f.id===l);if(!d||d.status!=="pending_unbind"||d.unbind_available_at&&new Date(d.unbind_available_at)>new Date)return!1;const p=i.map(f=>f.id===l?{...f,status:"unbound"}:f);a(p);const y={id:`uh_${Date.now()}`,seat_id:s,device_fingerprint:d.device_fingerprint,device_name:d.device_name,unbound_at:new Date().toISOString(),reason:"user_request"};if(j([...b,y]),t){const f=t.total_unbinds_count+1,z=N+1>=g.unbindsPerMonth?t.consecutive_limit_hits+1:0;o({...t,total_unbinds_count:f,last_unbind_at:new Date().toISOString(),consecutive_limit_hits:z})}return!0},[i,s,b,t,N,g.unbindsPerMonth,a,j,o]),G=r.useCallback(()=>{if(!S)return;const l=i.map(d=>d.id===S.id?{...d,last_active_at:new Date().toISOString()}:d);a(l)},[S,i,a]),R=r.useCallback(()=>{if(!t)return;const l=new Date(t.bound_at),p=Math.floor((new Date().getTime()-l.getTime())/(1e3*60*60*24*30));let y=t.trust_level;p>=Q.monthsToTrusted&&t.consecutive_limit_hits<Q.suspiciousActivity.maxUnbindsAtLimit?y="trusted":p>=1&&(y="standard"),(t.consecutive_limit_hits>=Q.suspiciousActivity.maxUnbindsAtLimit||t.recent_regions.length>Q.suspiciousActivity.maxRegionsPerWeek)&&(y="new"),y!==t.trust_level&&o({...t,trust_level:y,trust_level_updated_at:new Date().toISOString()})},[t,o]),_=r.useRef(!1),E=r.useRef(s);E.current!==s&&(E.current=s,_.current=!1),r.useEffect(()=>{if(k||_.current||i.length===0)return;_.current=!0;const l=new Date,d=i.filter(p=>p.status==="pending_unbind"&&p.unbind_available_at&&new Date(p.unbind_available_at)<=l);if(d.length>0){const p=i.map(f=>d.some(z=>z.id===f.id)?{...f,status:"unbound"}:f);a(p);const y=d.map(f=>({id:`uh_${Date.now()}_${f.id}`,seat_id:s,device_fingerprint:f.device_fingerprint,device_name:f.device_name,unbound_at:new Date().toISOString(),reason:"user_request"}));if(j([...b,...y]),t){const f=t.total_unbinds_count+d.length;o({...t,total_unbinds_count:f,last_unbind_at:new Date().toISOString()})}}},[k,i,s,b,t,a,j,o]);const F=r.useCallback(()=>{s&&(localStorage.removeItem(`${se}_${s}`),localStorage.removeItem(`${te}_${s}`),localStorage.removeItem(`${ne}_${s}`),u([]),m(null),w([]))},[s]);return{devices:i,activeDevices:n,currentDevice:S,binding:t,unbindHistory:b,trustConfig:g,loading:k,error:L,hasEmail:M,setEmail:O,verifyEmail:U,canAddDevice:D,unbindsLast30Days:N,unbindsRemaining:g.unbindsPerMonth-N,addCurrentDevice:v,checkCanUnbind:A,requestUnbind:q,confirmUnbind:B,cancelUnbind:K,completeUnbind:V,updateLastActive:G,updateTrustLevel:R,pendingUnbindDeviceId:x,hasPendingUnbindRequest:!!C,resetAll:F,_mockCode:null}}function es({seatId:s,profileName:c,profileType:i,className:u,onEmailSet:t}){const{user:m}=ie(),{binding:b,hasEmail:w,setEmail:k,verifyEmail:T}=ye({seatId:s}),[L,H]=r.useState(""),[C,$]=r.useState(!1),[x,h]=r.useState(null),[a,o]=r.useState(!1);m!=null&&m.email;const j=async()=>{const g=L.trim().toLowerCase();if(!g){h("Введите email");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(g)){h("Введите корректный email");return}$(!0),h(null);const N=await k(g);N.success?(await T(),t==null||t(g)):h(N.error||"Ошибка при привязке email"),$(!1)};return w&&b?e.jsxs("div",{className:P("space-y-4",u),children:[e.jsx("div",{className:"rounded-2xl border-2 p-4 backdrop-blur-sm bg-gradient-to-r from-[rgba(255,138,91,0.2)] to-[rgba(255,138,91,0.1)] border-[rgba(255,138,91,0.3)]",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5 text-coral",children:b.email_verified?e.jsx(ae,{className:"w-5 h-5"}):e.jsx(Ne,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium mb-1 text-[#1a1a1a]",children:"Email для приложения"}),e.jsx("p",{className:"text-sm text-[#1a1a1a]",children:b.email})]})]})}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Этот email используется для входа в мобильное приложение",c&&` (профиль: ${c})`,"."]})]}):e.jsxs("div",{className:P("space-y-4",u),children:[e.jsx(W,{variant:"coral",title:"Укажите email для мобильного приложения",message:i==="child"?"Этот email будет использоваться для входа ребёнка в мобильное приложение. Можно указать email ребёнка или ваш собственный.":"Этот email будет использоваться для входа в мобильное приложение и для подтверждения отвязки устройств.",icon:e.jsx(ce,{className:"w-5 h-5"})}),e.jsxs(I,{type:"button",variant:"ghost",size:"sm",onClick:()=>o(!a),className:"h-auto p-0 text-sm text-primary hover:underline",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Зачем нужен email?"]}),a&&e.jsxs("div",{className:"p-4 bg-cloud/50 rounded-xl text-sm space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:"Email нужен для:"})}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"Идентификации пользователя в мобильном приложении"}),e.jsx("li",{children:"Загрузки личных данных и прогресса тренировок"}),e.jsx("li",{children:"Получения кодов подтверждения при отвязке устройств"}),e.jsx("li",{children:"Уведомлений о важных событиях"})]}),e.jsx("p",{className:"text-muted-foreground",children:"У каждого участника лицензии (родителя и ребёнка) должен быть свой email. Email нельзя изменить после привязки."})]}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ke,{htmlFor:`email-${s}`,children:["Email ",c&&`для ${c}`]}),e.jsx(Ce,{id:`email-${s}`,type:"email",value:L,onChange:g=>H(g.target.value),placeholder:"example@mail.com"})]})}),x&&e.jsx(W,{variant:"error",message:x,icon:e.jsx(Se,{className:"w-5 h-5"}),onClose:()=>h(null)}),e.jsx(I,{onClick:j,disabled:C||!L.trim(),className:"w-full",size:"lg",children:C?"Сохранение...":"Привязать email"}),e.jsx("p",{className:"text-xs text-coral text-center font-medium",children:"Email нельзя изменить после привязки"})]})}function ss({type:s}){switch(s){case"mobile":return e.jsx(ce,{className:"w-5 h-5"});case"tablet":return e.jsx(Ke,{className:"w-5 h-5"});default:return e.jsx(He,{className:"w-5 h-5"})}}function ts({level:s}){switch(s){case"trusted":return e.jsx(Be,{className:"w-4 h-4 text-green-500"});case"standard":return e.jsx(Ie,{className:"w-4 h-4 text-blue-500"});default:return e.jsx(qe,{className:"w-4 h-4 text-amber-500"})}}function ns({seatId:s,profileName:c,profileType:i,className:u,onEmailSet:t}){const{activeDevices:m,currentDevice:b,binding:w,trustConfig:k,unbindsRemaining:T,hasEmail:L,checkCanUnbind:H,requestUnbind:C,confirmUnbind:$,cancelUnbind:x}=ye({seatId:s}),[h,a]=r.useState(null),[o,j]=r.useState(!1),[g,N]=r.useState(!1),[n,S]=r.useState(""),[D,M]=r.useState(!1),[O,U]=r.useState(null),[v,A]=r.useState(null),q=Math.max(0,T),B=async _=>{U(null),a(_);const E=H(_.id);if(!E.canUnbind){const F={no_email:"Email не привязан",limit_reached:`Лимит отвязок исчерпан. Следующая отвязка будет доступна ${E.unbindsResetAt?_e(E.unbindsResetAt):"позже"}`,last_device:"Нельзя отвязать последнее устройство",pending_unbind:"Устройство уже в процессе отвязки"};U(F[E.reason||""]||"Невозможно отвязать устройство");return}j(!0)},K=async()=>{if(!h)return;M(!0),U(null);const _=await C(h.id);_.success?(j(!1),N(!0),A("Код подтверждения отправлен на вашу почту")):U(_.error||"Ошибка при отправке кода"),M(!1)},V=async()=>{if(!n||n.length!==6){U("Введите 6-значный код");return}M(!0),U(null);const _=await $(n);_.success?(N(!1),S(""),a(null),A(`Устройство будет отвязано через ${k.cooldownHours} ч.`)):U(_.error||"Неверный код"),M(!1)},G=async _=>{await x(_.id)&&A("Отвязка отменена")},R=()=>{j(!1),N(!1),S(""),a(null),U(null)};return L?e.jsxs("div",{className:P("space-y-6",u),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-medium",children:["Устройства ",c&&`(${c})`]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ts,{level:w==null?void 0:w.trust_level}),e.jsx("span",{children:We[(w==null?void 0:w.trust_level)||"new"]})]})]}),(w==null?void 0:w.email)&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-cloud/50 rounded-xl",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center",children:e.jsx(Ne,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Email для приложения"}),e.jsx("div",{className:"font-medium truncate",children:w.email})]}),w.email_verified&&e.jsx(ae,{className:"w-5 h-5 text-green-500 flex-shrink-0"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-cloud/50 rounded-2xl p-4",children:[e.jsxs("div",{className:"text-2xl font-semibold",children:[m.length,"/",k.maxDevices]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Устройств"})]}),e.jsxs("div",{className:"bg-cloud/50 rounded-2xl p-4",children:[e.jsxs("div",{className:"text-2xl font-semibold",children:[q,"/",k.unbindsPerMonth]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Отвязок в месяц"})]})]}),v&&e.jsx(W,{variant:"success",message:v,onClose:()=>A(null)}),O&&e.jsx(W,{variant:"error",message:O,onClose:()=>U(null)}),e.jsxs("div",{className:"space-y-3",children:[m.map(_=>{const E=(b==null?void 0:b.id)===_.id,F=_.status==="pending_unbind";return e.jsxs("div",{className:P("flex items-center gap-4 p-4 rounded-2xl border-2 transition-colors",E?"border-primary/30 bg-primary/5":F?"border-amber-200 bg-amber-50":"border-border bg-white"),children:[e.jsx("div",{className:P("flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center",E?"bg-primary/10 text-primary":"bg-cloud text-muted-foreground"),children:e.jsx(ss,{type:_.device_type})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:_.device_name}),E&&e.jsx("span",{className:"text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full",children:"Текущее"})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:F?e.jsxs("span",{className:"flex items-center gap-1 text-amber-600",children:[e.jsx(Ee,{className:"w-3 h-3"}),"Отвязка через ",_.unbind_available_at&&_e(_.unbind_available_at)]}):e.jsxs("span",{children:["Добавлено ",new Date(_.created_at).toLocaleDateString("ru-RU")]})})]}),e.jsx("div",{className:"flex-shrink-0",children:F?e.jsx("button",{onClick:()=>G(_),className:"p-2 rounded-xl text-amber-600 hover:bg-amber-100 transition-colors",title:"Отменить отвязку",children:e.jsx(Le,{className:"w-5 h-5"})}):E?e.jsx(ae,{className:"w-5 h-5 text-green-500"}):e.jsx("button",{onClick:()=>B(_),className:"p-2 rounded-xl text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-colors",title:"Отвязать устройство",children:e.jsx(Re,{className:"w-5 h-5"})})})]},_.id)}),Array.from({length:k.maxDevices-m.length}).map((_,E)=>e.jsxs("div",{className:"flex items-center gap-4 p-4 rounded-2xl border-2 border-dashed border-border/50",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-cloud/50 flex items-center justify-center text-muted-foreground/50",children:e.jsx(ce,{className:"w-5 h-5"})}),e.jsx("div",{className:"text-muted-foreground/50",children:"Свободный слот"})]},`empty-${E}`))]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Устройства привязываются автоматически при входе в мобильное приложение по email. Для отвязки устройства потребуется подтверждение по email."}),e.jsx(ve,{isOpen:o,onClose:R,title:"Отвязать устройство?",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted-foreground",children:["Вы уверены, что хотите отвязать устройство ",e.jsx("strong",{children:h==null?void 0:h.device_name}),"?"]}),e.jsx(W,{variant:"warning",message:`После подтверждения устройство будет отвязано через ${k.cooldownHours} часов. В течение этого времени вы сможете отменить отвязку.`,icon:e.jsx(Me,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:R,className:"flex-1 px-4 py-3 rounded-xl border-2 border-border hover:bg-cloud transition-colors",children:"Отмена"}),e.jsx("button",{onClick:K,disabled:D,className:"flex-1 px-4 py-3 rounded-xl bg-destructive text-white hover:bg-destructive/90 transition-colors disabled:opacity-50",children:D?"Отправка...":"Отвязать"})]})]})}),e.jsx(ve,{isOpen:g,onClose:R,title:"Введите код подтверждения",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted-foreground",children:["Мы отправили 6-значный код на вашу почту ",e.jsx("strong",{children:w==null?void 0:w.email})]}),!1,e.jsx("input",{type:"text",inputMode:"numeric",maxLength:6,value:n,onChange:_=>S(_.target.value.replace(/\D/g,"")),placeholder:"000000",className:"w-full text-center text-2xl tracking-widest px-4 py-4 rounded-xl border-2 border-border focus:border-primary focus:outline-none transition-colors",autoFocus:!0}),O&&e.jsx(W,{variant:"error",message:O}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:R,className:"flex-1 px-4 py-3 rounded-xl border-2 border-border hover:bg-cloud transition-colors",children:"Отмена"}),e.jsx("button",{onClick:V,disabled:D||n.length!==6,className:"flex-1 px-4 py-3 rounded-xl bg-primary text-white hover:bg-primary/90 transition-colors disabled:opacity-50",children:D?"Проверка...":"Подтвердить"})]})]})})]}):e.jsxs("div",{className:P("space-y-4",u),children:[e.jsxs("h3",{className:"text-lg font-medium",children:["Настройка приложения ",c&&`для ${c}`]}),e.jsx(es,{seatId:s,profileName:c,profileType:i,onEmailSet:t})]})}const re=[{id:"individual",name:"Базовый",description:"Для одного участника",maxSeats:1,includesDevice:!0,price:8e4,period:"month",features:["Flex4 устройство","Программа без ограничений","Все типы тренировок (Концентрация, Спокойствие, Фокус)","Персональный прогресс и аналитика","Поддержка 24/7","Гарантия на устройство"]},{id:"family",name:"Родитель + Ребёнок",description:"Семейный",maxSeats:2,includesDevice:!0,price:12e4,period:"month",features:["Flex4 устройство","Программы для обоих (взрослые + дети)","Профили для родителя и ребёнка","Все типы тренировок (Концентрация, Спокойствие, Фокус)","Персональный прогресс для каждого","Поддержка 24/7","Гарантия на устройство","Приоритетная поддержка"]}],as={active:"Активна",expired:"Истекла",cancelled:"Отменена",pending:"Ожидает оплаты"},rs={active:"text-green-600",expired:"bg-muted text-muted-foreground",cancelled:"bg-destructive/20 text-destructive",pending:"bg-honey/20 text-honey-dark"};function De(s){return re.find(c=>c.id===s)}function we(s){return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}function is(s,c=7){const i=new Date(s.expires_at),u=new Date,t=Math.floor((i.getTime()-u.getTime())/(1e3*60*60*24));return t<=c&&t>0}function cs(){const{user:s}=ie(),c="waves_licenses",i="waves_license_seats",[u,t]=r.useState(()=>{try{const x=localStorage.getItem(c);return x?JSON.parse(x):[]}catch{return[]}}),[m,b]=r.useState(()=>{try{const x=localStorage.getItem(i);return(x?JSON.parse(x):[]).map(a=>{try{const o=`waves_seat_email_binding_${a.id}`,j=localStorage.getItem(o);if(j){const g=JSON.parse(j);return{...a,app_email:g.email,app_email_verified:g.email_verified,app_email_set_at:g.bound_at}}}catch{}return a})}catch{return[]}});return r.useEffect(()=>{localStorage.setItem(c,JSON.stringify(u))},[u]),r.useEffect(()=>{localStorage.setItem(i,JSON.stringify(m))},[m]),r.useEffect(()=>{const x=()=>{b(o=>o.map(j=>{try{const g=`waves_seat_email_binding_${j.id}`,N=localStorage.getItem(g);if(N){const n=JSON.parse(N);return{...j,app_email:n.email,app_email_verified:n.email_verified,app_email_set_at:n.bound_at}}}catch{}return j}))};x();const h=o=>{o.key&&o.key.startsWith("waves_seat_email_binding_")&&x()};window.addEventListener("storage",h);const a=setInterval(x,1e3);return()=>{window.removeEventListener("storage",h),clearInterval(a)}},[]),{licenses:u,seats:m,loading:!1,error:null,purchaseLicense:async x=>{await new Promise(o=>setTimeout(o,1e3));const h=De(x);if(!h)throw new Error("Invalid plan");const a={id:`license_${Date.now()}`,user_id:(s==null?void 0:s.id)||"",plan_type:x,status:"active",starts_at:new Date().toISOString(),expires_at:new Date(Date.now()+30*24*60*60*1e3).toISOString(),auto_renew:!0,max_seats:h.maxSeats,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return t(o=>[...o,a]),a},assignSeat:async(x,h,a)=>{const o=u.find(N=>N.id===x);if(!o)throw new Error("License not found");if(m.filter(N=>N.license_id===x).length>=o.max_seats)throw new Error("No available seats");const g={id:`seat_${Date.now()}`,license_id:x,profile_id:h,profile:a,assigned_at:new Date().toISOString()};return b(N=>[...N,g]),g},removeSeat:async x=>{const h=m.find(a=>a.id===x);if(h!=null&&h.app_email)throw new Error("Нельзя удалить участника с привязанным email. Обратитесь в поддержку.");try{const a=`waves_seat_email_binding_${x}`,o=localStorage.getItem(a);if(o&&JSON.parse(o).email)throw new Error("Нельзя удалить участника с привязанным email. Обратитесь в поддержку.")}catch(a){if(a instanceof Error&&a.message.includes("Нельзя удалить"))throw a}b(a=>a.filter(o=>o.id!==x))},linkDevice:async(x,h)=>{t(a=>a.map(o=>o.id===x?{...o,device_id:h,updated_at:new Date().toISOString()}:o))},updateSeatEmail:(x,h,a=!1)=>{b(o=>o.map(j=>j.id===x?{...j,app_email:h,app_email_verified:a,app_email_set_at:new Date().toISOString()}:j))},hasLicense:u.length>0}}function js(){const s=ze(),{data:c}=Oe(),{licenses:i,seats:u,purchaseLicense:t,assignSeat:m,removeSeat:b,linkDevice:w,hasLicense:k,updateSeatEmail:T}=cs(),{device:L,hasDevice:H}=Pe(),[C,$]=r.useState(!1),[x,h]=r.useState(!1),[a,o]=r.useState(null),j=async n=>{$(!0);try{await t(n),sessionStorage.setItem("license_purchased","true"),J.success("Лицензия успешно приобретена!"),h(!1),o(null)}catch{J.error("Ошибка при покупке лицензии")}finally{$(!1)}},g=n=>u.filter(S=>S.license_id===n),N=n=>{const S=u.filter(D=>D.license_id===n).map(D=>D.profile_id);return(c||[]).filter(D=>!S.includes(D.id))};return e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-6 pt-8 pb-8",children:[e.jsx("div",{className:"mb-8",children:e.jsx(oe,{size:"2xl",className:"mb-2",children:"Мои лицензии"})}),!k&&e.jsx("div",{className:"space-y-6",children:e.jsxs(Y,{className:"glass-elegant border-0 p-6 sm:p-8",children:[e.jsxs("div",{className:"text-center max-w-md mx-auto mb-8",children:[e.jsx(oe,{size:"xl",className:"mb-3",children:"У вас нет активных лицензий"}),e.jsx("p",{className:"text-muted-foreground",children:"Выберите подходящий план, чтобы начать использовать Waves"})]}),e.jsx("div",{className:"grid gap-6 lg:grid-cols-2",children:re.map(n=>e.jsxs(Y,{className:P("relative p-4 sm:p-6 transition-all cursor-pointer hover:shadow-lg bg-white border-0",a===n.id?"bg-coral/5":"hover:bg-coral/5"),onClick:()=>o(n.id),children:[n.id==="family"&&e.jsxs(de,{className:"absolute -top-2 -right-2 bg-honey text-ink",children:[e.jsx(Je,{className:"h-3 w-3 mr-1"}),"Популярный"]}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[n.id==="individual"?e.jsx(Z,{name:"user",size:41,className:"text-coral flex-shrink-0"}):e.jsx(Z,{name:"users",size:41,className:"text-coral flex-shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"font-semibold text-base sm:text-lg truncate",children:n.name}),e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground truncate",children:n.description})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-baseline gap-2 mb-1",children:[e.jsx("span",{className:"text-2xl sm:text-3xl font-bold",children:we(n.price)}),n.id==="individual"&&e.jsx("span",{className:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap",children:"или 3 333 ₽/мес"}),n.id==="family"&&e.jsx("span",{className:"text-xs sm:text-sm text-muted-foreground whitespace-nowrap",children:"или 5 000 ₽/мес"})]}),(n.id==="individual"||n.id==="family")&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Рассрочка на 24 месяца без переплаты"})]}),e.jsx("ul",{className:"space-y-2 mb-6",children:n.features.map((S,D)=>e.jsxs("li",{className:"flex items-start gap-2 text-xs sm:text-sm",children:[e.jsx(Ue,{className:"h-4 w-4 text-coral flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"break-words",children:S})]},D))}),e.jsx(I,{className:P("w-full",a===n.id?"bg-gradient-to-r from-coral to-coral-light":""),variant:a===n.id?"default":"outline",onClick:S=>{S.stopPropagation(),j(n.id)},disabled:C,children:C&&a===n.id?"Оформление...":"Выбрать план"})]},n.id))})]})}),k&&e.jsxs("div",{className:"space-y-6",children:[i.map(n=>{const S=De(n.plan_type),D=g(n.id),M=N(n.id),O=n.max_seats-D.length,U=is(n);return e.jsxs(Y,{className:"bg-white shadow-[0_4px_20px_rgba(0,0,0,0.06)] border-0 p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-24 h-24 rounded-xl bg-gradient-to-br from-coral/20 to-coral/10 flex items-center justify-center",children:n.plan_type==="individual"?e.jsx(Z,{name:"user",size:38,className:"text-coral"}):e.jsx(Z,{name:"users",size:38,className:"text-coral"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:(S==null?void 0:S.name)||"Лицензия"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:S==null?void 0:S.description})]})]}),e.jsx(de,{className:P(rs[n.status],"border-0 !from-transparent !to-transparent"),style:n.status==="active"?{background:"white",backgroundImage:"none",border:"1px solid rgba(34, 197, 94, 0.3)"}:{backgroundImage:"none"},children:as[n.status]})]}),U&&e.jsxs("div",{className:"mb-6 flex items-center gap-2 p-3 bg-honey/10 border border-honey/30 rounded-lg",children:[e.jsx(Se,{className:"h-4 w-4 text-honey"}),e.jsxs("span",{className:"text-sm",children:["Лицензия истекает"," ",new Date(n.expires_at).toLocaleDateString("ru-RU")]}),e.jsx(I,{variant:"link",size:"sm",className:"ml-auto h-auto p-0",children:"Продлить"})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3 mb-6",children:[e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Действует до"}),e.jsx("p",{className:"font-medium",children:new Date(n.expires_at).toLocaleDateString("ru-RU")})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Участники"}),e.jsxs("p",{className:"font-medium",children:[D.length," из ",n.max_seats]})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Устройство"}),e.jsx("p",{className:"font-medium",children:n.device_id?"Подключено":"Не привязано"})]})]}),e.jsxs("div",{className:"border-t border-border/50 pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-medium",children:"Участники"}),O>0&&M.length>0&&e.jsxs(ue,{children:[e.jsx(Ae,{asChild:!0,children:e.jsxs(I,{variant:"outline",size:"sm",children:[e.jsx(be,{className:"h-4 w-4 mr-1"}),"Добавить"]})}),e.jsxs(me,{children:[e.jsxs(xe,{children:[e.jsx(he,{children:"Добавить участника"}),e.jsx(fe,{children:"Выберите профиль для добавления в лицензию"})]}),e.jsx("div",{className:"space-y-2 mt-4",children:M.map(v=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-muted/50 transition-colors",onClick:async()=>{try{await m(n.id,v.id,{id:v.id,first_name:v.first_name,last_name:v.last_name||void 0,type:v.type}),J.success(`${v.first_name} добавлен в лицензию`)}catch{J.error("Ошибка при добавлении участника")}},children:[e.jsx(ge,{className:"h-10 w-10",children:e.jsx(pe,{children:v.first_name[0]})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-medium",children:[v.first_name," ",v.last_name||""]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:v.type==="parent"?"Родитель":"Ребёнок"})]}),e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"})]},v.id))})]})]})]}),D.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Нет добавленных участников"}):e.jsx("div",{className:"space-y-4",children:D.map(v=>{var A,q,B,K,V,G,R;return e.jsxs("div",{className:"p-4 bg-muted/30 rounded-xl space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ge,{className:"h-10 w-10",children:e.jsx(pe,{children:((q=(A=v.profile)==null?void 0:A.first_name)==null?void 0:q[0])||"?"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-medium",children:[(B=v.profile)==null?void 0:B.first_name," ",((K=v.profile)==null?void 0:K.last_name)||""]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[((V=v.profile)==null?void 0:V.type)==="parent"?"Родитель":"Ребёнок"," · Добавлен ",new Date(v.assigned_at).toLocaleDateString("ru-RU")]})]}),v.app_email?e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Email привязан"}),e.jsx("p",{className:"text-xs text-coral",children:"Удаление через поддержку"})]}):e.jsx(I,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-destructive",onClick:()=>{b(v.id),J.success("Участник удалён")},children:"Удалить"})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-border/30",children:e.jsx(ns,{seatId:v.id,profileName:(G=v.profile)==null?void 0:G.first_name,profileType:(R=v.profile)==null?void 0:R.type,onEmailSet:_=>{T(v.id,_,!0)}})})]},v.id)})}),O>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-3",children:["Доступно ещё ",O," ",O===1?"место":"места"]})]}),e.jsx("div",{className:"mt-6 pt-6 border-t border-border/50",children:e.jsxs(I,{variant:"outline",className:"w-full sm:w-auto",onClick:async()=>{if(!n.device_id&&H&&L)try{await w(n.id,L.id),J.success(`Устройство ${L.model||L.id} успешно привязано к лицензии`)}catch{J.error("Ошибка при привязке устройства")}s("/cabinet/device")},children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),n.device_id?"Управление нейроустройством":"Привязать нейроустройство"]})})]},n.id)}),e.jsxs(Y,{className:"bg-white shadow-[0_4px_20px_rgba(0,0,0,0.06)] border-0 p-6 text-center cursor-pointer hover:bg-coral/5 transition-colors",onClick:()=>h(!0),children:[e.jsx(be,{className:"h-8 w-8 text-coral mx-auto mb-2"}),e.jsx("p",{className:"text-foreground",children:"Приобрести ещё одну лицензию"})]})]}),e.jsx(ue,{open:x,onOpenChange:h,children:e.jsxs(me,{className:"max-w-2xl",children:[e.jsxs(xe,{children:[e.jsx(he,{children:"Выбор лицензии"}),e.jsx(fe,{children:"Выберите план, который подходит вам"})]}),e.jsx("div",{className:"grid gap-4 lg:grid-cols-2 mt-4",children:re.map(n=>e.jsxs(Y,{className:P("relative p-4 border-2 cursor-pointer transition-all",a===n.id?"border-coral bg-coral/5":"border-border/50 hover:border-coral/50"),onClick:()=>o(n.id),children:[e.jsx("h4",{className:"font-semibold",children:n.name}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:n.description}),e.jsxs("p",{className:"text-xl font-bold",children:[we(n.price),e.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:" / мес"})]})]},n.id))}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsx(I,{variant:"outline",onClick:()=>h(!1),children:"Отмена"}),e.jsx(I,{onClick:()=>a&&j(a),disabled:!a||C,className:"bg-gradient-to-r from-coral to-coral-light",children:C?"Оформление...":"Оформить"})]})]})})]})}export{js as default};
