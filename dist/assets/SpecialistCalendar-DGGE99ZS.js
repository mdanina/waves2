import{j as e,r}from"./vendor-radix-J7BmBqsC.js";import{g as K,Y as R,B as p,i as G,t as V,m as ae,a0 as ne,ag as re,N as Q,E as le,a4 as ie,G as oe,J as ce,$ as de,a1 as me,r as he,a5 as ue,_ as Y,aL as fe,z as pe,D as xe}from"./index-CsvxaYtI.js";import{C as ge}from"./calendar-CkYc6SnW.js";import{S as T}from"./skeleton-CX4qEpye.js";import{A as je,a as be,b as Ne,c as we,d as ye,e as ve,f as De,g as ke}from"./alert-dialog-COnYxGom.js";import{g as Ce,a as _e,b as W,c as Se,d as Ae,e as Ee}from"./supabase-appointments-8FoTnk7D.js";import{u as Me}from"./vendor-react-CI1J5nwZ.js";import{P as Te,f as O,k as Re}from"./vendor-date-CR4liJ_d.js";import{P as J}from"./plus-CNlpg7MV.js";import{T as X}from"./trash-2-BiEfhxdN.js";import{r as $}from"./ru-DXu8W4Lf.js";import"./radio-group-DaEomwmN.js";import"./switch-CChs6D0W.js";import"./popover-DrT-WKCR.js";import{g as Oe}from"./supabase-specialist-schedule-BsySnTxr.js";import{c as Pe,b as Fe,d as Le,e as ze}from"./calendar-feed-CbZCm7zL.js";import{C as Ie}from"./copy-BIipb-ws.js";import"./vendor-charts-CkgrveCd.js";import"./vendor-query-Bb981xLV.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=K("CalendarOff",[["path",{d:"M4.2 4.2A2 2 0 0 0 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 1.82-1.18",key:"16swn3"}],["path",{d:"M21 15.5V6a2 2 0 0 0-2-2H9.5",key:"yhw86o"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M3 10h7",key:"1wap6i"}],["path",{d:"M21 10h-5.5",key:"quycpq"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=K("Repeat",[["path",{d:"m17 2 4 4-4 4",key:"nntrym"}],["path",{d:"M3 11v-1a4 4 0 0 1 4-4h14",key:"84bu3i"}],["path",{d:"m7 22-4-4 4-4",key:"1wqhfi"}],["path",{d:"M21 13v1a4 4 0 0 1-4 4H3",key:"1rx37r"}]]),$e={0:"sun",1:"mon",2:"tue",3:"wed",4:"thu",5:"fri",6:"sat"};function Ue({appointments:g,clients:f,selectedDate:y,schedule:D,onDelete:i,onCreateAtTime:o}){var k;const n=Me(),j=$e[Te(y)],b=((k=D==null?void 0:D.work_days)==null?void 0:k.includes(j))??!0,N=s=>f.find(h=>h.id===s.user_id)||null,x=s=>{if(!s.scheduled_at)return"";const h=new Date(s.scheduled_at),l=s.duration_minutes||45,c=new Date(h.getTime()+l*60*1e3);return O(c,"HH:mm",{locale:$})},A=s=>{n(`/specialist/sessions/${s}`)},v=[...g].sort((s,h)=>!s.scheduled_at||!h.scheduled_at?0:new Date(s.scheduled_at).getTime()-new Date(h.scheduled_at).getTime());return b?v.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(R,{className:"w-16 h-16 text-muted-foreground/50 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-muted-foreground",children:"У вас сегодня нет консультаций"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1 mb-6",children:O(y,"d MMMM, EEEE",{locale:$})}),o&&e.jsxs(p,{onClick:()=>o(""),className:"gap-2",children:[e.jsx(J,{className:"w-4 h-4"}),"Новая консультация"]})]}):e.jsxs("div",{className:"space-y-3",children:[v.map(s=>{const h=s.scheduled_at?O(new Date(s.scheduled_at),"HH:mm"):"",l=x(s),c=s.meeting_format,P=N(s),C=s.profile?s.profile.last_name?`${s.profile.first_name} ${s.profile.last_name}`:s.profile.first_name:Ce(P);return e.jsx("div",{className:G("p-4 rounded-lg border bg-card cursor-pointer transition-all hover:shadow-md",c==="online"&&"border-l-4 border-l-blue-500",c==="in_person"&&"border-l-4 border-l-primary",!c&&"border-l-4 border-l-muted-foreground"),onClick:()=>A(s.id),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex-shrink-0 text-center min-w-[70px]",children:[e.jsx("p",{className:"text-lg font-bold text-foreground",children:h}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["до ",l]})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-foreground truncate",children:C}),(s.recurring_pattern||s.parent_appointment_id)&&e.jsx(Ye,{className:"w-3.5 h-3.5 text-muted-foreground flex-shrink-0",title:"Повторяющаяся"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.status==="payment_pending"&&e.jsxs(V,{variant:"secondary",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:[e.jsx(ae,{className:"w-3 h-3 mr-1"}),"Ожидает оплаты"]}),c&&e.jsx(V,{variant:"outline",className:G("text-xs",c==="online"&&"border-blue-500 text-blue-600",c==="in_person"&&"border-primary text-primary"),children:c==="online"?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-3 h-3 mr-1"})," Онлайн"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-3 h-3 mr-1"})," Очно"]})}),s.appointment_type&&e.jsx("span",{className:"text-xs text-muted-foreground",children:s.appointment_type.name})]})]}),i&&e.jsx(p,{variant:"ghost",size:"sm",onClick:E=>{E.stopPropagation(),i(s.id)},className:"h-9 w-9 p-0 text-muted-foreground hover:text-destructive flex-shrink-0",children:e.jsx(X,{className:"w-4 h-4"})})]})},s.id)}),o&&e.jsxs(p,{variant:"outline",className:"w-full gap-2 mt-4",onClick:()=>o(""),children:[e.jsx(J,{className:"w-4 h-4"}),"Добавить консультацию"]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(He,{className:"w-16 h-16 text-muted-foreground/50 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-muted-foreground",children:"Выходной день"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"В этот день консультации не запланированы"})]})}function Be({specialistId:g,trigger:f}){const[y,D]=r.useState(!1),[i,o]=r.useState(!1),[n,j]=r.useState(null),[b,N]=r.useState(!1),{toast:x}=Q();r.useEffect(()=>{y&&g&&A()},[y,g]);const A=async()=>{o(!0);try{const l=await Pe(g);j(l?Fe(l):null)}catch(l){console.error("Ошибка загрузки токена:",l)}finally{o(!1)}},v=async()=>{o(!0);try{const l=await Le();j(l.feedUrl),x({title:"Ссылка создана",description:"Скопируйте ссылку и добавьте в свой календарь"})}catch(l){x({title:"Ошибка",description:l instanceof Error?l.message:"Не удалось создать ссылку",variant:"destructive"})}finally{o(!1)}},k=async()=>{o(!0);try{await ze(),j(null),x({title:"Ссылка отозвана",description:"Старая ссылка больше не работает"})}catch(l){x({title:"Ошибка",description:l instanceof Error?l.message:"Не удалось отозвать ссылку",variant:"destructive"})}finally{o(!1)}},s=async()=>{if(n)try{await navigator.clipboard.writeText(n),N(!0),x({title:"Скопировано",description:"Ссылка скопирована в буфер обмена"}),setTimeout(()=>N(!1),2e3)}catch{x({title:"Ошибка",description:"Не удалось скопировать ссылку",variant:"destructive"})}},h=e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Синхронизация с календарем"]});return e.jsxs(le,{open:y,onOpenChange:D,children:[e.jsx(ie,{asChild:!0,children:f||h}),e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-5 w-5 text-primary"}),"Синхронизация расписания"]}),e.jsx(me,{children:"Добавьте расписание консультаций в свой календарь."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Google Календарь"}),e.jsx("p",{className:"text-muted-foreground",children:"Меню «Другие календари» — «Добавить по URL»"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Apple Календарь"}),e.jsx("p",{className:"text-muted-foreground",children:"Меню «Файл» — «Подписка на новый календарь...»"})]})]}),n?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(he,{value:n,readOnly:!0,className:"font-mono text-xs"}),e.jsx(p,{variant:"outline",size:"icon",onClick:s,disabled:i,children:b?e.jsx(ue,{className:"h-4 w-4 text-green-500"}):e.jsx(Ie,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",onClick:v,disabled:i,className:"flex-1",children:[e.jsx(Y,{className:`h-4 w-4 mr-2 ${i?"animate-spin":""}`}),"Обновить ссылку"]}),e.jsx(p,{variant:"outline",size:"sm",onClick:k,disabled:i,className:"text-destructive hover:text-destructive",children:e.jsx(X,{className:"h-4 w-4"})})]})]}):e.jsxs(p,{onClick:v,disabled:i,className:"w-full bg-primary hover:bg-primary/90",children:[i?e.jsx(Y,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(R,{className:"h-4 w-4 mr-2"}),"Создать ссылку"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Календарь будет автоматически обновляться при изменении расписания. В событиях будут указаны имена клиентов и ссылки на видеоконсультации."})]})]})]})}function ds(){var q;const{specialistUser:g}=fe(),{toast:f}=Q(),[y,D]=useSearchParams(),[i,o]=r.useState(new Date),[n,j]=r.useState(new Date),[b,N]=r.useState([]),[x,A]=r.useState([]),[v,k]=r.useState(null),[s,h]=r.useState(!0),[l,c]=r.useState(!1),[P,C]=r.useState(!1),[E,F]=r.useState(null),[L,z]=r.useState(!1),m=(q=g==null?void 0:g.specialist)==null?void 0:q.id,I=r.useCallback(async(a=!1)=>{if(m)try{a&&c(!0);const t=new Date(n.getFullYear(),n.getMonth(),1),d=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59),[u,S,w]=await Promise.all([_e(),W(m,t,d),Oe().catch(()=>null)]);A(u),N(S),k(w)}catch(t){console.error("Error loading calendar data:",t),f({title:"Ошибка",description:"Не удалось загрузить данные календаря",variant:"destructive"})}finally{h(!1),c(!1)}},[m,n,f]),_=r.useCallback(async()=>{if(m)try{c(!0);const a=new Date(n.getFullYear(),n.getMonth(),1),t=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59),d=await W(m,a,t);N(d)}catch(a){console.error("Error loading appointments:",a),f({title:"Ошибка",description:"Не удалось загрузить консультации",variant:"destructive"})}finally{c(!1)}},[m,n,f]),H=r.useRef(!1);r.useEffect(()=>{m&&!H.current&&(H.current=!0,I())},[m,I]),r.useEffect(()=>{s||!H.current||_()},[n,s,_]),r.useEffect(()=>{if(!m)return;const a=Se(m,(t,d,u)=>{const S=w=>{if(!(w!=null&&w.scheduled_at))return!1;const M=new Date(w.scheduled_at),se=new Date(n.getFullYear(),n.getMonth(),1),te=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59);return M>=se&&M<=te};switch(t){case"INSERT":d&&S(d)&&_();break;case"UPDATE":d&&(S(d)||S(u))&&_();break;case"DELETE":u&&S(u)&&N(w=>w.filter(M=>M.id!==u.id));break}});return()=>{a()}},[m,n,_]);const Z=async a=>{const t=b.find(u=>u.id===a);if(!t)return;if(t.recurring_pattern||t.parent_appointment_id){F(t),C(!0);return}await U(a,!1)},U=async(a,t)=>{try{t?(await Ae(a),f({title:"Успешно",description:"Все повторяющиеся консультации удалены"})):(await Ee(a),f({title:"Успешно",description:"Консультация удалена"})),await _(),C(!1),F(null)}catch(d){console.error("Error deleting appointment:",d),f({title:"Ошибка",description:"Не удалось удалить консультацию",variant:"destructive"})}},ee=b.filter(a=>a.scheduled_at?Re(new Date(a.scheduled_at),i):!1),B=r.useMemo(()=>{const a=new Map;for(const t of b){if(!t.scheduled_at)continue;const d=new Date(t.scheduled_at).toDateString(),u=a.get(d)||{hasOnline:!1,hasInPerson:!1};t.meeting_format==="in_person"?u.hasInPerson=!0:t.meeting_format==="online"&&(u.hasOnline=!0),a.set(d,u)}return a},[b]);return s?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"border-b bg-background px-4 md:px-6 py-3 md:py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(T,{className:"h-10 w-40"}),e.jsx(T,{className:"h-10 w-10"})]})}),e.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row overflow-hidden",children:[e.jsx("div",{className:"lg:w-1/2 p-6 flex items-center justify-center",children:e.jsx(T,{className:"h-80 w-80"})}),e.jsx("div",{className:"lg:w-1/2 p-6",children:e.jsx(T,{className:"h-full w-full"})})]})]}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"border-b bg-background px-4 md:px-6 py-3 md:py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Календарь"}),e.jsxs("div",{className:"flex items-center gap-2",children:[m&&e.jsx(Be,{specialistId:m}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>I(!0),disabled:l,children:e.jsx(Y,{className:`w-4 h-4 ${l?"animate-spin":""}`})})]})]})}),e.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row overflow-hidden",children:[e.jsx("div",{className:"lg:w-1/2 border-b lg:border-b-0 lg:border-r bg-background p-4 md:p-6 flex flex-col items-center justify-center",children:e.jsx(ge,{mode:"single",selected:i,onSelect:a=>a&&o(a),month:n,onMonthChange:j,className:"w-fit",classNames:{months:"flex justify-center",month:"space-y-6",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-lg font-semibold",nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"mx-auto",head_cell:"text-sm font-medium w-[72px] h-12",cell:"h-[72px] w-[72px]",day:"h-[72px] w-[72px] text-lg font-medium relative [&.has-online-appointment]:after:content-[''] [&.has-online-appointment]:after:absolute [&.has-online-appointment]:after:bottom-2 [&.has-online-appointment]:after:left-1/2 [&.has-online-appointment]:after:-translate-x-1/2 [&.has-online-appointment]:after:h-1.5 [&.has-online-appointment]:after:w-1.5 [&.has-online-appointment]:after:rounded-full [&.has-online-appointment]:after:bg-blue-500 [&.has-inperson-appointment]:after:content-[''] [&.has-inperson-appointment]:after:absolute [&.has-inperson-appointment]:after:bottom-2 [&.has-inperson-appointment]:after:left-1/2 [&.has-inperson-appointment]:after:-translate-x-1/2 [&.has-inperson-appointment]:after:h-1.5 [&.has-inperson-appointment]:after:w-1.5 [&.has-inperson-appointment]:after:rounded-full [&.has-inperson-appointment]:after:bg-primary",day_selected:"border-2 border-primary rounded-full bg-transparent text-foreground hover:border-primary hover:bg-transparent focus:border-primary focus:bg-transparent"},modifiers:{hasOnlineAppointment:a=>{const t=B.get(a.toDateString());return!!(t!=null&&t.hasOnline)&&!(t!=null&&t.hasInPerson)},hasInPersonAppointment:a=>{var t;return((t=B.get(a.toDateString()))==null?void 0:t.hasInPerson)??!1}},modifiersClassNames:{hasOnlineAppointment:"has-online-appointment",hasInPersonAppointment:"has-inperson-appointment"}})}),e.jsx("div",{className:"lg:w-1/2 p-4 md:p-6 flex-1 min-h-0",children:e.jsxs("div",{className:"bg-card rounded-lg border border-border shadow-sm h-full flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 md:p-6 pb-3 md:pb-4 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(p,{variant:"outline",size:"sm",onClick:()=>o(new Date(i.getTime()-24*60*60*1e3)),children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-center flex-1 min-w-0",children:e.jsx("p",{className:"text-xs sm:text-sm font-medium truncate",children:O(i,"EEEE, d MMMM yyyy",{locale:$})})}),e.jsx(p,{variant:"outline",size:"sm",onClick:()=>o(new Date(i.getTime()+24*60*60*1e3)),children:e.jsx(xe,{className:"w-4 h-4"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 md:p-6 pt-3 md:pt-4",children:e.jsx(Ue,{appointments:ee,clients:x,selectedDate:i,schedule:v,onDelete:Z})})]})})]}),e.jsx(je,{open:P,onOpenChange:C,children:e.jsxs(be,{children:[e.jsxs(Ne,{children:[e.jsx(we,{children:"Удаление повторяющейся консультации"}),e.jsx(ye,{children:"Эта консультация является частью повторяющейся серии. Что вы хотите сделать?"})]}),e.jsxs("div",{className:"space-y-2 py-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"deleteOption",checked:!L,onChange:()=>z(!1),className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Удалить только эту консультацию"})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"deleteOption",checked:L,onChange:()=>z(!0),className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Удалить все последующие консультации"})]})]}),e.jsxs(ve,{children:[e.jsx(De,{onClick:()=>{C(!1),F(null),z(!1)},children:"Отмена"}),e.jsx(ke,{onClick:()=>{E&&U(E.id,L)},children:"Удалить"})]})]})})]})}export{ds as default};
