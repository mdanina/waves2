import{r as j,j as e}from"./vendor-radix-htwXsPHy.js";import{b4 as X,v as o,C as r,J as n,i as m,B as p,D as C,K as d,ai as R,z as U,w as ee,af as S,Z as q,r as se}from"./index-Dv2C02zj.js";import{S as h}from"./skeleton-_MojRjq8.js";import{L as f}from"./vendor-react-CI8wve7f.js";import{g as te,a as ae,f as le,b as ie}from"./client-utils-BLj6ZS6T.js";import{S as M}from"./star-N_dgvkCe.js";import{A as E}from"./arrow-right-DuiPKs_q.js";import"./vendor-charts-DjioKZbK.js";import"./vendor-query-BNGVDYIL.js";function je(){var A;const{specialistUser:l}=X(),[i,T]=j.useState({activeClients:0,todayAppointments:0,weekAppointments:0,completedThisMonth:0,ratingAvg:null,ratingCount:0}),[D,B]=j.useState([]),[F,N]=j.useState(!0),L=j.useMemo(()=>{var s;return((s=l==null?void 0:l.specialist)==null?void 0:s.display_name)||"Специалист"},[(A=l==null?void 0:l.specialist)==null?void 0:A.display_name]);j.useEffect(()=>{O()},[]);const O=async()=>{var s;try{N(!0);const t=(s=l==null?void 0:l.specialist)==null?void 0:s.id;if(!t){console.warn("No specialist ID found"),N(!1);return}const c=new Date,g=new Date(c.getFullYear(),c.getMonth(),c.getDate()),_=new Date(g);_.setDate(_.getDate()+1);const w=new Date(g);w.setDate(w.getDate()+7);const z=new Date(c.getFullYear(),c.getMonth(),1),[$,Y,H,J]=await Promise.all([o.from("client_assignments").select("client_user_id",{count:"exact",head:!0}).eq("specialist_id",t).eq("status","active"),o.from("appointments").select(`
            id,
            scheduled_at,
            status,
            video_room_url,
            user_id,
            appointment_type_id
          `).eq("specialist_id",t).gte("scheduled_at",g.toISOString()).lt("scheduled_at",_.toISOString()).order("scheduled_at",{ascending:!0}),o.from("appointments").select("id",{count:"exact",head:!0}).eq("specialist_id",t).gte("scheduled_at",g.toISOString()).lt("scheduled_at",w.toISOString()),o.from("appointments").select("id",{count:"exact",head:!0}).eq("specialist_id",t).eq("status","completed").gte("scheduled_at",z.toISOString())]),K=$.count||0;let k=[];const u=Y.data||[];if(u.length>0){const V=u.map(a=>a.user_id),I=u.map(a=>a.appointment_type_id).filter(Boolean),[W,Z]=await Promise.all([o.from("profiles").select("user_id, first_name, last_name").in("user_id",V),I.length>0?o.from("appointment_types").select("id, name").in("id",I):Promise.resolve({data:[]})]),G=W.data||[],Q=Z.data||[];k=u.map(a=>{const y=G.find(b=>b.user_id===a.user_id),v=Q.find(b=>b.id===a.appointment_type_id);return{id:a.id,scheduled_at:a.scheduled_at,status:a.status,video_room_url:a.video_room_url,client_email:null,client_phone:null,appointment_type_name:(v==null?void 0:v.name)||null,profile:y?{first_name:y.first_name,last_name:y.last_name}:void 0}})}B(k);const{data:x}=await o.from("specialists").select("rating_avg, rating_count").eq("id",t).single();T({activeClients:K,todayAppointments:u.length,weekAppointments:H.count||0,completedThisMonth:J.count||0,ratingAvg:(x==null?void 0:x.rating_avg)||null,ratingCount:(x==null?void 0:x.rating_count)||0})}catch(t){console.error("Error loading dashboard:",t)}finally{N(!1)}},P=s=>{const t=ie(s);return e.jsx(se,{variant:t.variant,className:t.className,children:t.label})};return F?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(h,{className:"h-8 w-64"}),e.jsx(h,{className:"h-4 w-32 mt-2"})]}),e.jsx(h,{className:"h-10 w-40"})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[1,2,3,4,5].map(s=>e.jsxs(r,{children:[e.jsx(n,{className:"pb-2",children:e.jsx(h,{className:"h-4 w-24"})}),e.jsx(m,{children:e.jsx(h,{className:"h-8 w-12"})})]},s))}),e.jsx(h,{className:"h-64"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold",children:["Добро пожаловать, ",L,"!"]}),e.jsx("p",{className:"text-muted-foreground",children:new Date().toLocaleDateString("ru-RU",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx(p,{asChild:!0,children:e.jsxs(f,{to:"/specialist/calendar",children:[e.jsx(C,{className:"mr-2 h-4 w-4"}),"Открыть календарь"]})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsxs(r,{children:[e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"Активные клиенты"}),e.jsx(R,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:i.activeClients}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Назначено вам"})]})]}),e.jsxs(r,{children:[e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"Сегодня"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:i.todayAppointments}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Консультаций запланировано"})]})]}),e.jsxs(r,{children:[e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"На этой неделе"}),e.jsx(C,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:i.weekAppointments}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Консультаций всего"})]})]}),e.jsxs(r,{children:[e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"За месяц"}),e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:i.completedThisMonth}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Завершено"})]})]}),e.jsxs(r,{children:[e.jsxs(n,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(d,{className:"text-sm font-medium",children:"Рейтинг"}),e.jsx(M,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(m,{children:i.ratingCount>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex items-center gap-0.5",children:[1,2,3,4,5].map(s=>e.jsx(M,{className:`h-4 w-4 ${s<=Math.round(i.ratingAvg||0)?"fill-yellow-400 text-yellow-400":"fill-none text-gray-300"}`},s))}),e.jsx("span",{className:"text-2xl font-bold",children:(i.ratingAvg||0).toFixed(1)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[i.ratingCount," ",(()=>{const s=i.ratingCount,t=s%10,c=s%100;return c>=11&&c<=19?"оценок":t===1?"оценка":t>=2&&t<=4?"оценки":"оценок"})()]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold text-muted-foreground",children:"—"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Пока нет оценок"})]})})]})]}),e.jsxs(r,{children:[e.jsx(n,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(d,{children:"Сегодняшние консультации"}),e.jsx(S,{children:"Ваше расписание на сегодня"})]}),e.jsx(p,{variant:"outline",asChild:!0,children:e.jsxs(f,{to:"/specialist/calendar",children:["Все консультации",e.jsx(E,{className:"ml-2 h-4 w-4"})]})})]})}),e.jsx(m,{children:D.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(C,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:"На сегодня консультаций нет"}),e.jsx("p",{className:"text-sm mt-1",children:"Новые клиенты будут назначены координатором"})]}):e.jsx("div",{className:"space-y-4",children:D.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:te(s.profile,s.client_email)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:ae(s.profile,s.client_email)}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[le(s.scheduled_at),s.appointment_type_name&&` • ${s.appointment_type_name}`]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[P(s.status),s.video_room_url&&s.status!=="completed"&&e.jsx(p,{size:"sm",asChild:!0,children:e.jsxs("a",{href:s.video_room_url,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Начать"]})}),e.jsx(p,{variant:"ghost",size:"sm",asChild:!0,children:e.jsx(f,{to:`/specialist/sessions/${s.id}`,children:e.jsx(E,{className:"h-4 w-4"})})})]})]},s.id))})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsx(r,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsx(f,{to:"/specialist/clients",children:e.jsxs(n,{children:[e.jsxs(d,{className:"text-lg flex items-center gap-2",children:[e.jsx(R,{className:"h-5 w-5 text-primary"}),"Мои клиенты"]}),e.jsx(S,{children:"Просмотр списка назначенных клиентов"})]})})}),e.jsx(r,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsx(f,{to:"/specialist/sessions",children:e.jsxs(n,{children:[e.jsxs(d,{className:"text-lg flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5 text-primary"}),"Сессии"]}),e.jsx(S,{children:"История и записи сессий"})]})})})]})]})}export{je as default};
