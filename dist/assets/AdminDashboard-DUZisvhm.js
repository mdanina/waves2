import{r as O,j as e}from"./vendor-radix-J7BmBqsC.js";import{b as L}from"./vendor-query-Bb981xLV.js";import{x as w,O as W,a as V,b as H,c as K,d as Q,e as M,C as g,R as y,T as j,ag as D,h as b,F,Y as E,m as U}from"./index-CsvxaYtI.js";import{u as Y}from"./vendor-react-CI1J5nwZ.js";import{T as I}from"./trending-up-ESIQ9yhH.js";import{P as $}from"./package-DiQpez8U.js";import"./vendor-charts-CkgrveCd.js";async function G(n){try{const c=(n==null?void 0:n.startDate)||new Date(Date.now()-2592e6).toISOString(),s=(n==null?void 0:n.endDate)||new Date().toISOString(),[d,t,m,x,r,l]=await Promise.all([J(c,s),X(),Z(c,s),ee(c,s),se(c,s),te(c,s)]);return{users:d,profiles:t,assessments:m,appointments:x,payments:r,packages:l}}catch(c){return console.error("Error in getMetrics:",c),{users:{total:0,newThisPeriod:0,activeThisPeriod:0,byRegion:[],marketingConsent:0},profiles:{total:0,byType:[],averageFamilySize:0,childrenByAge:[]},assessments:{total:0,completed:0,abandoned:0,inProgress:0,byType:[],conversionRate:0,averageCompletionTime:null,paid:0,byWorryTags:[]},appointments:{scheduled:0,completed:0,cancelled:0,noShow:0,inProgress:0,byType:[]},payments:{totalRevenue:0,revenueThisPeriod:0,successful:0,failed:0,averageCheck:0,byMethod:[]},packages:{sold:0,sessionsUsed:0,sessionsRemaining:0}}}}async function J(n,c){try{const{data:s,error:d}=await w.from("users").select("id, region, marketing_consent, created_at");if(d)throw console.error("Error fetching all users:",d),d;const{data:t,error:m}=await w.from("users").select("id").gte("created_at",n).lte("created_at",c);if(m)throw console.error("Error fetching new users:",m),m;const{data:x,error:r}=await w.from("assessments").select("profile_id").gte("created_at",n).lte("created_at",c);if(r)throw console.error("Error fetching active assessments:",r),r;const{data:l,error:h}=await w.from("appointments").select("user_id").gte("created_at",n).lte("created_at",c);if(h)throw console.error("Error fetching active appointments:",h),h;const u=new Set;if(x&&x.length>0){const a=x.map(o=>o.profile_id).filter(o=>!!o);if(a.length>0){const{data:o,error:f}=await w.from("profiles").select("user_id").in("id",a);f?console.error("Error fetching profiles:",f):o&&o.forEach(_=>{_.user_id&&u.add(_.user_id)})}}l&&l.forEach(a=>{a.user_id&&u.add(a.user_id)});const p=(s||[]).reduce((a,o)=>{const f=o.region||"Не указан";return a[f]=(a[f]||0)+1,a},{});return{total:(s==null?void 0:s.length)||0,newThisPeriod:(t==null?void 0:t.length)||0,activeThisPeriod:u.size,byRegion:Object.entries(p).map(([a,o])=>({region:a,count:o})),marketingConsent:(s||[]).filter(a=>a.marketing_consent).length}}catch(s){return console.error("Error in getUsersMetrics:",s),{total:0,newThisPeriod:0,activeThisPeriod:0,byRegion:[],marketingConsent:0}}}async function X(){try{const{data:n,error:c}=await w.from("profiles").select("type, dob, user_id");if(c)throw console.error("Error fetching profiles:",c),c;const s=(n||[]).reduce((r,l)=>(r[l.type]=(r[l.type]||0)+1,r),{}),t=(n||[]).filter(r=>r.type==="child"&&r.dob).reduce((r,l)=>{if(!l.dob)return r;const h=Math.floor((Date.now()-new Date(l.dob).getTime())/(365.25*24*60*60*1e3)),u=h<3?"0-2":h<6?"3-5":h<10?"6-9":h<14?"10-13":"14+";return r[u]=(r[u]||0)+1,r},{}),m=new Set((n||[]).map(r=>r.user_id)),x=m.size>0?(n||[]).length/m.size:0;return{total:(n==null?void 0:n.length)||0,byType:Object.entries(s).map(([r,l])=>({type:r,count:l})),averageFamilySize:Math.round(x*10)/10,childrenByAge:Object.entries(t).map(([r,l])=>({ageRange:r,count:l}))}}catch(n){return console.error("Error in getProfilesMetrics:",n),{total:0,byType:[],averageFamilySize:0,childrenByAge:[]}}}async function Z(n,c){try{const{data:s,error:d}=await w.from("assessments").select("id, assessment_type, status, is_paid, started_at, completed_at, updated_at, worry_tags").gte("created_at",n).lte("created_at",c);if(d)throw console.error("Error fetching assessments:",d),d;const{data:t,error:m}=await w.from("assessments").select("id, assessment_type, status, is_paid, started_at, completed_at, worry_tags").eq("status","completed").gte("completed_at",n).lte("completed_at",c);m&&console.error("Error fetching completed assessments:",m);const{data:x,error:r}=await w.from("assessments").select("id, assessment_type, status, is_paid, started_at, completed_at, updated_at, worry_tags").eq("status","abandoned").gte("updated_at",n).lte("updated_at",c);r&&console.error("Error fetching abandoned assessments:",r);const l=(s||[]).filter(i=>i.status==="completed"),h=(s||[]).filter(i=>i.status==="abandoned"),u=(s||[]).filter(i=>i.status==="in_progress"),p=t||[],a=x||[],o=(s||[]).reduce((i,v)=>(i[v.assessment_type]=(i[v.assessment_type]||0)+1,i),{}),f=p.length+a.length,_=f>0?p.length/f*100:0,C=p.map(i=>i.id);let S=null;if(C.length>0){const{data:i,error:v}=await w.from("answers").select("assessment_id, created_at").in("assessment_id",C).order("created_at",{ascending:!0});if(!v&&i){const P=i.reduce((T,N)=>(T[N.assessment_id]||(T[N.assessment_id]=[]),T[N.assessment_id].push(new Date(N.created_at).getTime()),T),{}),k=[];for(const T of C){const N=P[T];if(N&&N.length>1){const R=(N[N.length-1]-N[0])/(1e3*60);R>0&&R<=120&&k.push(R)}}k.length>0&&(S=Math.round(k.reduce((T,N)=>T+N,0)/k.length))}}const z=[...s||[],...p||[],...a||[]],B=Array.from(new Map(z.map(i=>[i.id,i])).values()),A={};B.forEach(i=>{i.worry_tags&&(typeof i.worry_tags=="object"&&!Array.isArray(i.worry_tags)?Object.values(i.worry_tags).flat():Array.isArray(i.worry_tags)?i.worry_tags:[]).forEach(P=>{A[P]=(A[P]||0)+1})});const q=p.filter(i=>i.is_paid).length;return{total:(s==null?void 0:s.length)||0,completed:p.length,abandoned:a.length,inProgress:u.length,byType:Object.entries(o).map(([i,v])=>({type:i,count:v})),conversionRate:Math.round(_*10)/10,averageCompletionTime:S?Math.round(S):null,paid:q,byWorryTags:Object.entries(A).map(([i,v])=>({tag:i,count:v})).sort((i,v)=>v.count-i.count)}}catch(s){return console.error("Error in getAssessmentsMetrics:",s),{total:0,completed:0,abandoned:0,inProgress:0,byType:[],conversionRate:0,averageCompletionTime:null,paid:0,byWorryTags:[]}}}async function ee(n,c){try{const{data:s,error:d}=await w.from("appointments").select("id, status, appointment_type_id, scheduled_at").gte("scheduled_at",n).lte("scheduled_at",c);if(d)throw console.error("Error fetching appointments:",d),d;if(!s||s.length===0)return{scheduled:0,completed:0,cancelled:0,noShow:0,inProgress:0,byType:[]};const t=s.filter(a=>a.status==="scheduled"),m=s.filter(a=>a.status==="completed"),x=s.filter(a=>a.status==="cancelled"),r=s.filter(a=>a.status==="no_show"),l=s.filter(a=>a.status==="in_progress"),h=[...new Set(s.map(a=>a.appointment_type_id).filter(Boolean))];let u=[];if(h.length>0){const{data:a,error:o}=await w.from("appointment_types").select("id, name").in("id",h);o?console.error("Error fetching appointment types:",o):u=a||[]}const p={};return s.forEach(a=>{const o=u.find(_=>_.id===a.appointment_type_id),f=(o==null?void 0:o.name)||"Неизвестно";p[f]=(p[f]||0)+1}),{scheduled:t.length,completed:m.length,cancelled:x.length,noShow:r.length,inProgress:l.length,byType:Object.entries(p).map(([a,o])=>({type:a,count:o}))}}catch(s){return console.error("Error in getAppointmentsMetrics:",s),{scheduled:0,completed:0,cancelled:0,noShow:0,inProgress:0,byType:[]}}}async function se(n,c){try{const{data:s,error:d}=await w.from("payments").select("id, amount, status, payment_method, created_at");if(d)throw console.error("Error fetching all payments:",d),d;const{data:t,error:m}=await w.from("payments").select("id, amount, status, payment_method").gte("created_at",n).lte("created_at",c);if(m)throw console.error("Error fetching period payments:",m),m;const x=(s||[]).filter(o=>o.status==="completed"),r=(t||[]).filter(o=>o.status==="completed"),l=(t||[]).filter(o=>o.status==="failed"),h=x.reduce((o,f)=>o+Number(f.amount||0),0),u=r.reduce((o,f)=>o+Number(f.amount||0),0),p=r.length>0?u/r.length:0,a=(t||[]).reduce((o,f)=>{const _=f.payment_method||"Неизвестно";return o[_]=(o[_]||0)+1,o},{});return{totalRevenue:Math.round(h*100)/100,revenueThisPeriod:Math.round(u*100)/100,successful:r.length,failed:l.length,averageCheck:Math.round(p*100)/100,byMethod:Object.entries(a).map(([o,f])=>({method:o,count:f}))}}catch(s){return console.error("Error in getPaymentsMetrics:",s),{totalRevenue:0,revenueThisPeriod:0,successful:0,failed:0,averageCheck:0,byMethod:[]}}}async function te(n,c){try{const{data:s,error:d}=await w.from("package_purchases").select("id, package_id, sessions_remaining, created_at").gte("created_at",n).lte("created_at",c);if(d)throw console.error("Error fetching package purchases:",d),d;if(!s||s.length===0)return{sold:0,sessionsUsed:0,sessionsRemaining:0};const t=[...new Set(s.map(h=>h.package_id).filter(Boolean))],{data:m,error:x}=await w.from("packages").select("id, session_count").in("id",t);if(x)throw console.error("Error fetching packages:",x),x;const r=(s||[]).reduce((h,u)=>h+u.sessions_remaining,0);let l=0;return(s||[]).forEach(h=>{const u=m==null?void 0:m.find(p=>p.id===h.package_id);u&&(l+=u.session_count-h.sessions_remaining)}),{sold:s.length,sessionsUsed:l,sessionsRemaining:r}}catch(s){return console.error("Error in getPackagesMetrics:",s),{sold:0,sessionsUsed:0,sessionsRemaining:0}}}function re(n){return L({queryKey:["admin-metrics",n],queryFn:()=>G(n),staleTime:5*60*1e3,retry:1,retryDelay:1e3})}function he(){const n=Y(),[c,s]=O.useState("month"),d=O.useMemo(()=>{if(c==="all")return;const r=new Date,l=new Date;switch(c){case"day":l.setDate(r.getDate()-1);break;case"week":l.setDate(r.getDate()-7);break;case"month":l.setDate(r.getDate()-30);break}return{startDate:l.toISOString(),endDate:r.toISOString()}},[c]),{data:t,isLoading:m,error:x}=re(d);return m?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(W,{className:"h-8 w-8 animate-spin text-primary"})}):x?e.jsx("div",{className:"text-center text-destructive",children:"Ошибка загрузки метрик. Попробуйте обновить страницу."}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Дэшборд"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Обзор метрик продукта"})]}),e.jsxs(V,{value:c,onValueChange:r=>s(r),children:[e.jsx(H,{className:"w-[180px]",children:e.jsx(K,{})}),e.jsxs(Q,{children:[e.jsx(M,{value:"day",children:"Последний день"}),e.jsx(M,{value:"week",children:"Последняя неделя"}),e.jsx(M,{value:"month",children:"Последний месяц"}),e.jsx(M,{value:"all",children:"Все время"})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Пользователи"}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(g,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:()=>n("/admin/users"),children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Всего пользователей"}),e.jsx(D,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.users.total}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Новых за период: ",t.users.newThisPeriod]})]})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Активных пользователей"}),e.jsx(I,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.users.activeThisPeriod}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"За выбранный период"})]})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Согласие на маркетинг"}),e.jsx(D,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.users.marketingConsent}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.users.total>0?Math.round(t.users.marketingConsent/t.users.total*100):0,"% от всех пользователей"]})]})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Средний размер семьи"}),e.jsx(D,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.profiles.averageFamilySize}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Всего профилей: ",t.profiles.total]})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Оценки"}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[e.jsxs(g,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:()=>n("/admin/assessments"),children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Всего оценок"}),e.jsx(F,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.assessments.total}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Завершено: ",t.assessments.completed]})]})]}),e.jsxs(g,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:()=>n("/admin/assessments"),children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Конверсия"}),e.jsx(I,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[t.assessments.conversionRate,"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Брошено: ",t.assessments.abandoned]})]})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Среднее время"}),e.jsx(F,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.assessments.averageCompletionTime?`${Math.round(t.assessments.averageCompletionTime)} мин`:"—"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Прохождения оценки"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Консультации"}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsxs(g,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:()=>n("/admin/appointments"),children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Запланировано"}),e.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:t.appointments.scheduled})})]}),e.jsxs(g,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:()=>n("/admin/appointments"),children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Завершено"}),e.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:t.appointments.completed})})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Отменено"}),e.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:t.appointments.cancelled})})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"No-show"}),e.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:t.appointments.noShow})})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"В процессе"}),e.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:t.appointments.inProgress})})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Платежи"}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(g,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:()=>n("/admin/payments"),children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Общая выручка"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[t.payments.totalRevenue.toLocaleString()," ₽"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["За период: ",t.payments.revenueThisPeriod.toLocaleString()," ₽"]})]})]}),e.jsxs(g,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:()=>n("/admin/payments"),children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Успешных платежей"}),e.jsx(I,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.payments.successful}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Неудачных: ",t.payments.failed]})]})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Средний чек"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(b,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[t.payments.averageCheck.toLocaleString()," ₽"]})})]}),e.jsxs(g,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium",children:"Пакеты"}),e.jsx($,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.packages.sold}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Использовано сессий: ",t.packages.sessionsUsed]})]})]})]})]})]}):null}export{he as default};
