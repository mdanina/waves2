import{r as f,j as e}from"./vendor-radix-htwXsPHy.js";import{c as E}from"./vendor-react-CI8wve7f.js";import{b as F,u as I,c as M}from"./vendor-query-BNGVDYIL.js";import{g as w,v as Q,G as k,C,J as b,K as N,i as S,o as K,b as T,c as L,d as q,e as A,f as a,r as P,B as $,Z as z}from"./index-Dv2C02zj.js";import{T as D,a as G,b as H,c as n,d as J,e as d}from"./table-Dp3rzXzr.js";import{S as U}from"./search-BPVVDSxP.js";import{f as Z}from"./vendor-date-CR4liJ_d.js";import"./vendor-charts-DjioKZbK.js";function O(){return F({queryKey:["admin-appointments"],queryFn:async()=>{const{data:u,error:l}=await Q.from("appointments").select(`
          *,
          user:users!appointments_user_id_fkey(id, email),
          profile:profiles(id, first_name, last_name),
          appointment_type:appointment_types(id, name, duration_minutes, price)
        `).order("scheduled_at",{ascending:!1}).limit(1e3);if(l)throw l;return(u||[]).map(r=>{var c,i,h;return{...r,user:((c=r.user)==null?void 0:c[0])||r.user,profile:((i=r.profile)==null?void 0:i[0])||r.profile,appointment_type:((h=r.appointment_type)==null?void 0:h[0])||r.appointment_type}})}})}function W(){const u=I();return M({mutationFn:async({id:l,updates:r})=>{const{error:c}=await Q.from("appointments").update(r).eq("id",l);if(c)throw c},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-appointments"]}),w.success("Консультация обновлена")},onError:l=>{w.error(`Ошибка обновления: ${l.message}`)}})}function ce(){const[u,l]=E(),[r,c]=f.useState(""),[i,h]=f.useState("all"),p=f.useRef(null),x=u.get("id"),{data:t,isLoading:R}=O(),V=W();f.useEffect(()=>{if(x&&t&&p.current){p.current.scrollIntoView({behavior:"smooth",block:"center"});const s=setTimeout(()=>{l({},{replace:!0})},3e3);return()=>clearTimeout(s)}},[x,t,l]);const y=t==null?void 0:t.filter(s=>{var j,_,g,v;const o=s.id.toLowerCase().includes(r.toLowerCase())||((_=(j=s.user)==null?void 0:j.email)==null?void 0:_.toLowerCase().includes(r.toLowerCase()))||((v=(g=s.profile)==null?void 0:g.first_name)==null?void 0:v.toLowerCase().includes(r.toLowerCase())),m=i==="all"||s.status===i;return o&&m}),B=async(s,o)=>{await V.mutateAsync({id:s,updates:{status:o}})};return R?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(k,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Управление консультациями"}),e.jsxs("p",{className:"text-muted-foreground mt-1",children:["Всего консультаций: ",(t==null?void 0:t.length)||0]})]}),e.jsxs(C,{children:[e.jsx(b,{children:e.jsx(N,{children:"Фильтры"})}),e.jsxs(S,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(K,{placeholder:"Поиск по email или имени...",value:r,onChange:s=>c(s.target.value),className:"pl-10"})]}),e.jsxs(T,{value:i,onValueChange:h,children:[e.jsx(L,{className:"w-[180px]",children:e.jsx(q,{placeholder:"Статус"})}),e.jsxs(A,{children:[e.jsx(a,{value:"all",children:"Все статусы"}),e.jsx(a,{value:"payment_pending",children:"Ожидает оплаты"}),e.jsx(a,{value:"scheduled",children:"Запланировано"}),e.jsx(a,{value:"in_progress",children:"В процессе"}),e.jsx(a,{value:"completed",children:"Завершено"}),e.jsx(a,{value:"cancelled",children:"Отменено"}),e.jsx(a,{value:"no_show",children:"No-show"})]})]})]})]}),e.jsxs(C,{children:[e.jsx(b,{children:e.jsx(N,{children:"Список консультаций"})}),e.jsx(S,{children:e.jsxs(D,{children:[e.jsx(G,{children:e.jsxs(H,{children:[e.jsx(n,{children:"Дата и время"}),e.jsx(n,{children:"Тип консультации"}),e.jsx(n,{children:"Пользователь"}),e.jsx(n,{children:"Профиль"}),e.jsx(n,{children:"Статус"}),e.jsx(n,{children:"Видео"}),e.jsx(n,{children:"Действия"})]})}),e.jsx(J,{children:y==null?void 0:y.map(s=>{var o,m;return e.jsxs(H,{ref:s.id===x?p:void 0,className:s.id===x?"bg-primary/10 animate-pulse":"",children:[e.jsx(d,{children:Z(new Date(s.scheduled_at),"dd.MM.yyyy HH:mm")}),e.jsxs(d,{children:[((o=s.appointment_type)==null?void 0:o.name)||"—",s.appointment_type&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",s.appointment_type.duration_minutes," мин,"," ",s.appointment_type.price," ₽)"]})]}),e.jsx(d,{children:((m=s.user)==null?void 0:m.email)||"—"}),e.jsx(d,{children:s.profile?`${s.profile.first_name} ${s.profile.last_name||""}`.trim():"—"}),e.jsx(d,{children:e.jsx(P,{variant:s.status==="completed"?"default":s.status==="cancelled"||s.status==="no_show"?"destructive":"secondary",className:s.status==="payment_pending"?"bg-amber-100 text-amber-800 border-amber-300":"",children:s.status==="payment_pending"?"Ожидает оплаты":s.status==="scheduled"?"Запланировано":s.status==="in_progress"?"В процессе":s.status==="completed"?"Завершено":s.status==="cancelled"?"Отменено":"No-show"})}),e.jsx(d,{children:s.video_room_url&&s.status!=="completed"&&s.status!=="cancelled"?e.jsx($,{size:"sm",variant:"outline",asChild:!0,children:e.jsxs("a",{href:s.video_room_url,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),"Войти"]})}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"—"})}),e.jsx(d,{children:e.jsxs(T,{value:s.status,onValueChange:j=>B(s.id,j),children:[e.jsx(L,{className:"w-[150px]",children:e.jsx(q,{})}),e.jsxs(A,{children:[e.jsx(a,{value:"payment_pending",children:"Ожидает оплаты"}),e.jsx(a,{value:"scheduled",children:"Запланировано"}),e.jsx(a,{value:"in_progress",children:"В процессе"}),e.jsx(a,{value:"completed",children:"Завершено"}),e.jsx(a,{value:"cancelled",children:"Отменено"}),e.jsx(a,{value:"no_show",children:"No-show"})]})]})})]},s.id)})})]})})]})]})}export{ce as default};
