import{r as p,j as e}from"./vendor-radix-CDHcN1cP.js";import{h as qe,C as w,$ as b,a0 as S,ak as T,i as C,x as Oe,Z as E,B as l,_ as Ve,L as u,a9 as ae,al as Be,D as g,a6 as Qe,r as Ce,a4 as He,a7 as Ye,ad as Ae,F as De,a as M,b as O,c as V,d as B,e as j,ay as Ze,az as Ge,aA as Je,aB as We,f,R as o}from"./index-Dt6uKTGi.js";import{D as Xe,a as es,b as ss,c as as,d as ts,e as rs}from"./dialog-Bj2cYqgx.js";import{u as ns,a as D,c as is}from"./vendor-query-DyYoeD25.js";import{L as k}from"./vendor-react-D0zZO7ze.js";import{g as ls,a as cs}from"./supabase-client-documents-Bh14NKuG.js";import{S as ds}from"./search--cxoAvO3.js";import{C as te}from"./copy-BQyQHpRi.js";import{S as os}from"./square-pen-DClxkTk9.js";import{E as $}from"./external-link-DbqO2EaT.js";import{E as ms}from"./eye-MTBUaJjA.js";import{D as xs}from"./download-zFy5GEJo.js";import"./vendor-charts-DMFz3Lzq.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=qe("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=qe("UserCog",[["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m21.7 16.4-.9-.3",key:"12j9ji"}],["path",{d:"m15.2 13.9-.9-.3",key:"1fdjdi"}],["path",{d:"m16.6 18.7.3-.9",key:"heedtr"}],["path",{d:"m19.1 12.2.3-.9",key:"1af3ki"}],["path",{d:"m19.6 18.7-.4-1",key:"1x9vze"}],["path",{d:"m16.8 12.3-.4-1",key:"vqeiwj"}],["path",{d:"m14.3 16.6 1-.4",key:"1qlj63"}],["path",{d:"m20.7 13.8 1-.4",key:"1v5t8k"}]]),hs={primary:"Основной",consultant:"Консультант",temporary:"Временный"};function ps(m){if(!m)return null;const y=new Date(m),r=new Date;let h=r.getFullYear()-y.getFullYear();const L=r.getMonth()-y.getMonth();if((L<0||L===0&&r.getDate()<y.getDate())&&h--,h<1)return`${(r.getFullYear()-y.getFullYear())*12+(r.getMonth()-y.getMonth())} мес.`;const q=h%10,U=h%100;return U>=11&&U<=19?`${h} лет`:q===1?`${h} год`:q>=2&&q<=4?`${h} года`:`${h} лет`}const Le={emotion_regulation:"Регуляция эмоций",behavior:"Поведение",executive_functions:"Исполнительные функции",sensory_processing:"Сенсорная обработка",communication:"Коммуникация и речь",social_cognition:"Социальное познание",identity:"Самооценка",learning:"Обучение",motivation:"Мотивация",trauma:"Травматический опыт",emotional:"Эмоциональные симптомы",conduct:"Проблемы поведения",hyperactivity:"Гиперактивность",peer_problems:"Проблемы со сверстниками",prosocial:"Просоциальное поведение",total_difficulties:"Общие трудности",anxiety:"Тревожность",depression:"Депрессия",total_score:"Общий балл",family_stress:"Семейный стресс",partner_relationship:"Отношения с партнёром",coparenting:"Совместное воспитание"},js={checkup:"Чекап",parent:"Родитель",family:"Семья"},gs={typical:"bg-green-100 text-green-800",borderline:"bg-yellow-100 text-yellow-800",concerning:"bg-red-100 text-red-800"},fs={typical:"Норма",borderline:"Пограничный",concerning:"Требует внимания"},ys={payment_pending:"Ожидает оплаты",scheduled:"Запланирована",in_progress:"В процессе",completed:"Завершена",cancelled:"Отменена",no_show:"Неявка"},_s={payment_pending:"bg-amber-100 text-amber-800",scheduled:"bg-blue-100 text-blue-800",in_progress:"bg-purple-100 text-purple-800",completed:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800",no_show:"bg-gray-100 text-gray-800"};function zs(){var ce,de,oe,me,xe,ue,he,pe,je,ge,fe,ye,_e,Ne,ve,we,be,Se;const[m,y]=p.useState(""),[r,h]=p.useState(null),[L,q]=p.useState(null),[U,Q]=p.useState(!1),[H,P]=p.useState(!1),[K,Y]=p.useState(""),[A,Z]=p.useState("primary"),[re,G]=p.useState("active"),[ne,J]=p.useState(""),[n,ie]=p.useState(null),Re=ns(),{data:$e,isLoading:Ue}=D({queryKey:["support-recent-users"],queryFn:async()=>{const{data:s,error:a}=await o.from("users").select("id, email, phone, created_at").order("created_at",{ascending:!1}).limit(10);if(a)throw a;return s||[]}}),{data:ze,isLoading:Fe}=D({queryKey:["support-users",m],queryFn:async()=>{const{data:s}=await o.from("users").select("id, email, phone, created_at").or(`email.ilike.%${m}%,phone.ilike.%${m}%`).limit(10),{data:a}=await o.from("profiles").select("user_id, first_name, last_name").or(`first_name.ilike.%${m}%,last_name.ilike.%${m}%`).limit(10),d=[...new Set((a==null?void 0:a.map(c=>c.user_id))||[])];let i=[];if(d.length>0){const{data:c}=await o.from("users").select("id, email, phone, created_at").in("id",d);i=c||[]}const _=[...s||[],...i].filter((c,N,v)=>N===v.findIndex(Me=>Me.id===c.id)),I=new Map((a||[]).map(c=>[c.user_id,{first_name:c.first_name,last_name:c.last_name}]));return _.slice(0,10).map(c=>{var N,v;return{...c,profile_name:I.get(c.id)?`${((N=I.get(c.id))==null?void 0:N.first_name)||""} ${((v=I.get(c.id))==null?void 0:v.last_name)||""}`.trim():null}})},enabled:m.length>2}),z=m.length>2?ze:$e,le=m.length>2?Fe:Ue,{data:t}=D({queryKey:["support-user-data",r],queryFn:async()=>{if(!r)return null;const[s,a,d,i]=await Promise.allSettled([o.from("users").select("*").eq("id",r).single(),o.from("profiles").select("*").eq("user_id",r),o.from("assessments").select("*, profile:profiles!inner(user_id, first_name, last_name)").eq("profile.user_id",r).order("completed_at",{ascending:!1,nullsFirst:!1}).limit(20),o.from("appointments").select("*, appointment_type:appointment_types(id, name, duration_minutes, price)").eq("user_id",r).order("scheduled_at",{ascending:!1}).limit(20)]);return{user:s.status==="fulfilled"?s.value.data:null,profiles:a.status==="fulfilled"?a.value.data||[]:[],assessments:d.status==="fulfilled"?d.value.data||[]:[],appointments:i.status==="fulfilled"?i.value.data||[]:[]}},enabled:!!r}),{data:R,isLoading:Ie}=D({queryKey:["support-user-documents",r],queryFn:async()=>{if(!r)return[];const{data:s,error:a}=await o.from("client_documents").select("*").eq("client_user_id",r).is("deleted_at",null).order("created_at",{ascending:!1});if(a)throw a;return s||[]},enabled:!!r}),{data:x,isLoading:Te}=D({queryKey:["support-user-assignments",r],queryFn:async()=>{if(!r)return[];const{data:s,error:a}=await o.from("client_assignments").select(`
          *,
          specialist:specialists(id, display_name, specialization_codes),
          profile:profiles(id, first_name, last_name, type)
        `).eq("client_user_id",r).eq("status","active").order("assigned_at",{ascending:!1});if(a)throw a;return s||[]},enabled:!!r}),{data:W}=D({queryKey:["support-available-specialists"],queryFn:async()=>{const{data:s,error:a}=await o.from("specialists").select("id, display_name, specialization_codes, is_available, accepts_new_clients").eq("is_available",!0).order("display_name");if(a)throw a;return s||[]},enabled:H}),{data:X}=D({queryKey:["support-user-profiles",r],queryFn:async()=>{if(!r)return[];const{data:s,error:a}=await o.from("profiles").select("id, first_name, last_name, type").eq("user_id",r).order("type");if(a)throw a;return s||[]},enabled:H&&!!r}),ee=is({mutationFn:async({clientUserId:s,specialistId:a,assignmentType:d,assignmentStatus:i,profileId:F,oldAssignmentId:_})=>{var N;if(_){const{error:v}=await o.from("client_assignments").update({status:"completed",ended_at:new Date().toISOString()}).eq("id",_);if(v)throw v}const{data:I}=await o.auth.getUser(),{error:c}=await o.from("client_assignments").insert({client_user_id:s,specialist_id:a,assignment_type:d,profile_id:F||null,assigned_by:(N=I.user)==null?void 0:N.id,status:i,started_at:new Date().toISOString()});if(c)throw c},onSuccess:()=>{Re.invalidateQueries({queryKey:["support-user-assignments",r]}),f.success("Специалист назначен"),P(!1),Y(""),Z("primary"),G("active"),J("")},onError:s=>{f.error(`Ошибка: ${s.message}`)}}),Ee=()=>{if(!r||!K){f.error("Выберите специалиста");return}const s=x==null?void 0:x.find(a=>a.assignment_type==="primary");ee.mutate({clientUserId:r,specialistId:K,assignmentType:A,assignmentStatus:re,profileId:ne||void 0,oldAssignmentId:A==="primary"?s==null?void 0:s.id:void 0})},se=async(s,a)=>{try{await navigator.clipboard.writeText(s),q(a),f.success("Скопировано в буфер"),setTimeout(()=>q(null),2e3)}catch{f.error("Не удалось скопировать")}},Pe=async()=>{var s;if(!((s=t==null?void 0:t.user)!=null&&s.email)){f.error("У пользователя нет email");return}Q(!0);try{const{error:a}=await o.auth.resetPasswordForEmail(t.user.email,{redirectTo:`${window.location.origin}/reset-password`});if(a)throw a;f.success(`Ссылка для сброса пароля отправлена на ${t.user.email}`)}catch(a){f.error(`Ошибка: ${a.message}`)}finally{Q(!1)}},Ke=async(s,a)=>{try{const d=await cs(s),i=document.createElement("a");i.href=d,i.download=a,i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i)}catch(d){f.error(`Ошибка загрузки: ${d.message}`)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Инструменты поддержки"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Быстрый доступ к данным пользователей"})]}),e.jsxs(w,{children:[e.jsxs(b,{children:[e.jsx(S,{children:"Поиск пользователя"}),e.jsx(T,{children:"Найдите пользователя для просмотра его данных"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ds,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Oe,{placeholder:"Поиск по email, телефону или ФИО...",value:m,onChange:s=>y(s.target.value),className:"pl-10"})]}),le&&e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(E,{className:"h-4 w-4 animate-spin"})}),z&&z.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:m.length>2?"Результаты поиска":"Последние пользователи"}),z.map(s=>{const a=s.profile_name?`${s.profile_name} (${s.email||s.phone||s.id})`:s.email||s.phone||s.id;return e.jsxs(l,{variant:r===s.id?"default":"outline",className:"w-full justify-start",onClick:()=>h(s.id),children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"truncate",children:a})]},s.id)})]}),!le&&z&&z.length===0&&m.length>2&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Пользователи не найдены"})]})]}),t&&e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(w,{children:[e.jsx(b,{children:e.jsx(S,{children:"Информация о пользователе"})}),e.jsxs(C,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(u,{className:"text-xs text-muted-foreground",children:"Email"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"flex-1",children:((ce=t.user)==null?void 0:ce.email)||"—"}),((de=t.user)==null?void 0:de.email)&&e.jsx(l,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>se(t.user.email,"email"),children:L==="email"?e.jsx(ae,{className:"h-3 w-3 text-green-600"}):e.jsx(te,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-xs text-muted-foreground",children:"Телефон"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"flex-1",children:((oe=t.user)==null?void 0:oe.phone)||"—"}),((me=t.user)==null?void 0:me.phone)&&e.jsx(l,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>se(t.user.phone,"phone"),children:L==="phone"?e.jsx(ae,{className:"h-3 w-3 text-green-600"}):e.jsx(te,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-xs text-muted-foreground",children:"ID пользователя"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"flex-1 font-mono text-xs",children:((xe=t.user)==null?void 0:xe.id)||"—"}),((ue=t.user)==null?void 0:ue.id)&&e.jsx(l,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>se(t.user.id,"id"),children:L==="id"?e.jsx(ae,{className:"h-3 w-3 text-green-600"}):e.jsx(te,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-xs text-muted-foreground",children:"Регион"}),e.jsx("p",{children:((he=t.user)==null?void 0:he.region)||"—"})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-xs text-muted-foreground",children:"Роль"}),e.jsx("p",{children:((pe=t.user)==null?void 0:pe.role)||"user"})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-xs text-muted-foreground",children:"Дата регистрации"}),e.jsx("p",{children:(je=t.user)!=null&&je.created_at?new Date(t.user.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric"}):"—"})]}),e.jsxs("div",{className:"pt-3 border-t space-y-2",children:[e.jsx(u,{className:"text-xs text-muted-foreground",children:"Быстрые действия"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(k,{to:`/admin/users?search=${encodeURIComponent(((ge=t.user)==null?void 0:ge.email)||((fe=t.user)==null?void 0:fe.phone)||"")}`,children:e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx(os,{className:"h-3 w-3 mr-1"}),"Редактировать"]})}),((ye=t.user)==null?void 0:ye.email)&&e.jsxs(l,{variant:"outline",size:"sm",onClick:Pe,disabled:U,children:[U?e.jsx(E,{className:"h-3 w-3 mr-1 animate-spin"}):e.jsx(us,{className:"h-3 w-3 mr-1"}),"Сбросить пароль"]})]})]})]})]}),e.jsxs(w,{children:[e.jsx(b,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),"Профили (",t.profiles.length,")"]})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-2",children:[t.profiles.map(s=>{const a=ps(s.dob);return e.jsxs("div",{className:"p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"font-medium",children:[s.first_name," ",s.last_name||""]}),e.jsx(g,{variant:s.type==="parent"?"secondary":"default",children:s.type==="parent"?"Родитель":"Ребёнок"})]}),e.jsxs("div",{className:"flex gap-4 mt-1 text-sm text-muted-foreground",children:[a&&e.jsx("span",{children:a}),s.dob&&e.jsx("span",{children:new Date(s.dob).toLocaleDateString("ru-RU")})]})]},s.id)}),t.profiles.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет профилей"})]})})]}),e.jsxs(w,{className:"md:col-span-2",children:[e.jsxs(b,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-4 w-4"}),"Назначенные специалисты (",(x==null?void 0:x.length)||0,")"]}),e.jsx(T,{children:"Специалисты, работающие с клиентом"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{to:"/admin/assignments",children:e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Все назначения"]})}),e.jsxs(l,{variant:"default",size:"sm",onClick:()=>P(!0),children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),x&&x.length>0?"Переназначить":"Назначить"]})]})]}),e.jsx(C,{children:Te?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(E,{className:"h-4 w-4 animate-spin"})}):x&&x.length>0?e.jsx("div",{className:"space-y-2",children:x.map(s=>{var d,i,F;const a=s.profile?`${s.profile.first_name||""} ${s.profile.last_name||""}`.trim()+(s.profile.type==="child"?" (ребёнок)":s.profile.type==="parent"?" (родитель)":""):null;return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ke,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:((d=s.specialist)==null?void 0:d.display_name)||"Без имени"}),a&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Для: ",a]}),((F=(i=s.specialist)==null?void 0:i.specialization_codes)==null?void 0:F.length)>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:s.specialist.specialization_codes.map(_=>e.jsx(g,{variant:"outline",className:"text-xs",children:_},_))})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(g,{className:s.assignment_type==="primary"?"bg-blue-100 text-blue-800":s.assignment_type==="consultant"?"bg-purple-100 text-purple-800":"bg-gray-100 text-gray-800",children:hs[s.assignment_type]||s.assignment_type})})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mt-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Назначен: ",new Date(s.assigned_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"})]}),s.notes&&e.jsxs("span",{children:["Заметки: ",s.notes]})]})]},s.id)})}):e.jsx("p",{className:"text-sm text-muted-foreground",children:'Специалист не назначен. Нажмите "Назначить" для выбора специалиста.'})})]}),e.jsxs(w,{className:"md:col-span-2",children:[e.jsxs(b,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(S,{children:["Оценки (",t.assessments.length,")"]}),e.jsx(T,{children:"Отсортированы по дате завершения (новые сверху)"})]}),e.jsx(k,{to:"/admin/assessments",children:e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Все оценки"]})})]}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-3",children:[t.assessments.map(s=>{var a;return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",children:js[s.assessment_type]||s.assessment_type}),e.jsx(g,{variant:s.status==="completed"?"default":s.status==="abandoned"?"destructive":"secondary",children:s.status==="completed"?"Завершена":s.status==="in_progress"?"В процессе":s.status==="abandoned"?"Прервана":s.status}),s.is_paid&&e.jsxs(g,{className:"bg-green-100 text-green-800",children:[e.jsx(Ce,{className:"h-3 w-3 mr-1"}),"Оплачена"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[s.status==="completed"&&s.results_summary&&e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>ie(s),children:e.jsx(ms,{className:"h-4 w-4"})}),e.jsx(k,{to:`/admin/assessments?id=${s.id}`,children:e.jsx(l,{variant:"ghost",size:"sm",children:e.jsx($,{className:"h-4 w-4"})})})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 mt-2 text-sm text-muted-foreground",children:[((a=s.profile)==null?void 0:a.first_name)&&e.jsxs("span",{children:["Профиль: ",s.profile.first_name," ",s.profile.last_name||""]}),s.completed_at&&e.jsxs("span",{children:["Завершена: ",new Date(s.completed_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})]}),!s.completed_at&&s.created_at&&e.jsxs("span",{children:["Создана: ",new Date(s.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"})]})]})]},s.id)}),t.assessments.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет оценок"})]})})]}),e.jsxs(w,{className:"md:col-span-2",children:[e.jsxs(b,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(S,{children:["Консультации (",t.appointments.length,")"]}),e.jsx(T,{children:"Отсортированы по дате (новые сверху)"})]}),e.jsx(k,{to:"/admin/appointments",children:e.jsxs(l,{variant:"outline",size:"sm",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Все консультации"]})})]}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-3",children:[t.appointments.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm font-medium",children:[e.jsx(He,{className:"h-4 w-4"}),new Date(s.scheduled_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"}),e.jsx("span",{className:"text-muted-foreground ml-1",children:new Date(s.scheduled_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${_s[s.status]||"bg-gray-100 text-gray-800"}`,children:ys[s.status]||s.status})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.video_room_url&&!["completed","cancelled","no_show"].includes(s.status)&&e.jsx("a",{href:s.video_room_url,target:"_blank",rel:"noopener noreferrer",children:e.jsxs(l,{variant:"outline",size:"sm",className:"text-blue-600",children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Войти"]})}),e.jsx(k,{to:`/admin/appointments?id=${s.id}`,children:e.jsx(l,{variant:"ghost",size:"sm",children:e.jsx($,{className:"h-4 w-4"})})})]})]}),s.appointment_type&&e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-4 text-sm",children:[e.jsx("span",{className:"font-medium",children:s.appointment_type.name}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(Ae,{className:"h-3 w-3"}),s.appointment_type.duration_minutes," мин"]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(Ce,{className:"h-3 w-3"}),s.appointment_type.price===0?"Бесплатно":`${s.appointment_type.price.toLocaleString("ru-RU")} ₽`]})]}),s.notes&&e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium",children:"Заметки:"})," ",s.notes]})]},s.id)),t.appointments.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет консультаций"})]})})]}),e.jsxs(w,{className:"md:col-span-2",children:[e.jsxs(b,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(De,{className:"h-4 w-4"}),"Документы (",(R==null?void 0:R.length)||0,")"]}),e.jsx(T,{children:"Загруженные файлы клиента"})]}),e.jsx(C,{children:Ie?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(E,{className:"h-4 w-4 animate-spin"})}):R&&R.length>0?e.jsx("div",{className:"space-y-2",children:R.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[e.jsx(De,{className:"h-5 w-5 text-muted-foreground flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:s.file_name}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs text-muted-foreground",children:[e.jsx(g,{variant:"outline",className:"text-xs",children:ls(s.category)}),e.jsxs("span",{children:[(s.file_size_bytes/1024).toFixed(1)," KB"]}),e.jsx("span",{children:new Date(s.created_at).toLocaleDateString("ru-RU")})]}),s.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 truncate",children:s.description})]})]}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>Ke(s.file_path,s.file_name),children:e.jsx(xs,{className:"h-4 w-4"})})]},s.id))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет документов"})})]})]}),e.jsx(Xe,{open:H,onOpenChange:P,children:e.jsxs(es,{children:[e.jsxs(ss,{children:[e.jsx(as,{children:"Назначить специалиста"}),e.jsx(ts,{children:"Выберите специалиста и тип назначения для клиента"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Специалист"}),e.jsxs(M,{value:K,onValueChange:Y,children:[e.jsx(O,{children:e.jsx(V,{placeholder:"Выберите специалиста"})}),e.jsx(B,{children:W==null?void 0:W.map(s=>e.jsx(j,{value:s.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.display_name}),!s.accepts_new_clients&&e.jsx(g,{variant:"outline",className:"text-xs",children:"Не принимает"})]})},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Тип назначения"}),e.jsxs(M,{value:A,onValueChange:Z,children:[e.jsx(O,{children:e.jsx(V,{})}),e.jsxs(B,{children:[e.jsx(j,{value:"primary",children:"Основной специалист"}),e.jsx(j,{value:"consultant",children:"Консультант"}),e.jsx(j,{value:"temporary",children:"Временный"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'При выборе "Основной" предыдущий основной специалист будет заменён'})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Статус"}),e.jsxs(M,{value:re,onValueChange:G,children:[e.jsx(O,{children:e.jsx(V,{})}),e.jsxs(B,{children:[e.jsx(j,{value:"active",children:"Активно"}),e.jsx(j,{value:"paused",children:"Приостановлено"}),e.jsx(j,{value:"completed",children:"Завершено"}),e.jsx(j,{value:"cancelled",children:"Отменено"})]})]})]}),X&&X.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Профиль (член семьи)"}),e.jsxs(M,{value:ne||"none",onValueChange:s=>J(s==="none"?"":s),children:[e.jsx(O,{children:e.jsx(V,{placeholder:"Выберите профиль (опционально)"})}),e.jsxs(B,{children:[e.jsx(j,{value:"none",children:"Не указывать"}),X.map(s=>e.jsxs(j,{value:s.id,children:[s.first_name," ",s.last_name||"",s.type==="child"&&" (ребёнок)",s.type==="parent"&&" (родитель)",s.type==="partner"&&" (партнёр)"]},s.id))]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Укажите, с каким членом семьи будет работать специалист"})]})]}),e.jsxs(rs,{children:[e.jsx(l,{variant:"outline",onClick:()=>{P(!1),Y(""),Z("primary"),G("active"),J("")},children:"Отмена"}),e.jsx(l,{onClick:Ee,disabled:!K||ee.isPending,children:ee.isPending?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"h-4 w-4 mr-2 animate-spin"}),"Сохранение..."]}):"Назначить"})]})]})}),e.jsx(Ze,{open:!!n,onOpenChange:()=>ie(null),children:e.jsxs(Ge,{className:"w-[400px] sm:w-[500px] overflow-y-auto",children:[e.jsx(Je,{children:e.jsxs(We,{children:["Результаты ",(n==null?void 0:n.assessment_type)==="checkup"?"чекапа":(n==null?void 0:n.assessment_type)==="parent"?"оценки родителя":(n==null?void 0:n.assessment_type)==="family"?"семейной оценки":"оценки"]})}),n&&e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Профиль:"})," ",((_e=n.profile)==null?void 0:_e.first_name)||"—"," ",((Ne=n.profile)==null?void 0:Ne.last_name)||""]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Дата завершения:"})," ",n.completed_at?new Date(n.completed_at).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—"]}),((ve=n.results_summary)==null?void 0:ve.version)===2&&e.jsxs("p",{children:[e.jsx("strong",{children:"Версия:"})," v2 (10 шкал)"]}),((we=n.results_summary)==null?void 0:we.age_group)&&e.jsxs("p",{children:[e.jsx("strong",{children:"Возрастная группа:"})," ",n.results_summary.age_group==="preschool"?"Дошкольник (3-6)":n.results_summary.age_group==="elementary"?"Младший школьник (7-11)":n.results_summary.age_group==="teenager"?"Подросток (12-18)":n.results_summary.age_group]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Результаты по шкалам:"}),n.results_summary&&Object.entries(n.results_summary).filter(([s])=>Le[s]).map(([s,a])=>{const d=typeof a=="object"?a.score:a,i=typeof a=="object"?a.status:null;return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border bg-muted/30",children:[e.jsx("span",{className:"text-sm",children:Le[s]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-sm font-medium",children:d}),i&&e.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${gs[i]||""}`,children:fs[i]||i})]})]},s)})]}),((Se=(be=n.results_summary)==null?void 0:be.worry_tags)==null?void 0:Se.length)>0&&e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Теги беспокойства:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:n.results_summary.worry_tags.map((s,a)=>e.jsx(g,{variant:"outline",className:"text-xs",children:s},a))})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(k,{to:`/admin/assessments?id=${n.id}`,children:e.jsxs(l,{variant:"outline",className:"w-full",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Открыть в разделе Оценки"]})})})]})]})})]})}export{zs as default};
