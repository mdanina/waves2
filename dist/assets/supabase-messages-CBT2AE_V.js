import{w as i,p as w}from"./index-Bu4m9iDU.js";const x="__support__",I=25,$=["admin","super_admin","support"],k={super_admin:"Главный администратор",admin:"Администратор",support:"Поддержка"},G={super_admin:"Служба поддержки",admin:"Служба поддержки",support:"Служба поддержки"};async function L(a,s){if(s.length===0)return new Map;const e=new Map;for(const o of s)e.set(o,{lastMessage:null,unreadCount:0});const r=s.map(o=>`and(sender_id.eq.${a},recipient_id.eq.${o}),and(sender_id.eq.${o},recipient_id.eq.${a})`).join(","),[n,t]=await Promise.all([i.from("messages").select("*").or(r).order("created_at",{ascending:!1}).limit(s.length*2),i.from("messages").select("sender_id").eq("recipient_id",a).eq("is_read",!1).in("sender_id",s)]);for(const o of n.data||[]){const l=o.sender_id===a?o.recipient_id:o.sender_id,u=e.get(l);u&&!u.lastMessage&&(u.lastMessage=o)}for(const o of t.data||[]){const l=e.get(o.sender_id);l&&l.unreadCount++}return e}async function F(a){const{data:s,error:e}=await i.rpc("get_message_recipients",{p_user_ids:a});if(!e&&s)return s;w.warn("get_message_recipients RPC failed, using fallback:",e==null?void 0:e.message);const[{data:r},{data:n},{data:t}]=await Promise.all([i.from("users").select("id, email, role").in("id",a),i.from("profiles").select("user_id, first_name, last_name, type").in("user_id",a),i.from("specialists").select("user_id, display_name, avatar_url, specialization_codes").in("user_id",a)]);return a.map(o=>{const l=r==null?void 0:r.find(d=>d.id===o),u=(n==null?void 0:n.filter(d=>d.user_id===o))||[],_=u.find(d=>d.type==="parent")||u[0],c=t==null?void 0:t.find(d=>d.user_id===o);return{user_id:o,email:(l==null?void 0:l.email)||null,role:(l==null?void 0:l.role)||null,first_name:(_==null?void 0:_.first_name)||null,last_name:(_==null?void 0:_.last_name)||null,avatar_url:(c==null?void 0:c.avatar_url)||null,display_name:(c==null?void 0:c.display_name)||null,specialist_avatar:(c==null?void 0:c.avatar_url)||null,specialization_codes:(c==null?void 0:c.specialization_codes)||null}})}async function z(a,s){if(s.length===0)return[];const e=s.map(u=>u.id),[r,{data:n},t]=await Promise.all([F(e),i.from("specializations").select("code, name").eq("is_active",!0),L(a,e)]),o={};n==null||n.forEach(u=>{o[u.code]=u.name});const l=[];for(const u of s){const _=u.id,c=u.type,d=r.find(m=>String(m.user_id)===String(_));let y="Пользователь";d!=null&&d.display_name?y=d.display_name:d!=null&&d.first_name?y=d.first_name+(d.last_name?" "+d.last_name:""):c==="admin"&&(d!=null&&d.role)?y=G[d.role]||"Служба поддержки":d!=null&&d.email&&(y=d.email);let h;c==="specialist"&&(d!=null&&d.specialization_codes)&&(h=d.specialization_codes.map(m=>o[m]).filter(Boolean).slice(0,2).join(", ")||"Специалист");let p;c==="admin"&&(d!=null&&d.role)&&(p=k[d.role]||"Администратор");const M=t.get(_)||{lastMessage:null,unreadCount:0};l.push({recipientId:_,recipientName:y,recipientAvatar:(d==null?void 0:d.specialist_avatar)||(d==null?void 0:d.avatar_url)||null,recipientType:c,specialization:h,adminRole:p,lastMessage:M.lastMessage,unreadCount:M.unreadCount})}return l.sort((u,_)=>u.lastMessage&&_.lastMessage?_.lastMessage.created_at.localeCompare(u.lastMessage.created_at):u.lastMessage&&!_.lastMessage?-1:!u.lastMessage&&_.lastMessage?1:u.recipientName.localeCompare(_.recipientName)),l}async function D(a={}){const{page:s=1,pageSize:e=I}=a,{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");const{data:n,error:t}=await i.rpc("get_available_message_recipients");let o=[];if(!t&&n&&n.length>0)o=n.map(h=>({id:h.recipient_id,type:h.recipient_type}));else{t&&w.warn("get_available_message_recipients RPC failed, using fallback:",t.message);const{data:h}=await i.from("specialists").select("id").eq("user_id",r.id).single();if(h){const p=new Set,{data:M}=await i.from("client_assignments").select("client_user_id").eq("specialist_id",h.id).eq("status","active");M==null||M.forEach(E=>{o.push({id:E.client_user_id,type:"client"}),p.add(E.client_user_id)});const{data:m}=await i.from("specialists").select("user_id").eq("status","active").neq("user_id",r.id);m==null||m.forEach(E=>{p.has(E.user_id)||(o.push({id:E.user_id,type:"specialist"}),p.add(E.user_id))});const{data:f}=await i.from("users").select("id").in("role",$).neq("id",r.id);f==null||f.forEach(E=>{p.has(E.id)||o.push({id:E.id,type:"admin"})})}else{const p=new Set,{data:M}=await i.from("client_assignments").select("specialist:specialists!inner(user_id)").eq("client_user_id",r.id).eq("status","active");M==null||M.forEach(f=>{o.push({id:f.specialist.user_id,type:"specialist"}),p.add(f.specialist.user_id)});const{data:m}=await i.from("users").select("id").in("role",$);m==null||m.forEach(f=>{p.has(f.id)||o.push({id:f.id,type:"admin"})})}}const l=await z(r.id,o),u=l.length,_=Math.ceil(u/e),c=(s-1)*e,d=c+e;return{conversations:l.slice(c,d),totalCount:u,page:s,pageSize:e,totalPages:_}}async function X(a={}){const{page:s=1,pageSize:e=I}=a,{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");const{data:n}=await i.from("client_assignments").select("specialist:specialists!inner(user_id)").eq("client_user_id",r.id).eq("status","active"),t=[],o=new Set;n==null||n.forEach(f=>{o.has(f.specialist.user_id)||(t.push({id:f.specialist.user_id,type:"specialist"}),o.add(f.specialist.user_id))});const l=await z(r.id,t),u=l.length,_=Math.ceil(u/e),c=(s-1)*e,d=c+e,y=l.slice(c,d),{data:h}=await i.rpc("get_available_message_recipients"),p=(h==null?void 0:h.filter(f=>f.recipient_type==="admin").map(f=>f.recipient_id))||[],M=p.length>0;let m=null;if(M){const f=p.flatMap(C=>[`and(sender_id.eq.${r.id},recipient_id.eq.${C})`,`and(sender_id.eq.${C},recipient_id.eq.${r.id})`]).join(","),{data:E}=await i.from("messages").select("*").or(f).order("created_at",{ascending:!1}).limit(1),{count:g}=await i.from("messages").select("*",{count:"exact",head:!0}).eq("recipient_id",r.id).eq("is_read",!1).in("sender_id",p),S=E==null?void 0:E[0];(S||g&&g>0)&&(m={recipientId:x,recipientName:"Служба поддержки",recipientAvatar:null,recipientType:"admin",adminRole:"Поддержка",lastMessage:S||null,unreadCount:g||0})}return{support:m?[m]:[],specialists:y,hasNewSupportOption:M,specialistsTotalCount:u,specialistsPage:s,specialistsPageSize:e,specialistsTotalPages:_}}async function Z(a=50,s){const{data:{user:e}}=await i.auth.getUser();if(!e)throw new Error("Необходима авторизация");const{data:r}=await i.rpc("get_available_message_recipients"),n=(r==null?void 0:r.filter(c=>c.recipient_type==="admin").map(c=>c.recipient_id))||[];if(n.length===0)return[];const t=n.flatMap(c=>[`and(sender_id.eq.${e.id},recipient_id.eq.${c})`,`and(sender_id.eq.${c},recipient_id.eq.${e.id})`]).join(",");let o=i.from("messages").select("*").or(t).order("created_at",{ascending:!1}).limit(a);const{data:l,error:u}=await o;if(u)throw w.error("Error fetching support messages:",u),new Error(`Failed to fetch support messages: ${u.message}`);return(await A(l||[])).reverse()}async function V(a,s){const{data:{user:e}}=await i.auth.getUser();if(!e)throw new Error("Необходима авторизация");if(!a.trim()&&!s)throw new Error("Сообщение не может быть пустым");const{data:r,error:n}=await i.rpc("send_support_message",{p_content:a.trim(),p_attachment_url:(s==null?void 0:s.url)||null,p_attachment_name:(s==null?void 0:s.name)||null,p_attachment_type:(s==null?void 0:s.type)||null,p_attachment_size:(s==null?void 0:s.size)||null});if(n)throw w.error("Error sending support message:",n),new Error(`Failed to send support message: ${n.message}`);return r}async function Y(a,s,e){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");if(!s.trim()&&!e)throw new Error("Сообщение не может быть пустым");const{data:n,error:t}=await i.from("messages").insert({sender_id:r.id,recipient_id:a,content:s.trim(),is_support_message:!0,actual_sender_id:r.id,attachment_url:(e==null?void 0:e.url)||null,attachment_name:(e==null?void 0:e.name)||null,attachment_type:(e==null?void 0:e.type)||null,attachment_size:(e==null?void 0:e.size)||null}).select().single();if(t)throw w.error("Error sending support reply:",t),new Error(`Failed to send support reply: ${t.message}`);return n}async function H(){const{data:{user:a}}=await i.auth.getUser();if(!a)throw new Error("Необходима авторизация");const{data:s}=await i.from("users").select("id").in("role",$),e=(s==null?void 0:s.map(n=>n.id))||[];if(e.length===0)return;const{error:r}=await i.from("messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("recipient_id",a.id).eq("is_read",!1).in("sender_id",e);r&&w.error("Error marking support messages as read:",r)}async function J(a,s=50,e){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");const{data:n}=await i.from("users").select("id").in("role",$),t=(n==null?void 0:n.map(c=>c.id))||[];if(t.length===0)return[];let o=i.from("messages").select("*").eq("is_support_message",!0).or(`and(sender_id.eq.${a},recipient_id.in.(${t.join(",")})),and(sender_id.in.(${t.join(",")}),recipient_id.eq.${a})`).order("created_at",{ascending:!1}).limit(s);const{data:l,error:u}=await o;if(u)throw w.error("Error fetching admin support messages:",u),new Error(`Failed to fetch admin support messages: ${u.message}`);return(await A(l||[])).reverse()}async function K(a){const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Необходима авторизация");const{data:e}=await i.from("users").select("id").in("role",$),r=(e==null?void 0:e.map(t=>t.id))||[];if(r.length===0)return;const{error:n}=await i.from("messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("sender_id",a).eq("is_support_message",!0).eq("is_read",!1).in("recipient_id",r);n&&w.error("Error marking admin support messages as read:",n)}async function Q(a={}){const{page:s=1,pageSize:e=I}=a,{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");const n=[],t=new Set,{data:o}=await i.from("specialists").select("user_id").eq("status","active");o==null||o.forEach(g=>{g.user_id!==r.id&&(n.push({id:g.user_id,type:"specialist"}),t.add(g.user_id))});const{data:l}=await i.from("client_assignments").select("client_user_id").eq("status","active"),u=new Set;l==null||l.forEach(g=>{g.client_user_id!==r.id&&!t.has(g.client_user_id)&&u.add(g.client_user_id)});const{data:_}=await i.from("messages").select("sender_id, recipient_id").eq("is_support_message",!0),{data:c}=await i.from("users").select("id").in("role",$),d=new Set((c==null?void 0:c.map(g=>g.id))||[]);_==null||_.forEach(g=>{const S=d.has(g.sender_id)?g.recipient_id:g.sender_id;S&&!d.has(S)&&S!==r.id&&!t.has(S)&&u.add(S)}),u.forEach(g=>{n.push({id:g,type:"client"}),t.add(g)});const{data:y}=await i.from("users").select("id").in("role",$).neq("id",r.id);y==null||y.forEach(g=>{t.has(g.id)||(n.push({id:g.id,type:"admin"}),t.add(g.id))});const h=await z(r.id,n),p=h.length,M=Math.ceil(p/e),m=(s-1)*e,f=m+e;return{conversations:h.slice(m,f),totalCount:p,page:s,pageSize:e,totalPages:M}}const P=60*60*24;async function A(a){const s=a.filter(t=>t.attachment_url&&!t.attachment_url.startsWith("http")&&!t.attachment_url.startsWith("blob:")).map(t=>t.attachment_url);if(s.length===0)return a;const{data:e,error:r}=await i.storage.from("message-attachments").createSignedUrls(s,P);if(r)return w.error("Error creating signed URLs:",r),a;const n=new Map;return e==null||e.forEach(t=>{t.signedUrl&&n.set(t.path,t.signedUrl)}),a.map(t=>t.attachment_url&&n.has(t.attachment_url)?{...t,attachment_url:n.get(t.attachment_url)}:t)}async function ee(a,s=50,e){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");let n=i.from("messages").select("*").or(`and(sender_id.eq.${r.id},recipient_id.eq.${a}),and(sender_id.eq.${a},recipient_id.eq.${r.id})`).order("created_at",{ascending:!1}).limit(s);const{data:t,error:o}=await n;if(o)throw w.error("Error fetching messages:",o),new Error(`Failed to fetch messages: ${o.message}`);return(await A(t||[])).reverse()}async function se(a){if(!a.attachment_url||a.attachment_url.startsWith("http")||a.attachment_url.startsWith("blob:"))return a;const s=await O(a.attachment_url);return s?{...a,attachment_url:s}:a}async function O(a){const{data:s,error:e}=await i.storage.from("message-attachments").createSignedUrl(a,P);return e?(w.error("Error creating signed URL:",e),null):s.signedUrl}async function re(a,s){const{data:{user:e}}=await i.auth.getUser();if(!e)throw new Error("Необходима авторизация");const r=10*1024*1024;if(s.size>r)throw new Error("Файл слишком большой (максимум 10MB)");const n=s.name.split(".").pop()||"",t=`${Date.now()}-${Math.random().toString(36).substring(7)}.${n}`,o=`${e.id}/${a}/${t}`,{error:l}=await i.storage.from("message-attachments").upload(o,s);if(l)throw w.error("Error uploading attachment:",l),new Error(`Ошибка загрузки файла: ${l.message}`);return{url:o,name:s.name,type:s.type,size:s.size}}async function te(a,s,e){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");if(!s.trim()&&!e)throw new Error("Сообщение не может быть пустым");const{data:n,error:t}=await i.from("messages").insert({sender_id:r.id,recipient_id:a,content:s.trim(),attachment_url:(e==null?void 0:e.url)||null,attachment_name:(e==null?void 0:e.name)||null,attachment_type:(e==null?void 0:e.type)||null,attachment_size:(e==null?void 0:e.size)||null}).select().single();if(t)throw w.error("Error sending message:",t),new Error(`Failed to send message: ${t.message}`);return n}async function ae(a){const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Необходима авторизация");const{error:e}=await i.from("messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("sender_id",a).eq("recipient_id",s.id).eq("is_read",!1);e&&w.error("Error marking messages as read:",e)}async function ie(){const{data:{user:a}}=await i.auth.getUser();if(!a)return 0;const{count:s,error:e}=await i.from("messages").select("*",{count:"exact",head:!0}).eq("recipient_id",a.id).eq("is_read",!1);return e?(w.error("Error fetching unread count:",e),0):s||0}function ne(a,s){const e=i.channel(`messages:recipient_id=eq.${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`recipient_id=eq.${a}`},r=>{s(r.new)}).subscribe();return()=>{e.unsubscribe()}}function oe(a){const s=i.channel("admin-support-messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},e=>{const r=e.new;r.is_support_message===!0&&a(r)}).subscribe();return()=>{s.unsubscribe()}}async function de(a,s,e){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");const{data:n,error:t}=await i.from("chat_groups").insert({name:a,description:null,created_by:r.id}).select().single();if(t)throw w.error("Error creating chat group:",t),new Error(`Ошибка создания группы: ${t.message}`);const{error:o}=await i.rpc("add_group_members_safe",{p_group_id:n.id,p_member_ids:s,p_creator_id:r.id});if(o){w.error("Error adding group members:",o);try{await i.from("chat_groups").delete().eq("id",n.id)}catch(l){w.error("Error deleting orphaned group:",l)}throw new Error(`Ошибка добавления участников: ${o.message}`)}return n}function N(a,s,e){return r=>{const n=e==null?void 0:e.find(l=>l.user_id===r);if(n!=null&&n.display_name)return n.display_name;const t=s==null?void 0:s.find(l=>l.user_id===r);if(t!=null&&t.first_name)return t.first_name+(t.last_name?" "+t.last_name:"");const o=a==null?void 0:a.find(l=>l.id===r);return(o==null?void 0:o.email)||"Пользователь"}}function T(a,s){return e=>{const r=s==null?void 0:s.find(t=>t.user_id===e);if(r!=null&&r.avatar_url)return r.avatar_url;const n=a==null?void 0:a.find(t=>t.user_id===e);return(n==null?void 0:n.avatar_url)||null}}async function le(a={}){const{page:s=1,pageSize:e=I}=a,{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");const{data:n}=await i.from("chat_group_members").select("group_id").eq("user_id",r.id);if(!n||n.length===0)return{conversations:[],totalCount:0,page:s,pageSize:e,totalPages:0};const t=n.map(q=>q.group_id),{data:o}=await i.from("chat_group_members").select("*").in("group_id",t),l=[...new Set((o||[]).map(q=>q.user_id))],[{data:u},{data:_},{data:c},{data:d},{data:y},{data:h},{data:p}]=await Promise.all([i.from("chat_groups").select("*").in("id",t),i.from("users").select("id, email").in("id",l),i.from("profiles").select("user_id, first_name, last_name, avatar_url").in("user_id",l),i.from("specialists").select("user_id, display_name, avatar_url").in("user_id",l),i.from("group_messages").select("*").in("group_id",t).order("created_at",{ascending:!1}).limit(t.length*2),i.from("group_message_reads").select("*").eq("user_id",r.id).in("group_id",t),i.from("group_messages").select("id, group_id, sender_id, created_at").in("group_id",t).neq("sender_id",r.id)]),M=N(_,c,d),m=T(c,d),f=new Map;for(const q of t){const U=h==null?void 0:h.find(v=>v.group_id===q),b=(p||[]).filter(v=>v.group_id===q);let R=0;U!=null&&U.last_read_at?R=b.filter(v=>v.created_at>U.last_read_at).length:R=b.length,f.set(q,R)}const E=[];for(const q of u||[]){const U=(o||[]).filter(v=>v.group_id===q.id).map(v=>({...v,userName:M(v.user_id),userAvatar:m(v.user_id)})),b=y==null?void 0:y.find(v=>v.group_id===q.id),R=b?{...b,senderName:M(b.sender_id),senderAvatar:m(b.sender_id)}:null;E.push({group:q,members:U,lastMessage:R,unreadCount:f.get(q.id)||0})}E.sort((q,U)=>q.lastMessage&&U.lastMessage?U.lastMessage.created_at.localeCompare(q.lastMessage.created_at):q.lastMessage&&!U.lastMessage?-1:!q.lastMessage&&U.lastMessage?1:q.group.name.localeCompare(U.group.name));const g=E.length,S=Math.ceil(g/e),C=(s-1)*e,W=C+e;return{conversations:E.slice(C,W),totalCount:g,page:s,pageSize:e,totalPages:S}}async function ue(a,s=50,e){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");let n=i.from("group_messages").select("*").eq("group_id",a).order("created_at",{ascending:!1}).limit(s);const{data:t,error:o}=await n;if(o)throw w.error("Error fetching group messages:",o),new Error(`Ошибка загрузки сообщений: ${o.message}`);if(!t||t.length===0)return[];const l=[...new Set(t.map(p=>p.sender_id))],[{data:u},{data:_}]=await Promise.all([i.from("profiles").select("user_id, first_name, last_name, avatar_url").in("user_id",l),i.from("specialists").select("user_id, display_name, avatar_url").in("user_id",l)]),c=N(null,u,_),d=T(u,_),y=t.map(p=>({...p,senderName:c(p.sender_id),senderAvatar:d(p.sender_id)}));return(await A(y)).reverse()}async function ce(a,s,e){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Необходима авторизация");if(!s.trim()&&!e)throw new Error("Сообщение не может быть пустым");const{data:n,error:t}=await i.from("group_messages").insert({group_id:a,sender_id:r.id,content:s.trim(),attachment_url:(e==null?void 0:e.url)||null,attachment_name:(e==null?void 0:e.name)||null,attachment_type:(e==null?void 0:e.type)||null,attachment_size:(e==null?void 0:e.size)||null}).select().single();if(t)throw w.error("Error sending group message:",t),new Error(`Ошибка отправки сообщения: ${t.message}`);return n}async function _e(a,s){const{data:{user:e}}=await i.auth.getUser();if(!e)throw new Error("Необходима авторизация");const{error:r}=await i.from("group_message_reads").upsert({group_id:a,user_id:e.id,last_read_message_id:s,last_read_at:new Date().toISOString()},{onConflict:"group_id,user_id"});r&&w.error("Error marking group messages as read:",r)}function ge(a,s){const e=i.channel(`group_messages:group_id=eq.${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"group_messages",filter:`group_id=eq.${a}`},r=>{s(r.new)}).subscribe();return()=>{e.unsubscribe()}}export{I as D,x as S,Q as a,oe as b,le as c,ge as d,se as e,Y as f,ie as g,te as h,ue as i,_e as j,ce as k,de as l,ae as m,K as n,J as o,ee as p,O as q,D as r,ne as s,X as t,re as u,H as v,V as w,Z as x};
