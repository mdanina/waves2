const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/profileStorage-B9P4N8Co.js","assets/index-Bu4m9iDU.js","assets/vendor-radix-htwXsPHy.js","assets/vendor-charts-DjioKZbK.js","assets/vendor-query-BNGVDYIL.js","assets/vendor-react-CI8wve7f.js","assets/index-D06XXFa7.css"])))=>i.map(i=>d[i]);
import{ac as g,p as c,w as i}from"./index-Bu4m9iDU.js";async function P(s,t,e){try{const n=await A(s,t);if(n)return e&&n.total_steps!==e&&(await i.from("assessments").update({total_steps:e}).eq("id",n.id),n.total_steps=e),{id:n.id,assessment:n};const{getProfiles:u}=await g(async()=>{const{getProfiles:d}=await import("./profileStorage-B9P4N8Co.js");return{getProfiles:d}},__vite__mapDeps([0,1,2,3,4,5,6])),l=await u(),o=l.find(d=>d.id===s&&d.type==="child"),r=l.find(d=>d.type==="parent"),a=l.find(d=>d.type==="partner"),_={};if(o!=null&&o.worry_tags&&(_.child=o.worry_tags),r!=null&&r.worry_tags){const d=["Выгорание","Тревожность","Пониженное настроение","Трудности с концентрацией внимания","Общий стресс"],E=["Разделение/развод","Семейный стресс","Отношения с партнером","Психическое здоровье партнера","Воспитание","Семейный конфликт"];_.personal=r.worry_tags.filter(p=>d.includes(p)),_.family=r.worry_tags.filter(p=>E.includes(p))}a!=null&&a.worry_tags&&(_.family=a.worry_tags);const{data:w,error:m}=await i.from("assessments").insert({profile_id:s,assessment_type:t,status:"in_progress",current_step:1,total_steps:e||null,worry_tags:Object.keys(_).length>0?_:null}).select("*").single();if(m)throw c.error("Error creating assessment:",m),m;const{data:f}=await i.from("assessments").select("*").eq("profile_id",s).eq("assessment_type",t).eq("status","in_progress").order("created_at",{ascending:!0});if(!f||f.length===0)return{id:w.id,assessment:w};if(f.length===1)return{id:f[0].id,assessment:f[0]};const[h,...q]=f,y=q.map(d=>d.id);return c.warn(`Race condition detected: found ${f.length} in_progress assessments. Keeping earliest, deleting ${y.length} duplicates.`),await i.from("assessments").delete().in("id",y),{id:h.id,assessment:h}}catch(n){throw c.error("Error getting/creating assessment:",n),n}}async function A(s,t){try{const{data:e,error:n}=await i.from("assessments").select("*").eq("profile_id",s).eq("assessment_type",t).eq("status","in_progress").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(n)throw n;return e}catch(e){return c.error("Error getting active assessment:",e),null}}async function D(s,t){try{const{error:e}=await i.from("assessments").update({current_step:t,updated_at:new Date().toISOString()}).eq("id",s);if(e)throw e}catch(e){throw c.error("Error updating assessment step:",e),e}}async function b(s,t){try{const e={assessment_id:s,question_code:t.questionCode,question_id:t.questionId,category:t.category,value:t.value,answer_type:t.answerType||null,step_number:t.stepNumber},{error:n}=await i.from("answers").upsert(e,{onConflict:"assessment_id,question_id"}).select();if(n)throw n}catch(e){throw c.error("Error saving answer:",e),e}}async function k(s){try{const{data:t,error:e}=await i.from("answers").select("*").eq("assessment_id",s).order("question_id",{ascending:!0});if(e)throw e;return t||[]}catch(t){throw c.error("Error getting answers:",t),t}}async function x(s){try{const{data:t,error:e}=await i.rpc("complete_assessment",{assessment_uuid:s});if(e)throw e;return t}catch(t){throw c.error("Error completing assessment:",t),t}}async function O(s,t){try{const{data:e,error:n}=await i.from("assessments").select("*").eq("profile_id",s).eq("assessment_type",t).eq("status","completed").order("completed_at",{ascending:!1}).limit(1).maybeSingle();if(n)throw n;return e}catch(e){return c.error("Error getting completed assessment:",e),null}}async function R(s){try{const{data:t,error:e}=await i.rpc("complete_assessment",{assessment_uuid:s});if(e)throw e;return t}catch(t){return c.error("Error recalculating assessment results:",t),null}}async function v(s,t){if(s.length===0)return{};try{const{data:e,error:n}=await i.from("assessments").select("*").in("profile_id",s).eq("assessment_type",t).eq("status","completed").order("completed_at",{ascending:!1});if(n)throw n;const u=(e==null?void 0:e.reduce((o,r)=>{if(!r.profile_id)return o;const a=o[r.profile_id];return(!a||!a.completed_at&&r.completed_at||a.completed_at&&r.completed_at&&new Date(r.completed_at)>new Date(a.completed_at))&&(o[r.profile_id]=r),o},{}))||{},l={};for(const o of s)l[o]=u[o]||null;return l}catch(e){throw c.error("Error getting assessments for profiles:",e),e}}async function W(s,t){if(s.length===0)return{};try{const{data:e,error:n}=await i.from("assessments").select("*").in("profile_id",s).eq("assessment_type",t).eq("status","in_progress").order("created_at",{ascending:!1});if(n)throw n;const u=(e==null?void 0:e.reduce((o,r)=>{if(!r.profile_id)return o;const a=o[r.profile_id];return(!a||!a.created_at&&r.created_at||a.created_at&&r.created_at&&new Date(r.created_at)>new Date(a.created_at))&&(o[r.profile_id]=r),o},{}))||{},l={};for(const o of s)l[o]=u[o]||null;return l}catch(e){throw c.error("Error getting active assessments for profiles:",e),e}}async function F(){try{const{getCurrentUser:s,getProfiles:t}=await g(async()=>{const{getCurrentUser:r,getProfiles:a}=await import("./profileStorage-B9P4N8Co.js");return{getCurrentUser:r,getProfiles:a}},__vite__mapDeps([0,1,2,3,4,5,6]));if(!await s())throw new Error("User not authenticated");const u=(await t()).map(r=>r.id);if(u.length===0)return[];const{data:l,error:o}=await i.from("assessments").select("*").in("profile_id",u).order("created_at",{ascending:!1});if(o)throw o;return l||[]}catch(s){throw c.error("Error getting all assessments for user:",s),s}}async function I(s){try{const{getProfiles:t}=await g(async()=>{const{getProfiles:r}=await import("./profileStorage-B9P4N8Co.js");return{getProfiles:r}},__vite__mapDeps([0,1,2,3,4,5,6])),n=(await t()).filter(r=>r.type==="child"&&r.id!==s);if(n.length===0)return null;const u=n.map(r=>r.id),l=await v(u,"checkup");return n.find(r=>{const a=l[r.id];return!a||a.status!=="completed"})||null}catch(t){return c.error("Error finding next child without checkup:",t),null}}export{k as a,O as b,x as c,F as d,v as e,I as f,P as g,W as h,R as r,b as s,D as u};
