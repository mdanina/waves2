import{r as o,j as e}from"./vendor-radix-J7BmBqsC.js";import{L as te}from"./vendor-react-CI1J5nwZ.js";import{g as ne,aL as ae,N as le,C as h,R as _,h as T,T as F,Y as G,y as ie,a0 as W,t as I,r as re,a as ce,b as oe,c as de,d as me,e as j,V as xe,X as ue,a9 as he,F as je,aM as V,B as pe,x as X}from"./index-CsvxaYtI.js";import{S as $}from"./skeleton-CX4qEpye.js";import{T as fe,a as ge,b as Y,c as p,d as Ne,e as f}from"./table-C7dNPMty.js";import{T as _e,a as ve,b as H,c as we}from"./tabs-CT8W70EM.js";import{P as be,a as ye,b as A,c as Ce,d as R,e as Se}from"./pagination-ZMu3Im2J.js";import{h as Te,g as Ae,a as ke,i as Le,b as Pe}from"./client-utils-BLj6ZS6T.js";import{S as Ie}from"./search-CJS3ZstJ.js";import"./vendor-charts-CkgrveCd.js";import"./vendor-query-Bb981xLV.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=ne("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]),k=20;function Ge(){const{specialistUser:M}=ae(),D=M==null?void 0:M.specialist,{toast:Q}=le(),[v,Z]=o.useState(""),[L,J]=o.useState("all"),[w,K]=o.useState("upcoming"),[b,O]=o.useState([]),[U,q]=o.useState(!0),[l,g]=o.useState(1),[E,ee]=o.useState(0),i=Math.ceil(E/k);o.useEffect(()=>{if(!D)return;let s=!1;return(async()=>{try{q(!0);const t=(l-1)*k,m=t+k-1,{data:x,error:d,count:u}=await X.from("appointments").select(`
            id,
            user_id,
            scheduled_at,
            status,
            notes,
            transcript,
            transcript_status,
            started_at,
            ended_at,
            duration_seconds,
            appointment_type:appointment_types (name, duration_minutes),
            profile:profiles (first_name, last_name),
            client_user:users!appointments_user_id_fkey (email, phone)
          `,{count:"exact"}).eq("specialist_id",D.id).order("scheduled_at",{ascending:!1}).range(t,m);if(s)return;if(d)throw d;ee(u||0);const n=x||[];let a;if(n.length>0)try{const N=n.map(C=>C.id),{data:P,error:z}=await X.rpc("get_appointments_content_counts",{p_appointment_ids:N});if(s)return;if(z)console.warn("Batch counts function not available:",z.message),a=n.map(C=>({...C,recordings_count:0,notes_count:0,clinical_notes_count:0}));else{const C=new Map((P||[]).map(S=>[S.appointment_id,S]));a=n.map(S=>{const c=C.get(S.id);return{...S,recordings_count:(c==null?void 0:c.recordings_count)||0,notes_count:(c==null?void 0:c.notes_count)||0,clinical_notes_count:(c==null?void 0:c.clinical_notes_count)||0}})}}catch{if(s)return;a=n.map(N=>({...N,recordings_count:0,notes_count:0,clinical_notes_count:0}))}else a=[];if(s)return;O(a)}catch(t){if(s)return;console.error("Error loading appointments:",t),Q({title:"Ошибка",description:"Не удалось загрузить консультации",variant:"destructive"})}finally{s||q(!1)}})(),()=>{s=!0}},[D,l,Q]),o.useEffect(()=>{g(1)},[w,L,v]);const B=b.filter(s=>{var u,n,a,N,P;const t=(s.profile?`${s.profile.first_name} ${s.profile.last_name||""}`:((u=s.client_user)==null?void 0:u.email)||"").toLowerCase().includes(v.toLowerCase())||((a=(n=s.client_user)==null?void 0:n.email)==null?void 0:a.toLowerCase().includes(v.toLowerCase()))||((P=(N=s.client_user)==null?void 0:N.phone)==null?void 0:P.includes(v)),m=L==="all"||s.status===L,x=new Date,d=new Date(s.scheduled_at);return w==="upcoming"?t&&m&&d>=x&&s.status==="scheduled":w==="past"?t&&m&&(d<x||s.status==="completed"):t&&m}),se=s=>{const r=Pe(s);return e.jsx(I,{variant:r.variant,className:r.className,children:r.label})},y={upcoming:b.filter(s=>s.status==="scheduled"&&new Date(s.scheduled_at)>=new Date).length,completed:b.filter(s=>s.status==="completed").length,total:b.length};return U?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Сессии"}),e.jsx("p",{className:"text-muted-foreground",children:"Загрузка..."})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:[1,2,3].map(s=>e.jsxs(h,{children:[e.jsx(_,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:e.jsx($,{className:"h-4 w-24"})}),e.jsx(T,{children:e.jsx($,{className:"h-8 w-12"})})]},s))}),e.jsx(h,{children:e.jsx(_,{children:e.jsx($,{className:"h-10 w-full"})})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Сессии"}),e.jsx("p",{className:"text-muted-foreground",children:"История и управление консультациями"})]})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(h,{children:[e.jsxs(_,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:"Предстоящие"}),e.jsx(G,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{children:e.jsx("div",{className:"text-2xl font-bold",children:y.upcoming})})]}),e.jsxs(h,{children:[e.jsxs(_,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:"Проведено"}),e.jsx(ie,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{children:e.jsx("div",{className:"text-2xl font-bold",children:y.completed})})]}),e.jsxs(h,{children:[e.jsxs(_,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:"Всего сессий"}),e.jsx(W,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{children:e.jsx("div",{className:"text-2xl font-bold",children:y.total})})]})]}),e.jsx(h,{children:e.jsx(_,{children:e.jsxs(_e,{value:w,onValueChange:K,className:"w-full",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs(ve,{children:[e.jsxs(H,{value:"upcoming",children:["Предстоящие",y.upcoming>0&&e.jsx(I,{variant:"secondary",className:"ml-2",children:y.upcoming})]}),e.jsx(H,{value:"past",children:"Прошедшие"}),e.jsx(H,{value:"all",children:"Все"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative w-64",children:[e.jsx(Ie,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(re,{placeholder:"Поиск по клиенту...",value:v,onChange:s=>Z(s.target.value),className:"pl-10"})]}),e.jsxs(ce,{value:L,onValueChange:s=>J(s),children:[e.jsxs(oe,{className:"w-40",children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),e.jsx(de,{placeholder:"Статус"})]}),e.jsxs(me,{children:[e.jsx(j,{value:"all",children:"Все статусы"}),e.jsx(j,{value:"payment_pending",children:"Ожидает оплаты"}),e.jsx(j,{value:"scheduled",children:"Запланировано"}),e.jsx(j,{value:"in_progress",children:"Идёт"}),e.jsx(j,{value:"completed",children:"Завершено"}),e.jsx(j,{value:"cancelled",children:"Отменено"}),e.jsx(j,{value:"no_show",children:"Не явился"})]})]})]})]}),e.jsxs(we,{value:w,className:"mt-6",children:[b.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(W,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Пока нет сессий"}),e.jsx("p",{className:"text-sm mt-1",children:"Сессии появятся когда координатор назначит вам клиентов"})]}):B.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsx("p",{children:"Сессии не найдены по заданным фильтрам"})}):e.jsxs(fe,{children:[e.jsx(ge,{children:e.jsxs(Y,{children:[e.jsx(p,{children:"Клиент"}),e.jsx(p,{children:"Дата и время"}),e.jsx(p,{children:"Тип"}),e.jsx(p,{children:"Статус"}),e.jsx(p,{children:"Длительность"}),e.jsx(p,{children:"Материалы"}),e.jsx(p,{className:"text-right",children:"Действия"})]})}),e.jsx(Ne,{children:B.map(s=>{var x,d,u,n,a;const{date:r,time:t}=Te(s.scheduled_at),m=(s.recordings_count||0)>0||(s.notes_count||0)>0||(s.clinical_notes_count||0)>0||!!s.transcript;return e.jsxs(Y,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xe,{children:e.jsx(ue,{children:Ae(s.profile,(x=s.client_user)==null?void 0:x.email)})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:ke(s.profile,(d=s.client_user)==null?void 0:d.email)}),((u=s.client_user)==null?void 0:u.phone)&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.client_user.phone})]})]})}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:r}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t})]})]})}),e.jsx(f,{children:e.jsx("span",{className:"text-sm",children:((n=s.appointment_type)==null?void 0:n.name)||"—"})}),e.jsx(f,{children:se(s.status)}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(he,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:s.duration_seconds?Le(s.duration_seconds):(a=s.appointment_type)!=null&&a.duration_minutes?`${s.appointment_type.duration_minutes} мин`:"—"})]})}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[s.transcript&&e.jsxs(I,{variant:"outline",className:"text-xs",children:[e.jsx(je,{className:"h-3 w-3 mr-1"}),"Транскрипт"]}),(s.clinical_notes_count||0)>0&&e.jsxs(I,{variant:"outline",className:"text-xs text-purple-600 border-purple-200",children:[e.jsx(V,{className:"h-3 w-3 mr-1"}),"AI-заметки"]}),!m&&e.jsx("span",{className:"text-muted-foreground text-sm",children:"—"})]})}),e.jsx(f,{className:"text-right",children:e.jsx(pe,{size:"sm",variant:"outline",asChild:!0,children:e.jsxs(te,{to:`/specialist/sessions/${s.id}`,children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"Анализ"]})})})]},s.id)})})]}),i>1&&B.length>0&&e.jsxs("div",{className:"mt-6 flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Показано ",(l-1)*k+1,"–",Math.min(l*k,E)," из ",E]}),e.jsx(be,{children:e.jsxs(ye,{children:[e.jsx(A,{children:e.jsx(Ce,{onClick:()=>g(s=>Math.max(1,s-1)),className:l===1?"pointer-events-none opacity-50":"cursor-pointer"})}),l>2&&e.jsx(A,{children:e.jsx(R,{onClick:()=>g(1),className:"cursor-pointer",children:"1"})}),Array.from({length:Math.min(3,i)},(s,r)=>{const t=Math.max(1,Math.min(l-1+r,i-2+r));return t<1||t>i?null:e.jsx(A,{children:e.jsx(R,{isActive:t===l,onClick:()=>g(t),className:"cursor-pointer",children:t})},t)}),l<i-1&&i>3&&e.jsx(A,{children:e.jsx(R,{onClick:()=>g(i),className:"cursor-pointer",children:i})}),e.jsx(A,{children:e.jsx(Se,{onClick:()=>g(s=>Math.min(i,s+1)),className:l===i?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]})]})]})})}),e.jsx(h,{className:"bg-lavender-pale border-lavender",children:e.jsx(T,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"p-2 bg-lavender-light rounded-lg",children:e.jsx(V,{className:"h-5 w-5 text-secondary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-foreground",children:"AI-анализ сессий"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:'Нажмите "Анализ" чтобы открыть 2-колоночный интерфейс для работы с транскриптом, заметками и создания AI-генерированных клинических заметок.'})]})]})})})]})}export{Ge as default};
