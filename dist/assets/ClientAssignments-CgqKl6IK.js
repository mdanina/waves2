import{r as d,j as e}from"./vendor-radix-J7BmBqsC.js";import{g as gs,f as O,x as D,u as ys,E as xe,G as he,J as me,$ as ue,a5 as Oe,a1 as pe,A as Je,p as Ue,B as g,K as Ns,L as C,r as Fe,O as Ae,Q as rs,a as H,b as B,c as Q,d as V,e as w,i as vs,Y as xs,a9 as hs,aA as ws,m as bs,_ as Cs,C as Z,R as G,T as J,h as U,ag as Ee,y as cs,t as k,af as De,aB as Ss,a6 as ks,a2 as We,a3 as Xe,at as Ts,au as As,av as Es,aw as Ds,aC as $s}from"./index-CsvxaYtI.js";import{T as Ls,a as Ps,b as $e,c as Le}from"./tabs-CT8W70EM.js";import{T as Pe,a as Ie,b as W,c as _,d as Me,e as f}from"./table-C7dNPMty.js";import{S as oe}from"./skeleton-CX4qEpye.js";import{b as X,u as is,c as ze}from"./vendor-query-Bb981xLV.js";import{S as Is}from"./switch-CChs6D0W.js";import{C as Ms}from"./calendar-CkYc6SnW.js";import{P as Os,a as qs,b as Fs}from"./popover-DrT-WKCR.js";import{L as ds}from"./link-2-CADKPG0I.js";import{C as zs}from"./copy-BIipb-ws.js";import{S as ts}from"./search-CJS3ZstJ.js";import{M as es}from"./map-pin-sRA3SeWw.js";import{j as ss,f as qe,N as Rs,O as Ks}from"./vendor-date-CR4liJ_d.js";import{r as ns}from"./ru-DXu8W4Lf.js";import{S as Hs}from"./square-pen-CbHu4rZl.js";import{E as Bs}from"./eye-PA3INOij.js";import{B as Qs}from"./briefcase-sH88EsxI.js";import"./vendor-charts-CkgrveCd.js";import"./vendor-react-CI1J5nwZ.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=gs("ArrowLeftRight",[["path",{d:"M8 3 4 7l4 4",key:"9rb6wj"}],["path",{d:"M4 7h16",key:"6tx8e3"}],["path",{d:"m16 21 4-4-4-4",key:"siv7j2"}],["path",{d:"M20 17H4",key:"h6l3hr"}]]);function Vs(){return X({queryKey:["coordinator-unassigned-appointments"],queryFn:async()=>{const{data:r,error:x}=await D.from("appointments").select(`
          id,
          user_id,
          profile_id,
          scheduled_at,
          status,
          notes,
          created_at,
          appointment_type:appointment_types(name),
          user:users!appointments_user_id_fkey(email, phone),
          profile:profiles(first_name, last_name, type)
        `).is("specialist_id",null).in("status",["pending_specialist","scheduled","in_progress"]).order("scheduled_at",{ascending:!0});if(x)throw x;return(r||[]).map(t=>{var c,i,o,l,n,S;return{id:t.id,user_id:t.user_id,profile_id:t.profile_id,scheduled_at:t.scheduled_at,status:t.status,notes:t.notes,created_at:t.created_at,appointment_type_name:((c=t.appointment_type)==null?void 0:c.name)||null,user_email:((i=t.user)==null?void 0:i.email)||null,user_phone:((o=t.user)==null?void 0:o.phone)||null,profile_first_name:((l=t.profile)==null?void 0:l.first_name)||null,profile_last_name:((n=t.profile)==null?void 0:n.last_name)||null,profile_type:((S=t.profile)==null?void 0:S.type)||null}})},staleTime:30*1e3})}function Ys(){return X({queryKey:["coordinator-available-specialists"],queryFn:async()=>{const{data:r,error:x}=await D.from("specialists").select("*").eq("is_available",!0).order("display_name");if(x)throw x;const t=(r||[]).map(l=>l.id),{data:c,error:i}=await D.from("client_assignments").select("specialist_id").in("specialist_id",t).eq("status","active");if(i)throw i;const o={};return(c||[]).forEach(l=>{o[l.specialist_id]=(o[l.specialist_id]||0)+1}),(r||[]).map(l=>({id:l.id,user_id:l.user_id,display_name:l.display_name,specialization_codes:l.specialization_codes||[],is_available:l.is_available,accepts_new_clients:l.accepts_new_clients,current_clients_count:o[l.id]||0,max_clients:l.max_clients||50}))},staleTime:60*1e3})}function Zs(){const r=is();return ze({mutationFn:async({appointmentId:x,clientUserId:t,specialistId:c,profileId:i,assignmentType:o="primary",notes:l})=>{var q,E;let n=D.from("client_assignments").select("id").eq("client_user_id",t).eq("specialist_id",c).eq("status","active");i?n=n.eq("profile_id",i):n=n.is("profile_id",null);const{data:S}=await n.maybeSingle();if(!S){const{data:P}=await D.auth.getUser(),{error:u}=await D.from("client_assignments").insert({client_user_id:t,specialist_id:c,profile_id:i||null,assignment_type:o,assigned_by:(q=P.user)==null?void 0:q.id,status:"active",notes:l||null,started_at:new Date().toISOString()});if(u)throw u}const{data:T}=await D.auth.getUser(),{error:A}=await D.rpc("assign_specialist_to_appointment",{p_appointment_id:x,p_specialist_id:c,p_assigned_by:((E=T.user)==null?void 0:E.id)||null});if(A)throw A;return{success:!0}},onSuccess:()=>{r.invalidateQueries({queryKey:["coordinator-unassigned-appointments"]}),r.invalidateQueries({queryKey:["coordinator-available-specialists"]}),r.invalidateQueries({queryKey:["coordinator-all-assignments"]}),O.success("Клиент успешно назначен специалисту")},onError:x=>{O.error(`Ошибка назначения: ${x.message}`)}})}function Gs(){return X({queryKey:["coordinator-all-assignments"],queryFn:async()=>{const{data:r,error:x}=await D.from("client_assignments").select(`
          *,
          client:users!client_assignments_client_user_id_fkey(
            email,
            client_profile:profiles(first_name, last_name)
          ),
          profile:profiles!client_assignments_profile_id_fkey(first_name, last_name, type),
          specialist:specialists!client_assignments_specialist_id_fkey(display_name, specialization_codes)
        `).order("assigned_at",{ascending:!1});if(x)throw x;return(r||[]).map(t=>{var i,o,l,n,S,T,A,q,E;const c=((o=(i=t.client)==null?void 0:i.client_profile)==null?void 0:o[0])||((l=t.client)==null?void 0:l.client_profile);return{id:t.id,client_user_id:t.client_user_id,specialist_id:t.specialist_id,profile_id:t.profile_id,assignment_type:t.assignment_type,status:t.status,assigned_at:t.assigned_at,notes:t.notes,client_email:((n=t.client)==null?void 0:n.email)||null,client_first_name:(c==null?void 0:c.first_name)||null,client_last_name:(c==null?void 0:c.last_name)||null,profile_first_name:((S=t.profile)==null?void 0:S.first_name)||null,profile_last_name:((T=t.profile)==null?void 0:T.last_name)||null,profile_type:((A=t.profile)==null?void 0:A.type)||null,specialist_name:((q=t.specialist)==null?void 0:q.display_name)||null,specialist_specializations:((E=t.specialist)==null?void 0:E.specialization_codes)||[]}})},staleTime:30*1e3})}function Js(){const r=is();return ze({mutationFn:async({id:x,assignment_type:t,status:c,notes:i})=>{const o={};t!==void 0&&(o.assignment_type=t),c!==void 0&&(o.status=c),i!==void 0&&(o.notes=i);const{error:l}=await D.from("client_assignments").update(o).eq("id",x);if(l)throw l},onSuccess:()=>{r.invalidateQueries({queryKey:["coordinator-all-assignments"]}),r.invalidateQueries({queryKey:["coordinator-available-specialists"]}),O.success("Назначение обновлено")},onError:x=>{O.error(`Ошибка обновления: ${x.message}`)}})}function Us(){return X({queryKey:["admin-change-requests"],queryFn:async()=>{const{data:r,error:x}=await D.from("specialist_change_requests").select(`
          *,
          client:users!specialist_change_requests_client_user_id_fkey(
            email,
            profile:profiles(first_name, last_name)
          ),
          current_specialist:specialists!specialist_change_requests_current_specialist_id_fkey(display_name),
          new_specialist:specialists!specialist_change_requests_new_specialist_id_fkey(display_name)
        `).order("created_at",{ascending:!1});if(x)throw x;return(r||[]).map(t=>{var i,o,l,n,S,T;const c=((o=(i=t.client)==null?void 0:i.profile)==null?void 0:o[0])||((l=t.client)==null?void 0:l.profile);return{id:t.id,client_user_id:t.client_user_id,current_specialist_id:t.current_specialist_id,new_specialist_id:t.new_specialist_id,reason:t.reason,status:t.status,processed_by:t.processed_by,processed_at:t.processed_at,coordinator_notes:t.coordinator_notes,created_at:t.created_at,updated_at:t.updated_at,client_email:((n=t.client)==null?void 0:n.email)||null,client_first_name:(c==null?void 0:c.first_name)||null,client_last_name:(c==null?void 0:c.last_name)||null,current_specialist_name:((S=t.current_specialist)==null?void 0:S.display_name)||null,new_specialist_name:((T=t.new_specialist)==null?void 0:T.display_name)||null}})},staleTime:30*1e3})}function Ws(){const r=is();return ze({mutationFn:async({requestId:x,newSpecialistId:t,status:c,notes:i})=>{const{data:o,error:l}=await D.rpc("process_specialist_change_request",{p_request_id:x,p_new_specialist_id:t,p_status:c,p_notes:i||null});if(l)throw l;return o},onSuccess:(x,t)=>{r.invalidateQueries({queryKey:["admin-change-requests"]}),r.invalidateQueries({queryKey:["coordinator-all-assignments"]}),r.invalidateQueries({queryKey:["coordinator-available-specialists"]}),t.status==="approved"?O.success("Запрос одобрен, специалист изменён"):O.success("Запрос отклонён")},onError:x=>{O.error(`Ошибка обработки запроса: ${x.message}`)}})}const Xs={"Первичная встреча":["coordinator"],"Повторная встреча с координатором":["coordinator"],"Детский психолог":["child_psychologist","psychologist","clinical_psychologist"],Нейропсихолог:["neuropsychologist"],Психиатр:["psychiatrist"],Невролог:["neurologist"],"Семейный психолог":["family_therapist","psychologist"],Логопед:["logopedist"]},ea="Повторная встреча с координатором",sa={Москва:"Europe/Moscow","Санкт-Петербург":"Europe/Moscow",Казань:"Europe/Moscow","Нижний Новгород":"Europe/Moscow","Ростов-на-Дону":"Europe/Moscow",Воронеж:"Europe/Moscow",Волгоград:"Europe/Moscow",Самара:"Europe/Samara",Екатеринбург:"Asia/Yekaterinburg",Челябинск:"Asia/Yekaterinburg",Уфа:"Asia/Yekaterinburg",Пермь:"Asia/Yekaterinburg",Омск:"Asia/Omsk",Новосибирск:"Asia/Krasnoyarsk",Красноярск:"Asia/Krasnoyarsk"};function aa(){return""}const as=aa();function ta({open:r,onOpenChange:x,specialists:t,onSuccess:c}){const{session:i}=ys(),[o,l]=d.useState(""),[n,S]=d.useState(null),[T,A]=d.useState(""),[q,E]=d.useState(""),[P,u]=d.useState(""),[b,ne]=d.useState(new Date),[I,je]=d.useState("10:00"),[F,ee]=d.useState(!0),[$,z]=d.useState(null),fe=d.useCallback(async a=>{if(!(i!=null&&i.access_token)||a.length<2)return[];const h=await fetch(`${as}/api/admin/users/search?q=${encodeURIComponent(a)}`,{headers:{Authorization:`Bearer ${i.access_token}`}});if(!h.ok)throw new Error("Failed to search users");return(await h.json()).users||[]},[i==null?void 0:i.access_token]),{data:Y,isLoading:se}=X({queryKey:["admin-user-search",o],queryFn:()=>fe(o),enabled:o.length>=2&&!n,staleTime:3e4}),{data:N,isLoading:ie}=X({queryKey:["admin-user-profiles",n==null?void 0:n.id],queryFn:async()=>{if(!(i!=null&&i.access_token)||!(n!=null&&n.id))return[];const a=await fetch(`${as}/api/admin/users/${n.id}/profiles`,{headers:{Authorization:`Bearer ${i.access_token}`}});if(!a.ok)throw new Error("Failed to fetch profiles");return(await a.json()).profiles||[]},enabled:!!(n!=null&&n.id)}),{data:p,isLoading:ge}=X({queryKey:["appointment-types"],queryFn:async()=>{const{data:a,error:h}=await D.from("appointment_types").select("*").eq("is_active",!0).order("price",{ascending:!0});if(h)throw h;return a||[]},enabled:r}),{data:L}=X({queryKey:["client-coordinator",n==null?void 0:n.id],queryFn:async()=>{if(!(n!=null&&n.id))return null;const{data:a,error:h}=await D.from("client_assignments").select(`
          specialist_id,
          specialists!inner (
            id,
            specialization_codes
          )
        `).eq("client_user_id",n.id).eq("status","active").limit(10);if(h)return console.error("Error fetching client coordinator:",h),null;const j=a==null?void 0:a.find(M=>{var Ce,Se;return(Se=(Ce=M.specialists)==null?void 0:Ce.specialization_codes)==null?void 0:Se.includes("coordinator")});return(j==null?void 0:j.specialist_id)||null},enabled:!!(n!=null&&n.id)}),ae=ze({mutationFn:async a=>{if(!(i!=null&&i.access_token))throw new Error("Not authenticated");const h=await fetch(`${as}/api/admin/appointments/create`,{method:"POST",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!h.ok){const j=await h.json();throw new Error(j.error||"Failed to create appointment")}return h.json()},onSuccess:a=>{z(a),a.is_free?O.success("Бесплатная запись создана",{description:F?"Подтверждение отправлено на email клиента":"Запись успешно создана"}):O.success("Запись создана",{description:F?"Ссылка на оплату отправлена на email клиента":"Скопируйте ссылку на оплату для клиента"}),c==null||c()},onError:a=>{O.error("Ошибка создания записи",{description:a instanceof Error?a.message:"Неизвестная ошибка"})}});d.useEffect(()=>{p!=null&&p.length&&!P&&u(p[0].id)},[p,P]),d.useEffect(()=>{A("")},[n==null?void 0:n.id]),d.useEffect(()=>{E("")},[P]);const te=()=>{l(""),S(null),A(""),E(""),u(""),ne(new Date),je("10:00"),ee(!0),z(null)},R=()=>{te(),x(!1)},ye=async()=>{if(!b||!n||!P)return;const[a,h]=I.split(":").map(Number),j=new Date(b);if(j.setHours(a,h,0,0),ss(j,new Date)){O.error("Нельзя создать консультацию в прошлом");return}await ae.mutateAsync({userId:n.id,profileId:T||void 0,appointmentTypeId:P,scheduledAt:j.toISOString(),specialistId:q||void 0,sendEmail:F})},Ne=()=>{$!=null&&$.payment_url&&(navigator.clipboard.writeText($.payment_url),O.success("Ссылка скопирована"))},Re=b&&I&&(()=>{const[a,h]=I.split(":").map(Number),j=new Date(b);return j.setHours(a,h,0,0),!ss(j,new Date)})(),le=b&&Re&&n&&P,ve=a=>a.first_name?a.last_name?`${a.first_name} ${a.last_name}`:a.first_name:a.email||a.phone||"Пользователь",we=a=>{const h=a.first_name?a.last_name?`${a.first_name} ${a.last_name}`:a.first_name:"Без имени",j=a.type==="child"?"ребёнок":"взрослый";return`${h} (${j})`},y=p==null?void 0:p.find(a=>a.id===P),be=(y==null?void 0:y.name)===ea,re=t.filter(a=>{if(!a.accepts_new_clients)return!1;if(y){if(be)return a.id===L;const h=Xs[y.name]||[];return h.length===0?!0:a.specialization_codes.some(j=>h.includes(j))}return!0}),v=()=>{if(!b||!I)return null;const[a,h]=I.split(":").map(Number),j=new Date(b);return j.setHours(a,h,0,0),j.toLocaleTimeString("ru-RU",{timeZone:"Europe/Moscow",hour:"2-digit",minute:"2-digit"})},_e=()=>{if(!b||!I||!(n!=null&&n.region))return null;const a=sa[n.region];if(!a)return null;const[h,j]=I.split(":").map(Number),M=new Date(b);return M.setHours(h,j,0,0),M.toLocaleTimeString("ru-RU",{timeZone:a,hour:"2-digit",minute:"2-digit"})};return $?$.is_free?e.jsx(xe,{open:r,onOpenChange:R,children:e.jsxs(he,{className:"sm:max-w-[500px]",children:[e.jsxs(me,{children:[e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-5 w-5 text-green-500"}),"Бесплатная запись создана"]}),e.jsx(pe,{children:F?"Подтверждение отправлено клиенту на email":"Запись успешно создана"})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs(Je,{children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsx(Ue,{children:"Запись создана и подтверждена. Клиенту не требуется оплата."})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(g,{variant:"outline",onClick:R,children:"Закрыть"}),e.jsx(g,{onClick:te,children:"Создать ещё"})]})]})}):e.jsx(xe,{open:r,onOpenChange:R,children:e.jsxs(he,{className:"sm:max-w-[500px]",children:[e.jsxs(me,{children:[e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-5 w-5 text-green-500"}),"Запись создана"]}),e.jsxs(pe,{children:["Ссылка на оплату ",F?"отправлена клиенту":"готова для копирования"]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs(Je,{children:[e.jsx(ds,{className:"h-4 w-4"}),e.jsxs(Ue,{className:"flex flex-col gap-2",children:[e.jsx("span",{className:"font-medium",children:"Ссылка на оплату:"}),e.jsx("code",{className:"text-xs bg-muted p-2 rounded block break-all",children:$.payment_url})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{onClick:Ne,variant:"outline",className:"flex-1",children:[e.jsx(zs,{className:"mr-2 h-4 w-4"}),"Скопировать"]}),e.jsxs(g,{onClick:()=>window.open($.payment_url,"_blank"),variant:"outline",className:"flex-1",children:[e.jsx(ds,{className:"mr-2 h-4 w-4"}),"Открыть"]})]}),$.expires_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsxs("p",{children:["Срок оплаты: ",qe(new Date($.expires_at),"d MMMM yyyy, HH:mm",{locale:ns})," (МСК)"]}),e.jsx("p",{className:"mt-1",children:"После истечения срока запись будет автоматически отменена."})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(g,{variant:"outline",onClick:R,children:"Закрыть"}),e.jsx(g,{onClick:te,children:"Создать ещё"})]})]})}):e.jsx(xe,{open:r,onOpenChange:R,children:e.jsxs(he,{className:"sm:max-w-[500px] max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Создать запись с оплатой"}),e.jsx(pe,{children:"Создайте запись для клиента и отправьте ссылку на оплату"})]}),e.jsx(Ns,{className:"flex-1 pr-4",children:e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(C,{children:"Клиент"}),n?e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-primary/10 rounded-md",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(rs,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:ve(n)}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:n.email||n.phone||"—"}),n.region&&e.jsxs("span",{className:"flex items-center gap-1 px-1.5 py-0.5 bg-background rounded",children:[e.jsx(es,{className:"w-3 h-3"}),n.region]})]})]}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>S(null),children:"Изменить"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(ts,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Fe,{placeholder:"Поиск по email, телефону или имени...",value:o,onChange:a=>l(a.target.value),className:"pl-10"})]}),se&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ae,{className:"w-4 h-4 animate-spin"}),"Поиск..."]}),Y&&Y.length>0&&e.jsx("div",{className:"border rounded-md max-h-48 overflow-auto",children:Y.map(a=>e.jsxs("button",{className:"w-full p-3 text-left hover:bg-muted/50 border-b last:border-b-0 flex items-center gap-3",onClick:()=>{S(a),l("")},children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(rs,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:ve(a)}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:"truncate",children:a.email||a.phone||"—"}),a.region&&e.jsxs("span",{className:"flex items-center gap-1 shrink-0",children:[e.jsx(es,{className:"w-3 h-3"}),a.region]})]})]})]},a.id))}),o.length>=2&&!se&&(Y==null?void 0:Y.length)===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Пользователи не найдены"})]})]}),n&&N&&N.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Профиль (на кого запись)"}),ie?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ae,{className:"w-4 h-4 animate-spin"}),"Загрузка..."]}):e.jsxs(H,{value:T||"__none__",onValueChange:a=>A(a==="__none__"?"":a),children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"Выберите профиль (опционально)"})}),e.jsxs(V,{children:[e.jsx(w,{value:"__none__",children:"Без указания профиля"}),N.map(a=>e.jsx(w,{value:a.id,children:we(a)},a.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Тип консультации"}),ge?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ae,{className:"w-4 h-4 animate-spin"}),"Загрузка..."]}):e.jsxs(H,{value:P,onValueChange:u,children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"Выберите тип"})}),e.jsx(V,{children:p==null?void 0:p.map(a=>e.jsxs(w,{value:a.id,children:[a.name," — ",a.price," ₽"]},a.id))})]}),y&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Продолжительность: ",y.duration_minutes," мин. • Стоимость: ",y.price," ₽"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Специалист (опционально)"}),e.jsxs(H,{value:q||"__none__",onValueChange:a=>E(a==="__none__"?"":a),children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"Назначить позже"})}),e.jsxs(V,{children:[e.jsx(w,{value:"__none__",children:"Назначить позже"}),re.length>0?re.map(a=>e.jsx(w,{value:a.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:a.display_name}),e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",a.current_clients_count,"/",a.max_clients,")"]})]})},a.id)):e.jsx(w,{value:"__no_specialists__",disabled:!0,children:"Нет доступных специалистов"})]})]}),y&&re.length===0&&e.jsx("p",{className:"text-xs text-amber-600",children:be&&!L?"У клиента нет назначенного координатора. Сначала проведите первичную встречу и назначьте координатора.":`Нет доступных специалистов для типа «${y.name}». Можно назначить позже.`})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(C,{children:"Дата и время"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-xs",children:"Дата"}),e.jsxs(Os,{children:[e.jsx(qs,{asChild:!0,children:e.jsxs(g,{variant:"outline",className:vs("w-full justify-start text-left font-normal",!b&&"text-muted-foreground"),children:[e.jsx(xs,{className:"mr-2 h-4 w-4"}),b?qe(b,"d MMMM yyyy",{locale:ns}):e.jsx("span",{children:"Выберите дату"})]})}),e.jsx(Fs,{className:"w-auto p-0",align:"start",children:e.jsx(Ms,{mode:"single",selected:b,onSelect:ne,initialFocus:!0,disabled:a=>ss(a,Rs())})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"text-xs",children:"Время"}),e.jsx(Fe,{type:"time",value:I,onChange:a=>je(a.target.value),className:"w-full",min:Ks(b||new Date)?qe(new Date,"HH:mm"):void 0})]})]}),b&&I&&e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(hs,{className:"w-3 h-3"}),e.jsxs("span",{children:["МСК: ",v()]})]}),(n==null?void 0:n.region)&&_e()&&v()!==_e()&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(es,{className:"w-3 h-3"}),e.jsxs("span",{children:[n.region,": ",_e()]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ws,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(C,{className:"cursor-pointer",children:"Отправить email"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ссылка на оплату будет отправлена клиенту"})]})]}),e.jsx(Is,{checked:F,onCheckedChange:ee})]}),e.jsx(Je,{children:e.jsxs(Ue,{className:"text-sm",children:["После создания записи клиенту будет дано ",e.jsx("strong",{children:"24 часа"})," на оплату. Если оплата не поступит — запись автоматически отменится."]})})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(g,{variant:"outline",onClick:R,disabled:ae.isPending,children:"Отмена"}),e.jsx(g,{onClick:ye,disabled:!le||ae.isPending,children:ae.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"w-4 h-4 animate-spin mr-2"}),"Создание..."]}):"Создать запись"})]})]})})}const na={child_psychology:"Детский психолог",family_therapy:"Семейный терапевт",cbt:"КПТ",trauma:"Травматерапевт",anxiety:"Тревожные расстройства",depression:"Депрессия",adhd:"СДВГ",autism:"Аутизм",eating_disorders:"РПП",parenting:"Родительство",psychologist:"Психолог",psychiatrist:"Психиатр",psychotherapist:"Психотерапевт",clinical_psychologist:"Клинический психолог",child_psychologist:"Детский психолог",family_therapist:"Семейный терапевт",neuropsychologist:"Нейропсихолог",logopedist:"Логопед",defectologist:"Дефектолог",art_therapist:"Арт-терапевт",coordinator:"Координатор"};function Ca(){const[r,x]=d.useState(null),[t,c]=d.useState(""),[i,o]=d.useState("primary"),[l,n]=d.useState(""),[S,T]=d.useState(!1),[A,q]=d.useState(""),[E,P]=d.useState(""),[u,b]=d.useState(null),[ne,I]=d.useState("primary"),[je,F]=d.useState("active"),[ee,$]=d.useState(""),[z,fe]=d.useState(""),[Y,se]=d.useState(!1),[N,ie]=d.useState(null),[p,ge]=d.useState(null),[L,ae]=d.useState(null),[te,R]=d.useState(""),[ye,Ne]=d.useState(""),[Re,le]=d.useState(!1),[ve,we]=d.useState(!1),{data:y,isLoading:be,refetch:re}=Vs(),{data:v,isLoading:_e}=Ys(),{data:a,isLoading:h,refetch:j}=Gs(),{data:M,isLoading:Ce,refetch:Se}=Us(),ce=Zs(),ke=Js(),Ke=Ws(),ms=s=>{x(s),c(""),o("primary"),n(""),T(!0)},us=async()=>{!r||!t||(await ce.mutateAsync({appointmentId:r.id,clientUserId:r.user_id,specialistId:t,profileId:r.profile_id,assignmentType:i,notes:l||void 0}),T(!1),x(null))},He=s=>{if(s.profile_first_name){const m=s.profile_last_name?`${s.profile_first_name} ${s.profile_last_name}`:s.profile_first_name,K=s.profile_type==="child"?"ребёнок":s.profile_type==="parent"?"родитель":s.profile_type==="partner"?"партнёр":"";return K?`${m} (${K})`:m}return null},Be=s=>s.user_email||s.user_phone||"Клиент",Qe=s=>qe(new Date(s),"dd MMM yyyy, HH:mm",{locale:ns}),ps=s=>{const m=s.current_clients_count/s.max_clients*100;return m>=90?e.jsx(k,{variant:"destructive",children:"Загружен"}):m>=70?e.jsx(k,{variant:"secondary",children:"Почти загружен"}):e.jsx(k,{variant:"default",children:"Свободен"})},js=s=>{b(s),I(s.assignment_type),F(s.status),$(s.notes||""),fe(s.specialist_id||""),se(!0)},_s=async()=>{u&&(z&&z!==u.specialist_id?(await ke.mutateAsync({id:u.id,status:"completed",notes:ee||null}),await ce.mutateAsync({appointmentId:"",clientUserId:u.client_user_id,specialistId:z,profileId:u.profile_id||void 0,assignmentType:ne,notes:ee||void 0})):await ke.mutateAsync({id:u.id,assignment_type:ne,status:je,notes:ee||null}),se(!1),b(null))},Te=s=>na[s]||s,ls=(s,m)=>{ge(s),ae(m),R(""),Ne(""),le(!0)},fs=async()=>{!p||!L||(await Ke.mutateAsync({requestId:p.id,newSpecialistId:L==="approve"?te:null,status:L==="approve"?"approved":"rejected",notes:ye||void 0}),le(!1),ge(null),ae(null))},Ve=(M==null?void 0:M.filter(s=>s.status==="pending").length)||0,Ye=a==null?void 0:a.filter(s=>{if(!A)return!0;const m=A.toLowerCase(),K=`${s.client_first_name||""} ${s.client_last_name||""}`.toLowerCase(),de=(s.client_email||"").toLowerCase(),Ge=(s.specialist_name||"").toLowerCase();return K.includes(m)||de.includes(m)||Ge.includes(m)}),Ze=v==null?void 0:v.filter(s=>{if(!E)return!0;const m=E.toLowerCase(),K=s.display_name.toLowerCase(),de=s.specialization_codes.map(Ge=>Te(Ge).toLowerCase()).join(" ");return K.includes(m)||de.includes(m)});return be||_e?e.jsxs("div",{className:"space-y-6",children:[e.jsx(oe,{className:"h-8 w-64"}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(oe,{className:"h-32"}),e.jsx(oe,{className:"h-32"})]}),e.jsx(oe,{className:"h-64"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Назначение клиентов"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Привязка клиентов к специалистам"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{onClick:()=>we(!0),children:[e.jsx(bs,{className:"mr-2 h-4 w-4"}),"Создать запись с оплатой"]}),e.jsxs(g,{variant:"outline",onClick:()=>{re(),j(),Se()},children:[e.jsx(Cs,{className:"mr-2 h-4 w-4"}),"Обновить"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(Z,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(J,{className:"text-sm font-medium",children:"Ожидают назначения"}),e.jsx(hs,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:(y==null?void 0:y.length)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"записей без специалиста"})]})]}),e.jsxs(Z,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(J,{className:"text-sm font-medium",children:"Запросы на смену"}),e.jsx(os,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:Ve}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ожидают рассмотрения"})]})]}),e.jsxs(Z,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(J,{className:"text-sm font-medium",children:"Доступные специалисты"}),e.jsx(Ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:(v==null?void 0:v.filter(s=>s.accepts_new_clients).length)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"принимают новых клиентов"})]})]}),e.jsxs(Z,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(J,{className:"text-sm font-medium",children:"Всего назначений"}),e.jsx(cs,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:(a==null?void 0:a.filter(s=>s.status==="active").length)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"активных назначений"})]})]})]}),e.jsxs(Ls,{defaultValue:"unassigned",children:[e.jsxs(Ps,{children:[e.jsxs($e,{value:"unassigned",children:["Без специалиста (",(y==null?void 0:y.length)||0,")"]}),e.jsxs($e,{value:"change-requests",className:"relative",children:["Запросы на смену",Ve>0&&e.jsx(k,{variant:"destructive",className:"ml-2 h-5 min-w-[20px] px-1",children:Ve})]}),e.jsx($e,{value:"assignments",children:"Все назначения"}),e.jsx($e,{value:"specialists",children:"Специалисты"})]}),e.jsx(Le,{value:"unassigned",children:e.jsxs(Z,{children:[e.jsxs(G,{children:[e.jsx(J,{children:"Записи ожидающие назначения"}),e.jsx(De,{children:"Клиенты, которые записались на консультацию, но ещё не привязаны к специалисту"})]}),e.jsx(U,{children:!y||y.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(cs,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:"Все записи назначены специалистам"})]}):e.jsxs(Pe,{children:[e.jsx(Ie,{children:e.jsxs(W,{children:[e.jsx(_,{children:"Клиент / Профиль"}),e.jsx(_,{children:"Дата и время"}),e.jsx(_,{children:"Тип консультации"}),e.jsx(_,{children:"Статус"}),e.jsx(_,{className:"text-right",children:"Действия"})]})}),e.jsx(Me,{children:y.map(s=>{const m=He(s);return e.jsxs(W,{children:[e.jsx(f,{children:e.jsxs("div",{children:[m&&e.jsx("p",{className:"font-medium",children:m}),e.jsx("p",{className:m?"text-sm text-muted-foreground":"font-medium",children:Be(s)})]})}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4 text-muted-foreground"}),Qe(s.scheduled_at)]})}),e.jsx(f,{children:s.appointment_type_name||"Не указан"}),e.jsx(f,{children:e.jsx(k,{variant:s.status==="pending_specialist"?"destructive":s.status==="scheduled"?"secondary":"default",children:s.status==="pending_specialist"?"Ожидает специалиста":s.status==="scheduled"?"Запланировано":"В процессе"})}),e.jsx(f,{className:"text-right",children:e.jsxs(g,{size:"sm",onClick:()=>ms(s),children:[e.jsx(Ss,{className:"mr-2 h-4 w-4"}),"Назначить"]})})]},s.id)})})]})})]})}),e.jsx(Le,{value:"change-requests",children:e.jsxs(Z,{children:[e.jsxs(G,{children:[e.jsx(J,{children:"Запросы на смену специалиста"}),e.jsx(De,{children:"Запросы клиентов на смену назначенного специалиста"})]}),e.jsx(U,{children:Ce?e.jsx(oe,{className:"h-32"}):!M||M.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(os,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:"Нет запросов на смену специалиста"})]}):e.jsxs(Pe,{children:[e.jsx(Ie,{children:e.jsxs(W,{children:[e.jsx(_,{children:"Клиент"}),e.jsx(_,{children:"Текущий специалист"}),e.jsx(_,{children:"Причина"}),e.jsx(_,{children:"Статус"}),e.jsx(_,{children:"Дата"}),e.jsx(_,{className:"text-right",children:"Действия"})]})}),e.jsx(Me,{children:M.map(s=>e.jsxs(W,{children:[e.jsx(f,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.client_first_name?`${s.client_first_name} ${s.client_last_name||""}`:s.client_email||"Клиент"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.client_email||"—"})]})}),e.jsxs(f,{children:[e.jsx("p",{className:"font-medium",children:s.current_specialist_name||"—"}),s.new_specialist_name&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["→ ",s.new_specialist_name]})]}),e.jsx(f,{children:s.reason?e.jsx("span",{className:"text-sm truncate max-w-[200px] block",title:s.reason,children:s.reason.length>50?`${s.reason.substring(0,50)}...`:s.reason}):e.jsx("span",{className:"text-muted-foreground",children:"Не указана"})}),e.jsx(f,{children:e.jsx(k,{variant:s.status==="pending"?"secondary":s.status==="approved"?"default":s.status==="rejected"?"destructive":"outline",children:s.status==="pending"?"Ожидает":s.status==="approved"?"Одобрен":s.status==="rejected"?"Отклонён":"Отменён"})}),e.jsx(f,{className:"text-sm",children:Qe(s.created_at)}),e.jsxs(f,{className:"text-right",children:[s.status==="pending"&&e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(g,{size:"sm",variant:"default",onClick:()=>ls(s,"approve"),children:[e.jsx(Oe,{className:"mr-1 h-4 w-4"}),"Одобрить"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>ls(s,"reject"),children:[e.jsx(ks,{className:"mr-1 h-4 w-4"}),"Отклонить"]})]}),s.status!=="pending"&&s.coordinator_notes&&e.jsx("span",{className:"text-xs text-muted-foreground",title:s.coordinator_notes,children:s.coordinator_notes.length>30?`${s.coordinator_notes.substring(0,30)}...`:s.coordinator_notes})]})]},s.id))})]})})]})}),e.jsx(Le,{value:"assignments",children:e.jsxs(Z,{children:[e.jsxs(G,{children:[e.jsx(J,{children:"История назначений"}),e.jsx(De,{children:"Все назначения клиентов специалистам"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ts,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Fe,{placeholder:"Поиск по клиенту или специалисту...",value:A,onChange:s=>q(s.target.value),className:"pl-10"})]})}),h?e.jsx(oe,{className:"h-32"}):!Ye||Ye.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Ee,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:A?"Ничего не найдено":"Пока нет назначений"})]}):e.jsxs(Pe,{children:[e.jsx(Ie,{children:e.jsxs(W,{children:[e.jsx(_,{children:"Клиент / Профиль"}),e.jsx(_,{children:"Специалист"}),e.jsx(_,{children:"Тип"}),e.jsx(_,{children:"Статус"}),e.jsx(_,{children:"Комментарий"}),e.jsx(_,{children:"Дата"}),e.jsx(_,{className:"w-10"})]})}),e.jsx(Me,{children:Ye.map(s=>{var de;const m=s.profile_first_name?`${s.profile_first_name} ${s.profile_last_name||""}${s.profile_type==="child"?" (ребёнок)":s.profile_type==="parent"?" (родитель)":""}`:null,K=s.client_first_name?`${s.client_first_name} ${s.client_last_name||""}`:null;return e.jsxs(W,{children:[e.jsx(f,{children:e.jsxs("div",{children:[m&&e.jsx("p",{className:"font-medium",children:m}),e.jsx("p",{className:m?"text-sm text-muted-foreground":"font-medium",children:K||s.client_email||"Клиент"}),K&&s.client_email&&e.jsx("p",{className:"text-xs text-muted-foreground",children:s.client_email})]})}),e.jsx(f,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.specialist_name||"—"}),((de=s.specialist_specializations)==null?void 0:de.length)>0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:s.specialist_specializations.slice(0,2).map(Te).join(", ")})]})}),e.jsx(f,{children:e.jsx(k,{variant:"outline",children:s.assignment_type==="primary"?"Основной":s.assignment_type==="consultant"?"Консультант":"Временный"})}),e.jsx(f,{children:e.jsx(k,{variant:s.status==="active"?"default":"secondary",children:s.status==="active"?"Активно":s.status==="completed"?"Завершено":s.status==="paused"?"Приостановлено":"Отменено"})}),e.jsx(f,{children:s.notes?e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-[150px] block",title:s.notes,children:s.notes.length>30?`${s.notes.substring(0,30)}...`:s.notes}):e.jsx("span",{className:"text-muted-foreground",children:"—"})}),e.jsx(f,{className:"text-sm",children:Qe(s.assigned_at)}),e.jsx(f,{children:e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>js(s),title:"Редактировать",children:e.jsx(Hs,{className:"h-4 w-4"})})})]},s.id)})})]})]})]})}),e.jsx(Le,{value:"specialists",children:e.jsxs(Z,{children:[e.jsxs(G,{children:[e.jsx(J,{children:"Доступные специалисты"}),e.jsx(De,{children:"Список специалистов и их загрузка"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ts,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Fe,{placeholder:"Поиск по имени или специализации...",value:E,onChange:s=>P(s.target.value),className:"pl-10"})]})}),!Ze||Ze.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Ee,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:E?"Ничего не найдено":"Нет доступных специалистов"})]}):e.jsxs(Pe,{children:[e.jsx(Ie,{children:e.jsxs(W,{children:[e.jsx(_,{children:"Специалист"}),e.jsx(_,{children:"Специализации"}),e.jsx(_,{children:"Клиенты"}),e.jsx(_,{children:"Статус"}),e.jsx(_,{children:"Загрузка"}),e.jsx(_,{className:"w-10"})]})}),e.jsx(Me,{children:Ze.map(s=>e.jsxs(W,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>ie(s),children:[e.jsx(f,{className:"font-medium",children:s.display_name}),e.jsx(f,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.specialization_codes.slice(0,2).map(m=>e.jsx(k,{variant:"outline",className:"text-xs",children:Te(m)},m)),s.specialization_codes.length>2&&e.jsxs(k,{variant:"outline",className:"text-xs",children:["+",s.specialization_codes.length-2]})]})}),e.jsxs(f,{children:[s.current_clients_count," / ",s.max_clients]}),e.jsx(f,{children:s.accepts_new_clients?e.jsx(k,{variant:"default",children:"Принимает"}):e.jsx(k,{variant:"secondary",children:"Не принимает"})}),e.jsx(f,{children:ps(s)}),e.jsx(f,{children:e.jsx(g,{variant:"ghost",size:"icon",onClick:m=>{m.stopPropagation(),ie(s)},title:"Подробнее",children:e.jsx(Bs,{className:"h-4 w-4"})})})]},s.id))})]})]})]})})]}),e.jsx(xe,{open:S,onOpenChange:T,children:e.jsxs(he,{children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Назначить специалиста"}),e.jsx(pe,{children:r&&e.jsx(e.Fragment,{children:He(r)?e.jsxs(e.Fragment,{children:["Профиль: ",e.jsx("strong",{children:He(r)}),e.jsx("br",{}),"Клиент: ",Be(r)]}):e.jsxs(e.Fragment,{children:["Клиент: ",e.jsx("strong",{children:Be(r)})]})})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Специалист"}),e.jsxs(H,{value:t,onValueChange:c,children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"Выберите специалиста"})}),e.jsx(V,{children:v==null?void 0:v.filter(s=>s.accepts_new_clients).map(s=>e.jsx(w,{value:s.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.display_name}),e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",s.current_clients_count,"/",s.max_clients,")"]})]})},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Тип назначения"}),e.jsxs(H,{value:i,onValueChange:s=>o(s),children:[e.jsx(B,{children:e.jsx(Q,{})}),e.jsxs(V,{children:[e.jsx(w,{value:"primary",children:"Основной специалист"}),e.jsx(w,{value:"consultant",children:"Консультант"}),e.jsx(w,{value:"temporary",children:"Временный"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Заметки (опционально)"}),e.jsx(We,{placeholder:"Дополнительная информация о назначении...",value:l,onChange:s=>n(s.target.value)})]})]}),e.jsxs(Xe,{children:[e.jsx(g,{variant:"outline",onClick:()=>T(!1),children:"Отмена"}),e.jsx(g,{onClick:us,disabled:!t||ce.isPending,children:ce.isPending?"Назначение...":"Назначить"})]})]})}),e.jsx(xe,{open:Y,onOpenChange:se,children:e.jsxs(he,{children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Редактировать назначение"}),e.jsx(pe,{children:u&&e.jsxs(e.Fragment,{children:["Клиент:"," ",e.jsx("strong",{children:u.client_first_name?`${u.client_first_name} ${u.client_last_name||""}`:u.client_email}),e.jsx("br",{}),"Специалист: ",e.jsx("strong",{children:u.specialist_name})]})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Специалист"}),e.jsxs(H,{value:z,onValueChange:fe,children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"Выберите специалиста"})}),e.jsx(V,{children:v==null?void 0:v.map(s=>e.jsx(w,{value:s.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.display_name}),s.id===(u==null?void 0:u.specialist_id)&&e.jsx(k,{variant:"outline",className:"text-xs",children:"текущий"})]})},s.id))})]}),z&&z!==(u==null?void 0:u.specialist_id)&&e.jsx("p",{className:"text-xs text-orange-600",children:"При смене специалиста текущее назначение будет завершено"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Тип назначения"}),e.jsxs(H,{value:ne,onValueChange:s=>I(s),children:[e.jsx(B,{children:e.jsx(Q,{})}),e.jsxs(V,{children:[e.jsx(w,{value:"primary",children:"Основной специалист"}),e.jsx(w,{value:"consultant",children:"Консультант"}),e.jsx(w,{value:"temporary",children:"Временный"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Статус"}),e.jsxs(H,{value:je,onValueChange:F,children:[e.jsx(B,{children:e.jsx(Q,{})}),e.jsxs(V,{children:[e.jsx(w,{value:"active",children:"Активно"}),e.jsx(w,{value:"paused",children:"Приостановлено"}),e.jsx(w,{value:"completed",children:"Завершено"}),e.jsx(w,{value:"cancelled",children:"Отменено"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Комментарий"}),e.jsx(We,{placeholder:"Комментарий к назначению...",value:ee,onChange:s=>$(s.target.value),rows:3})]})]}),e.jsxs(Xe,{children:[e.jsx(g,{variant:"outline",onClick:()=>se(!1),children:"Отмена"}),e.jsx(g,{onClick:_s,disabled:ke.isPending||ce.isPending,children:ke.isPending||ce.isPending?"Сохранение...":"Сохранить"})]})]})}),e.jsx(Ts,{open:!!N,onOpenChange:s=>!s&&ie(null),children:e.jsxs(As,{className:"sm:max-w-md",children:[e.jsxs(Es,{children:[e.jsx(Ds,{children:N==null?void 0:N.display_name}),e.jsx($s,{children:"Информация о специалисте"})]}),N&&e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Специализации"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[N.specialization_codes.map(s=>e.jsx(k,{variant:"secondary",children:Te(s)},s)),N.specialization_codes.length===0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"Не указаны"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-1",children:[e.jsx(Ee,{className:"h-4 w-4"}),"Клиенты"]}),e.jsxs("p",{className:"text-lg font-semibold",children:[N.current_clients_count," / ",N.max_clients]})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-1",children:[e.jsx(Qs,{className:"h-4 w-4"}),"Загрузка"]}),e.jsxs("p",{className:"text-lg font-semibold",children:[Math.round(N.current_clients_count/N.max_clients*100),"%"]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Доступен для работы"}),e.jsx(k,{variant:N.is_available?"default":"secondary",children:N.is_available?"Да":"Нет"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Принимает новых клиентов"}),e.jsx(k,{variant:N.accepts_new_clients?"default":"secondary",children:N.accepts_new_clients?"Да":"Нет"})]})]}),e.jsx(g,{variant:"outline",className:"w-full",onClick:()=>ie(null),children:"Закрыть"})]})]})}),e.jsx(xe,{open:Re,onOpenChange:le,children:e.jsxs(he,{children:[e.jsxs(me,{children:[e.jsx(ue,{children:L==="approve"?"Одобрить запрос":"Отклонить запрос"}),e.jsx(pe,{children:p&&e.jsxs(e.Fragment,{children:["Клиент:"," ",e.jsx("strong",{children:p.client_first_name?`${p.client_first_name} ${p.client_last_name||""}`:p.client_email}),e.jsx("br",{}),"Текущий специалист: ",e.jsx("strong",{children:p.current_specialist_name}),p.reason&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),"Причина: ",p.reason]})]})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[L==="approve"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Новый специалист *"}),e.jsxs(H,{value:te,onValueChange:R,children:[e.jsx(B,{children:e.jsx(Q,{placeholder:"Выберите специалиста"})}),e.jsx(V,{children:v==null?void 0:v.filter(s=>s.accepts_new_clients&&s.id!==(p==null?void 0:p.current_specialist_id)).map(s=>e.jsx(w,{value:s.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.display_name}),e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",s.current_clients_count,"/",s.max_clients,")"]})]})},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{children:["Комментарий ",L==="reject"?"(рекомендуется указать причину)":"(опционально)"]}),e.jsx(We,{placeholder:L==="approve"?"Комментарий к переназначению...":"Укажите причину отклонения запроса...",value:ye,onChange:s=>Ne(s.target.value),rows:3})]})]}),e.jsxs(Xe,{children:[e.jsx(g,{variant:"outline",onClick:()=>le(!1),children:"Отмена"}),e.jsx(g,{onClick:fs,disabled:Ke.isPending||L==="approve"&&!te,variant:L==="approve"?"default":"destructive",children:Ke.isPending?"Обработка...":L==="approve"?"Одобрить":"Отклонить"})]})]})}),e.jsx(ta,{open:ve,onOpenChange:we,specialists:v||[],onSuccess:()=>{re(),j()}})]})}export{Ca as default};
