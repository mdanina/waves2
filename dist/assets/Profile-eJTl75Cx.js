import{j as e,r}from"./vendor-radix-htwXsPHy.js";import{j as D,u as G,H as V,S as J,a as K,I as v,B as Q,k as O,g as u,l as T,n as X}from"./index-Dv2C02zj.js";import{R as q}from"./Radio-6SPOB3xD.js";import{getCurrentUserData as Z,upsertUserData as $,PhoneAlreadyExistsError as ee}from"./userStorage-D4uruuWH.js";import{getProfiles as z,updateProfile as se,createProfile as te}from"./profileStorage-CNyPVPjQ.js";import{B as ae}from"./birth-date-picker-RdMiatSZ.js";import{isPushSupported as re,setupPushNotifications as ne}from"./push-notifications-DY0UVl1r.js";import{u as oe,a as ie}from"./vendor-react-CI8wve7f.js";import"./vendor-charts-DjioKZbK.js";import"./vendor-query-BNGVDYIL.js";import"./vendor-date-CR4liJ_d.js";function F({label:o,checked:i=!1,onChange:c,disabled:l=!1,className:f}){return e.jsxs("label",{className:D("flex items-center gap-3 cursor-pointer",l&&"opacity-50 cursor-not-allowed",f),children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"checkbox",checked:i,onChange:d=>c==null?void 0:c(d.target.checked),disabled:l,className:"sr-only"}),e.jsx("div",{className:D("w-6 h-6 rounded-lg border-2 transition-all duration-200","flex items-center justify-center",i?"bg-gradient-to-br from-coral to-coral-light border-coral shadow-md shadow-coral/30":"bg-white border-muted"),children:i&&e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:3,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})})]}),o&&e.jsx("span",{className:"text-sm",children:o})]})}function Ne(){const o=oe(),i=ie(),{user:c}=G(),[l,f]=r.useState(""),[d,y]=r.useState(""),[h,P]=r.useState(""),[p,S]=r.useState(""),[x,w]=r.useState(""),[m,C]=r.useState(""),[k,g]=r.useState(""),[I,E]=r.useState(!1),[B,_]=r.useState(!1),[L,j]=r.useState(!0),R=r.useRef(!1);r.useEffect(()=>{async function t(){var n;if(c)try{const s=await Z();s&&(C(s.phone?O(s.phone):""),_(s.marketing_consent||!1));const a=(await z()).find(W=>W.type==="parent");a&&(f(a.first_name||""),y(a.last_name||""),P(a.dob||""),S(a.gender||""),w(a.seeking_care||""));const N=a&&a.first_name&&a.last_name,b=s==null?void 0:s.phone,M=s==null?void 0:s.region;if(N&&b&&M&&(R.current=!0,((n=i.state)==null?void 0:n.from)!=="cabinet")){o("/cabinet",{replace:!0});return}}catch(s){console.error("Error loading user data:",s)}finally{j(!1)}}t()},[c,i.state,o]);const Y=t=>{const n=O(t.target.value);C(n),k&&g("")},H=async t=>{if(E(t),t&&re()){const n=await ne();n==="denied"?(u.error("Вы заблокировали уведомления в браузере. Разрешите их в настройках."),E(!1)):n==="granted"&&u.success("Уведомления включены!")}},U=async t=>{var n;if(t.preventDefault(),!m){g("Введите номер телефона");return}if(!T(m)){g("Введите корректный номер телефона");return}if(l&&d&&h&&p&&x&&m)try{j(!0);const s=X(m);await $({phone:s,marketing_consent:B});const a=(await z()).find(b=>b.type==="parent");a?(await se(a.id,{firstName:l,lastName:d,dateOfBirth:h,relationship:"parent",sex:p,seekingCare:x}),u.success("Профиль успешно обновлен!")):(await te({firstName:l,lastName:d,dateOfBirth:h,relationship:"parent",sex:p,seekingCare:x}),u.success("Профиль успешно создан!"));const N=((n=i.state)==null?void 0:n.from)==="cabinet"||R.current;o(N?"/cabinet":"/region")}catch(s){console.error("Error saving profile:",s),s instanceof ee?u.error(s.message):u.error("Ошибка при сохранении профиля"),j(!1)}};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(V,{}),e.jsxs("div",{className:"container mx-auto max-w-2xl px-4 py-12",children:[e.jsx(J,{currentStep:1,totalSteps:3,label:"ПРОФИЛЬ"}),e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(K,{size:"2xl",className:"mb-4",children:"Расскажите нам больше о себе"}),e.jsx("p",{className:"text-muted-foreground",children:"Данные используются только для облегчения лечения, в соответствии с нашей политикой конфиденциальности."})]}),e.jsxs("form",{onSubmit:U,className:"space-y-6",children:[e.jsx(v,{id:"firstName",type:"text",label:"Имя *",value:l,onChange:t=>f(t.target.value),required:!0}),e.jsx(v,{id:"lastName",type:"text",label:"Фамилия *",value:d,onChange:t=>y(t.target.value),required:!0}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{htmlFor:"dateOfBirth",className:"text-sm font-medium text-foreground",children:["Дата рождения ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(ae,{id:"dateOfBirth",value:h,onChange:P,required:!0,fromYear:new Date().getFullYear()-100,toYear:new Date().getFullYear()})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Пол ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(q,{name:"sex",value:p,onChange:S,options:[{value:"male",label:"Мужской"},{value:"female",label:"Женский"}],className:"grid grid-cols-2 gap-4"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["Вы ищете помощь для себя? ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(q,{name:"seekingCare",value:x,onChange:w,options:[{value:"yes",label:"Да"},{value:"no",label:"Нет"}],className:"grid grid-cols-2 gap-4"})]}),e.jsx(v,{id:"phone",type:"tel",label:"Номер телефона *",value:m,onChange:Y,placeholder:"+7 (999) 123-45-67",required:!0,error:k}),e.jsxs("div",{className:"space-y-4 rounded-lg border border-border p-4",children:[e.jsx(F,{checked:I,onChange:t=>H(t),label:e.jsx("span",{className:"text-sm leading-relaxed",children:"Разрешить отправлять уведомления о консультациях на платформе"})}),e.jsx(F,{checked:B,onChange:t=>_(t),label:e.jsxs("span",{className:"text-sm leading-relaxed",children:["Я согласен получать ",e.jsx("strong",{children:"периодические маркетинговые"})," письма о программах, предложениях и обновлениях Waves."]})})]}),e.jsx(Q,{type:"submit",size:"lg",disabled:L,className:"h-14 w-full text-base font-medium",children:L?"Сохранение...":"Продолжить"})]})]})]})]})}export{Ne as default};
