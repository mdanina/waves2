import{w as s,p as n}from"./index-Bu4m9iDU.js";function l(){return"http://localhost:3001"}const c=l();async function h(){try{const{data:{session:r},error:t}=await s.auth.getSession();if(t)throw n.error("Ошибка получения сессии:",t),new Error("Ошибка авторизации. Попробуйте перезайти в аккаунт.");if(!(r!=null&&r.access_token))throw new Error("Необходима авторизация. Попробуйте перезайти в аккаунт.");let e;try{e=await fetch(`${c}/api/calendar/generate-token`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`}})}catch(o){throw n.error("Сетевая ошибка при генерации токена:",o),new Error("Не удалось подключиться к серверу. Проверьте интернет-соединение.")}if(!e.ok){let o="Ошибка генерации токена";try{o=(await e.json()).error||o}catch{e.status===401?o="Сессия истекла. Попробуйте перезайти в аккаунт.":e.status===404?o="Сервер календаря недоступен. Проверьте настройки VITE_API_URL.":e.status===500?o="Ошибка сервера. Попробуйте позже.":o=`Ошибка сервера (${e.status}). Попробуйте позже.`}throw new Error(o)}let a;try{a=await e.json()}catch{throw new Error("Неверный формат ответа от сервера")}if(!a.success)throw new Error(a.error||"Ошибка генерации токена");if(!a.token||!a.feedUrl)throw new Error("Сервер не вернул данные токена");return{token:a.token,feedUrl:a.feedUrl}}catch(r){throw n.error("Ошибка генерации токена календаря:",r),r}}async function d(){try{const{data:{session:r}}=await s.auth.getSession();if(!(r!=null&&r.access_token))throw new Error("Необходима авторизация");const t=await fetch(`${c}/api/calendar/revoke-token`,{method:"DELETE",headers:{Authorization:`Bearer ${r.access_token}`}});if(!t.ok){const e=await t.json();throw new Error(e.error||"Ошибка отзыва токена")}}catch(r){throw n.error("Ошибка отзыва токена календаря:",r),r}}async function u(){try{const{data:{user:r}}=await s.auth.getUser();if(!r)return null;const{data:t,error:e}=await s.from("calendar_feed_tokens").select("token").eq("user_id",r.id).single();return e||!t?null:t.token}catch(r){return n.error("Ошибка получения токена календаря:",r),null}}function f(r){return`${c}/api/calendar/feed/${r}`}async function k(){try{const{data:{session:r},error:t}=await s.auth.getSession();if(t)throw n.error("Ошибка получения сессии:",t),new Error("Ошибка авторизации. Попробуйте перезайти в аккаунт.");if(!(r!=null&&r.access_token))throw new Error("Необходима авторизация. Попробуйте перезайти в аккаунт.");let e;try{e=await fetch(`${c}/api/calendar/specialist/generate-token`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`}})}catch(o){throw n.error("Сетевая ошибка при генерации токена:",o),new Error("Не удалось подключиться к серверу. Проверьте интернет-соединение.")}if(!e.ok){let o="Ошибка генерации токена";try{o=(await e.json()).error||o}catch{e.status===401?o="Сессия истекла. Попробуйте перезайти в аккаунт.":e.status===403?o="Доступ запрещён. Убедитесь, что вы являетесь специалистом.":e.status===500?o="Ошибка сервера. Попробуйте позже.":o=`Ошибка сервера (${e.status}). Попробуйте позже.`}throw new Error(o)}let a;try{a=await e.json()}catch{throw new Error("Неверный формат ответа от сервера")}if(!a.success)throw new Error(a.error||"Ошибка генерации токена");if(!a.token||!a.feedUrl)throw new Error("Сервер не вернул данные токена");return{token:a.token,feedUrl:a.feedUrl}}catch(r){throw n.error("Ошибка генерации токена календаря специалиста:",r),r}}async function E(){try{const{data:{session:r}}=await s.auth.getSession();if(!(r!=null&&r.access_token))throw new Error("Необходима авторизация");const t=await fetch(`${c}/api/calendar/specialist/revoke-token`,{method:"DELETE",headers:{Authorization:`Bearer ${r.access_token}`}});if(!t.ok){const e=await t.json();throw new Error(e.error||"Ошибка отзыва токена")}}catch(r){throw n.error("Ошибка отзыва токена календаря специалиста:",r),r}}async function p(r){try{const{data:{user:t}}=await s.auth.getUser();if(!t)return null;const{data:e,error:a}=await s.from("calendar_feed_tokens").select("token").eq("user_id",t.id).eq("specialist_id",r).single();return a||!e?null:e.token}catch(t){return n.error("Ошибка получения токена календаря специалиста:",t),null}}export{h as a,f as b,p as c,k as d,E as e,u as g,d as r};
