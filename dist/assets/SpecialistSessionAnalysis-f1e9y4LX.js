import{r as l,R as fn,j as e}from"./vendor-radix-J7BmBqsC.js";import{e as mn,u as xn,L as pn}from"./vendor-react-CI1J5nwZ.js";import{g as je,i as Me,aN as At,O as Y,F as ae,B as M,aO as st,a2 as rt,K as we,x as le,N as Ne,C as Fe,h as He,aP as hn,aQ as Lt,aR as Dt,t as X,aS as gn,aT as vn,aU as yn,q as se,aV as jn,aW as dt,aX as ft,aY as wn,aZ as Nn,a_ as bn,a$ as Sn,b0 as zn,b1 as Cn,b2 as En,b3 as mt,R as _t,T as Mt,o as xt,a5 as Re,a9 as et,w as $t,D as Rn,a6 as kn,a7 as pt,Q as Pn,Y as In,v as An}from"./index-CsvxaYtI.js";import{S as Ae}from"./skeleton-CX4qEpye.js";import{C as Ln,a as Dn,b as _n}from"./collapsible-DaJuErX2.js";import{g as Mn,a as $n,u as Tn,b as ht,c as Fn}from"./supabase-ai-CXYeb-fP.js";import{a as Hn,d as Bn}from"./client-utils-BLj6ZS6T.js";import{G as Gn}from"./grip-vertical-DbOjk_Y8.js";import{T as Tt,a as Ft,b as ze,c as Le}from"./tabs-CT8W70EM.js";import{P as gt}from"./plus-CNlpg7MV.js";import{T as Ht}from"./trash-2-BiEfhxdN.js";import{D as Un}from"./download-D4rweCku.js";import{L as vt}from"./lock-Dh4_7Z3d.js";import{P as Vn}from"./play-BCyXg3Ja.js";import{S as tt}from"./sparkles-BW0sNWVS.js";import{C as yt}from"./copy-BIipb-ws.js";import{S as qn}from"./save-Dg65xQN1.js";import"./vendor-charts-CkgrveCd.js";import"./vendor-query-Bb981xLV.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kn=je("MicOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=je("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=je("Music",[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const On=je("Pause",[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wn=je("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=je("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),Be=l.createContext(null);Be.displayName="PanelGroupContext";const q={group:"data-panel-group",groupDirection:"data-panel-group-direction",groupId:"data-panel-group-id",panel:"data-panel",panelCollapsible:"data-panel-collapsible",panelId:"data-panel-id",panelSize:"data-panel-size",resizeHandle:"data-resize-handle",resizeHandleActive:"data-resize-handle-active",resizeHandleEnabled:"data-panel-resize-handle-enabled",resizeHandleId:"data-panel-resize-handle-id",resizeHandleState:"data-resize-handle-state"},at=10,me=l.useLayoutEffect,Nt=fn.useId,Xn=typeof Nt=="function"?Nt:()=>null;let Yn=0;function it(t=null){const n=Xn(),s=l.useRef(t||n||null);return s.current===null&&(s.current=""+Yn++),t??s.current}function Bt({children:t,className:n="",collapsedSize:s,collapsible:r,defaultSize:o,forwardedRef:a,id:i,maxSize:c,minSize:d,onCollapse:h,onExpand:w,onResize:g,order:f,style:b,tagName:j="div",...x}){const C=l.useContext(Be);if(C===null)throw Error("Panel components must be rendered within a PanelGroup container");const{collapsePanel:p,expandPanel:u,getPanelSize:v,getPanelStyle:z,groupId:_,isPanelCollapsed:D,reevaluatePanelConstraints:k,registerPanel:m,resizePanel:A,unregisterPanel:L}=C,F=it(i),T=l.useRef({callbacks:{onCollapse:h,onExpand:w,onResize:g},constraints:{collapsedSize:s,collapsible:r,defaultSize:o,maxSize:c,minSize:d},id:F,idIsFromProps:i!==void 0,order:f});l.useRef({didLogMissingDefaultSizeWarning:!1}),me(()=>{const{callbacks:B,constraints:G}=T.current,O={...G};T.current.id=F,T.current.idIsFromProps=i!==void 0,T.current.order=f,B.onCollapse=h,B.onExpand=w,B.onResize=g,G.collapsedSize=s,G.collapsible=r,G.defaultSize=o,G.maxSize=c,G.minSize=d,(O.collapsedSize!==G.collapsedSize||O.collapsible!==G.collapsible||O.maxSize!==G.maxSize||O.minSize!==G.minSize)&&k(T.current,O)}),me(()=>{const B=T.current;return m(B),()=>{L(B)}},[f,F,m,L]),l.useImperativeHandle(a,()=>({collapse:()=>{p(T.current)},expand:B=>{u(T.current,B)},getId(){return F},getSize(){return v(T.current)},isCollapsed(){return D(T.current)},isExpanded(){return!D(T.current)},resize:B=>{A(T.current,B)}}),[p,u,v,D,F,A]);const K=z(T.current,o);return l.createElement(j,{...x,children:t,className:n,id:F,style:{...K,...b},[q.groupId]:_,[q.panel]:"",[q.panelCollapsible]:r||void 0,[q.panelId]:F,[q.panelSize]:parseFloat(""+K.flexGrow).toFixed(1)})}const Gt=l.forwardRef((t,n)=>l.createElement(Bt,{...t,forwardedRef:n}));Bt.displayName="Panel";Gt.displayName="forwardRef(Panel)";let nt=null,_e=-1,ie=null;function Jn(t,n){if(n){const s=(n&Ot)!==0,r=(n&Wt)!==0,o=(n&Xt)!==0,a=(n&Yt)!==0;if(s)return o?"se-resize":a?"ne-resize":"e-resize";if(r)return o?"sw-resize":a?"nw-resize":"w-resize";if(o)return"s-resize";if(a)return"n-resize"}switch(t){case"horizontal":return"ew-resize";case"intersection":return"move";case"vertical":return"ns-resize"}}function Zn(){ie!==null&&(document.head.removeChild(ie),nt=null,ie=null,_e=-1)}function Oe(t,n){var s,r;const o=Jn(t,n);if(nt!==o){if(nt=o,ie===null&&(ie=document.createElement("style"),document.head.appendChild(ie)),_e>=0){var a;(a=ie.sheet)===null||a===void 0||a.removeRule(_e)}_e=(s=(r=ie.sheet)===null||r===void 0?void 0:r.insertRule(`*{cursor: ${o} !important;}`))!==null&&s!==void 0?s:-1}}function Ut(t){return t.type==="keydown"}function Vt(t){return t.type.startsWith("pointer")}function qt(t){return t.type.startsWith("mouse")}function Ge(t){if(Vt(t)){if(t.isPrimary)return{x:t.clientX,y:t.clientY}}else if(qt(t))return{x:t.clientX,y:t.clientY};return{x:1/0,y:1/0}}function Qn(){if(typeof matchMedia=="function")return matchMedia("(pointer:coarse)").matches?"coarse":"fine"}function es(t,n,s){return t.x<n.x+n.width&&t.x+t.width>n.x&&t.y<n.y+n.height&&t.y+t.height>n.y}function ts(t,n){if(t===n)throw new Error("Cannot compare node with itself");const s={a:zt(t),b:zt(n)};let r;for(;s.a.at(-1)===s.b.at(-1);)t=s.a.pop(),n=s.b.pop(),r=t;I(r,"Stacking order can only be calculated for elements with a common ancestor");const o={a:St(bt(s.a)),b:St(bt(s.b))};if(o.a===o.b){const a=r.childNodes,i={a:s.a.at(-1),b:s.b.at(-1)};let c=a.length;for(;c--;){const d=a[c];if(d===i.a)return 1;if(d===i.b)return-1}}return Math.sign(o.a-o.b)}const ns=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function ss(t){var n;const s=getComputedStyle((n=Kt(t))!==null&&n!==void 0?n:t).display;return s==="flex"||s==="inline-flex"}function rs(t){const n=getComputedStyle(t);return!!(n.position==="fixed"||n.zIndex!=="auto"&&(n.position!=="static"||ss(t))||+n.opacity<1||"transform"in n&&n.transform!=="none"||"webkitTransform"in n&&n.webkitTransform!=="none"||"mixBlendMode"in n&&n.mixBlendMode!=="normal"||"filter"in n&&n.filter!=="none"||"webkitFilter"in n&&n.webkitFilter!=="none"||"isolation"in n&&n.isolation==="isolate"||ns.test(n.willChange)||n.webkitOverflowScrolling==="touch")}function bt(t){let n=t.length;for(;n--;){const s=t[n];if(I(s,"Missing node"),rs(s))return s}return null}function St(t){return t&&Number(getComputedStyle(t).zIndex)||0}function zt(t){const n=[];for(;t;)n.push(t),t=Kt(t);return n}function Kt(t){const{parentNode:n}=t;return n&&n instanceof ShadowRoot?n.host:n}const Ot=1,Wt=2,Xt=4,Yt=8,as=Qn()==="coarse";let ee=[],ye=!1,fe=new Map,Ue=new Map;const ke=new Set;function is(t,n,s,r,o){var a;const{ownerDocument:i}=n,c={direction:s,element:n,hitAreaMargins:r,setResizeHandlerState:o},d=(a=fe.get(i))!==null&&a!==void 0?a:0;return fe.set(i,d+1),ke.add(c),$e(),function(){var w;Ue.delete(t),ke.delete(c);const g=(w=fe.get(i))!==null&&w!==void 0?w:1;if(fe.set(i,g-1),$e(),g===1&&fe.delete(i),ee.includes(c)){const f=ee.indexOf(c);f>=0&&ee.splice(f,1),ot(),o("up",!0,null)}}}function ls(t){const{target:n}=t,{x:s,y:r}=Ge(t);ye=!0,lt({target:n,x:s,y:r}),$e(),ee.length>0&&(Te("down",t),t.preventDefault(),Jt(n)||t.stopImmediatePropagation())}function We(t){const{x:n,y:s}=Ge(t);if(ye&&t.buttons===0&&(ye=!1,Te("up",t)),!ye){const{target:r}=t;lt({target:r,x:n,y:s})}Te("move",t),ot(),ee.length>0&&t.preventDefault()}function Xe(t){const{target:n}=t,{x:s,y:r}=Ge(t);Ue.clear(),ye=!1,ee.length>0&&(t.preventDefault(),Jt(n)||t.stopImmediatePropagation()),Te("up",t),lt({target:n,x:s,y:r}),ot(),$e()}function Jt(t){let n=t;for(;n;){if(n.hasAttribute(q.resizeHandle))return!0;n=n.parentElement}return!1}function lt({target:t,x:n,y:s}){ee.splice(0);let r=null;(t instanceof HTMLElement||t instanceof SVGElement)&&(r=t),ke.forEach(o=>{const{element:a,hitAreaMargins:i}=o,c=a.getBoundingClientRect(),{bottom:d,left:h,right:w,top:g}=c,f=as?i.coarse:i.fine;if(n>=h-f&&n<=w+f&&s>=g-f&&s<=d+f){if(r!==null&&document.contains(r)&&a!==r&&!a.contains(r)&&!r.contains(a)&&ts(r,a)>0){let j=r,x=!1;for(;j&&!j.contains(a);){if(es(j.getBoundingClientRect(),c)){x=!0;break}j=j.parentElement}if(x)return}ee.push(o)}})}function Ye(t,n){Ue.set(t,n)}function ot(){let t=!1,n=!1;ee.forEach(r=>{const{direction:o}=r;o==="horizontal"?t=!0:n=!0});let s=0;Ue.forEach(r=>{s|=r}),t&&n?Oe("intersection",s):t?Oe("horizontal",s):n?Oe("vertical",s):Zn()}let Je=new AbortController;function $e(){Je.abort(),Je=new AbortController;const t={capture:!0,signal:Je.signal};ke.size&&(ye?(ee.length>0&&fe.forEach((n,s)=>{const{body:r}=s;n>0&&(r.addEventListener("contextmenu",Xe,t),r.addEventListener("pointerleave",We,t),r.addEventListener("pointermove",We,t))}),window.addEventListener("pointerup",Xe,t),window.addEventListener("pointercancel",Xe,t)):fe.forEach((n,s)=>{const{body:r}=s;n>0&&(r.addEventListener("pointerdown",ls,t),r.addEventListener("pointermove",We,t))}))}function Te(t,n){ke.forEach(s=>{const{setResizeHandlerState:r}=s,o=ee.includes(s);r(t,o,n)})}function os(){const[t,n]=l.useState(0);return l.useCallback(()=>n(s=>s+1),[])}function I(t,n){if(!t)throw console.error(n),Error(n)}function xe(t,n,s=at){return t.toFixed(s)===n.toFixed(s)?0:t>n?1:-1}function re(t,n,s=at){return xe(t,n,s)===0}function Z(t,n,s){return xe(t,n,s)===0}function cs(t,n,s){if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++){const o=t[r],a=n[r];if(!Z(o,a,s))return!1}return!0}function ve({panelConstraints:t,panelIndex:n,size:s}){const r=t[n];I(r!=null,`Panel constraints not found for index ${n}`);let{collapsedSize:o=0,collapsible:a,maxSize:i=100,minSize:c=0}=r;if(xe(s,c)<0)if(a){const d=(o+c)/2;xe(s,d)<0?s=o:s=c}else s=c;return s=Math.min(i,s),s=parseFloat(s.toFixed(at)),s}function Ce({delta:t,initialLayout:n,panelConstraints:s,pivotIndices:r,prevLayout:o,trigger:a}){if(Z(t,0))return n;const i=[...n],[c,d]=r;I(c!=null,"Invalid first pivot index"),I(d!=null,"Invalid second pivot index");let h=0;if(a==="keyboard"){{const g=t<0?d:c,f=s[g];I(f,`Panel constraints not found for index ${g}`);const{collapsedSize:b=0,collapsible:j,minSize:x=0}=f;if(j){const C=n[g];if(I(C!=null,`Previous layout not found for panel index ${g}`),Z(C,b)){const p=x-C;xe(p,Math.abs(t))>0&&(t=t<0?0-p:p)}}}{const g=t<0?c:d,f=s[g];I(f,`No panel constraints found for index ${g}`);const{collapsedSize:b=0,collapsible:j,minSize:x=0}=f;if(j){const C=n[g];if(I(C!=null,`Previous layout not found for panel index ${g}`),Z(C,x)){const p=C-b;xe(p,Math.abs(t))>0&&(t=t<0?0-p:p)}}}}{const g=t<0?1:-1;let f=t<0?d:c,b=0;for(;;){const x=n[f];I(x!=null,`Previous layout not found for panel index ${f}`);const p=ve({panelConstraints:s,panelIndex:f,size:100})-x;if(b+=p,f+=g,f<0||f>=s.length)break}const j=Math.min(Math.abs(t),Math.abs(b));t=t<0?0-j:j}{let f=t<0?c:d;for(;f>=0&&f<s.length;){const b=Math.abs(t)-Math.abs(h),j=n[f];I(j!=null,`Previous layout not found for panel index ${f}`);const x=j-b,C=ve({panelConstraints:s,panelIndex:f,size:x});if(!Z(j,C)&&(h+=j-C,i[f]=C,h.toPrecision(3).localeCompare(Math.abs(t).toPrecision(3),void 0,{numeric:!0})>=0))break;t<0?f--:f++}}if(cs(o,i))return o;{const g=t<0?d:c,f=n[g];I(f!=null,`Previous layout not found for panel index ${g}`);const b=f+h,j=ve({panelConstraints:s,panelIndex:g,size:b});if(i[g]=j,!Z(j,b)){let x=b-j,p=t<0?d:c;for(;p>=0&&p<s.length;){const u=i[p];I(u!=null,`Previous layout not found for panel index ${p}`);const v=u+x,z=ve({panelConstraints:s,panelIndex:p,size:v});if(Z(u,z)||(x-=z-u,i[p]=z),Z(x,0))break;t>0?p--:p++}}}const w=i.reduce((g,f)=>f+g,0);return Z(w,100)?i:o}function us({layout:t,panelsArray:n,pivotIndices:s}){let r=0,o=100,a=0,i=0;const c=s[0];I(c!=null,"No pivot index found"),n.forEach((g,f)=>{const{constraints:b}=g,{maxSize:j=100,minSize:x=0}=b;f===c?(r=x,o=j):(a+=x,i+=j)});const d=Math.min(o,100-a),h=Math.max(r,100-i),w=t[c];return{valueMax:d,valueMin:h,valueNow:w}}function Pe(t,n=document){return Array.from(n.querySelectorAll(`[${q.resizeHandleId}][data-panel-group-id="${t}"]`))}function Zt(t,n,s=document){const o=Pe(t,s).findIndex(a=>a.getAttribute(q.resizeHandleId)===n);return o??null}function Qt(t,n,s){const r=Zt(t,n,s);return r!=null?[r,r+1]:[-1,-1]}function en(t,n=document){var s;if(n instanceof HTMLElement&&(n==null||(s=n.dataset)===null||s===void 0?void 0:s.panelGroupId)==t)return n;const r=n.querySelector(`[data-panel-group][data-panel-group-id="${t}"]`);return r||null}function Ve(t,n=document){const s=n.querySelector(`[${q.resizeHandleId}="${t}"]`);return s||null}function ds(t,n,s,r=document){var o,a,i,c;const d=Ve(n,r),h=Pe(t,r),w=d?h.indexOf(d):-1,g=(o=(a=s[w])===null||a===void 0?void 0:a.id)!==null&&o!==void 0?o:null,f=(i=(c=s[w+1])===null||c===void 0?void 0:c.id)!==null&&i!==void 0?i:null;return[g,f]}function fs({committedValuesRef:t,eagerValuesRef:n,groupId:s,layout:r,panelDataArray:o,panelGroupElement:a,setLayout:i}){l.useRef({didWarnAboutMissingResizeHandle:!1}),me(()=>{if(!a)return;const c=Pe(s,a);for(let d=0;d<o.length-1;d++){const{valueMax:h,valueMin:w,valueNow:g}=us({layout:r,panelsArray:o,pivotIndices:[d,d+1]}),f=c[d];if(f!=null){const b=o[d];I(b,`No panel data found for index "${d}"`),f.setAttribute("aria-controls",b.id),f.setAttribute("aria-valuemax",""+Math.round(h)),f.setAttribute("aria-valuemin",""+Math.round(w)),f.setAttribute("aria-valuenow",g!=null?""+Math.round(g):"")}}return()=>{c.forEach((d,h)=>{d.removeAttribute("aria-controls"),d.removeAttribute("aria-valuemax"),d.removeAttribute("aria-valuemin"),d.removeAttribute("aria-valuenow")})}},[s,r,o,a]),l.useEffect(()=>{if(!a)return;const c=n.current;I(c,"Eager values not found");const{panelDataArray:d}=c,h=en(s,a);I(h!=null,`No group found for id "${s}"`);const w=Pe(s,a);I(w,`No resize handles found for group id "${s}"`);const g=w.map(f=>{const b=f.getAttribute(q.resizeHandleId);I(b,"Resize handle element has no handle id attribute");const[j,x]=ds(s,b,d,a);if(j==null||x==null)return()=>{};const C=p=>{if(!p.defaultPrevented)switch(p.key){case"Enter":{p.preventDefault();const u=d.findIndex(v=>v.id===j);if(u>=0){const v=d[u];I(v,`No panel data found for index ${u}`);const z=r[u],{collapsedSize:_=0,collapsible:D,minSize:k=0}=v.constraints;if(z!=null&&D){const m=Ce({delta:Z(z,_)?k-_:_-z,initialLayout:r,panelConstraints:d.map(A=>A.constraints),pivotIndices:Qt(s,b,a),prevLayout:r,trigger:"keyboard"});r!==m&&i(m)}}break}}};return f.addEventListener("keydown",C),()=>{f.removeEventListener("keydown",C)}});return()=>{g.forEach(f=>f())}},[a,t,n,s,r,o,i])}function Ct(t,n){if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function tn(t,n){const s=t==="horizontal",{x:r,y:o}=Ge(n);return s?r:o}function ms(t,n,s,r,o){const a=s==="horizontal",i=Ve(n,o);I(i,`No resize handle element found for id "${n}"`);const c=i.getAttribute(q.groupId);I(c,"Resize handle element has no group id attribute");let{initialCursorPosition:d}=r;const h=tn(s,t),w=en(c,o);I(w,`No group element found for id "${c}"`);const g=w.getBoundingClientRect(),f=a?g.width:g.height;return(h-d)/f*100}function xs(t,n,s,r,o,a){if(Ut(t)){const i=s==="horizontal";let c=0;t.shiftKey?c=100:o!=null?c=o:c=10;let d=0;switch(t.key){case"ArrowDown":d=i?0:c;break;case"ArrowLeft":d=i?-c:0;break;case"ArrowRight":d=i?c:0;break;case"ArrowUp":d=i?0:-c;break;case"End":d=100;break;case"Home":d=-100;break}return d}else return r==null?0:ms(t,n,s,r,a)}function ps({panelDataArray:t}){const n=Array(t.length),s=t.map(a=>a.constraints);let r=0,o=100;for(let a=0;a<t.length;a++){const i=s[a];I(i,`Panel constraints not found for index ${a}`);const{defaultSize:c}=i;c!=null&&(r++,n[a]=c,o-=c)}for(let a=0;a<t.length;a++){const i=s[a];I(i,`Panel constraints not found for index ${a}`);const{defaultSize:c}=i;if(c!=null)continue;const d=t.length-r,h=o/d;r++,n[a]=h,o-=h}return n}function he(t,n,s){n.forEach((r,o)=>{const a=t[o];I(a,`Panel data not found for index ${o}`);const{callbacks:i,constraints:c,id:d}=a,{collapsedSize:h=0,collapsible:w}=c,g=s[d];if(g==null||r!==g){s[d]=r;const{onCollapse:f,onExpand:b,onResize:j}=i;j&&j(r,g),w&&(f||b)&&(b&&(g==null||re(g,h))&&!re(r,h)&&b(),f&&(g==null||!re(g,h))&&re(r,h)&&f())}})}function De(t,n){if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!=n[s])return!1;return!0}function hs({defaultSize:t,dragState:n,layout:s,panelData:r,panelIndex:o,precision:a=3}){const i=s[o];let c;return i==null?c=t!=null?t.toPrecision(a):"1":r.length===1?c="1":c=i.toPrecision(a),{flexBasis:0,flexGrow:c,flexShrink:1,overflow:"hidden",pointerEvents:n!==null?"none":void 0}}function gs(t,n=10){let s=null;return(...o)=>{s!==null&&clearTimeout(s),s=setTimeout(()=>{t(...o)},n)}}function Et(t){try{if(typeof localStorage<"u")t.getItem=n=>localStorage.getItem(n),t.setItem=(n,s)=>{localStorage.setItem(n,s)};else throw new Error("localStorage not supported in this environment")}catch(n){console.error(n),t.getItem=()=>null,t.setItem=()=>{}}}function nn(t){return`react-resizable-panels:${t}`}function sn(t){return t.map(n=>{const{constraints:s,id:r,idIsFromProps:o,order:a}=n;return o?r:a?`${a}:${JSON.stringify(s)}`:JSON.stringify(s)}).sort((n,s)=>n.localeCompare(s)).join(",")}function rn(t,n){try{const s=nn(t),r=n.getItem(s);if(r){const o=JSON.parse(r);if(typeof o=="object"&&o!=null)return o}}catch{}return null}function vs(t,n,s){var r,o;const a=(r=rn(t,s))!==null&&r!==void 0?r:{},i=sn(n);return(o=a[i])!==null&&o!==void 0?o:null}function ys(t,n,s,r,o){var a;const i=nn(t),c=sn(n),d=(a=rn(t,o))!==null&&a!==void 0?a:{};d[c]={expandToSizes:Object.fromEntries(s.entries()),layout:r};try{o.setItem(i,JSON.stringify(d))}catch(h){console.error(h)}}function Rt({layout:t,panelConstraints:n}){const s=[...t],r=s.reduce((a,i)=>a+i,0);if(s.length!==n.length)throw Error(`Invalid ${n.length} panel layout: ${s.map(a=>`${a}%`).join(", ")}`);if(!Z(r,100)&&s.length>0)for(let a=0;a<n.length;a++){const i=s[a];I(i!=null,`No layout data found for index ${a}`);const c=100/r*i;s[a]=c}let o=0;for(let a=0;a<n.length;a++){const i=s[a];I(i!=null,`No layout data found for index ${a}`);const c=ve({panelConstraints:n,panelIndex:a,size:i});i!=c&&(o+=i-c,s[a]=c)}if(!Z(o,0))for(let a=0;a<n.length;a++){const i=s[a];I(i!=null,`No layout data found for index ${a}`);const c=i+o,d=ve({panelConstraints:n,panelIndex:a,size:c});if(i!==d&&(o-=d-i,s[a]=d,Z(o,0)))break}return s}const js=100,Ee={getItem:t=>(Et(Ee),Ee.getItem(t)),setItem:(t,n)=>{Et(Ee),Ee.setItem(t,n)}},kt={};function an({autoSaveId:t=null,children:n,className:s="",direction:r,forwardedRef:o,id:a=null,onLayout:i=null,keyboardResizeBy:c=null,storage:d=Ee,style:h,tagName:w="div",...g}){const f=it(a),b=l.useRef(null),[j,x]=l.useState(null),[C,p]=l.useState([]),u=os(),v=l.useRef({}),z=l.useRef(new Map),_=l.useRef(0),D=l.useRef({autoSaveId:t,direction:r,dragState:j,id:f,keyboardResizeBy:c,onLayout:i,storage:d}),k=l.useRef({layout:C,panelDataArray:[],panelDataArrayChanged:!1});l.useRef({didLogIdAndOrderWarning:!1,didLogPanelConstraintsWarning:!1,prevPanelIds:[]}),l.useImperativeHandle(o,()=>({getId:()=>D.current.id,getLayout:()=>{const{layout:y}=k.current;return y},setLayout:y=>{const{onLayout:S}=D.current,{layout:R,panelDataArray:E}=k.current,N=Rt({layout:y,panelConstraints:E.map(P=>P.constraints)});Ct(R,N)||(p(N),k.current.layout=N,S&&S(N),he(E,N,v.current))}}),[]),me(()=>{D.current.autoSaveId=t,D.current.direction=r,D.current.dragState=j,D.current.id=f,D.current.onLayout=i,D.current.storage=d}),fs({committedValuesRef:D,eagerValuesRef:k,groupId:f,layout:C,panelDataArray:k.current.panelDataArray,setLayout:p,panelGroupElement:b.current}),l.useEffect(()=>{const{panelDataArray:y}=k.current;if(t){if(C.length===0||C.length!==y.length)return;let S=kt[t];S==null&&(S=gs(ys,js),kt[t]=S);const R=[...y],E=new Map(z.current);S(t,R,E,C,d)}},[t,C,d]),l.useEffect(()=>{});const m=l.useCallback(y=>{const{onLayout:S}=D.current,{layout:R,panelDataArray:E}=k.current;if(y.constraints.collapsible){const N=E.map(te=>te.constraints),{collapsedSize:P=0,panelSize:$,pivotIndices:U}=de(E,y,R);if(I($!=null,`Panel size not found for panel "${y.id}"`),!re($,P)){z.current.set(y.id,$);const ne=ge(E,y)===E.length-1?$-P:P-$,V=Ce({delta:ne,initialLayout:R,panelConstraints:N,pivotIndices:U,prevLayout:R,trigger:"imperative-api"});De(R,V)||(p(V),k.current.layout=V,S&&S(V),he(E,V,v.current))}}},[]),A=l.useCallback((y,S)=>{const{onLayout:R}=D.current,{layout:E,panelDataArray:N}=k.current;if(y.constraints.collapsible){const P=N.map(Q=>Q.constraints),{collapsedSize:$=0,panelSize:U=0,minSize:te=0,pivotIndices:ne}=de(N,y,E),V=S??te;if(re(U,$)){const Q=z.current.get(y.id),be=Q!=null&&Q>=V?Q:V,qe=ge(N,y)===N.length-1?U-be:be-U,J=Ce({delta:qe,initialLayout:E,panelConstraints:P,pivotIndices:ne,prevLayout:E,trigger:"imperative-api"});De(E,J)||(p(J),k.current.layout=J,R&&R(J),he(N,J,v.current))}}},[]),L=l.useCallback(y=>{const{layout:S,panelDataArray:R}=k.current,{panelSize:E}=de(R,y,S);return I(E!=null,`Panel size not found for panel "${y.id}"`),E},[]),F=l.useCallback((y,S)=>{const{panelDataArray:R}=k.current,E=ge(R,y);return hs({defaultSize:S,dragState:j,layout:C,panelData:R,panelIndex:E})},[j,C]),T=l.useCallback(y=>{const{layout:S,panelDataArray:R}=k.current,{collapsedSize:E=0,collapsible:N,panelSize:P}=de(R,y,S);return I(P!=null,`Panel size not found for panel "${y.id}"`),N===!0&&re(P,E)},[]),K=l.useCallback(y=>{const{layout:S,panelDataArray:R}=k.current,{collapsedSize:E=0,collapsible:N,panelSize:P}=de(R,y,S);return I(P!=null,`Panel size not found for panel "${y.id}"`),!N||xe(P,E)>0},[]),B=l.useCallback(y=>{const{panelDataArray:S}=k.current;S.push(y),S.sort((R,E)=>{const N=R.order,P=E.order;return N==null&&P==null?0:N==null?-1:P==null?1:N-P}),k.current.panelDataArrayChanged=!0,u()},[u]);me(()=>{if(k.current.panelDataArrayChanged){k.current.panelDataArrayChanged=!1;const{autoSaveId:y,onLayout:S,storage:R}=D.current,{layout:E,panelDataArray:N}=k.current;let P=null;if(y){const U=vs(y,N,R);U&&(z.current=new Map(Object.entries(U.expandToSizes)),P=U.layout)}P==null&&(P=ps({panelDataArray:N}));const $=Rt({layout:P,panelConstraints:N.map(U=>U.constraints)});Ct(E,$)||(p($),k.current.layout=$,S&&S($),he(N,$,v.current))}}),me(()=>{const y=k.current;return()=>{y.layout=[]}},[]);const G=l.useCallback(y=>{let S=!1;const R=b.current;return R&&window.getComputedStyle(R,null).getPropertyValue("direction")==="rtl"&&(S=!0),function(N){N.preventDefault();const P=b.current;if(!P)return()=>null;const{direction:$,dragState:U,id:te,keyboardResizeBy:ne,onLayout:V}=D.current,{layout:Q,panelDataArray:be}=k.current,{initialLayout:Ie}=U??{},qe=Qt(te,y,P);let J=xs(N,y,$,U,ne,P);const ct=$==="horizontal";ct&&S&&(J=-J);const un=be.map(dn=>dn.constraints),Se=Ce({delta:J,initialLayout:Ie??Q,panelConstraints:un,pivotIndices:qe,prevLayout:Q,trigger:Ut(N)?"keyboard":"mouse-or-touch"}),ut=!De(Q,Se);(Vt(N)||qt(N))&&_.current!=J&&(_.current=J,!ut&&J!==0?ct?Ye(y,J<0?Ot:Wt):Ye(y,J<0?Xt:Yt):Ye(y,0)),ut&&(p(Se),k.current.layout=Se,V&&V(Se),he(be,Se,v.current))}},[]),O=l.useCallback((y,S)=>{const{onLayout:R}=D.current,{layout:E,panelDataArray:N}=k.current,P=N.map(Q=>Q.constraints),{panelSize:$,pivotIndices:U}=de(N,y,E);I($!=null,`Panel size not found for panel "${y.id}"`);const ne=ge(N,y)===N.length-1?$-S:S-$,V=Ce({delta:ne,initialLayout:E,panelConstraints:P,pivotIndices:U,prevLayout:E,trigger:"imperative-api"});De(E,V)||(p(V),k.current.layout=V,R&&R(V),he(N,V,v.current))},[]),oe=l.useCallback((y,S)=>{const{layout:R,panelDataArray:E}=k.current,{collapsedSize:N=0,collapsible:P}=S,{collapsedSize:$=0,collapsible:U,maxSize:te=100,minSize:ne=0}=y.constraints,{panelSize:V}=de(E,y,R);V!=null&&(P&&U&&re(V,N)?re(N,$)||O(y,$):V<ne?O(y,ne):V>te&&O(y,te))},[O]),ce=l.useCallback((y,S)=>{const{direction:R}=D.current,{layout:E}=k.current;if(!b.current)return;const N=Ve(y,b.current);I(N,`Drag handle element not found for id "${y}"`);const P=tn(R,S);x({dragHandleId:y,dragHandleRect:N.getBoundingClientRect(),initialCursorPosition:P,initialLayout:E})},[]),ue=l.useCallback(()=>{x(null)},[]),pe=l.useCallback(y=>{const{panelDataArray:S}=k.current,R=ge(S,y);R>=0&&(S.splice(R,1),delete v.current[y.id],k.current.panelDataArrayChanged=!0,u())},[u]),H=l.useMemo(()=>({collapsePanel:m,direction:r,dragState:j,expandPanel:A,getPanelSize:L,getPanelStyle:F,groupId:f,isPanelCollapsed:T,isPanelExpanded:K,reevaluatePanelConstraints:oe,registerPanel:B,registerResizeHandle:G,resizePanel:O,startDragging:ce,stopDragging:ue,unregisterPanel:pe,panelGroupElement:b.current}),[m,j,r,A,L,F,f,T,K,oe,B,G,O,ce,ue,pe]),W={display:"flex",flexDirection:r==="horizontal"?"row":"column",height:"100%",overflow:"hidden",width:"100%"};return l.createElement(Be.Provider,{value:H},l.createElement(w,{...g,children:n,className:s,id:a,ref:b,style:{...W,...h},[q.group]:"",[q.groupDirection]:r,[q.groupId]:f}))}const ln=l.forwardRef((t,n)=>l.createElement(an,{...t,forwardedRef:n}));an.displayName="PanelGroup";ln.displayName="forwardRef(PanelGroup)";function ge(t,n){return t.findIndex(s=>s===n||s.id===n.id)}function de(t,n,s){const r=ge(t,n),a=r===t.length-1?[r-1,r]:[r,r+1],i=s[r];return{...n.constraints,panelSize:i,pivotIndices:a}}function ws({disabled:t,handleId:n,resizeHandler:s,panelGroupElement:r}){l.useEffect(()=>{if(t||s==null||r==null)return;const o=Ve(n,r);if(o==null)return;const a=i=>{if(!i.defaultPrevented)switch(i.key){case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"End":case"Home":{i.preventDefault(),s(i);break}case"F6":{i.preventDefault();const c=o.getAttribute(q.groupId);I(c,`No group element found for id "${c}"`);const d=Pe(c,r),h=Zt(c,n,r);I(h!==null,`No resize element found for id "${n}"`);const w=i.shiftKey?h>0?h-1:d.length-1:h+1<d.length?h+1:0;d[w].focus();break}}};return o.addEventListener("keydown",a),()=>{o.removeEventListener("keydown",a)}},[r,t,n,s])}function on({children:t=null,className:n="",disabled:s=!1,hitAreaMargins:r,id:o,onBlur:a,onClick:i,onDragging:c,onFocus:d,onPointerDown:h,onPointerUp:w,style:g={},tabIndex:f=0,tagName:b="div",...j}){var x,C;const p=l.useRef(null),u=l.useRef({onClick:i,onDragging:c,onPointerDown:h,onPointerUp:w});l.useEffect(()=>{u.current.onClick=i,u.current.onDragging=c,u.current.onPointerDown=h,u.current.onPointerUp=w});const v=l.useContext(Be);if(v===null)throw Error("PanelResizeHandle components must be rendered within a PanelGroup container");const{direction:z,groupId:_,registerResizeHandle:D,startDragging:k,stopDragging:m,panelGroupElement:A}=v,L=it(o),[F,T]=l.useState("inactive"),[K,B]=l.useState(!1),[G,O]=l.useState(null),oe=l.useRef({state:F});me(()=>{oe.current.state=F}),l.useEffect(()=>{if(s)O(null);else{const H=D(L);O(()=>H)}},[s,L,D]);const ce=(x=r==null?void 0:r.coarse)!==null&&x!==void 0?x:15,ue=(C=r==null?void 0:r.fine)!==null&&C!==void 0?C:5;l.useEffect(()=>{if(s||G==null)return;const H=p.current;I(H,"Element ref not attached");let W=!1;return is(L,H,z,{coarse:ce,fine:ue},(S,R,E)=>{if(!R){T("inactive");return}switch(S){case"down":{T("drag"),W=!1,I(E,'Expected event to be defined for "down" action'),k(L,E);const{onDragging:N,onPointerDown:P}=u.current;N==null||N(!0),P==null||P();break}case"move":{const{state:N}=oe.current;W=!0,N!=="drag"&&T("hover"),I(E,'Expected event to be defined for "move" action'),G(E);break}case"up":{T("hover"),m();const{onClick:N,onDragging:P,onPointerUp:$}=u.current;P==null||P(!1),$==null||$(),W||N==null||N();break}}})},[ce,z,s,ue,D,L,G,k,m]),ws({disabled:s,handleId:L,resizeHandler:G,panelGroupElement:A});const pe={touchAction:"none",userSelect:"none"};return l.createElement(b,{...j,children:t,className:n,id:o,onBlur:()=>{B(!1),a==null||a()},onFocus:()=>{B(!0),d==null||d()},ref:p,role:"separator",style:{...pe,...g},tabIndex:f,[q.groupDirection]:z,[q.groupId]:_,[q.resizeHandle]:"",[q.resizeHandleActive]:F==="drag"?"pointer":K?"keyboard":void 0,[q.resizeHandleEnabled]:!s,[q.resizeHandleId]:L,[q.resizeHandleState]:F})}on.displayName="PanelResizeHandle";const Ns=({className:t,...n})=>e.jsx(ln,{className:Me("flex h-full w-full data-[panel-group-direction=vertical]:flex-col",t),...n}),Ze=Gt,Pt=({withHandle:t,className:n,...s})=>e.jsx(on,{className:Me("relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 [&[data-panel-group-direction=vertical]>div]:rotate-90",n),...s,children:t&&e.jsx("div",{className:"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border",children:e.jsx(Gn,{className:"h-2.5 w-2.5"})})});function bs({appointmentId:t,appointment:n}){const[s,r]=l.useState(n.transcript||""),[o,a]=l.useState(!0),[i,c]=l.useState(!1),[d,h]=l.useState(!1),[w,g]=l.useState(null);l.useEffect(()=>{f()},[t]);const f=async()=>{try{if(a(!0),g(null),n.transcript){r(n.transcript),a(!1);return}try{const x=await At(t);x&&r(x)}catch{console.log("No recordings found, using empty transcript")}}catch(x){console.error("Error loading transcript:",x),g(x instanceof Error?x.message:"Не удалось загрузить транскрипт")}finally{a(!1)}},b=async()=>{try{c(!0);const{error:x}=await le.from("appointments").update({transcript:s,updated_at:new Date().toISOString()}).eq("id",t);if(x)throw x;h(!1)}catch(x){console.error("Error saving transcript:",x),g(x instanceof Error?x.message:"Не удалось сохранить транскрипт")}finally{c(!1)}},j=async x=>{var p;const C=(p=x.target.files)==null?void 0:p[0];if(C){try{const u=await C.text();r(u),h(!0)}catch(u){console.error("Error reading file:",u),g("Не удалось прочитать файл")}x.target.value=""}};return o?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(Y,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):w&&!s?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx(ae,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-sm text-destructive",children:w})]}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 px-4 pb-4 flex items-center gap-2",children:[e.jsx("input",{type:"file",id:"transcript-upload",accept:".txt,.md",onChange:j,className:"hidden"}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>{var x;return(x=document.getElementById("transcript-upload"))==null?void 0:x.click()},children:[e.jsx(st,{className:"h-4 w-4 mr-2"}),"Загрузить"]}),!d&&s&&e.jsx(M,{variant:"outline",size:"sm",onClick:()=>h(!0),children:"Редактировать"}),d&&e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"default",size:"sm",onClick:b,disabled:i,children:i?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):"Сохранить"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{r(n.transcript||""),h(!1)},children:"Отмена"})]})]}),!s&&!d?e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 text-center",children:[e.jsx(ae,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Нет транскрипта для этой сессии"}),e.jsx(M,{variant:"outline",onClick:()=>h(!0),children:"Добавить транскрипт"})]}):d?e.jsx("div",{className:"flex-1 px-4 pb-4",children:e.jsx(rt,{value:s,onChange:x=>r(x.target.value),placeholder:"Вставьте или введите транскрипт сессии...",className:"h-full min-h-[300px] font-mono text-sm resize-none"})}):e.jsx(we,{className:"flex-1 px-4",children:e.jsx("div",{className:"pb-4",children:e.jsx("pre",{className:"whitespace-pre-wrap font-sans text-sm leading-relaxed",children:s})})})]})}async function cn(t){const{data:n,error:s}=await le.from("session_notes").select("*").eq("appointment_id",t).order("created_at",{ascending:!0});if(s)throw console.error("Error fetching session notes:",s),new Error(`Failed to fetch session notes: ${s.message}`);return n||[]}async function It(t){const{appointmentId:n,userId:s,content:r,source:o,originalFilename:a}=t,{data:i,error:c}=await le.from("session_notes").insert({appointment_id:n,user_id:s,content:r,source:o,original_filename:a||null}).select().single();if(c)throw console.error("Error creating session note:",c),new Error(`Failed to create session note: ${c.message}`);if(!i)throw new Error("Failed to create session note: No data returned");return i}async function Ss(t){const{error:n}=await le.from("session_notes").delete().eq("id",t);if(n)throw console.error("Error deleting session note:",n),new Error(`Failed to delete session note: ${n.message}`)}function zs({appointmentId:t}){const[n,s]=l.useState([]),[r,o]=l.useState(!0),[a,i]=l.useState(!1),[c,d]=l.useState(""),[h,w]=l.useState(!1),[g,f]=l.useState(null),{toast:b}=Ne();l.useEffect(()=>{j()},[t]);const j=async()=>{try{o(!0),f(null);const u=await cn(t);s(u)}catch(u){console.error("Error loading notes:",u),f(u instanceof Error?u.message:"Не удалось загрузить заметки")}finally{o(!1)}},x=async()=>{if(c.trim())try{w(!0);const{data:{user:u}}=await le.auth.getUser();if(!u)throw new Error("Необходима авторизация");await It({appointmentId:t,userId:u.id,content:c.trim(),source:"manual"}),d(""),i(!1),await j(),b({title:"Заметка добавлена",description:"Заметка успешно сохранена"})}catch(u){console.error("Error adding note:",u),b({title:"Ошибка",description:u instanceof Error?u.message:"Не удалось добавить заметку",variant:"destructive"})}finally{w(!1)}},C=async u=>{try{await Ss(u),await j(),b({title:"Заметка удалена"})}catch(v){console.error("Error deleting note:",v),b({title:"Ошибка",description:v instanceof Error?v.message:"Не удалось удалить заметку",variant:"destructive"})}},p=async u=>{var z;const v=(z=u.target.files)==null?void 0:z[0];if(v)try{w(!0);const{data:{user:_}}=await le.auth.getUser();if(!_)throw new Error("Необходима авторизация");const D=await v.text();await It({appointmentId:t,userId:_.id,content:D,source:"file",originalFilename:v.name}),await j(),b({title:"Файл загружен",description:`Заметка из файла "${v.name}" добавлена`})}catch(_){console.error("Error uploading file:",_),b({title:"Ошибка",description:_ instanceof Error?_.message:"Не удалось загрузить файл",variant:"destructive"})}finally{w(!1),u.target.value=""}};return r?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(Y,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):g?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx(ae,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-sm text-destructive",children:g})]}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 px-4 pb-4 flex items-center gap-2",children:[e.jsx("input",{type:"file",id:"notes-upload",accept:".txt,.md",onChange:p,className:"hidden"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{var u;return(u=document.getElementById("notes-upload"))==null?void 0:u.click()},disabled:h,children:h?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(gt,{className:"h-4 w-4 mr-2"}),"Из файла"]})}),!a&&e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>i(!0),children:[e.jsx(gt,{className:"h-4 w-4 mr-2"}),"Новая заметка"]})]}),a&&e.jsxs("div",{className:"flex-shrink-0 px-4 pb-4 space-y-2",children:[e.jsx(rt,{value:c,onChange:u=>d(u.target.value),placeholder:"Введите заметку...",className:"min-h-[100px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{size:"sm",onClick:x,disabled:h||!c.trim(),children:h?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):"Добавить"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{i(!1),d("")},children:"Отмена"})]})]}),n.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 text-center",children:[e.jsx(ae,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет заметок для этой сессии"})]}):e.jsx(we,{className:"flex-1 px-4",children:e.jsx("div",{className:"pb-4 space-y-3",children:n.map(u=>e.jsx(Fe,{children:e.jsx(He,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[u.original_filename&&e.jsxs("div",{className:"text-xs text-muted-foreground mb-2 flex items-center gap-1",children:[e.jsx(ae,{className:"h-3 w-3"}),u.original_filename]}),e.jsx("pre",{className:"whitespace-pre-wrap font-sans text-sm leading-relaxed",children:u.content}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:new Date(u.created_at).toLocaleString("ru-RU")})]}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>C(u.id),className:"h-8 w-8 p-0 text-muted-foreground hover:text-destructive",children:e.jsx(Ht,{className:"h-4 w-4"})})]})})},u.id))})})]})}function Cs({appointmentId:t}){const[n,s]=l.useState([]),[r,o]=l.useState(!0),[a,i]=l.useState(!1),[c,d]=l.useState(null),{toast:h}=Ne();l.useEffect(()=>{w()},[t]);const w=async()=>{try{o(!0),d(null);const p=await hn(t);s(p)}catch(p){console.error("Error loading recordings:",p),d(p instanceof Error?p.message:"Не удалось загрузить записи")}finally{o(!1)}},g=async p=>{var v;const u=(v=p.target.files)==null?void 0:v[0];if(u)try{i(!0);const{data:{user:z}}=await le.auth.getUser();if(!z)throw new Error("Необходима авторизация");const _=await Lt(u,t,z.id);await Dt({appointmentId:t,userId:z.id,filePath:_,fileName:u.name,fileSizeBytes:u.size,mimeType:u.type}),await w(),h({title:"Файл загружен",description:`Аудиофайл "${u.name}" успешно загружен`})}catch(z){console.error("Error uploading file:",z),h({title:"Ошибка загрузки",description:z instanceof Error?z.message:"Не удалось загрузить файл",variant:"destructive"})}finally{i(!1),p.target.value=""}},f=async p=>{try{await vn(p),await w(),h({title:"Запись удалена"})}catch(u){console.error("Error deleting recording:",u),h({title:"Ошибка",description:u instanceof Error?u.message:"Не удалось удалить запись",variant:"destructive"})}},b=async p=>{try{const u=await gn(p.file_path);window.open(u,"_blank")}catch(u){console.error("Error getting download URL:",u),h({title:"Ошибка",description:"Не удалось получить ссылку для скачивания",variant:"destructive"})}},j=p=>p?p<1024?`${p} B`:p<1024*1024?`${(p/1024).toFixed(1)} KB`:`${(p/(1024*1024)).toFixed(1)} MB`:"неизвестно",x=p=>{if(!p)return"неизвестно";const u=Math.floor(p/60),v=p%60;return`${u}:${v.toString().padStart(2,"0")}`},C=p=>{switch(p){case"completed":return e.jsx(X,{variant:"default",className:"bg-green-500",children:"Расшифровано"});case"processing":return e.jsx(X,{variant:"secondary",children:"Расшифровка..."});case"failed":return e.jsx(X,{variant:"destructive",children:"Ошибка"});default:return e.jsx(X,{variant:"outline",children:"Ожидание"})}};return r?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(Y,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):c?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx(ae,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-sm text-destructive",children:c})]}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 px-4 pb-4 flex items-center gap-2",children:[e.jsx("input",{type:"file",id:"audio-upload",accept:"audio/*",onChange:g,className:"hidden"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{var p;return(p=document.getElementById("audio-upload"))==null?void 0:p.click()},disabled:a,children:a?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(st,{className:"h-4 w-4 mr-2"}),"Загрузить аудио"]})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"MP3, WAV, WebM и другие форматы"})]}),n.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 text-center",children:[e.jsx(jt,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет загруженных аудиозаписей"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Загрузите аудиофайл для транскрибации"})]}):e.jsx(we,{className:"flex-1 px-4",children:e.jsx("div",{className:"pb-4 space-y-3",children:n.map(p=>e.jsx(Fe,{children:e.jsx(He,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(jt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:p.file_name||"Аудиозапись"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs text-muted-foreground mb-2",children:[e.jsx("span",{children:j(p.file_size_bytes)}),p.duration_seconds&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsx("span",{children:x(p.duration_seconds)})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:C(p.transcript_status)}),p.transcript&&e.jsx("div",{className:"mt-3 p-2 bg-muted rounded text-xs",children:e.jsx("p",{className:"line-clamp-3",children:p.transcript})}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:new Date(p.created_at).toLocaleString("ru-RU")})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>b(p),className:"h-8 w-8 p-0",title:"Скачать",children:e.jsx(Un,{className:"h-4 w-4"})}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>f(p.id),className:"h-8 w-8 p-0 text-muted-foreground hover:text-destructive",title:"Удалить",children:e.jsx(Ht,{className:"h-4 w-4"})})]})]})})},p.id))})})]})}const Es=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4","audio/wav"];function Rs(){for(const t of Es)if(MediaRecorder.isTypeSupported(t))return t;return"audio/webm"}function ks(t){const{appointmentId:n,specialistId:s,enableEncryption:r=!1,mimeType:o,onRecordingComplete:a,onError:i}=t,[c,d]=l.useState("idle"),[h,w]=l.useState(0),[g,f]=l.useState(null),[b,j]=l.useState(0),[x,C]=l.useState(null),[p,u]=l.useState([]),v=l.useRef(null),z=l.useRef(null),_=l.useRef([]),D=l.useRef(0),k=l.useRef(0),m=l.useRef(null),A=l.useRef(null),L=l.useRef(null),F=o||Rs(),T=l.useCallback(async()=>{try{const H=await yn(n);u(H)}catch(H){se.error("Failed to load local recordings:",H)}},[n]);l.useEffect(()=>{T()},[T]);const K=l.useCallback(()=>{m.current&&(clearInterval(m.current),m.current=null),L.current&&(cancelAnimationFrame(L.current),L.current=null),z.current&&(z.current.getTracks().forEach(H=>H.stop()),z.current=null),A.current=null,v.current=null,_.current=[],j(0)},[]),B=l.useCallback(()=>{if(!A.current)return;const H=new Uint8Array(A.current.frequencyBinCount);A.current.getByteFrequencyData(H);const W=H.reduce((y,S)=>y+S,0)/H.length;j(W/255),c==="recording"&&(L.current=requestAnimationFrame(B))},[c]),G=l.useCallback(()=>{if(D.current>0){const H=Date.now()-D.current-k.current;w(Math.floor(H/1e3))}},[]),O=l.useCallback(async()=>{try{f(null);const H=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});z.current=H;const W=new AudioContext,y=W.createMediaStreamSource(H),S=W.createAnalyser();S.fftSize=256,y.connect(S),A.current=S;const R=new MediaRecorder(H,{mimeType:F});v.current=R,_.current=[];const E=jn();C(E),R.ondataavailable=P=>{P.data.size>0&&_.current.push(P.data)},R.onerror=P=>{const $=new Error("Recording error occurred");f($),i==null||i($),K(),d("idle")},R.start(1e3);const N={id:E,appointmentId:n,specialistId:s,mimeType:F,durationSeconds:0,fileSizeBytes:0,status:"recording",retryCount:0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await dt(N),await T(),D.current=Date.now(),k.current=0,m.current=setInterval(G,1e3),L.current=requestAnimationFrame(B),d("recording"),se.log("Recording started:",E)}catch(H){const W=H instanceof Error?H:new Error("Failed to start recording");f(W),i==null||i(W),K(),se.error("Failed to start recording:",H)}},[n,s,F,K,T,G,B,i]),oe=l.useCallback(()=>{v.current&&c==="recording"&&(v.current.pause(),k.current=Date.now()-D.current-h*1e3,d("paused"),x&&ft(x,"paused").catch(se.error),se.log("Recording paused"))},[c,h,x]),ce=l.useCallback(()=>{v.current&&c==="paused"&&(v.current.resume(),D.current=Date.now()-h*1e3,k.current=0,d("recording"),x&&ft(x,"recording").catch(se.error),L.current=requestAnimationFrame(B),se.log("Recording resumed"))},[c,h,x,B]),ue=l.useCallback(async()=>!v.current||!x?null:(d("stopping"),new Promise(H=>{const W=v.current,y=x;W.onstop=async()=>{try{const S=new Blob(_.current,{type:F}),R=S.size,E=h;let N={id:y,appointmentId:n,specialistId:s,blob:S,mimeType:F,durationSeconds:E,fileSizeBytes:R,status:"completed",retryCount:0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};if(r){const P=await wn(),{encryptedBlob:$,iv:U}=await Nn(S,P);N={...N,blob:void 0,encryptedBlob:$,iv:Sn(U),encryptionKey:await bn(P)}}await dt(N),await T(),K(),d("idle"),w(0),C(null),a==null||a(N),se.log("Recording completed:",y,{durationSeconds:E,fileSizeBytes:R}),H(N)}catch(S){se.error("Error processing recording:",S);const R=S instanceof Error?S:new Error("Failed to process recording");f(R),i==null||i(R),K(),d("idle"),H(null)}},W.stop()})),[x,n,s,F,h,r,K,T,a,i]),pe=l.useCallback(()=>{v.current&&v.current.stop(),K(),d("idle"),w(0),C(null),se.log("Recording cancelled")},[K]);return l.useEffect(()=>()=>{K()},[K]),{state:c,isRecording:c==="recording",isPaused:c==="paused",duration:h,error:g,currentRecordingId:x,localRecordings:p,audioLevel:b,startRecording:O,pauseRecording:oe,resumeRecording:ce,stopRecording:ue,cancelRecording:pe,refreshRecordings:T}}function Qe(t){const n=Math.floor(t/60),s=t%60;return`${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}function Ps(t){return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`}function Is({appointmentId:t,specialistId:n,userId:s,onRecordingUploaded:r,className:o}){const{toast:a}=Ne(),[i,c]=l.useState(new Set),{state:d,isRecording:h,isPaused:w,duration:g,error:f,audioLevel:b,localRecordings:j,startRecording:x,pauseRecording:C,resumeRecording:p,stopRecording:u,cancelRecording:v,refreshRecordings:z}=ks({appointmentId:t,specialistId:n,enableEncryption:!0,onRecordingComplete:m=>{a({title:"Запись сохранена",description:`Длительность: ${Qe(m.durationSeconds)}. Зашифровано локально.`})},onError:m=>{a({title:"Ошибка записи",description:m.message,variant:"destructive"})}}),_=l.useCallback(async m=>{if(!(!(m.blob||m.encryptedBlob)||i.has(m.id))){c(L=>new Set(L).add(m.id));try{let L;if(m.encryptedBlob&&m.encryptionKey&&m.iv){const B=await zn(m.encryptionKey),G=Cn(m.iv);L=await En(m.encryptedBlob,B,G,m.mimeType)}else if(m.blob)L=m.blob;else throw new Error("No audio data available");const F=new File([L],`recording_${m.id}.webm`,{type:m.mimeType}),T=await Lt(F,t,s),K=await Dt({appointmentId:t,userId:s,filePath:T,fileName:F.name,fileSizeBytes:F.size,mimeType:m.mimeType,durationSeconds:m.durationSeconds});await mt(m.id),await z(),a({title:"Запись загружена",description:"Аудио успешно сохранено на сервер"}),r==null||r(K.id)}catch(L){console.error("Upload error:",L),a({title:"Ошибка загрузки",description:L instanceof Error?L.message:"Не удалось загрузить запись",variant:"destructive"})}finally{c(L=>{const F=new Set(L);return F.delete(m.id),F})}}},[t,s,i,z,a,r]),D=l.useCallback(async m=>{try{await mt(m),await z(),a({title:"Запись удалена",description:"Локальная запись удалена"})}catch{a({title:"Ошибка",description:"Не удалось удалить запись",variant:"destructive"})}},[z,a]),k=j.filter(m=>m.status==="completed"||m.status==="failed");return e.jsxs(Fe,{className:Me("",o),children:[e.jsx(_t,{className:"pb-3",children:e.jsxs(Mt,{className:"text-base flex items-center gap-2",children:[e.jsx(Ke,{className:"h-4 w-4"}),"Аудиозапись",e.jsxs(X,{variant:"outline",className:"ml-auto text-xs font-normal gap-1",children:[e.jsx(vt,{className:"h-3 w-3"}),"E2E"]})]})}),e.jsxs(He,{className:"space-y-4",children:[(h||w)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:w?"На паузе":"Запись..."}),e.jsx("span",{className:"font-mono font-medium",children:Qe(g)})]}),e.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:Me("h-full transition-all duration-100",w?"bg-yellow-500":"bg-red-500"),style:{width:`${Math.min(b*100,100)}%`}})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[d==="idle"&&e.jsxs(M,{onClick:x,variant:"default",size:"sm",className:"gap-2",children:[e.jsx(Ke,{className:"h-4 w-4"}),"Начать запись"]}),h&&e.jsxs(e.Fragment,{children:[e.jsxs(M,{onClick:C,variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(On,{className:"h-4 w-4"}),"Пауза"]}),e.jsxs(M,{onClick:u,variant:"destructive",size:"sm",className:"gap-2",children:[e.jsx(wt,{className:"h-4 w-4"}),"Стоп"]})]}),w&&e.jsxs(e.Fragment,{children:[e.jsxs(M,{onClick:p,variant:"default",size:"sm",className:"gap-2",children:[e.jsx(Vn,{className:"h-4 w-4"}),"Продолжить"]}),e.jsxs(M,{onClick:u,variant:"destructive",size:"sm",className:"gap-2",children:[e.jsx(wt,{className:"h-4 w-4"}),"Стоп"]}),e.jsx(M,{onClick:v,variant:"ghost",size:"sm",children:"Отмена"})]}),d==="stopping"&&e.jsxs(M,{disabled:!0,variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(Y,{className:"h-4 w-4 animate-spin"}),"Сохранение..."]})]}),f&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[e.jsx(xt,{className:"h-4 w-4"}),f.message]}),k.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[e.jsxs("div",{className:"text-sm font-medium text-muted-foreground",children:["Ожидают загрузки (",k.length,")"]}),k.map(m=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[m.status==="failed"?e.jsx(xt,{className:"h-4 w-4 text-destructive"}):m.encryptedBlob?e.jsx(vt,{className:"h-4 w-4 text-green-600"}):e.jsx(Ke,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[Qe(m.durationSeconds),m.encryptedBlob&&e.jsx("span",{className:"text-xs text-green-600",children:"(зашифровано)"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:Ps(m.fileSizeBytes)})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:i.has(m.id)?e.jsx(M,{disabled:!0,variant:"ghost",size:"sm",children:e.jsx(Y,{className:"h-4 w-4 animate-spin"})}):e.jsxs(e.Fragment,{children:[e.jsx(M,{onClick:()=>_(m),variant:"ghost",size:"sm",title:"Загрузить на сервер",children:e.jsx(st,{className:"h-4 w-4"})}),e.jsx(M,{onClick:()=>D(m.id),variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive",title:"Удалить",children:e.jsx(Kn,{className:"h-4 w-4"})})]})})]},m.id))]})]})]})}function As({appointmentId:t,appointment:n}){const[s,r]=l.useState("recording");return e.jsxs("div",{className:"h-full flex flex-col border-r bg-muted/30",children:[e.jsxs("div",{className:"border-b px-4 py-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Источники данных"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Записывайте или загружайте материалы сессии"})]}),e.jsxs(Tt,{value:s,onValueChange:r,className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs(Ft,{className:"mx-4 mt-4 grid grid-cols-4",children:[e.jsx(ze,{value:"recording",children:"Запись"}),e.jsx(ze,{value:"transcript",children:"Транскрипт"}),e.jsx(ze,{value:"notes",children:"Заметки"}),e.jsx(ze,{value:"files",children:"Файлы"})]}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsx(Le,{value:"recording",className:"h-full m-0 mt-4",children:e.jsx(we,{className:"h-full px-4",children:e.jsxs("div",{className:"pb-4",children:[e.jsx(Is,{appointmentId:t,specialistId:n.specialist_id||"",userId:n.user_id}),e.jsx("p",{className:"text-xs text-muted-foreground mt-4",children:'Записи сохраняются локально до загрузки на сервер. После загрузки они появятся во вкладке "Файлы".'})]})})}),e.jsx(Le,{value:"transcript",className:"h-full m-0 mt-4",children:e.jsx(bs,{appointmentId:t,appointment:n})}),e.jsx(Le,{value:"notes",className:"h-full m-0 mt-4",children:e.jsx(zs,{appointmentId:t})}),e.jsx(Le,{value:"files",className:"h-full m-0 mt-4",children:e.jsx(Cs,{appointmentId:t})})]})]})]})}function Ls({appointmentId:t,appointment:n,onNotesUpdate:s}){const{toast:r}=Ne(),[o,a]=l.useState([]),[i,c]=l.useState(null),[d,h]=l.useState(!0),[w,g]=l.useState(!1),[f,b]=l.useState({transcript:"",notes:""});l.useEffect(()=>{j()},[]),l.useEffect(()=>{x()},[t]);const j=async()=>{try{h(!0);const u=await Mn();if(a(u),u.length>0){const v=u.find(z=>z.is_default)||u[0];c(v.id)}}catch(u){console.error("Error loading templates:",u)}finally{h(!1)}},x=async()=>{try{let u=n.transcript||"";if(!u)try{u=await At(t)}catch{}let v="";try{const z=await cn(t);z.length>0&&(v=z.map(_=>_.content).join(`

`))}catch{}b({transcript:u,notes:v})}catch(u){console.error("Error loading source data:",u)}},C=async()=>{if(i)try{g(!0),await $n({appointmentId:t,templateId:i,transcript:f.transcript,notes:f.notes}),r({title:"Генерация запущена",description:"Клиническая заметка генерируется..."}),s(),x()}catch(u){console.error("Error generating note:",u),r({title:"Ошибка",description:u instanceof Error?u.message:"Не удалось запустить генерацию",variant:"destructive"})}finally{g(!1)}},p=f.transcript||f.notes;return o.find(u=>u.id===i),d?e.jsx("div",{className:"h-full flex items-center justify-center bg-muted/30",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Y,{className:"h-5 w-5 animate-spin"}),"Загрузка шаблонов..."]})}):e.jsxs("div",{className:"h-full flex flex-col bg-muted/30 border-x",children:[e.jsxs("div",{className:"border-b px-4 py-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Шаблоны"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Выберите шаблон для генерации заметки"})]}),e.jsxs("div",{className:"px-4 py-3 border-b space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Данные для анализа"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[f.transcript?e.jsxs(X,{variant:"outline",className:"text-green-600 border-green-200",children:[e.jsx(Re,{className:"h-3 w-3 mr-1"}),"Транскрипт"]}):e.jsxs(X,{variant:"outline",className:"text-muted-foreground",children:[e.jsx(et,{className:"h-3 w-3 mr-1"}),"Нет транскрипта"]}),f.notes?e.jsxs(X,{variant:"outline",className:"text-green-600 border-green-200",children:[e.jsx(Re,{className:"h-3 w-3 mr-1"}),"Заметки"]}):e.jsxs(X,{variant:"outline",className:"text-muted-foreground",children:[e.jsx(et,{className:"h-3 w-3 mr-1"}),"Нет заметок"]})]})]}),e.jsx(we,{className:"flex-1",children:e.jsxs("div",{className:"p-4 space-y-3",children:[o.map(u=>e.jsxs(Fe,{className:`cursor-pointer transition-colors ${i===u.id?"border-primary bg-primary/5":"hover:bg-muted/50"}`,onClick:()=>c(u.id),children:[e.jsx(_t,{className:"p-3 pb-2",children:e.jsxs(Mt,{className:"text-sm flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4"}),u.name,u.is_default&&e.jsx(X,{variant:"secondary",className:"text-xs",children:"По умолчанию"})]})}),u.description&&e.jsx(He,{className:"p-3 pt-0",children:e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:u.description})})]},u.id)),o.length===0&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ae,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Нет доступных шаблонов"})]})]})}),e.jsxs("div",{className:"p-4 border-t",children:[e.jsx(M,{onClick:C,disabled:!i||!p||w,className:"w-full",size:"lg",children:w?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4 mr-2 animate-spin"}),"Генерация..."]}):e.jsxs(e.Fragment,{children:[e.jsx(tt,{className:"h-4 w-4 mr-2"}),"Сгенерировать заметку"]})}),!p&&e.jsx("p",{className:"text-xs text-muted-foreground text-center mt-2",children:"Добавьте транскрипт или заметки слева"})]})]})}function Ds({clinicalNotes:t,onNotesUpdate:n}){var D,k;const{toast:s}=Ne(),[r,o]=l.useState(((D=t[0])==null?void 0:D.id)||null),[a,i]=l.useState(new Set),[c,d]=l.useState(null),[h,w]=l.useState(""),[g,f]=l.useState(!1),[b,j]=l.useState(null);l.useEffect(()=>{t.length>0&&(!t.some(A=>A.id===r)||!r)&&o(t[0].id)},[t,r]),l.useEffect(()=>{const m=t.find(A=>A.id===r);if(m!=null&&m.sections){const A=new Set(m.sections.map(L=>L.id));i(A)}},[r,t]);const x=t.find(m=>m.id===r),C=m=>{i(A=>{const L=new Set(A);return L.has(m)?L.delete(m):L.add(m),L})},p=m=>{d(m.id),w(m.content)},u=async m=>{try{f(!0),await Tn(m,h),s({title:"Сохранено",description:"Секция обновлена"}),d(null),n()}catch{s({title:"Ошибка",description:"Не удалось сохранить изменения",variant:"destructive"})}finally{f(!1)}},v=async(m,A)=>{try{await navigator.clipboard.writeText(m),j(A),setTimeout(()=>j(null),2e3)}catch{s({title:"Ошибка",description:"Не удалось скопировать текст",variant:"destructive"})}},z=async()=>{if(!(x!=null&&x.sections))return;const m=x.sections.map(A=>`## ${A.section_name}

${A.content}`).join(`

---

`);try{await navigator.clipboard.writeText(m),s({title:"Скопировано",description:"Все секции скопированы в буфер обмена"})}catch{s({title:"Ошибка",description:"Не удалось скопировать текст",variant:"destructive"})}},_=m=>{switch(m){case"generating":return e.jsxs(X,{variant:"outline",className:"text-blue-600 border-blue-200",children:[e.jsx(Y,{className:"h-3 w-3 mr-1 animate-spin"}),"Генерация"]});case"completed":return e.jsxs(X,{variant:"outline",className:"text-green-600 border-green-200",children:[e.jsx(Re,{className:"h-3 w-3 mr-1"}),"Готово"]});case"finalized":return e.jsxs(X,{variant:"default",children:[e.jsx(Re,{className:"h-3 w-3 mr-1"}),"Финализировано"]});default:return e.jsx(X,{variant:"outline",children:m})}};return t.length===0?e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"border-b px-4 py-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Результат"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"AI-заметки появятся здесь"})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(ae,{className:"h-12 w-12 mx-auto text-muted-foreground opacity-50"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-muted-foreground",children:"Нет заметок"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Выберите шаблон и нажмите "Сгенерировать"'})]})]})})]}):e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsx("div",{className:"border-b px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Результат"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t.length," заметок"]})]}),(x==null?void 0:x.sections)&&x.sections.length>0&&e.jsxs(M,{variant:"outline",size:"sm",onClick:z,children:[e.jsx(yt,{className:"h-4 w-4 mr-2"}),"Копировать всё"]})]})}),t.length>1&&e.jsx("div",{className:"border-b px-4 py-2",children:e.jsx(Tt,{value:r||void 0,onValueChange:o,children:e.jsx(Ft,{className:"w-full justify-start",children:t.map((m,A)=>e.jsxs(ze,{value:m.id,className:"text-xs",children:["Заметка ",A+1]},m.id))})})}),x&&e.jsxs("div",{className:"px-4 py-2 border-b flex items-center justify-between",children:[_(x.generation_status),x.template&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Шаблон: ",x.template.name]})]}),e.jsx(we,{className:"flex-1",children:e.jsxs("div",{className:"p-4 space-y-3",children:[(k=x==null?void 0:x.sections)==null?void 0:k.map(m=>e.jsxs("div",{className:"border rounded-lg overflow-hidden bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-muted/50 cursor-pointer hover:bg-muted/70",onClick:()=>C(m.id),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[a.has(m.id)?e.jsx($t,{className:"h-4 w-4"}):e.jsx(Rn,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium text-sm",children:m.section_name})]}),e.jsx("div",{className:"flex items-center gap-1",children:c!==m.id&&e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:A=>{A.stopPropagation(),p(m)},children:e.jsx(Wn,{className:"h-3 w-3"})}),e.jsx(M,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:A=>{A.stopPropagation(),v(m.content,m.id)},children:b===m.id?e.jsx(Re,{className:"h-3 w-3 text-green-500"}):e.jsx(yt,{className:"h-3 w-3"})})]})})]}),a.has(m.id)&&e.jsx("div",{className:"p-3",children:c===m.id?e.jsxs("div",{className:"space-y-2",children:[e.jsx(rt,{value:h,onChange:A=>w(A.target.value),rows:6,className:"text-sm"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(M,{variant:"ghost",size:"sm",onClick:()=>d(null),children:[e.jsx(kn,{className:"h-4 w-4 mr-1"}),"Отмена"]}),e.jsxs(M,{size:"sm",onClick:()=>u(m.id),disabled:g,children:[g?e.jsx(Y,{className:"h-4 w-4 mr-1 animate-spin"}):e.jsx(qn,{className:"h-4 w-4 mr-1"}),"Сохранить"]})]})]}):e.jsx("div",{className:"text-sm whitespace-pre-wrap text-muted-foreground",children:m.content})})]},m.id)),(x==null?void 0:x.generation_status)==="generating"&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(Y,{className:"h-8 w-8 animate-spin mx-auto text-primary"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Генерация заметки..."})]})})]})})]})}function _s({appointmentId:t,appointment:n,clinicalNotes:s,onNotesUpdate:r}){return e.jsx("div",{className:"flex-1 overflow-hidden h-full",children:e.jsxs(Ns,{direction:"horizontal",className:"h-full",children:[e.jsx(Ze,{defaultSize:35,minSize:25,maxSize:50,children:e.jsx(As,{appointmentId:t,appointment:n})}),e.jsx(Pt,{withHandle:!0}),e.jsx(Ze,{defaultSize:30,minSize:20,maxSize:40,children:e.jsx(Ls,{appointmentId:t,appointment:n,onNotesUpdate:r})}),e.jsx(Pt,{withHandle:!0}),e.jsx(Ze,{defaultSize:35,minSize:25,maxSize:50,children:e.jsx(Ds,{clinicalNotes:s,onNotesUpdate:r})})]})})}function tr(){var u;const{appointmentId:t}=mn(),n=xn(),{toast:s}=Ne(),[r,o]=l.useState(null),[a,i]=l.useState([]),[c,d]=l.useState(!0),[h,w]=l.useState(null),[g,f]=l.useState(!1),[b,j]=l.useState(!1);l.useEffect(()=>{t&&x()},[t]);const x=async()=>{if(t)try{d(!0),w(null);const{data:v,error:z}=await le.from("appointments").select(`
          *,
          appointment_type:appointment_types (name, duration_minutes),
          profile:profiles (first_name, last_name),
          client_user:users!appointments_user_id_fkey (email)
        `).eq("id",t).single();if(z)throw z;if(!v)throw new Error("Консультация не найдена");o(v);try{const _=await ht(t);i(_)}catch{console.log("No clinical notes yet"),i([])}}catch(v){console.error("Error loading appointment:",v),w(v instanceof Error?v.message:"Не удалось загрузить данные"),s({title:"Ошибка",description:v instanceof Error?v.message:"Не удалось загрузить данные",variant:"destructive"})}finally{d(!1)}},C=l.useCallback(async()=>{if(t)try{const v=await ht(t);i(v)}catch(v){console.error("Error refreshing notes:",v)}},[t]),p=async()=>{if(t)try{f(!0);const v=await Fn(t);o(z=>z&&{...z,summary:v.summary}),j(!0),s({title:"Сводка сгенерирована",description:"AI создал краткую сводку сессии"})}catch(v){console.error("Error generating summary:",v),s({title:"Ошибка генерации",description:v instanceof Error?v.message:"Не удалось сгенерировать сводку",variant:"destructive"})}finally{f(!1)}};return c?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex-shrink-0 border-b px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ae,{className:"h-9 w-9"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ae,{className:"h-6 w-48"}),e.jsx(Ae,{className:"h-4 w-72"})]})]})}),e.jsx("div",{className:"flex-1 p-6",children:e.jsx(Ae,{className:"h-full"})})]}):h||!r?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-destructive",children:h||"Консультация не найдена"}),e.jsxs(M,{variant:"outline",onClick:()=>n("/specialist/sessions"),children:[e.jsx(pt,{className:"mr-2 h-4 w-4"}),"Вернуться к списку"]})]})}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 border-b px-6 py-4 bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(M,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(pn,{to:"/specialist/sessions",children:e.jsx(pt,{className:"h-5 w-5"})})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-semibold flex items-center gap-2",children:[e.jsx(Pn,{className:"h-5 w-5 text-muted-foreground"}),Hn(r==null?void 0:r.profile,(u=r==null?void 0:r.client_user)==null?void 0:u.email)]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mt-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(In,{className:"h-4 w-4"}),Bn(r.scheduled_at,{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]}),r.appointment_type&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(et,{className:"h-4 w-4"}),r.appointment_type.name," (",r.appointment_type.duration_minutes," мин)"]})]})]})]}),e.jsx(M,{variant:r.summary?"outline":"default",size:"sm",onClick:p,disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"mr-2 h-4 w-4 animate-spin"}),"Генерация..."]}):e.jsxs(e.Fragment,{children:[e.jsx(tt,{className:"mr-2 h-4 w-4"}),r.summary?"Перегенерировать":"Сводка сессии"]})})]}),r.summary&&e.jsxs(Ln,{open:b,onOpenChange:j,className:"mt-3",children:[e.jsx(Dn,{asChild:!0,children:e.jsxs(M,{variant:"ghost",size:"sm",className:"w-full justify-between px-2",children:[e.jsxs("span",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(tt,{className:"h-4 w-4 text-purple-500"}),"Сводка сессии",e.jsx(X,{variant:"secondary",className:"text-xs",children:"AI"})]}),b?e.jsx(An,{className:"h-4 w-4"}):e.jsx($t,{className:"h-4 w-4"})]})}),e.jsx(_n,{className:"mt-2",children:e.jsx("div",{className:"bg-muted/50 rounded-lg p-4 text-sm whitespace-pre-wrap",children:r.summary})})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(_s,{appointmentId:t,appointment:r,clinicalNotes:a,onNotesUpdate:C})})]})}export{tr as default};
