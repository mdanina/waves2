import{r as u,j as e}from"./vendor-radix-htwXsPHy.js";import{u as D,c as L}from"./vendor-react-CI8wve7f.js";import{u as H,g as o,H as K,C as k,B as w,a7 as W,G,w as M}from"./index-Dv2C02zj.js";import{S as O}from"./separator-CH7uCMjL.js";import{h as J,f as V,g as X}from"./useAppointments-u0fKxR2v.js";import{a as Z}from"./usePackages-DyCmJAkV.js";import{b as ee,u as te,c as se}from"./vendor-query-BNGVDYIL.js";import{c as ne,g as ae,v as re,f as R}from"./payment-Bjeu9em9.js";import{f as ie}from"./moscowTime-Bf471xDt.js";import"./vendor-charts-DjioKZbK.js";import"./appointmentStorage-BM6-WgPI.js";import"./profileStorage-CNyPVPjQ.js";function oe(s){return ee({queryKey:["payment",s],queryFn:()=>s?ae(s):Promise.resolve(null),enabled:!!s,staleTime:30*1e3,gcTime:2*60*1e3,retry:2,refetchOnWindowFocus:!0,refetchInterval:r=>{const n=r.state.data;return n&&(n.status==="pending"||n.status==="processing")?5e3:!1}})}function ce(){const s=te(),{user:r}=H();return se({mutationFn:ne,onSuccess:n=>{s.invalidateQueries({queryKey:["payments",r==null?void 0:r.id]}),s.setQueryData(["payment",n.payment.id],n.payment),o.success("Платеж создан")},onError:n=>{o.error(`Ошибка при создании платежа: ${n.message}`)}})}function be(){var E;const s=D(),[r]=L(),n=r.get("appointment_id"),p=r.get("package_id"),a=r.get("type"),b=r.get("payment_id"),T=r.get("appointment_type_id"),d=r.get("scheduled_at"),N=r.get("profile_id"),v=r.get("specialist_id"),{data:c}=J(n),f=(c==null?void 0:c.appointment_type_id)||T,{data:m}=V(f||null),{data:l}=Z(p),{data:_}=oe(b),y=ce(),P=X(),[C,A]=u.useState(!1),[$,F]=u.useState(!1),[x,Y]=u.useState(null),g=u.useRef(null),q=a==="appointment"?c||(m&&d?{}:null):l,h=a==="appointment"?(m==null?void 0:m.price)||0:(l==null?void 0:l.price)||0;u.useEffect(()=>{if(window.YooMoneyCheckoutWidget){F(!0);return}const t=document.createElement("script");return t.src="https://yookassa.ru/checkout-widget/v1/checkout-widget.js",t.async=!0,t.onload=()=>{F(!0)},t.onerror=()=>{o.error("Не удалось загрузить виджет оплаты")},document.body.appendChild(t),()=>{if(g.current)try{g.current.destroy()}catch{}document.body.contains(t)&&document.body.removeChild(t)}},[]),u.useEffect(()=>{if(!(!$||!x||!window.YooMoneyCheckoutWidget)){if(g.current)try{g.current.destroy()}catch{}try{const t=new window.YooMoneyCheckoutWidget({confirmation_token:x,error_callback:function(i){console.error("YooKassa widget error:",i),o.error("Ошибка при оплате: "+(i.error||"Неизвестная ошибка"))},success_callback:async function(){var S,U;o.success("Оплата успешно завершена!");const i=b||((U=(S=y.data)==null?void 0:S.payment)==null?void 0:U.id);if(i)try{if(await re(i),a==="appointment")if(n)s(`/appointments/confirmation?appointment_id=${n}&payment_id=${i}`);else if(f&&d)try{const j=await P.mutateAsync({appointmentTypeId:f,scheduledAt:d,profileId:N||null,specialistId:v||null});s(`/appointments/confirmation?appointment_id=${j.id}&payment_id=${i}`)}catch(j){console.error("Error creating appointment after payment:",j),o.error("Оплата прошла, но не удалось создать запись. Обратитесь в поддержку."),s(`/appointments/confirmation?payment_id=${i}`)}else s(`/appointments/confirmation?payment_id=${i}`);else a==="package"&&p&&s(`/appointments/confirmation?package_id=${p}&payment_id=${i}`)}catch(j){console.error("Error verifying payment:",j),o.error("Ошибка при проверке платежа")}}});g.current=t,t.render("payment-form")}catch(t){console.error("Error initializing YooKassa widget:",t),o.error("Ошибка при инициализации виджета оплаты")}}},[$,x,b,a,n,p,s,y.data,f,d,N,v,P]),u.useEffect(()=>{_&&_.status==="completed"&&(a==="appointment"&&n?s(`/appointments/confirmation?appointment_id=${n}`):a==="package"&&p&&s(`/appointments/confirmation?package_id=${p}`))},[_,a,n,p,s]);const Q=async()=>{if(!q){o.error("Не удалось определить детали заказа");return}if(a==="appointment"&&h===0){n&&s(`/appointments/confirmation?appointment_id=${n}`);return}if(h===0){o.error("Не удалось определить сумму платежа");return}A(!0);try{const t={type:a,package_id:p};n?(t.appointment_id=n,t.appointment_type_id=m==null?void 0:m.id):f&&d&&(t.appointment_type_id=f,t.scheduled_at=d,N&&(t.profile_id=N));const i=await y.mutateAsync({amount:h,currency:"RUB",paymentMethod:"yookassa",metadata:t});i.paymentUrl?(Y(i.paymentUrl),o.success("Виджет оплаты загружается...")):o.error("Не удалось получить данные для оплаты")}catch(t){console.error("Payment error:",t),o.error(t.message||"Ошибка при создании платежа")}finally{A(!1)}},z=a==="appointment"&&(c||m&&d),B=a==="package"&&l,I={background:"var(--bg-golden-hour)",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundAttachment:"fixed"};return!z&&!B?e.jsxs("div",{className:"min-h-screen bg-background",style:I,children:[e.jsx(K,{}),e.jsx("div",{className:"container mx-auto max-w-2xl px-4 py-8",children:e.jsxs(k,{className:"p-8 text-center",children:[e.jsxs("p",{className:"text-muted-foreground mb-4",children:[a==="appointment"?"Консультация":"Пакет"," не найден"]}),e.jsx(w,{onClick:()=>s("/cabinet"),children:"Вернуться в кабинет"})]})})]}):e.jsxs("div",{className:"min-h-screen bg-background",style:I,children:[e.jsx(K,{}),e.jsxs("div",{className:"container mx-auto max-w-2xl px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-foreground mb-2",children:"Оплата"}),e.jsx("p",{className:"text-muted-foreground",children:"Подтвердите детали и завершите оплату"})]}),e.jsxs(k,{className:"p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Детали заказа"}),a==="appointment"&&m&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Тип консультации:"}),e.jsx("span",{className:"font-medium",children:m.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Длительность:"}),e.jsxs("span",{className:"font-medium",children:[m.duration_minutes," минут"]})]}),((c==null?void 0:c.scheduled_at)||d)&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Дата и время:"}),e.jsx("span",{className:"font-medium",children:ie((c==null?void 0:c.scheduled_at)||d)})]})]}),a==="package"&&l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Пакет:"}),e.jsx("span",{className:"font-medium",children:l.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Количество сессий:"}),e.jsx("span",{className:"font-medium",children:l.session_count})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Тип консультации:"}),e.jsx("span",{className:"font-medium",children:(E=l.appointment_type)==null?void 0:E.name})]})]}),e.jsx(O,{className:"my-4"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-semibold",children:"Итого:"}),e.jsx("span",{className:"text-2xl font-bold text-primary",children:R(h)})]})]}),e.jsxs(k,{className:"p-6 mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5"}),"Способ оплаты"]}),x?e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Оплата будет произведена через ЮKassa"}),e.jsx("div",{id:"payment-form",className:"min-h-[400px]"})]}):e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Оплата будет произведена через ЮKassa"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:'Нажмите кнопку "Оплатить" для начала оплаты'})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(w,{variant:"outline",onClick:()=>s(-1),className:"flex-1",children:"Отмена"}),e.jsx(w,{onClick:Q,disabled:C||y.isPending||!!x,className:"flex-1",size:"lg",children:C||y.isPending?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-4 w-4 mr-2 animate-spin"}),"Обработка..."]}):h===0?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Подтвердить (бесплатно)"]}):x?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Виджет оплаты загружен"]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Оплатить ",R(h)]})})]})]})]})}export{be as default};
