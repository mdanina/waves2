import{r,j as e}from"./vendor-radix-htwXsPHy.js";import{J as Ss,ae as _s,aF as Ms,C as Ge,B as p,a7 as Is,ab as re,ah as U,q as ne,U as Te,aB as q,aG as pe,aH as ie,s as Ae,y as Pe,z as De,aI as Fe,K as W,aJ as ks,a4 as Rs,X as Es,Y as Ls,Z as zs,_ as Gs,L as Oe,aK as Ts,a2 as As}from"./index-Bu4m9iDU.js";import{S as le}from"./skeleton-B8c1PdQl.js";import{u as Ps,S as $e,M as Be,A as Ue,P as qe}from"./MessageAttachment-Dz8oj32h.js";import{a as Ds,D as We,s as Fs,b as Os,c as $s,d as Bs,e as K,m as Ke,u as Ve,f as Us,h as qs,i as Ws,j as Qe,k as Ks,l as Vs,n as He,o as Qs,p as Hs}from"./supabase-messages-CBT2AE_V.js";import{T as Js,a as Zs,b as Je}from"./tabs-djeQfOfi.js";import{P as Ze}from"./plus-L645YxVk.js";import{B as Xs}from"./bell-off-D6t74Kqt.js";import{S as Ys}from"./search-qJuoDY49.js";import{S as Xe}from"./shield-DMNTE370.js";import{S as Ye}from"./send-BgjHPcQS.js";import"./vendor-charts-DjioKZbK.js";import"./vendor-query-BNGVDYIL.js";import"./vendor-react-CI8wve7f.js";import"./download-C9jGyh4a.js";import"./image-DlLVluFk.js";function ft(){const{toast:g}=Ss(),{user:i}=_s(),{permission:fe,requestPermission:es,notifyNewMessage:V}=Ps(),E=r.useRef(null),Q=r.useRef(0),H=r.useRef(0),J=r.useRef(null),ge=r.useRef(null),ce=r.useRef([]),L=r.useRef(null),[C,M]=r.useState([]),[x,je]=r.useState(null),[Z,z]=r.useState([]),[S,G]=r.useState(""),[ss,Ne]=r.useState(!0),[ts,be]=r.useState(!1),[N,X]=r.useState(!1),[oe,as]=r.useState(""),[_,Y]=r.useState("all"),[b,I]=r.useState(null),[y,T]=r.useState(!1),[f,rs]=r.useState(1),[P,ns]=r.useState(1),[is,ls]=r.useState(0),[k,cs]=r.useState("direct"),[ye,de]=r.useState([]),[h,we]=r.useState(null),[ee,D]=r.useState([]),[me,ve]=r.useState(!1),[os,Ce]=r.useState(!1),[Se,ds]=r.useState(!1),[v,ms]=r.useState(1),[F,us]=r.useState(1),[xs,hs]=r.useState(0),[ps,O]=r.useState(!1),[$,se]=r.useState(""),[B,te]=r.useState([]),[ue,_e]=r.useState(!1),A=r.useCallback(()=>{setTimeout(()=>{var s;(s=E.current)==null||s.scrollIntoView({behavior:"smooth"})},100)},[]),w=r.useCallback(async(s=1,a=!1)=>{try{a&&Ne(!0);const n=await Ds({page:s,pageSize:We});M(n.conversations),rs(n.page),ns(n.totalPages),ls(n.totalCount)}catch(n){console.error("Error loading conversations:",n),g({title:"Ошибка",description:"Не удалось загрузить беседы",variant:"destructive"})}finally{a&&Ne(!1)}},[g]);r.useEffect(()=>{i!=null&&i.id&&w(1,!0)},[i==null?void 0:i.id,w]);const fs=r.useCallback(()=>{f>1&&w(f-1,!1)},[f,w]),gs=r.useCallback(()=>{f<P&&w(f+1,!1)},[f,P,w]),Me=r.useMemo(()=>Ms(()=>{w(f,!1)},2e3),[w,f]);r.useEffect(()=>{const s=()=>{i!=null&&i.id&&Me()};return window.addEventListener("focus",s),()=>window.removeEventListener("focus",s)},[i==null?void 0:i.id,Me]),r.useEffect(()=>{J.current=x},[x]),r.useEffect(()=>{ge.current=h},[h]),r.useEffect(()=>{ce.current=C},[C]),r.useEffect(()=>{if(!(i!=null&&i.id))return;const s=Fs(i.id,async a=>{var n;try{if(a.is_support_message===!0)return;const t=a.sender_id,m=J.current,c=await K(a),o=((n=J.current)==null?void 0:n.recipientId)===(m==null?void 0:m.recipientId);if(m&&t===m.recipientId&&o)z(l=>[...l,c]),setTimeout(()=>{var l;(l=E.current)==null||l.scrollIntoView({behavior:"smooth"})},100),await Ke(t),M(l=>l.map(u=>u.recipientId===t?{...u,lastMessage:c,unreadCount:0}:u));else{const l=ce.current.find(u=>u.recipientId===t);l&&V(l.recipientName,c.content),M(u=>u.map(d=>d.recipientId===t?{...d,lastMessage:c,unreadCount:d.unreadCount+1}:d))}}catch(t){console.error("Error processing message:",t)}});return()=>s()},[i==null?void 0:i.id,V]),r.useEffect(()=>{if(!(i!=null&&i.id))return;const s=Os(async a=>{try{if(a.sender_id===i.id)return;const n=a.sender_id,t=J.current,m=await K(a);if((t==null?void 0:t.recipientId)===n&&(t==null?void 0:t.recipientType)==="client")z(o=>[...o,m]),setTimeout(()=>{var o;(o=E.current)==null||o.scrollIntoView({behavior:"smooth"})},100),await He(n),M(o=>o.map(l=>l.recipientId===n?{...l,lastMessage:m,unreadCount:0}:l));else{const o=ce.current.find(l=>l.recipientId===n);o&&V(o.recipientName,m.content),M(l=>l.find(d=>d.recipientId===n)?l.map(d=>d.recipientId===n?{...d,lastMessage:m,unreadCount:d.unreadCount+1}:d):(w(f,!1),l))}}catch(n){console.error("Error processing support message:",n)}});return()=>s()},[i==null?void 0:i.id,V,w,f]),r.useEffect(()=>{Z.length>0&&A()},[Z,A]),r.useEffect(()=>{ee.length>0&&A()},[ee,A]);const js=async(s,a)=>{const n=++Q.current;try{be(!0);const t=a==="client",m=t?await Qs(s):await Hs(s);if(n!==Q.current)return;z(m),t?await He(s):await Ke(s),M(c=>c.map(o=>o.recipientId===s?{...o,unreadCount:0}:o))}catch(t){if(n!==Q.current)return;console.error("Error loading messages:",t),g({title:"Ошибка",description:"Не удалось загрузить сообщения",variant:"destructive"})}finally{n===Q.current&&be(!1)}},Ns=s=>{je(s),we(null),js(s.recipientId,s.recipientType)},Ie=s=>{var n;const a=(n=s.target.files)==null?void 0:n[0];if(a){if(a.size>10*1024*1024){g({title:"Файл слишком большой",description:"Максимальный размер файла — 10MB",variant:"destructive"});return}I(a)}L.current&&(L.current.value="")},ke=async()=>{if(!S.trim()&&!b||!x||!i||N||y)return;const s=S.trim(),a=`temp-${Date.now()}`,n=x.recipientId,t=b,m={id:a,sender_id:i.id,recipient_id:n,content:s,is_read:!1,read_at:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),attachment_url:t?URL.createObjectURL(t):null,attachment_name:(t==null?void 0:t.name)||null,attachment_type:(t==null?void 0:t.type)||null,attachment_size:(t==null?void 0:t.size)||null};z(c=>[...c,m]),G(""),I(null),A(),X(!0);try{let c;t&&(T(!0),c=await Ve(n,t),T(!1));const l=x.recipientType==="client"?await Us(n,s,c):await qs(n,s,c),u=await K(l);z(d=>d.map(j=>{var ze;return j.id===a?((ze=j.attachment_url)!=null&&ze.startsWith("blob:")&&URL.revokeObjectURL(j.attachment_url),u):j})),M(d=>d.map(j=>j.recipientId===n?{...j,lastMessage:u}:j))}catch(c){console.error("Error sending message:",c),z(o=>{var u;const l=o.find(d=>d.id===a);return(u=l==null?void 0:l.attachment_url)!=null&&u.startsWith("blob:")&&URL.revokeObjectURL(l.attachment_url),o.filter(d=>d.id!==a)}),G(s),t&&I(t),T(!1),g({title:"Ошибка",description:c instanceof Error?c.message:"Не удалось отправить сообщение",variant:"destructive"})}finally{X(!1)}},R=r.useCallback(async(s=1)=>{try{ve(!0);const a=await $s({page:s,pageSize:We});de(a.conversations),ms(a.page),us(a.totalPages),hs(a.totalCount),ds(!0)}catch(a){console.error("Error loading group conversations:",a),g({title:"Ошибка",description:"Не удалось загрузить групповые чаты",variant:"destructive"})}finally{ve(!1)}},[g]);r.useEffect(()=>{k==="groups"&&!Se&&!me&&R(1)},[k,Se,me,R]);const bs=r.useCallback(()=>{v>1&&R(v-1)},[v,R]),ys=r.useCallback(()=>{v<F&&R(v+1)},[v,F,R]),ws=async s=>{const a=++H.current,n=s.group.id;we(s),je(null);try{Ce(!0);const t=await Ws(n);if(a!==H.current)return;if(D(t),t.length>0){const m=t[t.length-1];await Qe(n,m.id),de(c=>c.map(o=>o.group.id===n?{...o,unreadCount:0}:o))}}catch(t){if(a!==H.current)return;console.error("Error loading group messages:",t),g({title:"Ошибка",description:"Не удалось загрузить сообщения группы",variant:"destructive"})}finally{a===H.current&&Ce(!1)}};r.useEffect(()=>{if(!h||!(i!=null&&i.id))return;const s=h.group.id,a=h.members,n=Bs(s,async t=>{var m;try{if(t.sender_id===i.id)return;const c=a.find(l=>l.user_id===t.sender_id);let o={...t,senderName:(c==null?void 0:c.userName)||"Пользователь",senderAvatar:(c==null?void 0:c.userAvatar)||null};if(o=await K(o),((m=ge.current)==null?void 0:m.group.id)!==s)return;D(l=>[...l,o]),setTimeout(()=>{var l;(l=E.current)==null||l.scrollIntoView({behavior:"smooth"})},100),await Qe(s,t.id)}catch(c){console.error("Error processing group message:",c)}});return()=>n()},[h==null?void 0:h.group.id,i==null?void 0:i.id]);const Re=async()=>{if(!S.trim()&&!b||!h||!i||N||y)return;const s=S.trim(),a=`temp-${Date.now()}`,n=h.group.id,t=b,m={id:a,group_id:n,sender_id:i.id,content:s,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),senderName:"Вы",attachment_url:t?URL.createObjectURL(t):null,attachment_name:(t==null?void 0:t.name)||null,attachment_type:(t==null?void 0:t.type)||null,attachment_size:(t==null?void 0:t.size)||null};D(c=>[...c,m]),G(""),I(null),A(),X(!0);try{let c;t&&(T(!0),c=await Ve(n,t),T(!1));const o=await Ks(n,s,c),l=await K(o);D(u=>u.map(d=>{var j;return d.id===a?((j=d.attachment_url)!=null&&j.startsWith("blob:")&&URL.revokeObjectURL(d.attachment_url),{...l,senderName:"Вы"}):d})),de(u=>u.map(d=>d.group.id===n?{...d,lastMessage:{...l,senderName:"Вы"}}:d))}catch(c){console.error("Error sending group message:",c),D(o=>{var u;const l=o.find(d=>d.id===a);return(u=l==null?void 0:l.attachment_url)!=null&&u.startsWith("blob:")&&URL.revokeObjectURL(l.attachment_url),o.filter(d=>d.id!==a)}),G(s),t&&I(t),T(!1),g({title:"Ошибка",description:c instanceof Error?c.message:"Не удалось отправить сообщение",variant:"destructive"})}finally{X(!1)}},vs=async()=>{if(!(!$.trim()||B.length===0||ue)){_e(!0);try{await Vs($.trim(),B),await R(),O(!1),se(""),te([]),g({title:"Группа создана",description:`Группа "${$.trim()}" успешно создана`})}catch(s){console.error("Error creating group:",s),g({title:"Ошибка",description:s instanceof Error?s.message:"Не удалось создать группу",variant:"destructive"})}finally{_e(!1)}}},Cs=s=>{te(a=>a.includes(s)?a.filter(n=>n!==s):[...a,s])},Ee=r.useDeferredValue(oe),Le=r.useMemo(()=>{const s=Ee.toLowerCase();return C.filter(a=>{var n,t;return _!=="all"&&a.recipientType!==_?!1:s?a.recipientName.toLowerCase().includes(s)||((n=a.specialization)==null?void 0:n.toLowerCase().includes(s))||((t=a.adminRole)==null?void 0:t.toLowerCase().includes(s)):!0})},[C,Ee,_]),xe=s=>{switch(s){case"client":return{bgClass:"bg-green-100 text-green-600",textClass:"text-green-600",Icon:Te};case"specialist":return{bgClass:"bg-blue-100 text-blue-600",textClass:"text-blue-600",Icon:$e};case"admin":return{bgClass:"bg-purple-100 text-purple-600",textClass:"text-purple-600",Icon:Xe}}},he=s=>s.recipientType==="specialist"?s.specialization||"Специалист":s.recipientType==="admin"?s.adminRole||"Администратор":"Клиент",ae=r.useMemo(()=>{const s={all:C.length,client:0,specialist:0,admin:0};for(const a of C)s[a.recipientType]++;return s},[C]);return ss?e.jsx("div",{className:"h-[calc(100vh-12rem)]",children:e.jsx(Ge,{className:"h-full",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"w-80 border-r p-4 space-y-4",children:[e.jsx(le,{className:"h-10 w-full"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsx(le,{className:"h-16 w-full"},s))})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(le,{className:"h-8 w-48"})})]})})}):e.jsxs("div",{className:"h-[calc(100vh-12rem)]",children:[e.jsx(Ge,{className:"h-full",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"w-80 border-r flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"font-semibold",children:"Сообщения"}),e.jsxs("div",{className:"flex items-center gap-1",children:[k==="groups"&&e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>O(!0),title:"Создать группу",children:e.jsx(Ze,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:es,title:fe==="granted"?"Уведомления включены":"Включить уведомления",children:fe==="granted"?e.jsx(Is,{className:"h-4 w-4 text-primary"}):e.jsx(Xs,{className:"h-4 w-4 text-muted-foreground"})})]})]}),e.jsx(Js,{value:k,onValueChange:s=>cs(s),children:e.jsxs(Zs,{className:"w-full",children:[e.jsxs(Je,{value:"direct",className:"flex-1",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),"Личные"]}),e.jsxs(Je,{value:"groups",className:"flex-1",children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),"Группы"]})]})}),k==="direct"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ys,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ne,{placeholder:"Поиск...",value:oe,onChange:s=>as(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-1 flex-wrap",children:[e.jsxs(p,{variant:_==="all"?"default":"outline",size:"sm",onClick:()=>Y("all"),className:"text-xs h-7",children:["Все (",ae.all,")"]}),e.jsxs(p,{variant:_==="client"?"default":"outline",size:"sm",onClick:()=>Y("client"),className:"text-xs h-7",children:[e.jsx(Te,{className:"w-3 h-3 mr-1"}),ae.client]}),e.jsxs(p,{variant:_==="specialist"?"default":"outline",size:"sm",onClick:()=>Y("specialist"),className:"text-xs h-7",children:[e.jsx($e,{className:"w-3 h-3 mr-1"}),ae.specialist]}),e.jsxs(p,{variant:_==="admin"?"default":"outline",size:"sm",onClick:()=>Y("admin"),className:"text-xs h-7",children:[e.jsx(Xe,{className:"w-3 h-3 mr-1"}),ae.admin]})]})]})]}),k==="direct"&&e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"flex-1",children:Le.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(re,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:oe||_!=="all"?"Ничего не найдено":"Нет собеседников"})]}):e.jsx("div",{className:"p-2",children:Le.map(s=>{const a=xe(s.recipientType);return e.jsx("button",{onClick:()=>Ns(s),className:`w-full p-3 rounded-lg text-left transition-colors ${(x==null?void 0:x.recipientId)===s.recipientId?"bg-primary/10":"hover:bg-muted"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[s.recipientAvatar?e.jsx("img",{src:s.recipientAvatar,alt:s.recipientName,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:pe(s.recipientName)}),e.jsx("div",{className:`absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center ${a.bgClass}`,children:e.jsx(a.Icon,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium truncate",children:s.recipientName}),s.lastMessage&&e.jsx("span",{className:"text-xs text-muted-foreground",children:ie(s.lastMessage.created_at)})]}),e.jsx("p",{className:`text-xs truncate mb-0.5 ${a.textClass}`,children:he(s)}),s.lastMessage&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.lastMessage.sender_id===(i==null?void 0:i.id)?"Вы: ":"",s.lastMessage.content]})]}),s.unreadCount>0&&e.jsx(Ae,{className:"ml-2",children:s.unreadCount})]})},s.recipientId)})})}),P>1&&e.jsxs("div",{className:"p-2 border-t flex items-center justify-between",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:fs,disabled:f<=1,className:"h-8 px-2",children:e.jsx(Pe,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[f," / ",P," (",is,")"]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:gs,disabled:f>=P,className:"h-8 px-2",children:e.jsx(De,{className:"h-4 w-4"})})]})]}),k==="groups"&&e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"flex-1",children:me?e.jsx("div",{className:"p-4 space-y-3",children:[1,2,3].map(s=>e.jsx(le,{className:"h-16 w-full"},s))}):ye.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(U,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Нет групповых чатов"}),e.jsxs(p,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>O(!0),children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Создать группу"]})]}):e.jsx("div",{className:"p-2",children:ye.map(s=>e.jsx("button",{onClick:()=>ws(s),className:`w-full p-3 rounded-lg text-left transition-colors ${(h==null?void 0:h.group.id)===s.group.id?"bg-primary/10":"hover:bg-muted"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(U,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium truncate",children:s.group.name}),s.lastMessage&&e.jsx("span",{className:"text-xs text-muted-foreground",children:ie(s.lastMessage.created_at)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[s.members.length," ",Fe(s.members.length,"участник","участника","участников")]}),s.lastMessage&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.lastMessage.senderName,": ",s.lastMessage.content]})]}),s.unreadCount>0&&e.jsx(Ae,{className:"ml-2",children:s.unreadCount})]})},s.group.id))})}),F>1&&e.jsxs("div",{className:"p-2 border-t flex items-center justify-between",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:bs,disabled:v<=1,className:"h-8 px-2",children:e.jsx(Pe,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[v," / ",F," (",xs,")"]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:ys,disabled:v>=F,className:"h-8 px-2",children:e.jsx(De,{className:"h-4 w-4"})})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[x.recipientAvatar?e.jsx("img",{src:x.recipientAvatar,alt:x.recipientName,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:pe(x.recipientName)}),(()=>{const s=xe(x.recipientType);return e.jsx("div",{className:`absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center ${s.bgClass}`,children:e.jsx(s.Icon,{className:"w-3 h-3"})})})()]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:x.recipientName}),e.jsx("p",{className:`text-sm ${xe(x.recipientType).textClass}`,children:he(x)})]})]}),e.jsx(q,{className:"flex-1 p-4",children:ts?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(W,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):Z.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(re,{className:"h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Нет сообщений"}),e.jsx("p",{className:"text-sm mt-1",children:"Начните беседу"})]}):e.jsxs("div",{className:"space-y-4",children:[Z.map(s=>{const a=s.sender_id===(i==null?void 0:i.id);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:[s.content&&e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.attachment_url&&s.attachment_name&&s.attachment_type&&s.attachment_size&&e.jsx(Be,{url:s.attachment_url,name:s.attachment_name,type:s.attachment_type,size:s.attachment_size,isOwn:a}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:ie(s.created_at)}),a&&(s.is_read?e.jsx(ks,{className:"h-3 w-3"}):e.jsx(Rs,{className:"h-3 w-3"}))]})]})},s.id)}),e.jsx("div",{ref:E})]})}),e.jsxs("div",{className:"p-4 border-t space-y-2",children:[b&&e.jsx(Ue,{file:b,onRemove:()=>I(null)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:L,onChange:Ie,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>{var s;return(s=L.current)==null?void 0:s.click()},disabled:N||y,title:"Прикрепить файл",children:e.jsx(qe,{className:"h-4 w-4"})}),e.jsx(ne,{placeholder:"Введите сообщение...",value:S,onChange:s=>G(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),ke())},disabled:N||y}),e.jsx(p,{onClick:ke,disabled:!S.trim()&&!b||N||y,children:N||y?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx(Ye,{className:"h-4 w-4"})})]})]})]}):h?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(U,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:h.group.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h.members.length," ",Fe(h.members.length,"участник","участника","участников")]})]})]}),e.jsx(q,{className:"flex-1 p-4",children:os?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(W,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):ee.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(U,{className:"h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Нет сообщений"}),e.jsx("p",{className:"text-sm mt-1",children:"Начните беседу в группе"})]}):e.jsxs("div",{className:"space-y-4",children:[ee.map(s=>{const a=s.sender_id===(i==null?void 0:i.id);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!a&&e.jsx("p",{className:"text-xs font-medium mb-1 opacity-80",children:s.senderName||"Пользователь"}),s.content&&e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.attachment_url&&s.attachment_name&&s.attachment_type&&s.attachment_size&&e.jsx(Be,{url:s.attachment_url,name:s.attachment_name,type:s.attachment_type,size:s.attachment_size,isOwn:a}),e.jsx("div",{className:"flex items-center justify-end gap-1 mt-1",children:e.jsx("span",{className:"text-xs opacity-70",children:ie(s.created_at)})})]})},s.id)}),e.jsx("div",{ref:E})]})}),e.jsxs("div",{className:"p-4 border-t space-y-2",children:[b&&e.jsx(Ue,{file:b,onRemove:()=>I(null)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:L,onChange:Ie,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>{var s;return(s=L.current)==null?void 0:s.click()},disabled:N||y,title:"Прикрепить файл",children:e.jsx(qe,{className:"h-4 w-4"})}),e.jsx(ne,{placeholder:"Введите сообщение...",value:S,onChange:s=>G(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),Re())},disabled:N||y}),e.jsx(p,{onClick:Re,disabled:!S.trim()&&!b||N||y,children:N||y?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx(Ye,{className:"h-4 w-4"})})]})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-muted-foreground",children:[e.jsx(re,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Выберите беседу"}),e.jsx("p",{className:"text-sm mt-1",children:"Выберите собеседника из списка слева"})]})})]})}),e.jsx(Es,{open:ps,onOpenChange:s=>{O(s),s||(se(""),te([]))},children:e.jsxs(Ls,{className:"max-w-md",children:[e.jsx(zs,{children:e.jsx(Gs,{children:"Создать групповой чат"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Oe,{htmlFor:"groupName",children:"Название группы"}),e.jsx(ne,{id:"groupName",placeholder:"Введите название...",value:$,onChange:s=>se(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Oe,{children:["Участники (",B.length," выбрано)"]}),e.jsx(q,{className:"h-48 border rounded-md p-2",children:C.map(s=>e.jsxs("div",{className:"flex items-center gap-2 p-2 hover:bg-muted rounded cursor-pointer",onClick:()=>Cs(s.recipientId),children:[e.jsx(Ts,{checked:B.includes(s.recipientId)}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[s.recipientAvatar?e.jsx("img",{src:s.recipientAvatar,alt:s.recipientName,className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-xs font-medium",children:pe(s.recipientName)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.recipientName}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:he(s)})]})]})]},s.recipientId))})]})]}),e.jsxs(As,{children:[e.jsx(p,{variant:"outline",onClick:()=>{O(!1),se(""),te([])},children:"Отмена"}),e.jsxs(p,{onClick:vs,disabled:!$.trim()||B.length===0||ue,children:[ue?e.jsx(W,{className:"h-4 w-4 animate-spin mr-2"}):null,"Создать"]})]})]})})]})}export{ft as default};
