import{r,j as e}from"./vendor-radix-htwXsPHy.js";import{J as Z,aN as F,w as $,C as g,N,h as _,B as A,W as K,ah as B,x as O,E as U,q as V,G as X,z as Y,s as P}from"./index-Bu4m9iDU.js";import{S as b}from"./skeleton-B8c1PdQl.js";import{T as ee,a as se,b as D,c as f,d as te,e as p}from"./table-D_Yakl6M.js";import{s as ae}from"./supabase-appointments-DCPzJGw1.js";import{P as ne,a as re,b as C,c as ie,d as E,e as le}from"./pagination-B12bNrv1.js";import{g as ce,a as oe,c as de,d as me,e as xe}from"./client-utils-BLj6ZS6T.js";import{u as he}from"./vendor-react-CI8wve7f.js";import{S as ue}from"./search-qJuoDY49.js";import"./vendor-charts-DjioKZbK.js";import"./vendor-query-BNGVDYIL.js";const v=20;function Pe(){var R;const q=he(),{toast:k}=Z(),{specialistUser:x}=F(),[i,S]=r.useState([]),[z,H]=r.useState(!0),[T,I]=r.useState(!1),[c,G]=r.useState(""),[l,h]=r.useState(1),j=r.useCallback(async(s=!1)=>{try{I(!0);const{data:t,error:a}=await $.rpc("get_specialist_clients");if(a)throw a;if(!t||t.length===0){S([]);return}const d=t.map(m=>m.client_user_id),{data:u}=await $.from("profiles").select("user_id, first_name, last_name").in("user_id",d).eq("type","parent"),y=t.map(m=>{const w=u==null?void 0:u.find(J=>J.user_id===m.client_user_id);return{...m,client_profile:w?{first_name:w.first_name,last_name:w.last_name}:void 0}});S(y)}catch(t){console.error("Error loading clients:",t),k({title:"Ошибка",description:"Не удалось загрузить список клиентов",variant:"destructive"})}finally{s&&H(!1),I(!1)}},[k]);r.useEffect(()=>{j(!0)},[j]),r.useEffect(()=>{var a;const s=(a=x==null?void 0:x.specialist)==null?void 0:a.id;if(!s)return;const t=ae(s,d=>{(d==="INSERT"||d==="DELETE"||d==="UPDATE")&&j(!1)});return()=>{t()}},[(R=x==null?void 0:x.specialist)==null?void 0:R.id,j]);const Q=()=>j(!1);r.useEffect(()=>{h(1)},[c]);const o=r.useMemo(()=>{if(!c.trim())return i;const s=c.toLowerCase();return i.filter(t=>{var u,y,m;const a=t.client_profile?`${t.client_profile.first_name} ${t.client_profile.last_name||""}`.toLowerCase():"",d=t.profile_first_name?`${t.profile_first_name} ${t.profile_last_name||""}`.toLowerCase():"";return a.includes(s)||d.includes(s)||((u=t.client_email)==null?void 0:u.toLowerCase().includes(s))||((y=t.client_phone)==null?void 0:y.includes(s))||((m=t.client_region)==null?void 0:m.toLowerCase().includes(s))})},[i,c]),n=Math.ceil(o.length/v),L=r.useMemo(()=>{const s=(l-1)*v;return o.slice(s,s+v)},[o,l]),W=s=>{switch(s){case"primary":return e.jsx(P,{children:"Основной"});case"consultant":return e.jsx(P,{variant:"secondary",children:"Консультант"});case"temporary":return e.jsx(P,{variant:"outline",children:"Временный"})}},M=s=>{q(`/specialist/clients/${s}`)};return z?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx(b,{className:"h-8 w-48"}),e.jsx(b,{className:"h-4 w-64 mt-2"})]})}),e.jsxs(g,{children:[e.jsx(N,{children:e.jsx(b,{className:"h-10 w-full max-w-md"})}),e.jsx(_,{children:e.jsx("div",{className:"space-y-4",children:[1,2,3].map(s=>e.jsx(b,{className:"h-16 w-full"},s))})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Мои клиенты"}),e.jsx("p",{className:"text-muted-foreground",children:"Клиенты, назначенные вам координатором"})]}),e.jsx(A,{variant:"outline",size:"icon",onClick:Q,disabled:T,children:e.jsx(K,{className:`h-4 w-4 ${T?"animate-spin":""}`})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(g,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Всего клиентов"}),e.jsx(B,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(_,{children:e.jsx("div",{className:"text-2xl font-bold",children:i.length})})]}),e.jsxs(g,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Консультаций проведено"}),e.jsx(O,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(_,{children:e.jsx("div",{className:"text-2xl font-bold",children:i.reduce((s,t)=>s+(t.completed_appointments||0),0)})})]}),e.jsxs(g,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Запланировано"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(_,{children:e.jsx("div",{className:"text-2xl font-bold",children:i.filter(s=>s.next_appointment_at).length})})]})]}),e.jsxs(g,{children:[e.jsx(N,{children:e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(V,{placeholder:"Поиск по имени, email или телефону...",value:c,onChange:s=>G(s.target.value),className:"pl-10"})]})})}),e.jsxs(_,{children:[i.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(B,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Пока нет назначенных клиентов"}),e.jsx("p",{className:"text-sm mt-1",children:"Координатор назначит вам клиентов после установочных встреч"})]}):o.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsxs("p",{children:['Клиенты не найдены по запросу "',c,'"']})}):e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(D,{children:[e.jsx(f,{children:"Клиент"}),e.jsx(f,{children:"Тип"}),e.jsx(f,{className:"hidden md:table-cell",children:"Консультации"}),e.jsx(f,{className:"hidden lg:table-cell",children:"Последняя встреча"}),e.jsx(f,{children:"Следующая встреча"}),e.jsx(f,{className:"text-right",children:"Действия"})]})}),e.jsx(te,{children:L.map(s=>e.jsxs(D,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>M(s.client_user_id),children:[e.jsx(p,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:ce(s.client_profile,s.client_email)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:oe(s.client_profile,s.client_email)}),s.profile_first_name&&e.jsxs("p",{className:"text-sm text-primary",children:[s.profile_first_name," ",s.profile_last_name||"",s.profile_type==="child"&&" (ребёнок)",s.profile_type==="partner"&&" (партнёр)"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.client_email||s.client_phone||""})]})]})}),e.jsx(p,{children:W(s.assignment_type)}),e.jsxs(p,{className:"hidden md:table-cell",children:[e.jsx("span",{className:"font-medium",children:s.completed_appointments}),e.jsxs("span",{className:"text-muted-foreground",children:[" / ",s.total_appointments]})]}),e.jsx(p,{className:"hidden lg:table-cell text-muted-foreground",children:de(s.last_appointment_at)}),e.jsx(p,{children:s.next_appointment_at?e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(X,{className:"h-4 w-4 text-primary"}),me(s.next_appointment_at,{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"Не запланировано"})}),e.jsx(p,{className:"text-right",children:e.jsx(A,{variant:"ghost",size:"icon",onClick:t=>{t.stopPropagation(),M(s.client_user_id)},children:e.jsx(Y,{className:"h-4 w-4"})})})]},s.assignment_id))})]}),n>1&&L.length>0&&e.jsxs("div",{className:"mt-6 flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Показано ",(l-1)*v+1,"–",Math.min(l*v,o.length)," из ",o.length]}),e.jsx(ne,{children:e.jsxs(re,{children:[e.jsx(C,{children:e.jsx(ie,{onClick:()=>h(s=>Math.max(1,s-1)),className:l===1?"pointer-events-none opacity-50":"cursor-pointer"})}),l>2&&e.jsx(C,{children:e.jsx(E,{onClick:()=>h(1),className:"cursor-pointer",children:"1"})}),Array.from({length:Math.min(3,n)},(s,t)=>{const a=Math.max(1,Math.min(l-1+t,n-2+t));return a<1||a>n?null:e.jsx(C,{children:e.jsx(E,{isActive:a===l,onClick:()=>h(a),className:"cursor-pointer",children:a})},a)}),l<n-1&&n>3&&e.jsx(C,{children:e.jsx(E,{onClick:()=>h(n),className:"cursor-pointer",children:n})}),e.jsx(C,{children:e.jsx(le,{onClick:()=>h(s=>Math.min(n,s+1)),className:l===n?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]}),i.length>0&&n<=1&&e.jsx("div",{className:"pt-4 border-t mt-4 text-center text-sm text-muted-foreground",children:c?`Найдено: ${o.length} из ${i.length}`:`Всего: ${xe(i.length)}`})]})]})]})}export{Pe as default};
