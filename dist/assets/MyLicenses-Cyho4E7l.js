import{r as c,j as e}from"./vendor-radix-ClAtPGFM.js";import{g as K,i as A,u as ae,aA as Ne,Y as ne,bc as B,m as ye,a9 as ke,a5 as Ee,aa as Me,S as ce,C as Y,s as le,O as oe,ag as de,a4 as Le,B as z,D as ue,a3 as Ue,E as me,G as xe,_ as he,a0 as fe,T as ge,W as pe,z as Te,f as q}from"./index-BetUtCwY.js";import{u as Ae}from"./useProfiles-yoc-XtR9.js";import{u as Pe}from"./useDevice-CbLi8Uhy.js";import{S as Z}from"./smartphone-B1OFqSIC.js";import{I as $e}from"./info-LyByp5RH.js";import{T as Oe}from"./trash-2-wNFmdxdD.js";import{S as Re}from"./shield-C07Mg8j0.js";import{M as Ie}from"./monitor-D6FrTxWP.js";import{u as He}from"./vendor-react-C_NXOhYK.js";import{P as be}from"./plus-DZlllSoy.js";import"./vendor-charts-DLBwBPLi.js";import"./vendor-query-DNK10Tnx.js";import"./profileStorage-Bslow6L6.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=K("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=K("Crown",[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=K("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=K("ShieldCheck",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=K("Tablet",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["line",{x1:"12",x2:"12.01",y1:"18",y2:"18",key:"1dp563"}]]);function ve({isOpen:s,onClose:a,title:r,children:d,size:t="md",showCloseButton:m=!0,className:o}){if(c.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),c.useEffect(()=>{const M=T=>{T.key==="Escape"&&s&&a()};return window.addEventListener("keydown",M),()=>window.removeEventListener("keydown",M)},[s,a]),!s)return null;const C={sm:"max-w-md",md:"max-w-lg",lg:"max-w-2xl",xl:"max-w-4xl"};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute right-0 bottom-0 bg-black/50 backdrop-blur-sm",onClick:a}),e.jsxs("div",{className:A("relative w-full bg-white rounded-3xl shadow-2xl","animate-in fade-in zoom-in-95 duration-200",C[t],o),children:[(r||m)&&e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-border",children:[r&&e.jsx("h2",{className:"text-xl font-medium",children:r}),m&&e.jsx("button",{onClick:a,className:"ml-auto p-2 rounded-full hover:bg-cloud transition-colors",children:e.jsx("svg",{className:"w-5 h-5 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"p-6",children:d})]})]})}async function Je(s){const{email:a,code:r,deviceName:d,type:t}=s;try{const m=await fetch("/api/send-verification-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,code:r,deviceName:d,type:t})});return m.ok?{success:!0}:{success:!1,error:await m.text()}}catch(m){return console.error("Failed to send verification code:",m),{success:!1,error:m instanceof Error?m.message:"Network error"}}}const We={new:{level:"new",maxDevices:3,unbindsPerMonth:1,cooldownHours:24,requiresEmailCode:!0},standard:{level:"standard",maxDevices:3,unbindsPerMonth:1,cooldownHours:24,requiresEmailCode:!0},trusted:{level:"trusted",maxDevices:3,unbindsPerMonth:2,cooldownHours:12,requiresEmailCode:!0}},X={monthsToTrusted:3,suspiciousActivity:{maxRegionsPerWeek:3,maxUnbindsAtLimit:3}},Ge={new:"Новый",standard:"Стандартный",trusted:"Доверенный"},Ye={new:"Первый месяц использования",standard:"Стандартные условия",trusted:"Расширенные возможности за стабильное использование"};function je(s){const a=new Date(s),r=new Date,d=a.getTime()-r.getTime();if(d<=0)return"сейчас";const t=Math.floor(d/(1e3*60*60)),m=Math.floor(d%(1e3*60*60)/(1e3*60));if(t>24){const o=Math.floor(t/24);return`${o} ${Q(o,"день","дня","дней")}`}return t>0?`${t} ${Q(t,"час","часа","часов")}`:`${m} ${Q(m,"минута","минуты","минут")}`}function Q(s,a,r,d){const t=s%10,m=s%100;return m>=11&&m<=19?d:t===1?a:t>=2&&t<=4?r:d}function Ke(s){const a=new Date(s);return new Date(a.getTime()+30*24*60*60*1e3)}const ee="waves_seat_devices",se="waves_seat_email_binding",te="waves_seat_unbind_history";function Xe(){return Math.floor(1e5+Math.random()*9e5).toString()}function we(){const s=typeof navigator<"u"?navigator:null,a=typeof window<"u"?window.screen:null,r=[(s==null?void 0:s.userAgent)||"unknown",(s==null?void 0:s.language)||"unknown",(a==null?void 0:a.width)||0,(a==null?void 0:a.height)||0,Intl.DateTimeFormat().resolvedOptions().timeZone].join("|");let d=0;for(let t=0;t<r.length;t++){const m=r.charCodeAt(t);d=(d<<5)-d+m,d=d&d}return"fp_"+Math.abs(d).toString(36)}function Ze(){if(typeof navigator>"u")return"desktop";const s=navigator.userAgent.toLowerCase();return/tablet|ipad|playbook|silk/i.test(s)?"tablet":/mobile|iphone|ipod|android|blackberry|opera mini|iemobile/i.test(s)?"mobile":"desktop"}function Qe(){if(typeof navigator>"u")return"Unknown Device";const s=navigator.userAgent;if(/iPhone/.test(s))return"iPhone";if(/iPad/.test(s))return"iPad";const a=s.match(/Android.*;\s*([^;)]+)/);return a?a[1].trim():/Mac/.test(s)?"Mac":/Windows/.test(s)?"Windows PC":/Linux/.test(s)?"Linux PC":"Unknown Device"}function Se({seatId:s}){const{user:a}=ae(),[r,d]=c.useState([]),[t,m]=c.useState(null),[o,C]=c.useState([]),[M,T]=c.useState(!0),[P,_]=c.useState(null),[y,D]=c.useState(null),[f,N]=c.useState(null);c.useEffect(()=>{if(!(a!=null&&a.id)||!s){d([]),m(null),T(!1);return}try{const i=localStorage.getItem(`${ee}_${s}`);i&&d(JSON.parse(i));const l=localStorage.getItem(`${se}_${s}`);l&&m(JSON.parse(l));const h=localStorage.getItem(`${te}_${s}`);h&&C(JSON.parse(h))}catch(i){console.error("Error loading seat devices:",i),_(i instanceof Error?i:new Error("Failed to load devices"))}T(!1)},[a==null?void 0:a.id,s]);const j=c.useCallback(i=>{s&&(localStorage.setItem(`${ee}_${s}`,JSON.stringify(i)),d(i))},[s]),b=c.useCallback(i=>{s&&(localStorage.setItem(`${se}_${s}`,JSON.stringify(i)),m(i))},[s]),L=c.useCallback(i=>{s&&(localStorage.setItem(`${te}_${s}`,JSON.stringify(i)),C(i))},[s]),S=c.useMemo(()=>We[(t==null?void 0:t.trust_level)||"new"],[t==null?void 0:t.trust_level]),n=c.useMemo(()=>{const i=new Date;return i.setDate(i.getDate()-30),o.filter(l=>l.reason==="user_request"&&new Date(l.unbound_at)>i).length},[o]),x=c.useMemo(()=>r.filter(i=>i.status==="active"||i.status==="pending_unbind"),[r]),v=c.useMemo(()=>{const i=we();return r.find(l=>l.device_fingerprint===i&&l.status==="active")},[r]),$=c.useMemo(()=>x.length<S.maxDevices,[x.length,S.maxDevices]),E=c.useMemo(()=>!!(t!=null&&t.email),[t==null?void 0:t.email]),U=c.useCallback(async i=>{if(!s)return{success:!1,error:"Seat ID не указан"};if(t!=null&&t.email)return{success:!1,error:"Email уже привязан к этому месту"};const l={seat_id:s,email:i.toLowerCase().trim(),email_verified:!1,bound_at:new Date().toISOString(),trust_level:"new",trust_level_updated_at:new Date().toISOString(),total_unbinds_count:0,consecutive_limit_hits:0,recent_regions:[]};return b(l),{success:!0}},[s,t==null?void 0:t.email,b]),g=c.useCallback(async()=>t?(b({...t,email_verified:!0}),{success:!0}):{success:!1,error:"Email не привязан"},[t,b]),O=c.useCallback(async()=>{if(!E)throw new Error("Сначала укажите email для этого места в лицензии");if(!$)throw new Error("Достигнут лимит устройств");const i=we(),l=r.find(u=>u.device_fingerprint===i&&u.status==="active");if(l)return l;const h={id:`sd_${Date.now()}`,seat_id:s,device_fingerprint:i,device_name:Qe(),device_type:Ze(),status:"active",last_active_at:new Date().toISOString(),created_at:new Date().toISOString()},w=[...r,h];return j(w),h},[E,$,r,s,j]),I=c.useCallback(i=>{if(!E)return{canUnbind:!1,reason:"no_email"};const l=r.find(h=>h.id===i);if(!l)return{canUnbind:!1,reason:"last_device"};if(l.status==="pending_unbind")return{canUnbind:!1,reason:"pending_unbind",cooldownEndsAt:l.unbind_available_at};if(x.length<=1)return{canUnbind:!1,reason:"last_device"};if(n>=S.unbindsPerMonth){const h=o.filter(u=>u.reason==="user_request").sort((u,F)=>new Date(u.unbound_at).getTime()-new Date(F.unbound_at).getTime())[0];return{canUnbind:!1,reason:"limit_reached",unbindsRemaining:0,unbindsResetAt:(h?Ke(h.unbound_at):new Date).toISOString()}}return{canUnbind:!0,unbindsRemaining:S.unbindsPerMonth-n}},[E,r,x.length,n,S.unbindsPerMonth,o]),V=c.useCallback(async i=>{const l=I(i);if(!l.canUnbind)return{success:!1,error:{no_email:"Email не привязан к этому месту",limit_reached:"Достигнут лимит отвязок в этом месяце",last_device:"Нельзя отвязать последнее устройство",pending_unbind:"Устройство уже в процессе отвязки"}[l.reason||""]||"Невозможно отвязать устройство"};const h=r.find(ie=>ie.id===i);if(!h||!(t!=null&&t.email))return{success:!1,error:"Устройство или email не найдены"};const w=Xe(),u=new Date;u.setMinutes(u.getMinutes()+10);const F=await Je({email:t.email,code:w,deviceName:h.device_name,type:"unbind_device"});return F.success?(D(w),N(i),{success:!0,codeExpiresAt:u.toISOString()}):{success:!1,error:F.error||"Ошибка отправки кода"}},[I,r,t==null?void 0:t.email]),J=c.useCallback(async i=>{if(!f||!y)return{success:!1,error:"Нет активного запроса на отвязку"};if(i!==y)return{success:!1,error:"Неверный код подтверждения"};if(!r.find(u=>u.id===f))return{success:!1,error:"Устройство не найдено"};const h=new Date;h.setHours(h.getHours()+S.cooldownHours);const w=r.map(u=>u.id===f?{...u,status:"pending_unbind",unbind_requested_at:new Date().toISOString(),unbind_available_at:h.toISOString()}:u);return j(w),D(null),N(null),{success:!0,unbindAvailableAt:h.toISOString()}},[f,y,r,S.cooldownHours,j]),W=c.useCallback(async i=>{const l=r.find(w=>w.id===i);if(!l||l.status!=="pending_unbind")return!1;const h=r.map(w=>w.id===i?{...w,status:"active",unbind_requested_at:void 0,unbind_available_at:void 0}:w);return j(h),!0},[r,j]),G=c.useCallback(async i=>{const l=r.find(u=>u.id===i);if(!l||l.status!=="pending_unbind"||l.unbind_available_at&&new Date(l.unbind_available_at)>new Date)return!1;const h=r.map(u=>u.id===i?{...u,status:"unbound"}:u);j(h);const w={id:`uh_${Date.now()}`,seat_id:s,device_fingerprint:l.device_fingerprint,device_name:l.device_name,unbound_at:new Date().toISOString(),reason:"user_request"};if(L([...o,w]),t){const u=t.total_unbinds_count+1,F=n+1>=S.unbindsPerMonth?t.consecutive_limit_hits+1:0;b({...t,total_unbinds_count:u,last_unbind_at:new Date().toISOString(),consecutive_limit_hits:F})}return!0},[r,s,o,t,n,S.unbindsPerMonth,j,L,b]),R=c.useCallback(()=>{if(!v)return;const i=r.map(l=>l.id===v.id?{...l,last_active_at:new Date().toISOString()}:l);j(i)},[v,r,j]),p=c.useCallback(()=>{if(!t)return;const i=new Date(t.bound_at),h=Math.floor((new Date().getTime()-i.getTime())/(1e3*60*60*24*30));let w=t.trust_level;h>=X.monthsToTrusted&&t.consecutive_limit_hits<X.suspiciousActivity.maxUnbindsAtLimit?w="trusted":h>=1&&(w="standard"),(t.consecutive_limit_hits>=X.suspiciousActivity.maxUnbindsAtLimit||t.recent_regions.length>X.suspiciousActivity.maxRegionsPerWeek)&&(w="new"),w!==t.trust_level&&b({...t,trust_level:w,trust_level_updated_at:new Date().toISOString()})},[t,b]),k=c.useRef(!1),H=c.useRef(s);H.current!==s&&(H.current=s,k.current=!1),c.useEffect(()=>{if(M||k.current||r.length===0)return;k.current=!0;const i=new Date,l=r.filter(h=>h.status==="pending_unbind"&&h.unbind_available_at&&new Date(h.unbind_available_at)<=i);if(l.length>0){const h=r.map(u=>l.some(F=>F.id===u.id)?{...u,status:"unbound"}:u);j(h);const w=l.map(u=>({id:`uh_${Date.now()}_${u.id}`,seat_id:s,device_fingerprint:u.device_fingerprint,device_name:u.device_name,unbound_at:new Date().toISOString(),reason:"user_request"}));if(L([...o,...w]),t){const u=t.total_unbinds_count+l.length;b({...t,total_unbinds_count:u,last_unbind_at:new Date().toISOString()})}}},[M,r,s,o,t,j,L,b]);const Ce=c.useCallback(()=>{s&&(localStorage.removeItem(`${ee}_${s}`),localStorage.removeItem(`${se}_${s}`),localStorage.removeItem(`${te}_${s}`),d([]),m(null),C([]))},[s]);return{devices:r,activeDevices:x,currentDevice:v,binding:t,unbindHistory:o,trustConfig:S,loading:M,error:P,hasEmail:E,setEmail:U,verifyEmail:g,canAddDevice:$,unbindsLast30Days:n,unbindsRemaining:S.unbindsPerMonth-n,addCurrentDevice:O,checkCanUnbind:I,requestUnbind:V,confirmUnbind:J,cancelUnbind:W,completeUnbind:G,updateLastActive:R,updateTrustLevel:p,pendingUnbindDeviceId:f,hasPendingUnbindRequest:!!y,resetAll:Ce,_mockCode:null}}function es({seatId:s,profileName:a,profileType:r,className:d,onEmailSet:t}){const{user:m}=ae(),{binding:o,hasEmail:C,setEmail:M,verifyEmail:T}=Se({seatId:s}),[P,_]=c.useState(""),[y,D]=c.useState(!1),[f,N]=c.useState(null),[j,b]=c.useState(!1),L=(m==null?void 0:m.email)||"",S=async()=>{const x=P.trim().toLowerCase();if(!x){N("Введите email");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(x)){N("Введите корректный email");return}D(!0),N(null);const v=await M(x);v.success?(await T(),t==null||t(x)):N(v.error||"Ошибка при привязке email"),D(!1)},n=()=>{_(L)};return C&&o?e.jsxs("div",{className:A("space-y-4",d),children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-green-50 border-2 border-green-200 rounded-2xl",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center",children:e.jsx(Ne,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-green-900",children:"Email для приложения"}),o.email_verified&&e.jsx(ne,{className:"w-4 h-4 text-green-600"})]}),e.jsx("div",{className:"text-green-700 truncate",children:o.email})]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Этот email используется для входа в мобильное приложение",a&&` (профиль: ${a})`,"."]})]}):e.jsxs("div",{className:A("space-y-4",d),children:[e.jsx(B,{variant:"info",title:"Укажите email для мобильного приложения",message:r==="child"?"Этот email будет использоваться для входа ребёнка в мобильное приложение. Можно указать email ребёнка или ваш собственный.":"Этот email будет использоваться для входа в мобильное приложение и для подтверждения отвязки устройств.",icon:e.jsx(Z,{className:"w-5 h-5"})}),e.jsxs("button",{type:"button",onClick:()=>b(!j),className:"flex items-center gap-2 text-sm text-primary hover:underline",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Зачем нужен email?"]}),j&&e.jsxs("div",{className:"p-4 bg-cloud/50 rounded-xl text-sm space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:"Email нужен для:"})}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"Идентификации пользователя в мобильном приложении"}),e.jsx("li",{children:"Загрузки личных данных и прогресса тренировок"}),e.jsx("li",{children:"Получения кодов подтверждения при отвязке устройств"}),e.jsx("li",{children:"Уведомлений о важных событиях"})]}),e.jsx("p",{className:"text-muted-foreground",children:"У каждого участника лицензии (родителя и ребёнка) должен быть свой email. Email нельзя изменить после привязки."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:`email-${s}`,className:"block text-sm font-medium mb-2",children:["Email ",a&&`для ${a}`]}),e.jsx("input",{id:`email-${s}`,type:"email",value:P,onChange:x=>_(x.target.value),placeholder:"example@mail.com",className:"w-full px-4 py-3 rounded-xl border-2 border-border focus:border-primary focus:outline-none transition-colors"})]}),L&&P!==L&&e.jsxs("button",{type:"button",onClick:n,className:"text-sm text-primary hover:underline",children:["Использовать ",L]})]}),f&&e.jsx(B,{variant:"error",message:f,icon:e.jsx(ye,{className:"w-5 h-5"}),onClose:()=>N(null)}),e.jsx("button",{onClick:S,disabled:y||!P.trim(),className:A("w-full px-4 py-3 rounded-xl font-medium transition-colors","bg-primary text-white hover:bg-primary/90","disabled:opacity-50 disabled:cursor-not-allowed"),children:y?"Сохранение...":"Привязать email"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Email нельзя изменить после привязки"})]})}function ss({type:s}){switch(s){case"mobile":return e.jsx(Z,{className:"w-5 h-5"});case"tablet":return e.jsx(Ve,{className:"w-5 h-5"});default:return e.jsx(Ie,{className:"w-5 h-5"})}}function ts({level:s}){switch(s){case"trusted":return e.jsx(Be,{className:"w-4 h-4 text-green-500"});case"standard":return e.jsx(Re,{className:"w-4 h-4 text-blue-500"});default:return e.jsx(qe,{className:"w-4 h-4 text-amber-500"})}}function ns({seatId:s,profileName:a,profileType:r,className:d}){const{activeDevices:t,currentDevice:m,binding:o,trustConfig:C,unbindsRemaining:M,hasEmail:T,checkCanUnbind:P,requestUnbind:_,confirmUnbind:y,cancelUnbind:D}=Se({seatId:s}),[f,N]=c.useState(null),[j,b]=c.useState(!1),[L,S]=c.useState(!1),[n,x]=c.useState(""),[v,$]=c.useState(!1),[E,U]=c.useState(null),[g,O]=c.useState(null),I=Math.max(0,M),V=async p=>{U(null),N(p);const k=P(p.id);if(!k.canUnbind){const H={no_email:"Email не привязан",limit_reached:`Лимит отвязок исчерпан. Следующая отвязка будет доступна ${k.unbindsResetAt?je(k.unbindsResetAt):"позже"}`,last_device:"Нельзя отвязать последнее устройство",pending_unbind:"Устройство уже в процессе отвязки"};U(H[k.reason||""]||"Невозможно отвязать устройство");return}b(!0)},J=async()=>{if(!f)return;$(!0),U(null);const p=await _(f.id);p.success?(b(!1),S(!0),O("Код подтверждения отправлен на вашу почту")):U(p.error||"Ошибка при отправке кода"),$(!1)},W=async()=>{if(!n||n.length!==6){U("Введите 6-значный код");return}$(!0),U(null);const p=await y(n);p.success?(S(!1),x(""),N(null),O(`Устройство будет отвязано через ${C.cooldownHours} ч.`)):U(p.error||"Неверный код"),$(!1)},G=async p=>{await D(p.id)&&O("Отвязка отменена")},R=()=>{b(!1),S(!1),x(""),N(null),U(null)};return T?e.jsxs("div",{className:A("space-y-6",d),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-medium",children:["Устройства ",a&&`(${a})`]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ts,{level:o==null?void 0:o.trust_level}),e.jsx("span",{children:Ge[(o==null?void 0:o.trust_level)||"new"]})]})]}),(o==null?void 0:o.email)&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-cloud/50 rounded-xl",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center",children:e.jsx(Ne,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Email для приложения"}),e.jsx("div",{className:"font-medium truncate",children:o.email})]}),o.email_verified&&e.jsx(ne,{className:"w-5 h-5 text-green-500 flex-shrink-0"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-cloud/50 rounded-2xl p-4",children:[e.jsxs("div",{className:"text-2xl font-semibold",children:[t.length,"/",C.maxDevices]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Устройств"})]}),e.jsxs("div",{className:"bg-cloud/50 rounded-2xl p-4",children:[e.jsxs("div",{className:"text-2xl font-semibold",children:[I,"/",C.unbindsPerMonth]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Отвязок в месяц"})]})]}),e.jsx(B,{variant:"info",message:Ye[(o==null?void 0:o.trust_level)||"new"],icon:e.jsx($e,{className:"w-5 h-5"})}),g&&e.jsx(B,{variant:"success",message:g,onClose:()=>O(null)}),E&&e.jsx(B,{variant:"error",message:E,onClose:()=>U(null)}),e.jsxs("div",{className:"space-y-3",children:[t.map(p=>{const k=(m==null?void 0:m.id)===p.id,H=p.status==="pending_unbind";return e.jsxs("div",{className:A("flex items-center gap-4 p-4 rounded-2xl border-2 transition-colors",k?"border-primary/30 bg-primary/5":H?"border-amber-200 bg-amber-50":"border-border bg-white"),children:[e.jsx("div",{className:A("flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center",k?"bg-primary/10 text-primary":"bg-cloud text-muted-foreground"),children:e.jsx(ss,{type:p.device_type})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:p.device_name}),k&&e.jsx("span",{className:"text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full",children:"Текущее"})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:H?e.jsxs("span",{className:"flex items-center gap-1 text-amber-600",children:[e.jsx(ke,{className:"w-3 h-3"}),"Отвязка через ",p.unbind_available_at&&je(p.unbind_available_at)]}):e.jsxs("span",{children:["Добавлено ",new Date(p.created_at).toLocaleDateString("ru-RU")]})})]}),e.jsx("div",{className:"flex-shrink-0",children:H?e.jsx("button",{onClick:()=>G(p),className:"p-2 rounded-xl text-amber-600 hover:bg-amber-100 transition-colors",title:"Отменить отвязку",children:e.jsx(Ee,{className:"w-5 h-5"})}):k?e.jsx(ne,{className:"w-5 h-5 text-green-500"}):e.jsx("button",{onClick:()=>V(p),className:"p-2 rounded-xl text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-colors",title:"Отвязать устройство",children:e.jsx(Oe,{className:"w-5 h-5"})})})]},p.id)}),Array.from({length:C.maxDevices-t.length}).map((p,k)=>e.jsxs("div",{className:"flex items-center gap-4 p-4 rounded-2xl border-2 border-dashed border-border/50",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-cloud/50 flex items-center justify-center text-muted-foreground/50",children:e.jsx(Z,{className:"w-5 h-5"})}),e.jsx("div",{className:"text-muted-foreground/50",children:"Свободный слот"})]},`empty-${k}`))]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Устройства привязываются автоматически при входе в мобильное приложение по email. Для отвязки устройства потребуется подтверждение по email."}),e.jsx(ve,{isOpen:j,onClose:R,title:"Отвязать устройство?",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted-foreground",children:["Вы уверены, что хотите отвязать устройство ",e.jsx("strong",{children:f==null?void 0:f.device_name}),"?"]}),e.jsx(B,{variant:"warning",message:`После подтверждения устройство будет отвязано через ${C.cooldownHours} часов. В течение этого времени вы сможете отменить отвязку.`,icon:e.jsx(Me,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:R,className:"flex-1 px-4 py-3 rounded-xl border-2 border-border hover:bg-cloud transition-colors",children:"Отмена"}),e.jsx("button",{onClick:J,disabled:v,className:"flex-1 px-4 py-3 rounded-xl bg-destructive text-white hover:bg-destructive/90 transition-colors disabled:opacity-50",children:v?"Отправка...":"Отвязать"})]})]})}),e.jsx(ve,{isOpen:L,onClose:R,title:"Введите код подтверждения",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted-foreground",children:["Мы отправили 6-значный код на вашу почту ",e.jsx("strong",{children:o==null?void 0:o.email})]}),!1,e.jsx("input",{type:"text",inputMode:"numeric",maxLength:6,value:n,onChange:p=>x(p.target.value.replace(/\D/g,"")),placeholder:"000000",className:"w-full text-center text-2xl tracking-widest px-4 py-4 rounded-xl border-2 border-border focus:border-primary focus:outline-none transition-colors",autoFocus:!0}),E&&e.jsx(B,{variant:"error",message:E}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:R,className:"flex-1 px-4 py-3 rounded-xl border-2 border-border hover:bg-cloud transition-colors",children:"Отмена"}),e.jsx("button",{onClick:W,disabled:v||n.length!==6,className:"flex-1 px-4 py-3 rounded-xl bg-primary text-white hover:bg-primary/90 transition-colors disabled:opacity-50",children:v?"Проверка...":"Подтвердить"})]})]})})]}):e.jsxs("div",{className:A("space-y-4",d),children:[e.jsxs("h3",{className:"text-lg font-medium",children:["Настройка приложения ",a&&`для ${a}`]}),e.jsx(es,{seatId:s,profileName:a,profileType:r})]})}const re=[{id:"individual",name:"Базовый",description:"Для одного участника",maxSeats:1,includesDevice:!0,price:8e4,period:"month",features:["Flex4 устройство","Программа без ограничений","Все типы тренировок (Концентрация, Спокойствие, Фокус)","Персональный прогресс и аналитика","Поддержка 24/7","Гарантия на устройство"]},{id:"family",name:"Родитель + Ребёнок",description:"Семейный",maxSeats:2,includesDevice:!0,price:12e4,period:"month",features:["Flex4 устройство","Программы для обоих (взрослые + дети)","Профили для родителя и ребёнка","Все типы тренировок (Концентрация, Спокойствие, Фокус)","Персональный прогресс для каждого","Поддержка 24/7","Гарантия на устройство","Приоритетная поддержка"]}],rs={active:"Активна",expired:"Истекла",cancelled:"Отменена",pending:"Ожидает оплаты"},as={active:"text-green-600",expired:"bg-muted text-muted-foreground",cancelled:"bg-destructive/20 text-destructive",pending:"bg-honey/20 text-honey-dark"};function De(s){return re.find(a=>a.id===s)}function _e(s){return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}function is(s,a=7){const r=new Date(s.expires_at),d=new Date,t=Math.floor((r.getTime()-d.getTime())/(1e3*60*60*24));return t<=a&&t>0}function cs(){const{user:s}=ae(),[a,r]=c.useState([]),[d,t]=c.useState([]);return{licenses:a,seats:d,loading:!1,error:null,purchaseLicense:async _=>{await new Promise(f=>setTimeout(f,1e3));const y=De(_);if(!y)throw new Error("Invalid plan");const D={id:`license_${Date.now()}`,user_id:(s==null?void 0:s.id)||"",plan_type:_,status:"active",starts_at:new Date().toISOString(),expires_at:new Date(Date.now()+30*24*60*60*1e3).toISOString(),auto_renew:!0,max_seats:y.maxSeats,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return r(f=>[...f,D]),D},assignSeat:async(_,y,D)=>{const f=a.find(b=>b.id===_);if(!f)throw new Error("License not found");if(d.filter(b=>b.license_id===_).length>=f.max_seats)throw new Error("No available seats");const j={id:`seat_${Date.now()}`,license_id:_,profile_id:y,profile:D,assigned_at:new Date().toISOString()};return t(b=>[...b,j]),j},removeSeat:async _=>{t(y=>y.filter(D=>D.id!==_))},linkDevice:async(_,y)=>{r(D=>D.map(f=>f.id===_?{...f,device_id:y,updated_at:new Date().toISOString()}:f))},hasLicense:a.length>0}}function _s(){const s=He(),{data:a}=Ae(),{licenses:r,seats:d,purchaseLicense:t,assignSeat:m,removeSeat:o,linkDevice:C,hasLicense:M}=cs(),{device:T,hasDevice:P}=Pe(),[_,y]=c.useState(!1),[D,f]=c.useState(!1),[N,j]=c.useState(null),b=async n=>{y(!0);try{await t(n),sessionStorage.setItem("license_purchased","true"),q.success("Лицензия успешно приобретена!"),f(!1),j(null)}catch{q.error("Ошибка при покупке лицензии")}finally{y(!1)}},L=n=>d.filter(x=>x.license_id===n),S=n=>{const x=d.filter(v=>v.license_id===n).map(v=>v.profile_id);return(a||[]).filter(v=>!x.includes(v.id))};return e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 py-8",children:[e.jsx("div",{className:"mb-8",children:e.jsx(ce,{size:"2xl",className:"mb-2",children:"Мои лицензии"})}),!M&&e.jsx("div",{className:"space-y-6",children:e.jsxs(Y,{className:"glass-elegant border-0 p-6 sm:p-8",children:[e.jsxs("div",{className:"text-center max-w-md mx-auto mb-8",children:[e.jsx(ce,{size:"xl",className:"mb-3",children:"У вас нет активных лицензий"}),e.jsx("p",{className:"text-muted-foreground",children:"Выберите подходящий план, чтобы начать использовать Waves"})]}),e.jsx("div",{className:"grid gap-6 md:grid-cols-2",children:re.map(n=>e.jsxs(Y,{className:A("relative p-6 transition-all cursor-pointer hover:shadow-lg bg-white border-0",N===n.id?"bg-coral/5":"hover:bg-coral/5"),onClick:()=>j(n.id),children:[n.id==="family"&&e.jsxs(le,{className:"absolute -top-2 -right-2 bg-honey text-ink",children:[e.jsx(ze,{className:"h-3 w-3 mr-1"}),"Популярный"]}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[n.id==="individual"?e.jsx(oe,{className:"h-8 w-8 text-coral"}):e.jsx(de,{className:"h-8 w-8 text-coral"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:n.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n.description})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-baseline gap-2 mb-1",children:[e.jsx("span",{className:"text-3xl font-bold",children:_e(n.price)}),n.id==="individual"&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"или 3 333 ₽/мес"}),n.id==="family"&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"или 5 000 ₽/мес"})]}),(n.id==="individual"||n.id==="family")&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Рассрочка на 24 месяца без переплаты"})]}),e.jsx("ul",{className:"space-y-2 mb-6",children:n.features.map((x,v)=>e.jsxs("li",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Le,{className:"h-4 w-4 text-coral flex-shrink-0"}),e.jsx("span",{children:x})]},v))}),e.jsx(z,{className:A("w-full",N===n.id?"bg-gradient-to-r from-coral to-coral-light":""),variant:N===n.id?"default":"outline",onClick:x=>{x.stopPropagation(),b(n.id)},disabled:_,children:_&&N===n.id?"Оформление...":"Выбрать план"})]},n.id))})]})}),M&&e.jsxs("div",{className:"space-y-6",children:[r.map(n=>{const x=De(n.plan_type),v=L(n.id),$=S(n.id),E=n.max_seats-v.length,U=is(n);return e.jsxs(Y,{className:"bg-white shadow-[0_4px_20px_rgba(0,0,0,0.06)] border-0 p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-coral/20 to-coral/10 flex items-center justify-center",children:n.plan_type==="individual"?e.jsx(oe,{className:"h-6 w-6 text-coral"}):e.jsx(de,{className:"h-6 w-6 text-coral"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:(x==null?void 0:x.name)||"Лицензия"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:x==null?void 0:x.description})]})]}),e.jsx(le,{className:A(as[n.status],"border-0 !from-transparent !to-transparent"),style:n.status==="active"?{background:"white",backgroundImage:"none",border:"1px solid rgba(34, 197, 94, 0.3)"}:{backgroundImage:"none"},children:rs[n.status]})]}),U&&e.jsxs("div",{className:"mb-6 flex items-center gap-2 p-3 bg-honey/10 border border-honey/30 rounded-lg",children:[e.jsx(ye,{className:"h-4 w-4 text-honey"}),e.jsxs("span",{className:"text-sm",children:["Лицензия истекает"," ",new Date(n.expires_at).toLocaleDateString("ru-RU")]}),e.jsx(z,{variant:"link",size:"sm",className:"ml-auto h-auto p-0",children:"Продлить"})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3 mb-6",children:[e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Действует до"}),e.jsx("p",{className:"font-medium",children:new Date(n.expires_at).toLocaleDateString("ru-RU")})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Участники"}),e.jsxs("p",{className:"font-medium",children:[v.length," из ",n.max_seats]})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Устройство"}),e.jsx("p",{className:"font-medium",children:n.device_id?"Подключено":"Не привязано"})]})]}),e.jsxs("div",{className:"border-t border-border/50 pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"font-medium",children:"Участники"}),E>0&&$.length>0&&e.jsxs(ue,{children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(z,{variant:"outline",size:"sm",children:[e.jsx(be,{className:"h-4 w-4 mr-1"}),"Добавить"]})}),e.jsxs(me,{children:[e.jsxs(xe,{children:[e.jsx(he,{children:"Добавить участника"}),e.jsx(fe,{children:"Выберите профиль для добавления в лицензию"})]}),e.jsx("div",{className:"space-y-2 mt-4",children:$.map(g=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-muted/50 transition-colors",onClick:async()=>{try{await m(n.id,g.id,{id:g.id,first_name:g.first_name,last_name:g.last_name||void 0,type:g.type}),q.success(`${g.first_name} добавлен в лицензию`)}catch{q.error("Ошибка при добавлении участника")}},children:[e.jsx(ge,{className:"h-10 w-10",children:e.jsx(pe,{children:g.first_name[0]})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-medium",children:[g.first_name," ",g.last_name||""]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:g.type==="parent"?"Родитель":"Ребёнок"})]}),e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"})]},g.id))})]})]})]}),v.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Нет добавленных участников"}):e.jsx("div",{className:"space-y-4",children:v.map(g=>{var O,I,V,J,W,G,R;return e.jsxs("div",{className:"p-4 bg-muted/30 rounded-xl space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ge,{className:"h-10 w-10",children:e.jsx(pe,{children:((I=(O=g.profile)==null?void 0:O.first_name)==null?void 0:I[0])||"?"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-medium",children:[(V=g.profile)==null?void 0:V.first_name," ",((J=g.profile)==null?void 0:J.last_name)||""]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[((W=g.profile)==null?void 0:W.type)==="parent"?"Родитель":"Ребёнок"," · Добавлен ",new Date(g.assigned_at).toLocaleDateString("ru-RU")]})]}),e.jsx(z,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-destructive",onClick:()=>{o(g.id),q.success("Участник удалён")},children:"Удалить"})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-border/30",children:e.jsx(ns,{seatId:g.id,profileName:(G=g.profile)==null?void 0:G.first_name,profileType:(R=g.profile)==null?void 0:R.type})})]},g.id)})}),E>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-3",children:["Доступно ещё ",E," ",E===1?"место":"места"]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-border/50",children:[e.jsx("h4",{className:"font-medium mb-4",children:"Физическое устройство"}),e.jsxs(z,{variant:"outline",className:"w-full sm:w-auto",onClick:async()=>{if(!n.device_id&&P&&T)try{await C(n.id,T.id),q.success("Устройство успешно привязано к лицензии")}catch{q.error("Ошибка при привязке устройства")}s("/cabinet/device")},children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),n.device_id?"Управление устройством":"Привязать устройство"]})]})]},n.id)}),e.jsxs(Y,{className:"bg-white shadow-[0_4px_20px_rgba(0,0,0,0.06)] border-0 p-6 text-center cursor-pointer hover:bg-coral/5 transition-colors",onClick:()=>f(!0),children:[e.jsx(be,{className:"h-8 w-8 text-coral mx-auto mb-2"}),e.jsx("p",{className:"text-foreground",children:"Приобрести ещё одну лицензию"})]})]}),e.jsx(ue,{open:D,onOpenChange:f,children:e.jsxs(me,{className:"max-w-2xl",children:[e.jsxs(xe,{children:[e.jsx(he,{children:"Выбор лицензии"}),e.jsx(fe,{children:"Выберите план, который подходит вам"})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 mt-4",children:re.map(n=>e.jsxs(Y,{className:A("relative p-4 border-2 cursor-pointer transition-all",N===n.id?"border-coral bg-coral/5":"border-border/50 hover:border-coral/50"),onClick:()=>j(n.id),children:[e.jsx("h4",{className:"font-semibold",children:n.name}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:n.description}),e.jsxs("p",{className:"text-xl font-bold",children:[_e(n.price),e.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:" / мес"})]})]},n.id))}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsx(z,{variant:"outline",onClick:()=>f(!1),children:"Отмена"}),e.jsx(z,{onClick:()=>N&&b(N),disabled:!N||_,className:"bg-gradient-to-r from-coral to-coral-light",children:_?"Оформление...":"Оформить"})]})]})})]})}export{_s as default};
