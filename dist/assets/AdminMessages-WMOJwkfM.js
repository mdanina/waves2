import{r,j as e}from"./vendor-radix-htwXsPHy.js";import{E as Ss,ad as _s,aG as Ms,aH as Te,aI as Is,a4 as ks,aJ as Rs,aK as Es,aL as Ls,C as ze,B as p,a5 as Gs,a9 as re,ai as W,o as ne,U as Ae,aC as B,aM as pe,aN as ie,r as Pe,x as De,y as Oe,aO as $e,G as V,aP as Ts,a2 as zs,V as As,W as Ps,X as Ds,Y as Os,L as Fe,aQ as $s,a0 as Fs,aR as q,aS as Ue,aT as We,aU as Us,aV as Ws,aW as Bs,aX as Be,aY as Vs,aZ as qs,a_ as Ve,a$ as Ks,b0 as Qs}from"./index-Dv2C02zj.js";import{S as le}from"./skeleton-_MojRjq8.js";import{u as Hs,S as qe,M as Ke,A as Qe,P as He}from"./MessageAttachment-CWLS7d3f.js";import{T as Xs,a as Ys,b as Xe}from"./tabs-BqI5JGIV.js";import{P as Ye}from"./plus-CrCC_Tdd.js";import{B as Zs}from"./bell-off-BuZ_taXD.js";import{S as Js}from"./search-BPVVDSxP.js";import{S as Ze}from"./shield-Cx4EwisG.js";import{S as Je}from"./send-CfHFoQor.js";import"./vendor-charts-DjioKZbK.js";import"./vendor-query-BNGVDYIL.js";import"./vendor-react-CI8wve7f.js";import"./download-B3icIhd6.js";import"./image-DNnGKu0q.js";function pt(){const{toast:g}=Ss(),{user:i}=_s(),{permission:fe,requestPermission:es,notifyNewMessage:K}=Hs(),E=r.useRef(null),Q=r.useRef(0),H=r.useRef(0),X=r.useRef(null),ge=r.useRef(null),ce=r.useRef([]),L=r.useRef(null),[C,M]=r.useState([]),[x,je]=r.useState(null),[Y,G]=r.useState([]),[S,T]=r.useState(""),[ss,Ne]=r.useState(!0),[ts,ye]=r.useState(!1),[N,Z]=r.useState(!1),[oe,as]=r.useState(""),[_,J]=r.useState("all"),[y,I]=r.useState(null),[b,z]=r.useState(!1),[f,rs]=r.useState(1),[P,ns]=r.useState(1),[is,ls]=r.useState(0),[k,cs]=r.useState("direct"),[be,de]=r.useState([]),[h,we]=r.useState(null),[ee,D]=r.useState([]),[me,ve]=r.useState(!1),[os,Ce]=r.useState(!1),[Se,ds]=r.useState(!1),[v,ms]=r.useState(1),[O,us]=r.useState(1),[xs,hs]=r.useState(0),[ps,$]=r.useState(!1),[F,se]=r.useState(""),[U,te]=r.useState([]),[ue,_e]=r.useState(!1),A=r.useCallback(()=>{setTimeout(()=>{var s;(s=E.current)==null||s.scrollIntoView({behavior:"smooth"})},100)},[]),w=r.useCallback(async(s=1,a=!1)=>{try{a&&Ne(!0);const n=await Ms({page:s,pageSize:Te});M(n.conversations),rs(n.page),ns(n.totalPages),ls(n.totalCount)}catch(n){console.error("Error loading conversations:",n),g({title:"Ошибка",description:"Не удалось загрузить беседы",variant:"destructive"})}finally{a&&Ne(!1)}},[g]);r.useEffect(()=>{i!=null&&i.id&&w(1,!0)},[i==null?void 0:i.id,w]);const fs=r.useCallback(()=>{f>1&&w(f-1,!1)},[f,w]),gs=r.useCallback(()=>{f<P&&w(f+1,!1)},[f,P,w]),Me=r.useMemo(()=>Is(()=>{w(f,!1)},2e3),[w,f]);r.useEffect(()=>{const s=()=>{i!=null&&i.id&&Me()};return window.addEventListener("focus",s),()=>window.removeEventListener("focus",s)},[i==null?void 0:i.id,Me]),r.useEffect(()=>{X.current=x},[x]),r.useEffect(()=>{ge.current=h},[h]),r.useEffect(()=>{ce.current=C},[C]),r.useEffect(()=>{if(!(i!=null&&i.id))return;const s=ks(i.id,async a=>{var n;try{if(a.is_support_message===!0)return;const t=a.sender_id,m=X.current,c=await q(a),o=((n=X.current)==null?void 0:n.recipientId)===(m==null?void 0:m.recipientId);if(m&&t===m.recipientId&&o)G(l=>[...l,c]),setTimeout(()=>{var l;(l=E.current)==null||l.scrollIntoView({behavior:"smooth"})},100),await Ue(t),M(l=>l.map(u=>u.recipientId===t?{...u,lastMessage:c,unreadCount:0}:u));else{const l=ce.current.find(u=>u.recipientId===t);l&&K(l.recipientName,c.content),M(u=>u.map(d=>d.recipientId===t?{...d,lastMessage:c,unreadCount:d.unreadCount+1}:d))}}catch(t){console.error("Error processing message:",t)}});return()=>s()},[i==null?void 0:i.id,K]),r.useEffect(()=>{if(!(i!=null&&i.id))return;const s=Rs(async a=>{try{if(a.sender_id===i.id)return;const n=a.sender_id,t=X.current,m=await q(a);if((t==null?void 0:t.recipientId)===n&&(t==null?void 0:t.recipientType)==="client")G(o=>[...o,m]),setTimeout(()=>{var o;(o=E.current)==null||o.scrollIntoView({behavior:"smooth"})},100),await Ve(n),M(o=>o.map(l=>l.recipientId===n?{...l,lastMessage:m,unreadCount:0}:l));else{const o=ce.current.find(l=>l.recipientId===n);o&&K(o.recipientName,m.content),M(l=>l.find(d=>d.recipientId===n)?l.map(d=>d.recipientId===n?{...d,lastMessage:m,unreadCount:d.unreadCount+1}:d):(w(f,!1),l))}}catch(n){console.error("Error processing support message:",n)}});return()=>s()},[i==null?void 0:i.id,K,w,f]),r.useEffect(()=>{Y.length>0&&A()},[Y,A]),r.useEffect(()=>{ee.length>0&&A()},[ee,A]);const js=async(s,a)=>{const n=++Q.current;try{ye(!0);const t=a==="client",m=t?await Ks(s):await Qs(s);if(n!==Q.current)return;G(m),t?await Ve(s):await Ue(s),M(c=>c.map(o=>o.recipientId===s?{...o,unreadCount:0}:o))}catch(t){if(n!==Q.current)return;console.error("Error loading messages:",t),g({title:"Ошибка",description:"Не удалось загрузить сообщения",variant:"destructive"})}finally{n===Q.current&&ye(!1)}},Ns=s=>{je(s),we(null),js(s.recipientId,s.recipientType)},Ie=s=>{var n;const a=(n=s.target.files)==null?void 0:n[0];if(a){if(a.size>10*1024*1024){g({title:"Файл слишком большой",description:"Максимальный размер файла — 10MB",variant:"destructive"});return}I(a)}L.current&&(L.current.value="")},ke=async()=>{if(!S.trim()&&!y||!x||!i||N||b)return;const s=S.trim(),a=`temp-${Date.now()}`,n=x.recipientId,t=y,m={id:a,sender_id:i.id,recipient_id:n,content:s,is_read:!1,read_at:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),attachment_url:t?URL.createObjectURL(t):null,attachment_name:(t==null?void 0:t.name)||null,attachment_type:(t==null?void 0:t.type)||null,attachment_size:(t==null?void 0:t.size)||null};G(c=>[...c,m]),T(""),I(null),A(),Z(!0);try{let c;t&&(z(!0),c=await We(n,t),z(!1));const l=x.recipientType==="client"?await Us(n,s,c):await Ws(n,s,c),u=await q(l);G(d=>d.map(j=>{var Ge;return j.id===a?((Ge=j.attachment_url)!=null&&Ge.startsWith("blob:")&&URL.revokeObjectURL(j.attachment_url),u):j})),M(d=>d.map(j=>j.recipientId===n?{...j,lastMessage:u}:j))}catch(c){console.error("Error sending message:",c),G(o=>{var u;const l=o.find(d=>d.id===a);return(u=l==null?void 0:l.attachment_url)!=null&&u.startsWith("blob:")&&URL.revokeObjectURL(l.attachment_url),o.filter(d=>d.id!==a)}),T(s),t&&I(t),z(!1),g({title:"Ошибка",description:c instanceof Error?c.message:"Не удалось отправить сообщение",variant:"destructive"})}finally{Z(!1)}},R=r.useCallback(async(s=1)=>{try{ve(!0);const a=await Es({page:s,pageSize:Te});de(a.conversations),ms(a.page),us(a.totalPages),hs(a.totalCount),ds(!0)}catch(a){console.error("Error loading group conversations:",a),g({title:"Ошибка",description:"Не удалось загрузить групповые чаты",variant:"destructive"})}finally{ve(!1)}},[g]);r.useEffect(()=>{k==="groups"&&!Se&&!me&&R(1)},[k,Se,me,R]);const ys=r.useCallback(()=>{v>1&&R(v-1)},[v,R]),bs=r.useCallback(()=>{v<O&&R(v+1)},[v,O,R]),ws=async s=>{const a=++H.current,n=s.group.id;we(s),je(null);try{Ce(!0);const t=await Bs(n);if(a!==H.current)return;if(D(t),t.length>0){const m=t[t.length-1];await Be(n,m.id),de(c=>c.map(o=>o.group.id===n?{...o,unreadCount:0}:o))}}catch(t){if(a!==H.current)return;console.error("Error loading group messages:",t),g({title:"Ошибка",description:"Не удалось загрузить сообщения группы",variant:"destructive"})}finally{a===H.current&&Ce(!1)}};r.useEffect(()=>{if(!h||!(i!=null&&i.id))return;const s=h.group.id,a=h.members,n=Ls(s,async t=>{var m;try{if(t.sender_id===i.id)return;const c=a.find(l=>l.user_id===t.sender_id);let o={...t,senderName:(c==null?void 0:c.userName)||"Пользователь",senderAvatar:(c==null?void 0:c.userAvatar)||null};if(o=await q(o),((m=ge.current)==null?void 0:m.group.id)!==s)return;D(l=>[...l,o]),setTimeout(()=>{var l;(l=E.current)==null||l.scrollIntoView({behavior:"smooth"})},100),await Be(s,t.id)}catch(c){console.error("Error processing group message:",c)}});return()=>n()},[h==null?void 0:h.group.id,i==null?void 0:i.id]);const Re=async()=>{if(!S.trim()&&!y||!h||!i||N||b)return;const s=S.trim(),a=`temp-${Date.now()}`,n=h.group.id,t=y,m={id:a,group_id:n,sender_id:i.id,content:s,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),senderName:"Вы",attachment_url:t?URL.createObjectURL(t):null,attachment_name:(t==null?void 0:t.name)||null,attachment_type:(t==null?void 0:t.type)||null,attachment_size:(t==null?void 0:t.size)||null};D(c=>[...c,m]),T(""),I(null),A(),Z(!0);try{let c;t&&(z(!0),c=await We(n,t),z(!1));const o=await Vs(n,s,c),l=await q(o);D(u=>u.map(d=>{var j;return d.id===a?((j=d.attachment_url)!=null&&j.startsWith("blob:")&&URL.revokeObjectURL(d.attachment_url),{...l,senderName:"Вы"}):d})),de(u=>u.map(d=>d.group.id===n?{...d,lastMessage:{...l,senderName:"Вы"}}:d))}catch(c){console.error("Error sending group message:",c),D(o=>{var u;const l=o.find(d=>d.id===a);return(u=l==null?void 0:l.attachment_url)!=null&&u.startsWith("blob:")&&URL.revokeObjectURL(l.attachment_url),o.filter(d=>d.id!==a)}),T(s),t&&I(t),z(!1),g({title:"Ошибка",description:c instanceof Error?c.message:"Не удалось отправить сообщение",variant:"destructive"})}finally{Z(!1)}},vs=async()=>{if(!(!F.trim()||U.length===0||ue)){_e(!0);try{await qs(F.trim(),U),await R(),$(!1),se(""),te([]),g({title:"Группа создана",description:`Группа "${F.trim()}" успешно создана`})}catch(s){console.error("Error creating group:",s),g({title:"Ошибка",description:s instanceof Error?s.message:"Не удалось создать группу",variant:"destructive"})}finally{_e(!1)}}},Cs=s=>{te(a=>a.includes(s)?a.filter(n=>n!==s):[...a,s])},Ee=r.useDeferredValue(oe),Le=r.useMemo(()=>{const s=Ee.toLowerCase();return C.filter(a=>{var n,t;return _!=="all"&&a.recipientType!==_?!1:s?a.recipientName.toLowerCase().includes(s)||((n=a.specialization)==null?void 0:n.toLowerCase().includes(s))||((t=a.adminRole)==null?void 0:t.toLowerCase().includes(s)):!0})},[C,Ee,_]),xe=s=>{switch(s){case"client":return{bgClass:"bg-green-100 text-green-600",textClass:"text-green-600",Icon:Ae};case"specialist":return{bgClass:"bg-blue-100 text-blue-600",textClass:"text-blue-600",Icon:qe};case"admin":return{bgClass:"bg-purple-100 text-purple-600",textClass:"text-purple-600",Icon:Ze}}},he=s=>s.recipientType==="specialist"?s.specialization||"Специалист":s.recipientType==="admin"?s.adminRole||"Администратор":"Клиент",ae=r.useMemo(()=>{const s={all:C.length,client:0,specialist:0,admin:0};for(const a of C)s[a.recipientType]++;return s},[C]);return ss?e.jsx("div",{className:"h-[calc(100vh-12rem)]",children:e.jsx(ze,{className:"h-full",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"w-80 border-r p-4 space-y-4",children:[e.jsx(le,{className:"h-10 w-full"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsx(le,{className:"h-16 w-full"},s))})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(le,{className:"h-8 w-48"})})]})})}):e.jsxs("div",{className:"h-[calc(100vh-12rem)]",children:[e.jsx(ze,{className:"h-full",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"w-80 border-r flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"font-semibold",children:"Сообщения"}),e.jsxs("div",{className:"flex items-center gap-1",children:[k==="groups"&&e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>$(!0),title:"Создать группу",children:e.jsx(Ye,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:es,title:fe==="granted"?"Уведомления включены":"Включить уведомления",children:fe==="granted"?e.jsx(Gs,{className:"h-4 w-4 text-primary"}):e.jsx(Zs,{className:"h-4 w-4 text-muted-foreground"})})]})]}),e.jsx(Xs,{value:k,onValueChange:s=>cs(s),children:e.jsxs(Ys,{className:"w-full",children:[e.jsxs(Xe,{value:"direct",className:"flex-1",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),"Личные"]}),e.jsxs(Xe,{value:"groups",className:"flex-1",children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"Группы"]})]})}),k==="direct"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(Js,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ne,{placeholder:"Поиск...",value:oe,onChange:s=>as(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-1 flex-wrap",children:[e.jsxs(p,{variant:_==="all"?"default":"outline",size:"sm",onClick:()=>J("all"),className:"text-xs h-7",children:["Все (",ae.all,")"]}),e.jsxs(p,{variant:_==="client"?"default":"outline",size:"sm",onClick:()=>J("client"),className:"text-xs h-7",children:[e.jsx(Ae,{className:"w-3 h-3 mr-1"}),ae.client]}),e.jsxs(p,{variant:_==="specialist"?"default":"outline",size:"sm",onClick:()=>J("specialist"),className:"text-xs h-7",children:[e.jsx(qe,{className:"w-3 h-3 mr-1"}),ae.specialist]}),e.jsxs(p,{variant:_==="admin"?"default":"outline",size:"sm",onClick:()=>J("admin"),className:"text-xs h-7",children:[e.jsx(Ze,{className:"w-3 h-3 mr-1"}),ae.admin]})]})]})]}),k==="direct"&&e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"flex-1",children:Le.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(re,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:oe||_!=="all"?"Ничего не найдено":"Нет собеседников"})]}):e.jsx("div",{className:"p-2",children:Le.map(s=>{const a=xe(s.recipientType);return e.jsx("button",{onClick:()=>Ns(s),className:`w-full p-3 rounded-lg text-left transition-colors ${(x==null?void 0:x.recipientId)===s.recipientId?"bg-primary/10":"hover:bg-muted"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[s.recipientAvatar?e.jsx("img",{src:s.recipientAvatar,alt:s.recipientName,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:pe(s.recipientName)}),e.jsx("div",{className:`absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center ${a.bgClass}`,children:e.jsx(a.Icon,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium truncate",children:s.recipientName}),s.lastMessage&&e.jsx("span",{className:"text-xs text-muted-foreground",children:ie(s.lastMessage.created_at)})]}),e.jsx("p",{className:`text-xs truncate mb-0.5 ${a.textClass}`,children:he(s)}),s.lastMessage&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.lastMessage.sender_id===(i==null?void 0:i.id)?"Вы: ":"",s.lastMessage.content]})]}),s.unreadCount>0&&e.jsx(Pe,{className:"ml-2",children:s.unreadCount})]})},s.recipientId)})})}),P>1&&e.jsxs("div",{className:"p-2 border-t flex items-center justify-between",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:fs,disabled:f<=1,className:"h-8 px-2",children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[f," / ",P," (",is,")"]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:gs,disabled:f>=P,className:"h-8 px-2",children:e.jsx(Oe,{className:"h-4 w-4"})})]})]}),k==="groups"&&e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"flex-1",children:me?e.jsx("div",{className:"p-4 space-y-3",children:[1,2,3].map(s=>e.jsx(le,{className:"h-16 w-full"},s))}):be.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(W,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Нет групповых чатов"}),e.jsxs(p,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>$(!0),children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Создать группу"]})]}):e.jsx("div",{className:"p-2",children:be.map(s=>e.jsx("button",{onClick:()=>ws(s),className:`w-full p-3 rounded-lg text-left transition-colors ${(h==null?void 0:h.group.id)===s.group.id?"bg-primary/10":"hover:bg-muted"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(W,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium truncate",children:s.group.name}),s.lastMessage&&e.jsx("span",{className:"text-xs text-muted-foreground",children:ie(s.lastMessage.created_at)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[s.members.length," ",$e(s.members.length,"участник","участника","участников")]}),s.lastMessage&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.lastMessage.senderName,": ",s.lastMessage.content]})]}),s.unreadCount>0&&e.jsx(Pe,{className:"ml-2",children:s.unreadCount})]})},s.group.id))})}),O>1&&e.jsxs("div",{className:"p-2 border-t flex items-center justify-between",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:ys,disabled:v<=1,className:"h-8 px-2",children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[v," / ",O," (",xs,")"]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:bs,disabled:v>=O,className:"h-8 px-2",children:e.jsx(Oe,{className:"h-4 w-4"})})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[x.recipientAvatar?e.jsx("img",{src:x.recipientAvatar,alt:x.recipientName,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:pe(x.recipientName)}),(()=>{const s=xe(x.recipientType);return e.jsx("div",{className:`absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center ${s.bgClass}`,children:e.jsx(s.Icon,{className:"w-3 h-3"})})})()]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:x.recipientName}),e.jsx("p",{className:`text-sm ${xe(x.recipientType).textClass}`,children:he(x)})]})]}),e.jsx(B,{className:"flex-1 p-4",children:ts?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(V,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):Y.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(re,{className:"h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Нет сообщений"}),e.jsx("p",{className:"text-sm mt-1",children:"Начните беседу"})]}):e.jsxs("div",{className:"space-y-4",children:[Y.map(s=>{const a=s.sender_id===(i==null?void 0:i.id);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:[s.content&&e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.attachment_url&&s.attachment_name&&s.attachment_type&&s.attachment_size&&e.jsx(Ke,{url:s.attachment_url,name:s.attachment_name,type:s.attachment_type,size:s.attachment_size,isOwn:a}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:ie(s.created_at)}),a&&(s.is_read?e.jsx(Ts,{className:"h-3 w-3"}):e.jsx(zs,{className:"h-3 w-3"}))]})]})},s.id)}),e.jsx("div",{ref:E})]})}),e.jsxs("div",{className:"p-4 border-t space-y-2",children:[y&&e.jsx(Qe,{file:y,onRemove:()=>I(null)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:L,onChange:Ie,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>{var s;return(s=L.current)==null?void 0:s.click()},disabled:N||b,title:"Прикрепить файл",children:e.jsx(He,{className:"h-4 w-4"})}),e.jsx(ne,{placeholder:"Введите сообщение...",value:S,onChange:s=>T(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),ke())},disabled:N||b}),e.jsx(p,{onClick:ke,disabled:!S.trim()&&!y||N||b,children:N||b?e.jsx(V,{className:"h-4 w-4 animate-spin"}):e.jsx(Je,{className:"h-4 w-4"})})]})]})]}):h?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(W,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:h.group.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h.members.length," ",$e(h.members.length,"участник","участника","участников")]})]})]}),e.jsx(B,{className:"flex-1 p-4",children:os?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(V,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):ee.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(W,{className:"h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Нет сообщений"}),e.jsx("p",{className:"text-sm mt-1",children:"Начните беседу в группе"})]}):e.jsxs("div",{className:"space-y-4",children:[ee.map(s=>{const a=s.sender_id===(i==null?void 0:i.id);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!a&&e.jsx("p",{className:"text-xs font-medium mb-1 opacity-80",children:s.senderName||"Пользователь"}),s.content&&e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.attachment_url&&s.attachment_name&&s.attachment_type&&s.attachment_size&&e.jsx(Ke,{url:s.attachment_url,name:s.attachment_name,type:s.attachment_type,size:s.attachment_size,isOwn:a}),e.jsx("div",{className:"flex items-center justify-end gap-1 mt-1",children:e.jsx("span",{className:"text-xs opacity-70",children:ie(s.created_at)})})]})},s.id)}),e.jsx("div",{ref:E})]})}),e.jsxs("div",{className:"p-4 border-t space-y-2",children:[y&&e.jsx(Qe,{file:y,onRemove:()=>I(null)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:L,onChange:Ie,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>{var s;return(s=L.current)==null?void 0:s.click()},disabled:N||b,title:"Прикрепить файл",children:e.jsx(He,{className:"h-4 w-4"})}),e.jsx(ne,{placeholder:"Введите сообщение...",value:S,onChange:s=>T(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),Re())},disabled:N||b}),e.jsx(p,{onClick:Re,disabled:!S.trim()&&!y||N||b,children:N||b?e.jsx(V,{className:"h-4 w-4 animate-spin"}):e.jsx(Je,{className:"h-4 w-4"})})]})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-muted-foreground",children:[e.jsx(re,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Выберите беседу"}),e.jsx("p",{className:"text-sm mt-1",children:"Выберите собеседника из списка слева"})]})})]})}),e.jsx(As,{open:ps,onOpenChange:s=>{$(s),s||(se(""),te([]))},children:e.jsxs(Ps,{className:"max-w-md",children:[e.jsx(Ds,{children:e.jsx(Os,{children:"Создать групповой чат"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"groupName",children:"Название группы"}),e.jsx(ne,{id:"groupName",placeholder:"Введите название...",value:F,onChange:s=>se(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Fe,{children:["Участники (",U.length," выбрано)"]}),e.jsx(B,{className:"h-48 border rounded-md p-2",children:C.map(s=>e.jsxs("div",{className:"flex items-center gap-2 p-2 hover:bg-muted rounded cursor-pointer",onClick:()=>Cs(s.recipientId),children:[e.jsx($s,{checked:U.includes(s.recipientId)}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[s.recipientAvatar?e.jsx("img",{src:s.recipientAvatar,alt:s.recipientName,className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-xs font-medium",children:pe(s.recipientName)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.recipientName}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:he(s)})]})]})]},s.recipientId))})]})]}),e.jsxs(Fs,{children:[e.jsx(p,{variant:"outline",onClick:()=>{$(!1),se(""),te([])},children:"Отмена"}),e.jsxs(p,{onClick:vs,disabled:!F.trim()||U.length===0||ue,children:[ue?e.jsx(V,{className:"h-4 w-4 animate-spin mr-2"}):null,"Создать"]})]})]})})]})}export{pt as default};
