import{r as s}from"./vendor-radix-htwXsPHy.js";import{u as z}from"./vendor-query-BNGVDYIL.js";import{p as F,m as o,g as w}from"./index-Dv2C02zj.js";import{getProfiles as L}from"./profileStorage-CNyPVPjQ.js";import{g as V,a as j,c as B,s as G,u as H}from"./assessmentStorage-C8gjZ2L4.js";import{e as J}from"./vendor-react-CI8wve7f.js";function $({assessmentType:u,totalSteps:S,profileId:P}){const D=J(),{currentProfileId:E}=F(),M=z(),[c,d]=s.useState(null),[h,g]=s.useState(!1),[i,b]=s.useState(null),[C,v]=s.useState(1),[m,A]=s.useState(new Map),[k,y]=s.useState(!0);s.useEffect(()=>{let e=!1;async function n(){const r=P||D.profileId||E;if(u==="parent"||u==="family")try{const t=await L();if(e)return;const l=t.find(a=>a.type==="parent");if(l){d(l.id),g(!0);return}}catch(t){o.error("Error loading profiles:",t),e||(d(r||null),g(!0));return}e||(d(r||null),g(!0))}return n(),()=>{e=!0}},[P,D.profileId,E,u]),s.useEffect(()=>{async function e(){if(!h)return;if(!c){o.warn("Profile ID not found"),y(!1);return}const n=c;try{y(!0);const{id:r,assessment:t}=await V(n,u,S);b(r),v(t.current_step||1);const l=await j(t.id),a=new Map;l.forEach(f=>{a.set(f.question_id,f.value)}),A(a)}catch(r){o.error("Error initializing assessment:",r),w.error("Ошибка при загрузке оценки. Попробуйте обновить страницу.")}finally{y(!1)}}e()},[c,h,u,S]);const x=async(e,n,r,t,l,a)=>{if(!i){o.warn("Assessment ID not available - answer will NOT be saved!");return}const f=m.get(e),Q=C;A(p=>new Map(p).set(e,t)),v(a);try{await G(i,{questionId:e,questionCode:n,category:r,value:t,answerType:l,stepNumber:a}),await H(i,a)}catch(p){throw o.error("Error saving answer:",p),A(_=>{const I=new Map(_);return f!==void 0?I.set(e,f):I.delete(e),I}),v(Q),w.error("Ошибка при сохранении ответа. Попробуйте еще раз."),p}},K=async()=>{if(!i||!c)return o.warn("Assessment ID or Profile ID not available"),null;try{const e=await B(i);return await M.invalidateQueries({predicate:n=>{const r=n.queryKey[0];return["assessments","active-assessments","profiles","appointments","appointments-with-type","active-free-consultation"].includes(r)||r==="assessment"&&n.queryKey[1]===c}}),w.success("Оценка завершена!"),e}catch(e){return o.error("Error completing assessment:",e),w.error("Ошибка при завершении оценки"),null}},O=s.useCallback(e=>m.get(e)??null,[m]);return{assessmentId:i,currentStep:C,savedAnswers:m,loading:k,saveAnswer:x,complete:K,getSavedAnswer:O}}export{$ as u};
