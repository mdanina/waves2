import{r as v,j as e}from"./vendor-radix-ClAtPGFM.js";import{p as ds,a as kt}from"./friendly-and-clean-face-of-an-adult-person--gender (1)-mshj5uDX.js";import{c as us,a as fs}from"./friendly-and-clean-face-of-a-white-boy-7-yo--soft- (1)-BoJK1GJM.js";import{K as Rt,u as mt,w as Q,C as we,h as Je,N as Ct,O as Le,Q as ms,R as hs,T as Ve,V as qe,W as He,s as pe,B as O,X as Ne,Y as xs,Z as ct,D as Ce,E as Se,G as Ie,_ as Pe,$ as Ee,a0 as Bt,L as ps,a1 as Ut,a2 as Vt,f as ge,a3 as gs,q as js,a4 as vs,p as le,i as je,S as Ae,a5 as lt,t as ys,v as bs,x as qt,z as Ht,a6 as ws,r as Ns,a7 as _s,m as St,a8 as Et,a9 as At,y as ks,U as Qe}from"./index-BetUtCwY.js";import{isEligibleForCheckup as Ue,calculateAge as Cs,deleteProfile as Ss}from"./profileStorage-Bslow6L6.js";import{u as Es}from"./useProfiles-yoc-XtR9.js";import{u as Tt,a as Dt}from"./useAssessments-dUshUDQV.js";import{b as As,a as Ts}from"./useAppointments-CxXmeEP8.js";import{f as Lt}from"./moscowTime-Bf471xDt.js";import{A as Ze,h as Xe,a as et,b as tt,c as st,d as nt,e as rt,f as it,g as at}from"./alert-dialog-FEUrzu2i.js";import{S as Ds}from"./separator-BccFbfIq.js";import{B as dt}from"./briefcase-BEoGvIMr.js";import{P as Ls}from"./play-DchjK5rP.js";import{G as Is,B as Ps}from"./graduation-cap-DS1J5rRQ.js";import{S as Ms}from"./star-Co5D5f_2.js";import{g as Os,b as zs,a as Fs,r as $s}from"./calendar-feed-COy6bqNj.js";import{C as Rs}from"./copy-fhl1tURB.js";import{T as Bs}from"./trash-2-wNFmdxdD.js";import{u as Yt}from"./vendor-react-C_NXOhYK.js";import{E as Us}from"./external-link-zoBgkYNu.js";import{A as Vs}from"./arrow-right-DV4nD0Zh.js";import{s as qs,g as It}from"./supabase-messages-D8DPf7EN.js";import{u as Hs}from"./vendor-query-DNK10Tnx.js";import{E as ot}from"./eye-8rF4uclz.js";import{P as Pt}from"./plus-DZlllSoy.js";import"./vendor-charts-DLBwBPLi.js";import"./assessmentStorage-wjVU0Ga4.js";import"./appointmentStorage-DwszACBB.js";const Ys={child_psychology:"Детская психология",family_therapy:"Семейная терапия",cbt:"КПТ",trauma:"Работа с травмой",anxiety:"Тревожные расстройства",depression:"Депрессия",adhd:"СДВГ",autism:"Аутизм",eating_disorders:"Расстройства питания",parenting:"Родительство",psychologist:"Психолог",psychiatrist:"Психиатр",psychotherapist:"Психотерапевт",clinical_psychologist:"Клинический психолог",child_psychologist:"Детский психолог",family_therapist:"Семейный терапевт",neuropsychologist:"Нейропсихолог",logopedist:"Логопед",defectologist:"Дефектолог",art_therapist:"Арт-терапевт",cbt_specialist:"Специалист по КПТ",coordinator:"Координатор"},Gs={higher:"Высшее образование",additional:"Дополнительное образование",certification:"Сертификация",course:"Курс"};function Ws({specialistId:t,showChangeButton:s=!0,onSpecialistChange:i}){const{toast:a}=Rt(),{user:c}=mt(),[n,o]=v.useState(null),[m,d]=v.useState([]),[l,y]=v.useState(!0),[p,j]=v.useState(!1),[N,u]=v.useState(!1),[f,g]=v.useState(""),[h,x]=v.useState(!1),[b,T]=v.useState(!1);v.useEffect(()=>{D()},[t,c]);const D=async()=>{if(c)try{y(!0);let w=null;if(t){const{data:I,error:$}=await Q.from("specialists").select("*").eq("id",t).single();if($)throw $;w=I}else{const{data:I,error:$}=await Q.from("client_assignments").select("specialist_id").eq("client_user_id",c.id).eq("status","active").single();if($){if($.code==="PGRST116"){o(null),y(!1);return}throw $}const{data:H,error:Y}=await Q.from("specialists").select("*").eq("id",I.specialist_id).single();if(Y)throw Y;w=H}if(o(w),w){const{data:I}=await Q.from("specialist_education").select("*").eq("specialist_id",w.id).order("year_end",{ascending:!1,nullsFirst:!1});d(I||[]);const{data:$}=await Q.from("specialist_change_requests").select("id").eq("client_user_id",c.id).eq("status","pending").single();T(!!$)}}catch(w){console.error("Error loading specialist data:",w),a({title:"Ошибка",description:"Не удалось загрузить данные специалиста",variant:"destructive"})}finally{y(!1)}},L=w=>{const I=w.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);if(I)return`https://www.youtube.com/embed/${I[1]}`;const $=w.match(/vimeo\.com\/(?:video\/)?(\d+)/);return $?`https://player.vimeo.com/video/${$[1]}`:null},S=async()=>{if(!(!c||!n))try{x(!0);const{error:w}=await Q.from("specialist_change_requests").insert({client_user_id:c.id,current_specialist_id:n.id,reason:f||null,status:"pending"});if(w)throw w;a({title:"Запрос отправлен",description:"Координатор рассмотрит ваш запрос на смену специалиста"}),u(!1),g(""),T(!0),i==null||i()}catch(w){console.error("Error submitting change request:",w),a({title:"Ошибка",description:"Не удалось отправить запрос",variant:"destructive"})}finally{x(!1)}},E=w=>w.split(" ").map($=>$[0]).join("").toUpperCase().slice(0,2),k=(w,I)=>w&&I?`${w} - ${I}`:I?`${I}`:w?`с ${w}`:null;if(l)return e.jsx(we,{children:e.jsx(Je,{className:"flex items-center justify-center py-12",children:e.jsx(Ct,{className:"h-8 w-8 animate-spin text-muted-foreground"})})});if(!n)return e.jsx(we,{children:e.jsxs(Je,{className:"py-8 text-center",children:[e.jsx(Le,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Вам пока не назначен специалист. После установочной встречи координатор подберёт для вас подходящего специалиста."})]})});const F=n.video_intro_url?L(n.video_intro_url):null;return e.jsxs(e.Fragment,{children:[e.jsxs(we,{children:[e.jsx(ms,{children:e.jsxs(hs,{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-5 w-5"}),"Ваш специалист"]})}),e.jsxs(Je,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs(Ve,{className:"h-20 w-20",children:[e.jsx(qe,{src:n.avatar_url||void 0}),e.jsx(He,{className:"text-xl",children:E(n.display_name)})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-xl font-semibold",children:n.display_name}),n.experience_years&&e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx(dt,{className:"h-4 w-4"}),"Опыт работы: ",n.experience_years," лет"]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:e.jsx(pe,{variant:n.is_available?"default":"secondary",children:n.is_available?"Доступен":"Не в сети"})})]})]}),n.specialization_codes.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Специализации:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.specialization_codes.map(w=>e.jsx(pe,{variant:"outline",children:Ys[w]||w},w))})]}),n.bio&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"О специалисте:"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:n.bio})]}),n.video_intro_url&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Видеовизитка:"}),e.jsxs(O,{variant:"outline",onClick:()=>j(!0),className:"w-full sm:w-auto",children:[e.jsx(Ls,{className:"mr-2 h-4 w-4"}),"Смотреть видео"]})]}),m.length>0&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium mb-3 flex items-center gap-2",children:[e.jsx(Is,{className:"h-4 w-4"}),"Образование:"]}),e.jsx("div",{className:"space-y-3",children:m.map(w=>e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ps,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:w.institution})]}),w.specialty&&e.jsx("p",{className:"text-sm text-muted-foreground pl-6",children:w.specialty}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground pl-6",children:[k(w.year_start,w.year_end)&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ne,{className:"h-3 w-3"}),k(w.year_start,w.year_end)]}),e.jsx("span",{className:"px-2 py-0.5 bg-muted rounded",children:Gs[w.education_type]||w.education_type})]})]},w.id))})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx(Ds,{}),b?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground p-3 bg-muted/50 rounded-lg",children:[e.jsx(xs,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{children:"Ваш запрос на смену специалиста рассматривается"})]}):e.jsxs(O,{variant:"outline",onClick:()=>u(!0),className:"w-full",children:[e.jsx(ct,{className:"mr-2 h-4 w-4"}),"Запросить смену специалиста"]})]})]})]}),e.jsx(Ce,{open:p,onOpenChange:j,children:e.jsxs(Se,{className:"max-w-3xl w-[90vw] p-0",children:[e.jsx(Ie,{className:"px-6 pt-6",children:e.jsxs(Pe,{children:["Видеовизитка ",n.display_name]})}),e.jsx("div",{className:"px-6 pb-6",children:F?e.jsx("div",{className:"relative w-full",style:{paddingBottom:"56.25%"},children:e.jsx("iframe",{className:"absolute top-0 left-0 w-full h-full rounded-lg",src:F,title:"Видеовизитка специалиста",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsxs("p",{className:"text-muted-foreground",children:["Видео доступно по"," ",e.jsx("a",{href:n.video_intro_url,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:"ссылке"})]})]})})]})}),e.jsx(Ce,{open:N,onOpenChange:u,children:e.jsxs(Se,{children:[e.jsxs(Ie,{children:[e.jsx(Pe,{children:"Запросить смену специалиста"}),e.jsx(Bt,{children:"Если вы чувствуете, что текущий специалист вам не подходит, вы можете запросить смену. Координатор подберет вам другого специалиста."})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ps,{htmlFor:"change-reason",children:"Причина смены (необязательно)"}),e.jsx(Ut,{id:"change-reason",value:f,onChange:w=>g(w.target.value),placeholder:"Опишите, почему вы хотите сменить специалиста...",rows:3}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Это поможет координатору лучше подобрать нового специалиста"})]})}),e.jsxs(Vt,{children:[e.jsx(O,{variant:"outline",onClick:()=>u(!1),disabled:h,children:"Отмена"}),e.jsx(O,{onClick:S,disabled:h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(Ct,{className:"mr-2 h-4 w-4 animate-spin"}),"Отправка..."]}):"Отправить запрос"})]})]})})]})}async function Mt(){const{data:{user:t}}=await Q.auth.getUser();if(!t)return null;const{data:s,error:i}=await Q.rpc("get_pending_ratings_for_user",{p_user_id:t.id});return i?(console.error("Error fetching pending rating:",i),null):!s||s.length===0?null:s[0]}async function Ks(t){const{data:{user:s}}=await Q.auth.getUser();if(!s)return{success:!1,error:"Пользователь не авторизован"};const{error:i}=await Q.from("specialist_ratings").insert({appointment_id:t.appointment_id,client_user_id:s.id,specialist_id:t.specialist_id,rating:t.rating,review_text:t.review_text||null});return i?(console.error("Error submitting rating:",i),{success:!1,error:i.message}):{success:!0}}async function Js(t){const{error:s}=await Q.from("appointments").update({rating_skipped:!0}).eq("id",t);return s?(console.error("Error skipping rating:",s),{success:!1,error:s.message}):{success:!0}}async function Qs(t){if(!t||t.length===0)return"";const{data:s,error:i}=await Q.from("specializations").select("name").in("code",t);return i?(console.error("Error fetching specialization names:",i),""):(s==null?void 0:s.map(a=>a.name).join(", "))||""}function Zs(t){return new Date(t).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit",timeZone:"Europe/Moscow"})}function Xs({pendingRating:t,open:s,onClose:i,onSubmitted:a}){const[c,n]=v.useState(0),[o,m]=v.useState(0),[d,l]=v.useState(""),[y,p]=v.useState(!1),[j,N]=v.useState("");v.useEffect(()=>{n(0),m(0),l(""),N("")},[t==null?void 0:t.appointment_id]),v.useEffect(()=>{var x;((x=t==null?void 0:t.specialization_codes)==null?void 0:x.length)>0&&Qs(t.specialization_codes).then(N)},[t==null?void 0:t.specialization_codes]);const u=async()=>{if(c===0){ge.error("Пожалуйста, выберите оценку");return}p(!0);const x=await Ks({appointment_id:t.appointment_id,specialist_id:t.specialist_id,rating:c,review_text:d.trim()||void 0});p(!1),x.success?(ge.success("Спасибо за вашу оценку!"),a()):ge.error(x.error||"Не удалось отправить оценку")},f=async()=>{p(!0);const x=await Js(t.appointment_id);p(!1),x.success?i():ge.error(x.error||"Не удалось пропустить оценку")},g=x=>x.split(" ").map(b=>b[0]).join("").slice(0,2).toUpperCase(),h=o||c;return e.jsx(Ce,{open:s,onOpenChange:x=>!x&&i(),children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Pe,{className:"text-center text-xl",children:"Как прошла консультация?"})}),e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-muted/50 rounded-lg",children:[e.jsxs(Ve,{className:"h-14 w-14",children:[e.jsx(qe,{src:t.specialist_avatar||void 0}),e.jsx(He,{className:"bg-primary/10 text-primary text-lg",children:g(t.specialist_name)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("p",{className:"font-semibold text-foreground truncate",children:t.specialist_name})]}),j&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:j}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:Zs(t.scheduled_at)})]})]})]}),e.jsxs("div",{className:"flex flex-col items-center gap-2 py-4",children:[e.jsx("div",{className:"flex gap-2",children:[1,2,3,4,5].map(x=>e.jsx("button",{type:"button",onClick:()=>n(x),onMouseEnter:()=>m(x),onMouseLeave:()=>m(0),className:"p-1 transition-transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded","aria-label":`Оценка ${x} из 5`,children:e.jsx(Ms,{className:`h-10 w-10 transition-colors ${x<=h?"fill-yellow-400 text-yellow-400":"fill-none text-muted-foreground/50"}`})},x))}),h>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h===1&&"Очень плохо",h===2&&"Плохо",h===3&&"Нормально",h===4&&"Хорошо",h===5&&"Отлично"]})]}),e.jsxs("div",{children:[e.jsx(Ut,{placeholder:"Поделитесь впечатлениями (необязательно)...",value:d,onChange:x=>l(x.target.value),rows:3,maxLength:1e3,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right mt-1",children:[d.length,"/1000"]})]}),e.jsxs(Vt,{className:"flex-col sm:flex-row gap-2",children:[e.jsx(O,{variant:"ghost",onClick:f,disabled:y,className:"w-full sm:w-auto",children:"Пропустить"}),e.jsx(O,{onClick:u,disabled:y||c===0,className:"w-full sm:w-auto",children:y?"Отправка...":"Отправить"})]})]})})}function en({trigger:t}){const[s,i]=v.useState(!1),[a,c]=v.useState(!1),[n,o]=v.useState(null),[m,d]=v.useState(!1),{toast:l}=Rt();v.useEffect(()=>{s&&y()},[s]);const y=async()=>{c(!0);try{const f=await Os();o(f?zs(f):null)}catch(f){console.error("Ошибка загрузки токена:",f)}finally{c(!1)}},p=async()=>{c(!0);try{const f=await Fs();o(f.feedUrl),l({title:"Ссылка создана",description:"Скопируйте ссылку и добавьте в свой календарь"})}catch(f){l({title:"Ошибка",description:f instanceof Error?f.message:"Не удалось создать ссылку",variant:"destructive"})}finally{c(!1)}},j=async()=>{c(!0);try{await $s(),o(null),l({title:"Ссылка отозвана",description:"Старая ссылка больше не работает"})}catch(f){l({title:"Ошибка",description:f instanceof Error?f.message:"Не удалось отозвать ссылку",variant:"destructive"})}finally{c(!1)}},N=async()=>{if(n)try{await navigator.clipboard.writeText(n),d(!0),l({title:"Скопировано",description:"Ссылка скопирована в буфер обмена"}),setTimeout(()=>d(!1),2e3)}catch{l({title:"Ошибка",description:"Не удалось скопировать ссылку",variant:"destructive"})}},u=e.jsxs(O,{variant:"outline",size:"sm",className:"text-xs sm:text-sm",children:[e.jsx(Ne,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Добавить в календарь"})]});return e.jsxs(Ce,{open:s,onOpenChange:i,children:[e.jsx(gs,{asChild:!0,children:t||u}),e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsxs(Ie,{children:[e.jsxs(Pe,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Добавьте сессии себе в календарь"]}),e.jsx(Bt,{children:"Создайте ссылку и добавьте её в календарь."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Google Календарь"}),e.jsx("p",{className:"text-muted-foreground",children:"Меню «Другие календари» — «Добавить по URL»"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Apple Календарь"}),e.jsx("p",{className:"text-muted-foreground",children:"Меню «Файл» — «Подписка на новый календарь...»"})]})]}),n?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(js,{value:n,readOnly:!0,className:"font-mono text-xs"}),e.jsx(O,{variant:"outline",size:"icon",onClick:N,disabled:a,children:m?e.jsx(vs,{className:"h-4 w-4 text-green-500"}):e.jsx(Rs,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(O,{variant:"outline",size:"sm",onClick:p,disabled:a,className:"flex-1",children:[e.jsx(ct,{className:`h-4 w-4 mr-2 ${a?"animate-spin":""}`}),"Обновить ссылку"]}),e.jsx(O,{variant:"outline",size:"sm",onClick:j,disabled:a,className:"text-destructive hover:text-destructive",children:e.jsx(Bs,{className:"h-4 w-4"})})]})]}):e.jsxs(O,{onClick:p,disabled:a,className:"w-full bg-primary hover:bg-primary/90",children:[a?e.jsx(ct,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Создать ссылку"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Календарь будет автоматически обновляться при изменении ваших сессий. Не передавайте эту ссылку третьим лицам."})]})]})]})}const ke="waves_onboarding_checklist",tn=[{id:"fill_profiles",title:"Заполнить профили участников",description:"Добавьте информацию о себе и членах семьи",autoCheck:!0},{id:"select_goals",title:"Выбрать цели тренинга",description:"Определите, чего хотите достичь с помощью нейрофидбэка",link:"/cabinet/goals",linkText:"Открыть"},{id:"learn_neurofeedback",title:"Познакомиться с методом нейрофидбэка",description:"Узнайте, как работает технология",link:"https://waves.ai/neurofeedback",linkText:"Открыть"},{id:"download_app",title:"Скачать мобильное приложение",description:"Установите приложение Waves на телефон",link:"https://waves.ai/app",linkText:"Скачать"},{id:"order_device",title:"Заказать доставку устройства для тренировки",description:"Оформите заказ на устройство нейрофидбэка",link:"/cabinet/device",linkText:"Открыть"},{id:"pay_licenses",title:"Оплатить лицензии для участников",description:"Активируйте доступ для всех членов семьи",link:"/cabinet/licenses",linkText:"Открыть"},{id:"test_device",title:"Подключить и протестировать устройство",description:"Убедитесь, что устройство работает корректно"},{id:"complete_tutorial",title:"Пройти инструктаж в мобильном приложении",description:"Завершите обучение в приложении"}];function sn(t={}){const{user:s}=mt(),{profilesCount:i=0}=t,[a,c]=v.useState(()=>{if(typeof window>"u")return{items:{}};try{const u=localStorage.getItem(`${ke}_${(s==null?void 0:s.id)||"guest"}`);if(u)return JSON.parse(u)}catch(u){console.error("Error loading checklist state:",u)}return{items:{}}});v.useEffect(()=>{if(!(s!=null&&s.id))return;(async()=>{try{const{data:f,error:g}=await Q.from("users").select("onboarding_checklist").eq("id",s.id).single();if(g&&g.code!=="PGRST116"){le.error("Error loading checklist from DB:",g);const h=localStorage.getItem(`${ke}_${s.id}`);h&&c(JSON.parse(h));return}if(f!=null&&f.onboarding_checklist)c(f.onboarding_checklist),localStorage.setItem(`${ke}_${s.id}`,JSON.stringify(f.onboarding_checklist));else{const h=localStorage.getItem(`${ke}_${s.id}`);if(h){const x=JSON.parse(h);c(x),await Q.from("users").update({onboarding_checklist:x}).eq("id",s.id)}else c({items:{}})}}catch(f){le.error("Error loading checklist state:",f);const g=localStorage.getItem(`${ke}_${s.id}`);g&&c(JSON.parse(g))}})()},[s==null?void 0:s.id]),v.useEffect(()=>{if(!(s!=null&&s.id))return;const f=setTimeout(async()=>{try{localStorage.setItem(`${ke}_${s.id}`,JSON.stringify(a));const{error:g}=await Q.from("users").update({onboarding_checklist:a}).eq("id",s.id);g&&le.error("Error saving checklist to DB:",g)}catch(g){le.error("Error saving checklist state:",g)}},500);return()=>clearTimeout(f)},[a,s==null?void 0:s.id]);const n=v.useMemo(()=>tn.map(u=>{let f=a.items[u.id]||!1;return u.id==="fill_profiles"&&u.autoCheck&&(f=i>=1),{...u,completed:f}}),[a.items,i]),o=v.useMemo(()=>{const u=n.filter(h=>h.completed).length,f=n.length,g=Math.round(u/f*100);return{completed:u,total:f,percentage:g}},[n]),m=o.completed===o.total,d=!!a.dismissedAt,l=v.useCallback((u,f=!0)=>{c(g=>({...g,items:{...g.items,[u]:f}}))},[]),y=v.useCallback(u=>{c(f=>({...f,items:{...f.items,[u]:!f.items[u]}}))},[]),p=v.useCallback(()=>{c(u=>({...u,dismissedAt:new Date().toISOString()}))},[]),j=v.useCallback(()=>{c(u=>({...u,dismissedAt:void 0}))},[]),N=v.useCallback(()=>{c({items:{}})},[]);return{items:n,progress:o,isCompleted:m,isDismissed:d,markCompleted:l,toggleItem:y,dismiss:p,restore:j,reset:N}}function nn({profilesCount:t=0,className:s}){const i=Yt(),{items:a,progress:c,isCompleted:n,isDismissed:o,toggleItem:m,dismiss:d,restore:l,markCompleted:y}=sn({profilesCount:t}),[p,j]=v.useState(!0),[N,u]=v.useState(!1),[f,g]=v.useState(!1);if(v.useEffect(()=>{o&&!n&&l()},[o,n,l]),v.useEffect(()=>{if(n&&!o){g(!0);const b=setTimeout(()=>{u(!0),setTimeout(()=>{d()},500)},3e3);return()=>clearTimeout(b)}},[n,o,d]),o&&n)return null;const h=a.findIndex(b=>!b.completed),x=h!==-1?a[h]:null;return e.jsx("div",{className:je("transition-all duration-500",N&&"opacity-0 scale-95 -translate-y-4",s),children:e.jsxs(we,{className:"bg-white overflow-hidden border-0",children:[e.jsxs("div",{className:"p-4 sm:p-6 cursor-pointer",onClick:()=>j(!p),children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(Ae,{size:"xl",className:"truncate",children:f?"Отлично! Все готово":"С чего начать?"}),f&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5",children:"Вы выполнили все шаги для начала работы"})]})}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsxs("div",{className:"hidden sm:flex items-center gap-2",children:[e.jsx("div",{className:"w-24 h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-coral to-coral-light transition-all duration-500",style:{width:`${c.percentage}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:[c.percentage,"%"]})]}),n&&e.jsx(O,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-foreground",onClick:b=>{b.stopPropagation(),d()},children:e.jsx(lt,{className:"h-4 w-4"})}),e.jsx(O,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-foreground",onClick:b=>{b.stopPropagation(),j(!p)},children:p?e.jsx(ys,{className:"h-4 w-4"}):e.jsx(bs,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"sm:hidden mt-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-coral to-coral-light transition-all duration-500",style:{width:`${c.percentage}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:[c.percentage,"%"]})]})})]}),e.jsx("div",{className:je("overflow-hidden transition-all duration-300",p?"max-h-[1000px] opacity-100":"max-h-0 opacity-0"),children:e.jsx("div",{className:"px-4 sm:px-6 pb-4 sm:pb-6 space-y-2",children:a.map((b,T)=>e.jsx(rn,{item:b,index:T,isCurrent:(x==null?void 0:x.id)===b.id,onToggle:()=>!b.autoCheck&&m(b.id),onNavigate:D=>i(D),onMarkCompleted:D=>y(D,!0)},b.id))})})]})})}function rn({item:t,index:s,isCurrent:i,onToggle:a,onNavigate:c,onMarkCompleted:n}){var N;const o=!t.autoCheck,m=(N=t.link)==null?void 0:N.startsWith("/"),[d,l]=v.useState(!1),y=v.useRef(null),p=t.id==="learn_neurofeedback",j=p?"https://www.youtube.com/embed/dQw4w9WgXcQ?enablejsapi=1&origin="+encodeURIComponent(window.location.origin):null;return v.useEffect(()=>{if(!d||!p)return;let u=null,f=null;const g={value:!1},h=()=>window.YT&&window.YT.Player?Promise.resolve():new Promise(b=>{var E;if(document.querySelector('script[src="https://www.youtube.com/iframe_api"]')){const k=setInterval(()=>{window.YT&&window.YT.Player&&(clearInterval(k),b())},100);return}const D=window.onYouTubeIframeAPIReady;window.onYouTubeIframeAPIReady=()=>{D&&D(),b()};const L=document.createElement("script");L.src="https://www.youtube.com/iframe_api",L.async=!0;const S=document.getElementsByTagName("script")[0];(E=S.parentNode)==null||E.insertBefore(L,S)});return(async()=>{try{await h(),f=setInterval(()=>{if(y.current&&window.YT&&window.YT.Player){clearInterval(f);try{u=new window.YT.Player(y.current,{events:{onStateChange:b=>{if(b.data===0&&!g.value)try{const T=u.getCurrentTime(),D=u.getDuration();D>0&&T>=D-1&&(g.value=!0,n(t.id),setTimeout(()=>{l(!1)},1e3))}catch{g.value=!0,n(t.id),setTimeout(()=>{l(!1)},1e3)}},onReady:()=>{},onError:b=>{console.error("YouTube player error:",b)}}})}catch(b){console.error("Error initializing YouTube player:",b)}}},100)}catch(b){console.error("Error loading YouTube API:",b)}})(),()=>{if(f&&clearInterval(f),u&&typeof u.destroy=="function")try{u.destroy()}catch(b){console.error("Error destroying YouTube player:",b)}}},[d,p,t.id,n]),e.jsxs("div",{className:je("flex items-start gap-3 p-3 rounded-xl transition-all duration-200",i&&!t.completed&&"bg-white/50",t.completed&&"opacity-60",(o||t.completed)&&"cursor-pointer hover:bg-white/50"),onClick:o?a:t.completed?()=>a():void 0,children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:t.completed?e.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center shadow-sm",style:{background:"linear-gradient(108deg, rgba(34, 197, 94, 0.25) 0%, rgba(34, 197, 94, 0.14) 100%)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(34, 197, 94, 0.3)"},children:e.jsx(qt,{className:"h-4 w-4 text-green-600"})}):e.jsx("div",{className:je("w-6 h-6 rounded-full border flex items-center justify-center transition-colors",i&&"border-coral"),style:{background:i?"linear-gradient(108deg, rgba(255, 138, 91, 0.25) 0%, rgba(255, 138, 91, 0.14) 100%)":"linear-gradient(108deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.14) 100%)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:i?"1px solid rgba(255, 138, 91, 0.3)":"1px solid rgba(0, 0, 0, 0.1)"},children:e.jsx("span",{className:"text-xs font-medium text-foreground",children:s+1})})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:je("transition-all",t.completed&&"line-through text-muted-foreground"),children:t.title})}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[t.autoCheck&&!t.completed&&e.jsx(pe,{variant:"secondary",className:"text-xs font-light",children:"Автоматически"}),t.link&&!t.completed&&e.jsxs(e.Fragment,{children:[e.jsxs(O,{variant:"ghost",size:"sm",className:"h-7 px-2 text-coral hover:text-coral hover:bg-coral/10",onClick:u=>{u.stopPropagation(),p?l(!0):m?c(t.link):window.open(t.link,"_blank","noopener,noreferrer")},children:[e.jsx("span",{className:"text-xs mr-1",children:t.linkText||"Открыть"}),m?e.jsx(Ht,{className:"h-3 w-3"}):e.jsx(Us,{className:"h-3 w-3"})]}),p&&e.jsx(Ce,{open:d,onOpenChange:l,children:e.jsxs(Se,{className:"max-w-4xl w-[90vw] p-0",children:[e.jsx(Ie,{className:"px-6 pt-6",children:e.jsx(Pe,{children:t.title})}),e.jsx("div",{className:"px-6 pb-6",children:j&&e.jsx("div",{className:"relative w-full",style:{paddingBottom:"56.25%"},children:e.jsx("iframe",{ref:y,className:"absolute top-0 left-0 w-full h-full rounded-lg",src:j,title:t.title,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0})})})]})})]})]})]})})]})}function an(t){return Object.prototype.toString.call(t)==="[object Object]"}function Ot(t){return an(t)||Array.isArray(t)}function on(){return!!(typeof window<"u"&&window.document&&window.document.createElement)}function ht(t,s){const i=Object.keys(t),a=Object.keys(s);if(i.length!==a.length)return!1;const c=JSON.stringify(Object.keys(t.breakpoints||{})),n=JSON.stringify(Object.keys(s.breakpoints||{}));return c!==n?!1:i.every(o=>{const m=t[o],d=s[o];return typeof m=="function"?`${m}`==`${d}`:!Ot(m)||!Ot(d)?m===d:ht(m,d)})}function zt(t){return t.concat().sort((s,i)=>s.name>i.name?1:-1).map(s=>s.options)}function cn(t,s){if(t.length!==s.length)return!1;const i=zt(t),a=zt(s);return i.every((c,n)=>{const o=a[n];return ht(c,o)})}function xt(t){return typeof t=="number"}function ut(t){return typeof t=="string"}function Ge(t){return typeof t=="boolean"}function Ft(t){return Object.prototype.toString.call(t)==="[object Object]"}function q(t){return Math.abs(t)}function pt(t){return Math.sign(t)}function De(t,s){return q(t-s)}function ln(t,s){if(t===0||s===0||q(t)<=q(s))return 0;const i=De(q(t),q(s));return q(i/t)}function dn(t){return Math.round(t*100)/100}function Me(t){return Oe(t).map(Number)}function de(t){return t[Fe(t)]}function Fe(t){return Math.max(0,t.length-1)}function gt(t,s){return s===Fe(t)}function $t(t,s=0){return Array.from(Array(t),(i,a)=>s+a)}function Oe(t){return Object.keys(t)}function Gt(t,s){return[t,s].reduce((i,a)=>(Oe(a).forEach(c=>{const n=i[c],o=a[c],m=Ft(n)&&Ft(o);i[c]=m?Gt(n,o):o}),i),{})}function ft(t,s){return typeof s.MouseEvent<"u"&&t instanceof s.MouseEvent}function un(t,s){const i={start:a,center:c,end:n};function a(){return 0}function c(d){return n(d)/2}function n(d){return s-d}function o(d,l){return ut(t)?i[t](d):t(s,d,l)}return{measure:o}}function ze(){let t=[];function s(c,n,o,m={passive:!0}){let d;if("addEventListener"in c)c.addEventListener(n,o,m),d=()=>c.removeEventListener(n,o,m);else{const l=c;l.addListener(o),d=()=>l.removeListener(o)}return t.push(d),a}function i(){t=t.filter(c=>c())}const a={add:s,clear:i};return a}function fn(t,s,i,a){const c=ze(),n=1e3/60;let o=null,m=0,d=0;function l(){c.add(t,"visibilitychange",()=>{t.hidden&&u()})}function y(){N(),c.clear()}function p(g){if(!d)return;o||(o=g,i(),i());const h=g-o;for(o=g,m+=h;m>=n;)i(),m-=n;const x=m/n;a(x),d&&(d=s.requestAnimationFrame(p))}function j(){d||(d=s.requestAnimationFrame(p))}function N(){s.cancelAnimationFrame(d),o=null,m=0,d=0}function u(){o=null,m=0}return{init:l,destroy:y,start:j,stop:N,update:i,render:a}}function mn(t,s){const i=s==="rtl",a=t==="y",c=a?"y":"x",n=a?"x":"y",o=!a&&i?-1:1,m=y(),d=p();function l(u){const{height:f,width:g}=u;return a?f:g}function y(){return a?"top":i?"right":"left"}function p(){return a?"bottom":i?"left":"right"}function j(u){return u*o}return{scroll:c,cross:n,startEdge:m,endEdge:d,measureSize:l,direction:j}}function _e(t=0,s=0){const i=q(t-s);function a(l){return l<t}function c(l){return l>s}function n(l){return a(l)||c(l)}function o(l){return n(l)?a(l)?t:s:l}function m(l){return i?l-i*Math.ceil((l-s)/i):l}return{length:i,max:s,min:t,constrain:o,reachedAny:n,reachedMax:c,reachedMin:a,removeOffset:m}}function Wt(t,s,i){const{constrain:a}=_e(0,t),c=t+1;let n=o(s);function o(j){return i?q((c+j)%c):a(j)}function m(){return n}function d(j){return n=o(j),p}function l(j){return y().set(m()+j)}function y(){return Wt(t,m(),i)}const p={get:m,set:d,add:l,clone:y};return p}function hn(t,s,i,a,c,n,o,m,d,l,y,p,j,N,u,f,g,h,x){const{cross:b,direction:T}=t,D=["INPUT","SELECT","TEXTAREA"],L={passive:!1},S=ze(),E=ze(),k=_e(50,225).constrain(N.measure(20)),F={mouse:300,touch:400},w={mouse:500,touch:600},I=u?43:25;let $=!1,H=0,Y=0,ae=!1,ue=!1,te=!1,oe=!1;function ne(C){if(!x)return;function z(G){(Ge(x)||x(C,G))&&ye(G)}const V=s;S.add(V,"dragstart",G=>G.preventDefault(),L).add(V,"touchmove",()=>{},L).add(V,"touchend",()=>{}).add(V,"touchstart",z).add(V,"mousedown",z).add(V,"touchcancel",W).add(V,"contextmenu",W).add(V,"click",me,!0)}function X(){S.clear(),E.clear()}function ve(){const C=oe?i:s;E.add(C,"touchmove",Z,L).add(C,"touchend",W).add(C,"mousemove",Z,L).add(C,"mouseup",W)}function fe(C){const z=C.nodeName||"";return D.includes(z)}function ce(){return(u?w:F)[oe?"mouse":"touch"]}function R(C,z){const V=p.add(pt(C)*-1),G=y.byDistance(C,!u).distance;return u||q(C)<k?G:g&&z?G*.5:y.byIndex(V.get(),0).distance}function ye(C){const z=ft(C,a);oe=z,te=u&&z&&!C.buttons&&$,$=De(c.get(),o.get())>=2,!(z&&C.button!==0)&&(fe(C.target)||(ae=!0,n.pointerDown(C),l.useFriction(0).useDuration(0),c.set(o),ve(),H=n.readPoint(C),Y=n.readPoint(C,b),j.emit("pointerDown")))}function Z(C){if(!ft(C,a)&&C.touches.length>=2)return W(C);const V=n.readPoint(C),G=n.readPoint(C,b),re=De(V,H),K=De(G,Y);if(!ue&&!oe&&(!C.cancelable||(ue=re>K,!ue)))return W(C);const he=n.pointerMove(C);re>f&&(te=!0),l.useFriction(.3).useDuration(.75),m.start(),c.add(T(he)),C.preventDefault()}function W(C){const V=y.byDistance(0,!1).index!==p.get(),G=n.pointerUp(C)*ce(),re=R(T(G),V),K=ln(G,re),he=I-10*K,xe=h+K/50;ue=!1,ae=!1,E.clear(),l.useDuration(he).useFriction(xe),d.distance(re,!u),oe=!1,j.emit("pointerUp")}function me(C){te&&(C.stopPropagation(),C.preventDefault(),te=!1)}function se(){return ae}return{init:ne,destroy:X,pointerDown:se}}function xn(t,s){let a,c;function n(p){return p.timeStamp}function o(p,j){const u=`client${(j||t.scroll)==="x"?"X":"Y"}`;return(ft(p,s)?p:p.touches[0])[u]}function m(p){return a=p,c=p,o(p)}function d(p){const j=o(p)-o(c),N=n(p)-n(a)>170;return c=p,N&&(a=p),j}function l(p){if(!a||!c)return 0;const j=o(c)-o(a),N=n(p)-n(a),u=n(p)-n(c)>170,f=j/N;return N&&!u&&q(f)>.1?f:0}return{pointerDown:m,pointerMove:d,pointerUp:l,readPoint:o}}function pn(){function t(i){const{offsetTop:a,offsetLeft:c,offsetWidth:n,offsetHeight:o}=i;return{top:a,right:c+n,bottom:a+o,left:c,width:n,height:o}}return{measure:t}}function gn(t){function s(a){return t*(a/100)}return{measure:s}}function jn(t,s,i,a,c,n,o){const m=[t].concat(a);let d,l,y=[],p=!1;function j(g){return c.measureSize(o.measure(g))}function N(g){if(!n)return;l=j(t),y=a.map(j);function h(x){for(const b of x){if(p)return;const T=b.target===t,D=a.indexOf(b.target),L=T?l:y[D],S=j(T?t:a[D]);if(q(S-L)>=.5){g.reInit(),s.emit("resize");break}}}d=new ResizeObserver(x=>{(Ge(n)||n(g,x))&&h(x)}),i.requestAnimationFrame(()=>{m.forEach(x=>d.observe(x))})}function u(){p=!0,d&&d.disconnect()}return{init:N,destroy:u}}function vn(t,s,i,a,c,n){let o=0,m=0,d=c,l=n,y=t.get(),p=0;function j(){const L=a.get()-t.get(),S=!d;let E=0;return S?(o=0,i.set(a),t.set(a),E=L):(i.set(t),o+=L/d,o*=l,y+=o,t.add(o),E=y-p),m=pt(E),p=y,D}function N(){const L=a.get()-s.get();return q(L)<.001}function u(){return d}function f(){return m}function g(){return o}function h(){return b(c)}function x(){return T(n)}function b(L){return d=L,D}function T(L){return l=L,D}const D={direction:f,duration:u,velocity:g,seek:j,settled:N,useBaseFriction:x,useBaseDuration:h,useFriction:T,useDuration:b};return D}function yn(t,s,i,a,c){const n=c.measure(10),o=c.measure(50),m=_e(.1,.99);let d=!1;function l(){return!(d||!t.reachedAny(i.get())||!t.reachedAny(s.get()))}function y(N){if(!l())return;const u=t.reachedMin(s.get())?"min":"max",f=q(t[u]-s.get()),g=i.get()-s.get(),h=m.constrain(f/o);i.subtract(g*h),!N&&q(g)<n&&(i.set(t.constrain(i.get())),a.useDuration(25).useBaseFriction())}function p(N){d=!N}return{shouldConstrain:l,constrain:y,toggleActive:p}}function bn(t,s,i,a,c){const n=_e(-s+t,0),o=p(),m=y(),d=j();function l(u,f){return De(u,f)<=1}function y(){const u=o[0],f=de(o),g=o.lastIndexOf(u),h=o.indexOf(f)+1;return _e(g,h)}function p(){return i.map((u,f)=>{const{min:g,max:h}=n,x=n.constrain(u),b=!f,T=gt(i,f);return b?h:T||l(g,x)?g:l(h,x)?h:x}).map(u=>parseFloat(u.toFixed(3)))}function j(){if(s<=t+c)return[n.max];if(a==="keepSnaps")return o;const{min:u,max:f}=m;return o.slice(u,f)}return{snapsContained:d,scrollContainLimit:m}}function wn(t,s,i){const a=s[0],c=i?a-t:de(s);return{limit:_e(c,a)}}function Nn(t,s,i,a){const n=s.min+.1,o=s.max+.1,{reachedMin:m,reachedMax:d}=_e(n,o);function l(j){return j===1?d(i.get()):j===-1?m(i.get()):!1}function y(j){if(!l(j))return;const N=t*(j*-1);a.forEach(u=>u.add(N))}return{loop:y}}function _n(t){const{max:s,length:i}=t;function a(n){const o=n-s;return i?o/-i:0}return{get:a}}function kn(t,s,i,a,c){const{startEdge:n,endEdge:o}=t,{groupSlides:m}=c,d=p().map(s.measure),l=j(),y=N();function p(){return m(a).map(f=>de(f)[o]-f[0][n]).map(q)}function j(){return a.map(f=>i[n]-f[n]).map(f=>-q(f))}function N(){return m(l).map(f=>f[0]).map((f,g)=>f+d[g])}return{snaps:l,snapsAligned:y}}function Cn(t,s,i,a,c,n){const{groupSlides:o}=c,{min:m,max:d}=a,l=y();function y(){const j=o(n),N=!t||s==="keepSnaps";return i.length===1?[n]:N?j:j.slice(m,d).map((u,f,g)=>{const h=!f,x=gt(g,f);if(h){const b=de(g[0])+1;return $t(b)}if(x){const b=Fe(n)-de(g)[0]+1;return $t(b,de(g)[0])}return u})}return{slideRegistry:l}}function Sn(t,s,i,a,c){const{reachedAny:n,removeOffset:o,constrain:m}=a;function d(u){return u.concat().sort((f,g)=>q(f)-q(g))[0]}function l(u){const f=t?o(u):m(u),g=s.map((x,b)=>({diff:y(x-f,0),index:b})).sort((x,b)=>q(x.diff)-q(b.diff)),{index:h}=g[0];return{index:h,distance:f}}function y(u,f){const g=[u,u+i,u-i];if(!t)return u;if(!f)return d(g);const h=g.filter(x=>pt(x)===f);return h.length?d(h):de(g)-i}function p(u,f){const g=s[u]-c.get(),h=y(g,f);return{index:u,distance:h}}function j(u,f){const g=c.get()+u,{index:h,distance:x}=l(g),b=!t&&n(g);if(!f||b)return{index:h,distance:u};const T=s[h]-x,D=u+y(T,0);return{index:h,distance:D}}return{byDistance:j,byIndex:p,shortcut:y}}function En(t,s,i,a,c,n,o){function m(p){const j=p.distance,N=p.index!==s.get();n.add(j),j&&(a.duration()?t.start():(t.update(),t.render(1),t.update())),N&&(i.set(s.get()),s.set(p.index),o.emit("select"))}function d(p,j){const N=c.byDistance(p,j);m(N)}function l(p,j){const N=s.clone().set(p),u=c.byIndex(N.get(),j);m(u)}return{distance:d,index:l}}function An(t,s,i,a,c,n,o,m){const d={passive:!0,capture:!0};let l=0;function y(N){if(!m)return;function u(f){if(new Date().getTime()-l>10)return;o.emit("slideFocusStart"),t.scrollLeft=0;const x=i.findIndex(b=>b.includes(f));xt(x)&&(c.useDuration(0),a.index(x,0),o.emit("slideFocus"))}n.add(document,"keydown",p,!1),s.forEach((f,g)=>{n.add(f,"focus",h=>{(Ge(m)||m(N,h))&&u(g)},d)})}function p(N){N.code==="Tab"&&(l=new Date().getTime())}return{init:y}}function Te(t){let s=t;function i(){return s}function a(d){s=o(d)}function c(d){s+=o(d)}function n(d){s-=o(d)}function o(d){return xt(d)?d:d.get()}return{get:i,set:a,add:c,subtract:n}}function Kt(t,s){const i=t.scroll==="x"?o:m,a=s.style;let c=null,n=!1;function o(j){return`translate3d(${j}px,0px,0px)`}function m(j){return`translate3d(0px,${j}px,0px)`}function d(j){if(n)return;const N=dn(t.direction(j));N!==c&&(a.transform=i(N),c=N)}function l(j){n=!j}function y(){n||(a.transform="",s.getAttribute("style")||s.removeAttribute("style"))}return{clear:y,to:d,toggleActive:l}}function Tn(t,s,i,a,c,n,o,m,d){const y=Me(c),p=Me(c).reverse(),j=h().concat(x());function N(S,E){return S.reduce((k,F)=>k-c[F],E)}function u(S,E){return S.reduce((k,F)=>N(k,E)>0?k.concat([F]):k,[])}function f(S){return n.map((E,k)=>({start:E-a[k]+.5+S,end:E+s-.5+S}))}function g(S,E,k){const F=f(E);return S.map(w=>{const I=k?0:-i,$=k?i:0,H=k?"end":"start",Y=F[w][H];return{index:w,loopPoint:Y,slideLocation:Te(-1),translate:Kt(t,d[w]),target:()=>m.get()>Y?I:$}})}function h(){const S=o[0],E=u(p,S);return g(E,i,!1)}function x(){const S=s-o[0]-1,E=u(y,S);return g(E,-i,!0)}function b(){return j.every(({index:S})=>{const E=y.filter(k=>k!==S);return N(E,s)<=.1})}function T(){j.forEach(S=>{const{target:E,translate:k,slideLocation:F}=S,w=E();w!==F.get()&&(k.to(w),F.set(w))})}function D(){j.forEach(S=>S.translate.clear())}return{canLoop:b,clear:D,loop:T,loopPoints:j}}function Dn(t,s,i){let a,c=!1;function n(d){if(!i)return;function l(y){for(const p of y)if(p.type==="childList"){d.reInit(),s.emit("slidesChanged");break}}a=new MutationObserver(y=>{c||(Ge(i)||i(d,y))&&l(y)}),a.observe(t,{childList:!0})}function o(){a&&a.disconnect(),c=!0}return{init:n,destroy:o}}function Ln(t,s,i,a){const c={};let n=null,o=null,m,d=!1;function l(){m=new IntersectionObserver(u=>{d||(u.forEach(f=>{const g=s.indexOf(f.target);c[g]=f}),n=null,o=null,i.emit("slidesInView"))},{root:t.parentElement,threshold:a}),s.forEach(u=>m.observe(u))}function y(){m&&m.disconnect(),d=!0}function p(u){return Oe(c).reduce((f,g)=>{const h=parseInt(g),{isIntersecting:x}=c[h];return(u&&x||!u&&!x)&&f.push(h),f},[])}function j(u=!0){if(u&&n)return n;if(!u&&o)return o;const f=p(u);return u&&(n=f),u||(o=f),f}return{init:l,destroy:y,get:j}}function In(t,s,i,a,c,n){const{measureSize:o,startEdge:m,endEdge:d}=t,l=i[0]&&c,y=u(),p=f(),j=i.map(o),N=g();function u(){if(!l)return 0;const x=i[0];return q(s[m]-x[m])}function f(){if(!l)return 0;const x=n.getComputedStyle(de(a));return parseFloat(x.getPropertyValue(`margin-${d}`))}function g(){return i.map((x,b,T)=>{const D=!b,L=gt(T,b);return D?j[b]+y:L?j[b]+p:T[b+1][m]-x[m]}).map(q)}return{slideSizes:j,slideSizesWithGaps:N,startGap:y,endGap:p}}function Pn(t,s,i,a,c,n,o,m,d){const{startEdge:l,endEdge:y,direction:p}=t,j=xt(i);function N(h,x){return Me(h).filter(b=>b%x===0).map(b=>h.slice(b,b+x))}function u(h){return h.length?Me(h).reduce((x,b,T)=>{const D=de(x)||0,L=D===0,S=b===Fe(h),E=c[l]-n[D][l],k=c[l]-n[b][y],F=!a&&L?p(o):0,w=!a&&S?p(m):0,I=q(k-w-(E+F));return T&&I>s+d&&x.push(b),S&&x.push(h.length),x},[]).map((x,b,T)=>{const D=Math.max(T[b-1]||0);return h.slice(D,x)}):[]}function f(h){return j?N(h,i):u(h)}return{groupSlides:f}}function Mn(t,s,i,a,c,n,o){const{align:m,axis:d,direction:l,startIndex:y,loop:p,duration:j,dragFree:N,dragThreshold:u,inViewThreshold:f,slidesToScroll:g,skipSnaps:h,containScroll:x,watchResize:b,watchSlides:T,watchDrag:D,watchFocus:L}=n,S=2,E=pn(),k=E.measure(s),F=i.map(E.measure),w=mn(d,l),I=w.measureSize(k),$=gn(I),H=un(m,I),Y=!p&&!!x,ae=p||!!x,{slideSizes:ue,slideSizesWithGaps:te,startGap:oe,endGap:ne}=In(w,k,F,i,ae,c),X=Pn(w,I,g,p,k,F,oe,ne,S),{snaps:ve,snapsAligned:fe}=kn(w,H,k,F,X),ce=-de(ve)+de(te),{snapsContained:R,scrollContainLimit:ye}=bn(I,ce,fe,x,S),Z=Y?R:fe,{limit:W}=wn(ce,Z,p),me=Wt(Fe(Z),y,p),se=me.clone(),B=Me(i),C=({dragHandler:U,scrollBody:ie,scrollBounds:Ke,options:{loop:Be}})=>{Be||Ke.constrain(U.pointerDown()),ie.seek()},z=({scrollBody:U,translate:ie,location:Ke,offsetLocation:Be,previousLocation:ss,scrollLooper:ns,slideLooper:rs,dragHandler:is,animation:as,eventHandler:vt,scrollBounds:os,options:{loop:yt}},bt)=>{const wt=U.settled(),cs=!os.shouldConstrain(),Nt=yt?wt:wt&&cs,_t=Nt&&!is.pointerDown();_t&&as.stop();const ls=Ke.get()*bt+ss.get()*(1-bt);Be.set(ls),yt&&(ns.loop(U.direction()),rs.loop()),ie.to(Be.get()),_t&&vt.emit("settle"),Nt||vt.emit("scroll")},V=fn(a,c,()=>C(Re),U=>z(Re,U)),G=.68,re=Z[me.get()],K=Te(re),he=Te(re),xe=Te(re),J=Te(re),r=vn(K,xe,he,J,j,G),_=Sn(p,Z,ce,W,J),A=En(V,me,se,r,_,J,o),P=_n(W),M=ze(),ee=Ln(s,i,o,f),{slideRegistry:be}=Cn(Y,x,Z,ye,X,B),$e=An(t,i,be,A,r,M,o,L),Re={ownerDocument:a,ownerWindow:c,eventHandler:o,containerRect:k,slideRects:F,animation:V,axis:w,dragHandler:hn(w,t,a,c,J,xn(w,c),K,V,A,r,_,me,o,$,N,u,h,G,D),eventStore:M,percentOfView:$,index:me,indexPrevious:se,limit:W,location:K,offsetLocation:xe,previousLocation:he,options:n,resizeHandler:jn(s,o,c,i,w,b,E),scrollBody:r,scrollBounds:yn(W,xe,J,r,$),scrollLooper:Nn(ce,W,xe,[K,xe,he,J]),scrollProgress:P,scrollSnapList:Z.map(P.get),scrollSnaps:Z,scrollTarget:_,scrollTo:A,slideLooper:Tn(w,I,ce,ue,te,ve,Z,xe,i),slideFocus:$e,slidesHandler:Dn(s,o,T),slidesInView:ee,slideIndexes:B,slideRegistry:be,slidesToScroll:X,target:J,translate:Kt(w,s)};return Re}function On(){let t={},s;function i(l){s=l}function a(l){return t[l]||[]}function c(l){return a(l).forEach(y=>y(s,l)),d}function n(l,y){return t[l]=a(l).concat([y]),d}function o(l,y){return t[l]=a(l).filter(p=>p!==y),d}function m(){t={}}const d={init:i,emit:c,off:o,on:n,clear:m};return d}const zn={align:"center",axis:"x",container:null,slides:null,containScroll:"trimSnaps",direction:"ltr",slidesToScroll:1,inViewThreshold:0,breakpoints:{},dragFree:!1,dragThreshold:10,loop:!1,skipSnaps:!1,duration:25,startIndex:0,active:!0,watchDrag:!0,watchResize:!0,watchSlides:!0,watchFocus:!0};function Fn(t){function s(n,o){return Gt(n,o||{})}function i(n){const o=n.breakpoints||{},m=Oe(o).filter(d=>t.matchMedia(d).matches).map(d=>o[d]).reduce((d,l)=>s(d,l),{});return s(n,m)}function a(n){return n.map(o=>Oe(o.breakpoints||{})).reduce((o,m)=>o.concat(m),[]).map(t.matchMedia)}return{mergeOptions:s,optionsAtMedia:i,optionsMediaQueries:a}}function $n(t){let s=[];function i(n,o){return s=o.filter(({options:m})=>t.optionsAtMedia(m).active!==!1),s.forEach(m=>m.init(n,t)),o.reduce((m,d)=>Object.assign(m,{[d.name]:d}),{})}function a(){s=s.filter(n=>n.destroy())}return{init:i,destroy:a}}function Ye(t,s,i){const a=t.ownerDocument,c=a.defaultView,n=Fn(c),o=$n(n),m=ze(),d=On(),{mergeOptions:l,optionsAtMedia:y,optionsMediaQueries:p}=n,{on:j,off:N,emit:u}=d,f=w;let g=!1,h,x=l(zn,Ye.globalOptions),b=l(x),T=[],D,L,S;function E(){const{container:B,slides:C}=b;L=(ut(B)?t.querySelector(B):B)||t.children[0];const V=ut(C)?L.querySelectorAll(C):C;S=[].slice.call(V||L.children)}function k(B){const C=Mn(t,L,S,a,c,B,d);if(B.loop&&!C.slideLooper.canLoop()){const z=Object.assign({},B,{loop:!1});return k(z)}return C}function F(B,C){g||(x=l(x,B),b=y(x),T=C||T,E(),h=k(b),p([x,...T.map(({options:z})=>z)]).forEach(z=>m.add(z,"change",w)),b.active&&(h.translate.to(h.location.get()),h.animation.init(),h.slidesInView.init(),h.slideFocus.init(se),h.eventHandler.init(se),h.resizeHandler.init(se),h.slidesHandler.init(se),h.options.loop&&h.slideLooper.loop(),L.offsetParent&&S.length&&h.dragHandler.init(se),D=o.init(se,T)))}function w(B,C){const z=X();I(),F(l({startIndex:z},B),C),d.emit("reInit")}function I(){h.dragHandler.destroy(),h.eventStore.clear(),h.translate.clear(),h.slideLooper.clear(),h.resizeHandler.destroy(),h.slidesHandler.destroy(),h.slidesInView.destroy(),h.animation.destroy(),o.destroy(),m.clear()}function $(){g||(g=!0,m.clear(),I(),d.emit("destroy"),d.clear())}function H(B,C,z){!b.active||g||(h.scrollBody.useBaseFriction().useDuration(C===!0?0:b.duration),h.scrollTo.index(B,z||0))}function Y(B){const C=h.index.add(1).get();H(C,B,-1)}function ae(B){const C=h.index.add(-1).get();H(C,B,1)}function ue(){return h.index.add(1).get()!==X()}function te(){return h.index.add(-1).get()!==X()}function oe(){return h.scrollSnapList}function ne(){return h.scrollProgress.get(h.offsetLocation.get())}function X(){return h.index.get()}function ve(){return h.indexPrevious.get()}function fe(){return h.slidesInView.get()}function ce(){return h.slidesInView.get(!1)}function R(){return D}function ye(){return h}function Z(){return t}function W(){return L}function me(){return S}const se={canScrollNext:ue,canScrollPrev:te,containerNode:W,internalEngine:ye,destroy:$,off:N,on:j,emit:u,plugins:R,previousScrollSnap:ve,reInit:f,rootNode:Z,scrollNext:Y,scrollPrev:ae,scrollProgress:ne,scrollSnapList:oe,scrollTo:H,selectedScrollSnap:X,slideNodes:me,slidesInView:fe,slidesNotInView:ce};return F(s,i),setTimeout(()=>d.emit("init"),0),se}Ye.globalOptions=void 0;function jt(t={},s=[]){const i=v.useRef(t),a=v.useRef(s),[c,n]=v.useState(),[o,m]=v.useState(),d=v.useCallback(()=>{c&&c.reInit(i.current,a.current)},[c]);return v.useEffect(()=>{ht(i.current,t)||(i.current=t,d())},[t,d]),v.useEffect(()=>{cn(a.current,s)||(a.current=s,d())},[s,d]),v.useEffect(()=>{if(on()&&o){Ye.globalOptions=jt.globalOptions;const l=Ye(o,i.current,a.current);return n(l),()=>l.destroy()}else n(void 0)},[o,n]),[m,c]}jt.globalOptions=void 0;const Jt=v.createContext(null);function We(){const t=v.useContext(Jt);if(!t)throw new Error("useCarousel must be used within a <Carousel />");return t}const Qt=v.forwardRef(({orientation:t="horizontal",opts:s,setApi:i,plugins:a,className:c,children:n,...o},m)=>{const[d,l]=jt({...s,axis:t==="horizontal"?"x":"y"},a),[y,p]=v.useState(!1),[j,N]=v.useState(!1),u=v.useCallback(x=>{x&&(p(x.canScrollPrev()),N(x.canScrollNext()))},[]),f=v.useCallback(()=>{l==null||l.scrollPrev()},[l]),g=v.useCallback(()=>{l==null||l.scrollNext()},[l]),h=v.useCallback(x=>{x.key==="ArrowLeft"?(x.preventDefault(),f()):x.key==="ArrowRight"&&(x.preventDefault(),g())},[f,g]);return v.useEffect(()=>{!l||!i||i(l)},[l,i]),v.useEffect(()=>{if(l)return u(l),l.on("reInit",u),l.on("select",u),()=>{l==null||l.off("select",u)}},[l,u]),e.jsx(Jt.Provider,{value:{carouselRef:d,api:l,opts:s,orientation:t||((s==null?void 0:s.axis)==="y"?"vertical":"horizontal"),scrollPrev:f,scrollNext:g,canScrollPrev:y,canScrollNext:j},children:e.jsx("div",{ref:m,onKeyDownCapture:h,className:je("relative",c),role:"region","aria-roledescription":"carousel",...o,children:n})})});Qt.displayName="Carousel";const Zt=v.forwardRef(({className:t,...s},i)=>{const{carouselRef:a,orientation:c}=We();return e.jsx("div",{ref:a,className:"overflow-hidden",children:e.jsx("div",{ref:i,className:je("flex",c==="horizontal"?"-ml-4":"-mt-4 flex-col",t),...s})})});Zt.displayName="CarouselContent";const Xt=v.forwardRef(({className:t,...s},i)=>{const{orientation:a}=We();return e.jsx("div",{ref:i,role:"group","aria-roledescription":"slide",className:je("min-w-0 shrink-0 grow-0 basis-full",a==="horizontal"?"pl-4":"pt-4",t),...s})});Xt.displayName="CarouselItem";const es=v.forwardRef(({className:t,variant:s="outline",size:i="icon",...a},c)=>{const{orientation:n,scrollPrev:o,canScrollPrev:m}=We();return e.jsxs(O,{ref:c,variant:s,size:i,className:je("absolute h-8 w-8 rounded-full",n==="horizontal"?"-left-12 top-1/2 -translate-y-1/2":"-top-12 left-1/2 -translate-x-1/2 rotate-90",t),disabled:!m,onClick:o,...a,children:[e.jsx(ws,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Previous slide"})]})});es.displayName="CarouselPrevious";const ts=v.forwardRef(({className:t,variant:s="outline",size:i="icon",...a},c)=>{const{orientation:n,scrollNext:o,canScrollNext:m}=We();return e.jsxs(O,{ref:c,variant:s,size:i,className:je("absolute h-8 w-8 rounded-full",n==="horizontal"?"-right-12 top-1/2 -translate-y-1/2":"-bottom-12 left-1/2 -translate-x-1/2 rotate-90",t),disabled:!m,onClick:o,...a,children:[e.jsx(Vs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Next slide"})]})});ts.displayName="CarouselNext";function hr(){const t=Yt(),{user:s}=mt(),{setCurrentProfileId:i,setCurrentProfile:a}=Ns(),c=As(),n=Hs(),[o,m]=v.useState(null),[d,l]=v.useState(0),[y,p]=v.useState(null),[j,N]=v.useState(null),[u,f]=v.useState(!1),[g,h]=v.useState(null),x=v.useRef(null),[b,T]=v.useState(!1),[D,L]=v.useState(!0),[S,E]=v.useState(0),{data:k,isLoading:F,error:w}=Es(),{data:I,isLoading:$,error:H}=Ts();v.useEffect(()=>{le.log("Dashboard data state:",{profiles:(k==null?void 0:k.length)||0,profilesLoading:F,profilesError:w==null?void 0:w.message,appointments:(I==null?void 0:I.length)||0,appointmentsLoading:$,appointmentsError:H==null?void 0:H.message,user:s==null?void 0:s.id})},[k,F,w,I,$,H,s]);const Y=v.useMemo(()=>!k||!Array.isArray(k)?[]:k.map(r=>r.id),[k]),{data:ae,isLoading:ue}=Tt(Y,"checkup"),{data:te,isLoading:oe}=Dt(Y,"checkup"),ne=v.useMemo(()=>{if(!k||!Array.isArray(k))return null;const r=k.find(_=>_.type==="parent");return(r==null?void 0:r.id)||null},[k]),{data:X,isLoading:ve}=Tt(ne?[ne]:[],"parent"),{data:fe,isLoading:ce}=Dt(ne?[ne]:[],"parent"),R=v.useMemo(()=>{if(!k||!Array.isArray(k))return[];const r=ae||{},_=te||{},A=X||{},P=fe||{};return k.map(M=>M.type==="parent"?{...M,checkupAssessment:A[M.id]||null,activeCheckupAssessment:P[M.id]||null}:{...M,checkupAssessment:r[M.id]||null,activeCheckupAssessment:_[M.id]||null})},[k,ae,te,X,fe]),ye=F&&!k,Z=ue&&ae===void 0&&Y.length>0,W=oe&&te===void 0&&Y.length>0,B=ye||Z||W||ve&&X===void 0&&ne!==null||ce&&fe===void 0&&ne!==null;v.useEffect(()=>{async function r(){try{await Q.rpc("update_appointment_statuses")}catch(_){console.error("Error updating appointment statuses:",_)}}r()},[]),v.useEffect(()=>{async function r(){try{const _=await It();l(_)}catch(_){console.error("Error loading unread count:",_)}}s!=null&&s.id&&r()},[s==null?void 0:s.id]),v.useEffect(()=>{if(!(s!=null&&s.id))return;const r=qs(s.id,async()=>{const _=await It();l(_)});return()=>r()},[s==null?void 0:s.id]),v.useEffect(()=>{async function r(){const _=await Mt();_&&(N(_),f(!0))}s!=null&&s.id&&r()},[s==null?void 0:s.id]),v.useMemo(()=>{if(!k||!Array.isArray(k))return null;const r=k.find(_=>_.type==="parent");return(r==null?void 0:r.first_name)||null},[k]);const C=v.useCallback(r=>r.type==="parent"?r.gender==="male"?ds:kt:r.type==="child"?r.gender==="male"?us:fs:kt,[]),z=v.useMemo(()=>I?I.filter(r=>r.status==="scheduled"||r.status==="in_progress"||r.status==="payment_pending"):[],[I]),V=v.useCallback(r=>{if(!r)return"Для меня (родитель)";const _=k==null?void 0:k.find(A=>A.id===r);return _?`${_.first_name}${_.last_name?` ${_.last_name}`:""}`:"Профиль не найден"},[k]),G=async r=>{try{await c.mutateAsync(r),m(null)}catch{}},re=async r=>{try{await Ss(r),await n.invalidateQueries({queryKey:["profiles",s==null?void 0:s.id]}),h(null),ge.success("Член семьи удален")}catch(_){le.error("Error deleting profile:",_),ge.error("Ошибка при удалении члена семьи")}},K=v.useCallback(()=>{if(!x.current)return;const{scrollLeft:r,scrollWidth:_,clientWidth:A}=x.current;T(r>0),L(r<_-A-10);const M=Math.round(r/336);E(Math.max(0,Math.min(M,R.length-1)))},[R.length]);v.useEffect(()=>{if(R.length===0)return;K();const r=x.current;if(r)return r.addEventListener("scroll",K),window.addEventListener("resize",K),()=>{r.removeEventListener("scroll",K),window.removeEventListener("resize",K)}},[R,K]);const he=v.useCallback(r=>{if(!x.current)return;const _=336,A=_,P=x.current.scrollLeft;let M=r==="left"?P-A:P+A;M=Math.max(0,Math.min(M,x.current.scrollWidth-x.current.clientWidth)),x.current.scrollTo({left:M,behavior:"smooth"});const ee=Math.round(M/_);E(Math.max(0,Math.min(ee,R.length-1)))},[R.length]),xe=v.useCallback(r=>{if(!x.current)return;x.current.scrollTo({left:r*336,behavior:"smooth"}),E(r)},[]),J=v.useMemo(()=>{const r=R.filter(U=>U.type==="child");if(r.length===0)return{allowed:!1,reason:"no_children"};const _=r.filter(U=>Ue(U.dob).eligible);if(_.length===0)return{allowed:!1,reason:"no_eligible_children"};if(_.find(U=>{const ie=U.activeCheckupAssessment;return ie&&ie.status==="in_progress"&&!ie.completed_at}))return{allowed:!0,reason:"active_checkup_exists"};const P=_.map(U=>{const ie=U.checkupAssessment;return ie&&ie.status==="completed"&&ie.completed_at?new Date(ie.completed_at):null}).filter(U=>U!==null),M=P.length>0?new Date(Math.max(...P.map(U=>U.getTime()))):null;if(!M)return{allowed:!0,reason:"no_previous_checkup"};const ee=_.map(U=>new Date(U.created_at)).filter(U=>!isNaN(U.getTime())),be=ee.length>0?new Date(Math.max(...ee.map(U=>U.getTime()))):null;if(be&&be>M)return{allowed:!0,reason:"new_child_added"};const $e=Math.floor((Date.now()-M.getTime())/(1e3*60*60*24));return $e>=30?{allowed:!0,reason:"month_passed"}:{allowed:!1,reason:"too_soon",daysRemaining:30-$e,lastCheckupDate:M}},[R]);return v.useMemo(()=>R.filter(_=>_.type==="child").some(_=>{var A;return((A=_.checkupAssessment)==null?void 0:A.status)==="completed"}),[R]),v.useMemo(()=>{const r=R.filter(A=>A.type==="child");return r.length===0?!1:r.every(A=>{const P=Ue(A.dob);return!P.eligible&&P.reason==="too_young"})},[R]),v.useCallback(()=>{le.log("Checkup card clicked");const r=R.filter(P=>P.type==="child");if(r.length===0){t("/family-members");return}const _=r.filter(P=>Ue(P.dob).eligible);if(!J.allowed){if(J.reason==="no_eligible_children"){r.filter(M=>{const ee=Ue(M.dob);return!ee.eligible&&ee.reason==="too_young"}).length>0?ge.error("Чекап предназначен для детей от 3 до 18 лет. Ваш ребёнок ещё слишком маленький для прохождения чекапа."):ge.error("Чекап предназначен для детей от 3 до 18 лет.");return}if(J.reason==="too_soon"){const P=J.daysRemaining||0,M=J.lastCheckupDate?new Date(J.lastCheckupDate).toLocaleDateString("ru-RU"):"";ge.error(`Чекап можно пройти только раз в месяц или после добавления нового ребенка. Последний чекап был пройден ${M}. Повторно можно будет пройти через ${P} ${P===1?"день":P<5?"дня":"дней"}.`)}return}if(J.reason==="active_checkup_exists"){const P=_.find(M=>M.activeCheckupAssessment);if(P){le.log("Resuming checkup for child:",P.first_name),i(P.id),a(P),t(`/checkup-intro/${P.id}`);return}}const A=_[0];A&&(le.log("Starting checkup for child:",A.first_name),i(A.id),a(A),t(`/checkup-intro/${A.id}`))},[R,t,i,a,J]),v.useEffect(()=>{w&&(le.error("Error loading profiles:",w),ge.error("Не удалось загрузить данные. Попробуйте обновить страницу."))},[w]),e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-6 pt-8 pb-8",children:[(w||H)&&e.jsxs("div",{className:"mb-6 rounded-lg border border-destructive bg-destructive/10 p-4",children:[e.jsxs("p",{className:"text-sm font-medium text-destructive mb-2",children:[w&&`Ошибка загрузки профилей: ${w instanceof Error?w.message:"Неизвестная ошибка"}`,H&&`Ошибка загрузки консультаций: ${H instanceof Error?H.message:"Неизвестная ошибка"}`]}),e.jsx(O,{variant:"outline",size:"sm",onClick:()=>window.location.reload(),children:"Обновить страницу"})]}),z.length>0&&e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4",children:[e.jsx(Ae,{size:"xl",children:"Ваши предстоящие консультации"}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(O,{variant:"outline",size:"sm",onClick:()=>t("/cabinet/settings?tab=notifications"),className:"text-xs sm:text-sm",children:[e.jsx(_s,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Настроить уведомления"})]}),e.jsx(en,{})]})]}),z.length===1?e.jsx("div",{className:"space-y-4",children:z.map(r=>{var _;return e.jsx("div",{className:`rounded-xl border border-white/30 p-4 sm:p-6 text-card-foreground shadow-soft overflow-hidden ${r.status==="payment_pending"?"border-amber-300/50":""}`,style:{background:r.status==="payment_pending"?"linear-gradient(108deg, rgba(255, 193, 7, 0.35) 0%, rgba(255, 193, 7, 0.2) 100%)":"linear-gradient(108deg, rgba(255, 255, 255, 0.45) 0%, rgba(255, 255, 255, 0.25) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)"},children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-3 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r.status==="payment_pending"?e.jsxs(pe,{variant:"secondary",className:"bg-honey-pale text-foreground border-honey hover:bg-honey-pale font-light",children:[e.jsx(St,{className:"h-3 w-3 mr-1"}),"Ожидает оплаты"]}):r.payment_id?e.jsxs(pe,{variant:"secondary",className:"bg-sage-pale text-foreground border-sage hover:bg-sage-pale font-light",children:[e.jsx(Et,{className:"h-3 w-3 mr-1"}),"Оплачено"]}):null,r.status==="in_progress"&&e.jsxs(pe,{variant:"default",className:"bg-success hover:bg-success font-light",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-white animate-pulse mr-1"}),"Идет сейчас"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-white flex-shrink-0",children:e.jsx(Ne,{className:"h-5 w-5 text-ink"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Дата и время"}),e.jsx("p",{className:"font-medium truncate",children:Lt(r.scheduled_at)})]})]}),r.appointment_type&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-white flex-shrink-0",children:e.jsx(At,{className:"h-5 w-5 text-ink"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Тип консультации"}),e.jsxs("p",{className:"font-medium truncate",children:[r.appointment_type.name," (",r.appointment_type.duration_minutes," минут)"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-white flex-shrink-0",children:e.jsx(Le,{className:"h-5 w-5 text-ink"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Для кого"}),e.jsx("p",{className:"font-medium truncate",children:V(r.profile_id)})]})]}),r.status==="payment_pending"&&r.payment_expires_at&&e.jsxs("div",{className:"p-3 bg-honey-pale border border-honey rounded-lg",children:[e.jsxs("p",{className:"text-sm text-foreground",children:[e.jsx("strong",{children:"Срок оплаты:"})," ",new Date(r.payment_expires_at).toLocaleString("ru-RU",{day:"numeric",month:"long",hour:"2-digit",minute:"2-digit",timeZone:"Europe/Moscow"})," (МСК)"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"После истечения срока запись будет автоматически отменена"})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:ml-0 w-full md:w-auto md:min-w-[200px]",children:[r.specialist&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg cursor-pointer hover:bg-muted transition-colors mb-2",onClick:()=>p(r.specialist.id),children:[e.jsxs(Ve,{className:"h-10 w-10",children:[e.jsx(qe,{src:r.specialist.avatar_url||void 0}),e.jsx(He,{children:((_=r.specialist.display_name)==null?void 0:_.split(" ").map(A=>A[0]).join("").slice(0,2).toUpperCase())||"?"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Специалист"}),e.jsx("p",{className:"font-medium",children:r.specialist.display_name}),r.specialist.experience_years&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(dt,{className:"h-3 w-3"}),"Опыт: ",r.specialist.experience_years," лет"]})]}),e.jsx(ot,{className:"h-4 w-4 text-muted-foreground"})]}),r.status!=="payment_pending"&&r.video_room_url&&(()=>{const A=new Date(r.scheduled_at),P=new Date,M=(A.getTime()-P.getTime())/1e3/60;return r.status==="in_progress"||M<=15?e.jsxs(O,{variant:r.status==="in_progress"?"default":"outline",size:"sm",onClick:()=>window.open(r.video_room_url,"_blank"),className:r.status==="in_progress"?"bg-success hover:bg-success/90":"",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),r.status==="in_progress"?"Войти сейчас":"Войти в комнату"]}):e.jsxs(O,{variant:"outline",size:"sm",disabled:!0,className:"opacity-50",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Доступно за 15 мин"]})})(),r.status==="payment_pending"&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Ссылка на оплату отправлена на email"}),r.status!=="payment_pending"&&e.jsxs(Ze,{open:o===r.id,onOpenChange:A=>m(A?r.id:null),children:[e.jsx(Xe,{asChild:!0,children:e.jsxs(O,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-destructive hover:bg-muted/50 font-light",children:[e.jsx(lt,{className:"h-4 w-4 mr-2"}),"Отменить"]})}),e.jsxs(et,{children:[e.jsxs(tt,{children:[e.jsx(st,{children:"Отменить консультацию?"}),e.jsx(nt,{children:"Вы уверены, что хотите отменить консультацию? Это действие нельзя отменить."})]}),e.jsxs(rt,{children:[e.jsx(it,{children:"Нет, оставить"}),e.jsx(at,{onClick:()=>G(r.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Да, отменить"})]})]})]})]})]})},r.id)})}):e.jsxs(Qt,{opts:{align:"start",loop:!1},className:"w-full",children:[e.jsx(Zt,{className:"-ml-2 md:-ml-4",children:z.map(r=>{var _;return e.jsx(Xt,{className:"pl-2 md:pl-4 basis-full md:basis-[calc(50%-8px)] lg:basis-[calc(50%-8px)]",children:e.jsx("div",{className:`rounded-xl border border-white/30 p-4 sm:p-6 text-card-foreground shadow-soft overflow-hidden h-full ${r.status==="payment_pending"?"border-amber-300/50":""}`,style:{background:r.status==="payment_pending"?"linear-gradient(108deg, rgba(255, 193, 7, 0.35) 0%, rgba(255, 193, 7, 0.2) 100%)":"linear-gradient(108deg, rgba(255, 255, 255, 0.45) 0%, rgba(255, 255, 255, 0.25) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)"},children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-3 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r.status==="payment_pending"?e.jsxs(pe,{variant:"secondary",className:"bg-honey-pale text-foreground border-honey hover:bg-honey-pale font-light",children:[e.jsx(St,{className:"h-3 w-3 mr-1"}),"Ожидает оплаты"]}):r.payment_id?e.jsxs(pe,{variant:"secondary",className:"bg-sage-pale text-foreground border-sage hover:bg-sage-pale font-light",children:[e.jsx(Et,{className:"h-3 w-3 mr-1"}),"Оплачено"]}):null,r.status==="in_progress"&&e.jsxs(pe,{variant:"default",className:"bg-success hover:bg-success font-light",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-white animate-pulse mr-1"}),"Идет сейчас"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-white flex-shrink-0",children:e.jsx(Ne,{className:"h-5 w-5 text-ink"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Дата и время"}),e.jsx("p",{className:"font-medium truncate",children:Lt(r.scheduled_at)})]})]}),r.appointment_type&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-white flex-shrink-0",children:e.jsx(At,{className:"h-5 w-5 text-ink"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Тип консультации"}),e.jsxs("p",{className:"font-medium truncate",children:[r.appointment_type.name," (",r.appointment_type.duration_minutes," минут)"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-white flex-shrink-0",children:e.jsx(Le,{className:"h-5 w-5 text-ink"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Для кого"}),e.jsx("p",{className:"font-medium truncate",children:V(r.profile_id)})]})]}),r.status==="payment_pending"&&r.payment_expires_at&&e.jsxs("div",{className:"p-3 bg-honey-pale border border-honey rounded-lg",children:[e.jsxs("p",{className:"text-sm text-foreground",children:[e.jsx("strong",{children:"Срок оплаты:"})," ",new Date(r.payment_expires_at).toLocaleString("ru-RU",{day:"numeric",month:"long",hour:"2-digit",minute:"2-digit",timeZone:"Europe/Moscow"})," (МСК)"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"После истечения срока запись будет автоматически отменена"})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[r.specialist&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg cursor-pointer hover:bg-muted transition-colors mb-2",onClick:()=>p(r.specialist.id),children:[e.jsxs(Ve,{className:"h-10 w-10",children:[e.jsx(qe,{src:r.specialist.avatar_url||void 0}),e.jsx(He,{children:((_=r.specialist.display_name)==null?void 0:_.split(" ").map(A=>A[0]).join("").slice(0,2).toUpperCase())||"?"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Специалист"}),e.jsx("p",{className:"font-medium",children:r.specialist.display_name}),r.specialist.experience_years&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(dt,{className:"h-3 w-3"}),"Опыт: ",r.specialist.experience_years," лет"]})]}),e.jsx(ot,{className:"h-4 w-4 text-muted-foreground"})]}),r.status!=="payment_pending"&&r.video_room_url&&(()=>{const A=new Date(r.scheduled_at),P=new Date,M=(A.getTime()-P.getTime())/1e3/60;return r.status==="in_progress"||M<=15?e.jsxs(O,{variant:r.status==="in_progress"?"default":"outline",size:"sm",onClick:()=>window.open(r.video_room_url,"_blank"),className:r.status==="in_progress"?"bg-success hover:bg-success/90":"",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),r.status==="in_progress"?"Войти сейчас":"Войти в комнату"]}):e.jsxs(O,{variant:"outline",size:"sm",disabled:!0,className:"opacity-50",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Доступно за 15 мин"]})})(),r.status==="payment_pending"&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Ссылка на оплату отправлена на email"}),r.status!=="payment_pending"&&e.jsxs(Ze,{open:o===r.id,onOpenChange:A=>m(A?r.id:null),children:[e.jsx(Xe,{asChild:!0,children:e.jsxs(O,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-destructive hover:bg-muted/50 font-light",children:[e.jsx(lt,{className:"h-4 w-4 mr-2"}),"Отменить"]})}),e.jsxs(et,{children:[e.jsxs(tt,{children:[e.jsx(st,{children:"Отменить консультацию?"}),e.jsx(nt,{children:"Вы уверены, что хотите отменить консультацию? Это действие нельзя отменить."})]}),e.jsxs(rt,{children:[e.jsx(it,{children:"Нет, оставить"}),e.jsx(at,{onClick:()=>G(r.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Да, отменить"})]})]})]})]})]})})},r.id)})}),e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-4",children:[e.jsx(es,{className:"static translate-y-0 h-8 w-8"}),e.jsx(ts,{className:"static translate-y-0 h-8 w-8"})]})]})]}),B?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Загрузка..."})}):null,e.jsx(nn,{profilesCount:R.length,className:"mb-8"}),!1,e.jsxs("div",{className:"mb-12",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsx(Ae,{size:"xl",children:"Ваша семья"}),R.length>0&&e.jsxs(O,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground hover:bg-muted/50 font-light",onClick:()=>t("/add-family-member",{state:{from:"cabinet"}}),children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"}),"Добавить члена семьи"]})]}),R.length===0?e.jsxs(we,{className:"border-2 bg-card p-8 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Пока нет членов семьи"}),e.jsxs(O,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground hover:bg-muted/50 font-light",onClick:()=>t("/add-family-member",{state:{from:"cabinet"}}),children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"}),"Добавить члена семьи"]})]}):e.jsxs("div",{className:"relative",children:[b&&e.jsx(O,{variant:"ghost",size:"icon",className:"absolute left-0 top-1/2 -translate-y-1/2 z-10 h-10 w-10 rounded-full bg-white/90 hover:bg-white shadow-md",onClick:()=>he("left"),"aria-label":"Предыдущая карточка",children:e.jsx(ks,{className:"h-5 w-5 text-ink"})}),D&&e.jsx(O,{variant:"ghost",size:"icon",className:"absolute right-0 top-1/2 -translate-y-1/2 z-10 h-10 w-10 rounded-full bg-white/90 hover:bg-white shadow-md",onClick:()=>he("right"),"aria-label":"Следующая карточка",children:e.jsx(Ht,{className:"h-5 w-5 text-ink"})}),e.jsx("div",{ref:x,className:"flex gap-4 overflow-x-auto pb-4 scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none",WebkitOverflowScrolling:"touch",touchAction:"pan-x"},onScroll:K,children:R.map(r=>{var M,ee;const _=r.dob?Cs(r.dob):null,A=((M=r.checkupAssessment)==null?void 0:M.status)==="completed",P=(ee=r.checkupAssessment)!=null&&ee.completed_at?new Date(r.checkupAssessment.completed_at).toLocaleDateString("ru-RU"):null;return e.jsx(we,{className:"glass-elegant min-w-[320px] flex-shrink-0 flex flex-col border-2 p-6 transition-all hover:shadow-md",children:e.jsxs("div",{className:"flex flex-col items-center text-center flex-1",children:[e.jsx("img",{src:C(r),alt:`${r.first_name} ${r.last_name||""}`,className:"h-20 w-20 rounded-full object-cover mb-4"}),e.jsx("div",{className:"flex items-center gap-3 mb-2",children:e.jsxs(Ae,{size:"lg",children:[r.first_name," ",r.last_name||""]})}),_!==null&&e.jsxs("p",{className:"text-muted-foreground mb-2",children:[_," лет"]}),A&&e.jsxs(pe,{variant:"default",className:"bg-success text-success-foreground hover:bg-success font-light mb-2",children:[e.jsx(qt,{className:"h-3 w-3 mr-1"}),"Чекап завершен"]}),A&&P&&e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Завершен: ",P]}),e.jsxs("div",{className:"flex flex-col gap-2 mt-auto w-full",children:[A&&e.jsxs(O,{variant:"outline",size:"sm",className:"w-full",onClick:()=>t(`/results-report?profileId=${r.id}`),children:[e.jsx(ot,{className:"h-4 w-4 mr-2"}),"Посмотреть результаты"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(O,{variant:"ghost",size:"sm",className:"flex-1 text-muted-foreground hover:text-foreground hover:bg-muted/50 font-light",onClick:()=>{le.log("Edit clicked for member:",{id:r.id,name:`${r.first_name} ${r.last_name}`,type:r.type,isParent:r.type==="parent"}),r.type==="parent"?t("/profile",{state:{from:"cabinet"}}):t(`/edit-family-member/${r.id}`,{state:{from:"cabinet"}})},children:[e.jsx(Qe,{name:"pencil",style:"rr",className:"h-4 w-4 mr-2"}),"Редактировать"]}),r.type!=="parent"&&e.jsxs(Ze,{open:g===r.id,onOpenChange:be=>h(be?r.id:null),children:[e.jsx(Xe,{asChild:!0,children:e.jsxs(O,{variant:"ghost",size:"sm",className:"flex-1 text-muted-foreground hover:text-destructive hover:bg-muted/50 font-light",onClick:()=>h(r.id),children:[e.jsx(Qe,{name:"trash",style:"rr",className:"h-4 w-4 mr-2"}),"Удалить"]})}),e.jsxs(et,{children:[e.jsxs(tt,{children:[e.jsx(st,{children:"Удалить члена семьи?"}),e.jsxs(nt,{children:["Вы уверены, что хотите удалить ",r.first_name," ",r.last_name||"","? Это действие нельзя будет отменить."]})]}),e.jsxs(rt,{children:[e.jsx(it,{children:"Отмена"}),e.jsx(at,{onClick:()=>re(r.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Удалить"})]})]})]})]})]})]})},r.id)})}),R.length>1&&e.jsx("div",{className:"flex justify-center gap-2 mt-4",children:R.map((r,_)=>e.jsx("button",{className:`h-2 w-2 rounded-full transition-colors ${_===S?"bg-coral-light":"bg-muted-foreground/30 hover:bg-muted-foreground/60"}`,onClick:()=>xe(_),"aria-label":`Перейти к карточке ${_+1}`},_))})]})]}),e.jsxs("div",{className:"mb-12",children:[e.jsx(Ae,{size:"xl",className:"mb-4",children:"Есть вопросы?"}),e.jsxs(we,{className:"glass-elegant border-2 p-6",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Напишите в поддержку, чтобы решить любые проблемы или попросить помочь."}),e.jsxs(O,{onClick:()=>window.open("https://t.me/waves_support_bot","_blank","noopener,noreferrer"),children:[e.jsx(Qe,{name:"help-circle",style:"rr",className:"h-4 w-4 mr-2"}),"Написать в поддержку"]})]})]}),e.jsx(Ce,{open:!!y,onOpenChange:r=>!r&&p(null),children:e.jsx(Se,{className:"max-w-2xl w-[90vw] max-h-[90vh] overflow-y-auto p-0 bg-background",style:{background:"var(--bg-golden-hour)",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundAttachment:"fixed"},children:e.jsx("div",{className:"px-6 pb-6 pt-6",children:y&&e.jsx(Ws,{specialistId:y,showChangeButton:!0,onSpecialistChange:()=>p(null)})})})}),j&&e.jsx(Xs,{pendingRating:j,open:u,onClose:()=>{f(!1),N(null)},onSubmitted:async()=>{f(!1),N(null);const r=await Mt();r&&(N(r),f(!0))}})]})}export{hr as default};
