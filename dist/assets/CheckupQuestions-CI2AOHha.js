import{r as c,j as s}from"./vendor-radix-J7BmBqsC.js";import{u as O,e as D,c as F}from"./vendor-react-CI1J5nwZ.js";import{s as L,q as d,H as V,P as W,B as Y,x as J}from"./index-CsvxaYtI.js";import{g as K,a as U}from"./checkupQuestions-CelrvA-2.js";import{u as X}from"./useAssessment-B2u30bjB.js";import{getPrepositionalName as Z,getProfile as ee,getAgeGroup as re}from"./profileStorage-CU3CxDLE.js";import{f as E}from"./assessmentStorage-kMcQQ0-2.js";import{u as te,r as se}from"./scoring-DyuEFZvw.js";import"./vendor-charts-CkgrveCd.js";import"./vendor-query-Bb981xLV.js";const q=300;function ge(){const l=O(),T=D(),[w]=F(),G=parseInt(w.get("start")||"1")-1,{currentProfileId:_,setCurrentProfileId:p,setCurrentProfile:h}=L(),i=T.profileId||_,[y,R]=c.useState(null),[f,Q]=c.useState("elementary"),t=c.useMemo(()=>K(f),[f]),{assessmentId:N,currentStep:m,loading:j,saveAnswer:g,savedAnswers:I,complete:x}=X({assessmentType:"checkup",totalSteps:t.length,profileId:i});c.useEffect(()=>{let r=!1;async function e(){if(i)try{const n=await ee(i);if(!r&&n){R(n);const o=re(n.dob);Q(o),d.log("Child age group determined:",{profileId:n.id,dob:n.dob,ageGroup:o})}}catch(n){r||d.error("Error loading profile:",n)}}return e(),()=>{r=!0}},[i]),c.useEffect(()=>{async function r(){if(N&&f)try{await J.from("assessments").update({age_group:f}).eq("id",N)}catch(e){d.error("Error saving age_group to assessment:",e)}}r()},[N,f]);const $=w.has("start")?G:i&&m>1?m-1:0,[a,v]=c.useState($),[ae,b]=c.useState(t.map(r=>({questionId:r.id,value:null}))),[k,A]=c.useState(!1);c.useEffect(()=>{b(t.map(r=>({questionId:r.id,value:null}))),A(!1)},[t]);const u=c.useRef(null),S=w.get("start");c.useEffect(()=>{if(!j&&i&&!k&&t.length>0&&I.size>=0){if(t.some(e=>I.has(e.id))){const e=t.map(n=>{const o=I.get(n.id)??null;return n.isReverse&&o!==null&&o>=0?{questionId:n.id,value:te(o)}:{questionId:n.id,value:o}});b(e)}if(S){const e=parseInt(S)-1;e>=0&&e<t.length&&v(e)}else if(m>1){const e=m-1;e>=0&&e<t.length&&v(e)}A(!0)}},[j,i,m,k,S,t]),c.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[a]),c.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]);const z=c.useCallback(async r=>{const e=t[a];if(!e){d.error("Current question is not defined");return}try{b(o=>{const C=[...o];return C[a]={questionId:e.id,value:r},C});const n=e.isReverse===!0?se(r):r;if(i)try{await g(e.id,`checkup_${e.id.toString().padStart(2,"0")}`,e.scale,n,"default",a+1)}catch(o){d.error("Error saving answer:",o)}u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{a<t.length-1?(i&&window.history.replaceState({},"",`/checkup-questions/${i}`),v(a+1)):i?(async()=>{try{await x();const o=await E(i);o?(p(o.id),h(o),l(`/checkup-intro/${o.id}`)):l("/parent-intro")}catch(o){d.error("Error completing assessment:",o),l("/parent-intro")}})():l("/parent-intro"),u.current=null},q)}catch(n){d.error("Error in handleAnswer:",n)}},[a,t,i,g,x,l,p,h]),B=c.useCallback(async()=>{const r=t[a];r&&(i&&await g(r.id,`checkup_${r.id.toString().padStart(2,"0")}`,r.scale,-1,"default",a+1),b(e=>{const n=[...e];return n[a]={questionId:r.id,value:-1},n}),u.current&&clearTimeout(u.current),u.current=setTimeout(async()=>{if(a<t.length-1)v(a+1);else if(i)try{await x();const e=await E(i);e?(p(e.id),h(e),l(`/checkup-intro/${e.id}`)):l("/parent-intro")}catch(e){d.error("Error checking next child:",e),l("/parent-intro")}else l("/parent-intro");u.current=null},q))},[a,t,i,g,x,l,p,h]);if(!t||t.length===0)return d.error("questions is not defined or empty"),s.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"text-muted-foreground",children:"Ошибка загрузки вопросов"})})});if(a<0||a>=t.length)return l("/checkup-intro"),null;const P=t[a];if(!P)return l("/checkup-intro"),null;const H=(a+1)/t.length*100,M=y?Z(y.first_name,y.gender):"вашем ребенке";return j?s.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"text-muted-foreground",children:"Загрузка..."})})}):s.jsxs("div",{className:"min-h-screen bg-background",children:[s.jsx(V,{}),s.jsx("div",{className:"border-b border-border bg-primary py-4",children:s.jsx("div",{className:"container mx-auto px-4",children:s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx(W,{value:H,className:"flex-1 bg-primary-foreground/20"}),s.jsxs("span",{className:"text-sm font-medium text-primary-foreground",children:[a+1," / ",t.length]})]})})}),s.jsx("div",{className:"container mx-auto max-w-4xl px-4 py-12",children:s.jsx("div",{className:"space-y-8",children:s.jsxs("div",{className:"space-y-6",children:[s.jsxs("p",{className:"text-center text-muted-foreground",children:["Пожалуйста, ответьте на следующие вопросы о ",M,". Оценивайте ситуацию за последние шесть месяцев."]}),s.jsx("h2",{className:"text-center text-3xl font-bold text-foreground",children:P.text}),s.jsx("div",{className:"space-y-3 pt-8",children:U.map(r=>s.jsx("button",{onClick:()=>z(r.value),className:"w-full rounded-lg border border-border bg-card px-6 py-4 text-center text-base font-medium text-card-foreground transition-all hover:border-primary hover:bg-secondary/50 active:scale-[0.98]",children:r.label},r.value))}),s.jsx("div",{className:"pt-8 text-center",children:s.jsx(Y,{variant:"ghost",onClick:B,className:"text-muted-foreground hover:text-foreground",children:"Пропустить"})})]})})})]})}export{ge as default};
