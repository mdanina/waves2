import{r as t,j as e}from"./vendor-radix-htwXsPHy.js";import{E as Ge,u as He,aH as he,bt as Ke,aI as Ue,a4 as Ze,B as x,a3 as xe,C as fe,a9 as W,a5 as Je,bu as ge,r as G,ai as be,o as je,aC as Ne,G as H,aM as we,aN as ve,x as Xe,y as Ye,aP as es,a2 as ss,aR as ye,bv as j,bw as Ce,aS as Se,aT as ts,bx as as,aV as ns,by as is,b0 as rs}from"./index-Dv2C02zj.js";import{S as K}from"./skeleton-_MojRjq8.js";import{u as ls,S as ke,M as cs,A as os,P as ds}from"./MessageAttachment-CWLS7d3f.js";import{u as us}from"./vendor-react-CI8wve7f.js";import{B as ms}from"./bell-off-BuZ_taXD.js";import{S as ps}from"./search-BPVVDSxP.js";import{P as hs}from"./plus-CrCC_Tdd.js";import{S as Me}from"./shield-Cx4EwisG.js";import{S as xs}from"./send-CfHFoQor.js";import"./vendor-charts-DjioKZbK.js";import"./vendor-query-BNGVDYIL.js";import"./download-B3icIhd6.js";import"./image-DNnGKu0q.js";function Ts(){const Ie=us(),{toast:v}=Ge(),{user:n}=He(),{permission:U,requestPermission:_e,notifyNewMessage:$}=ls(),Z=t.useRef(null),T=t.useRef(0),B=t.useRef(null),J=t.useRef([]),[u,X]=t.useState({support:[],specialists:[],hasNewSupportOption:!1,specialistsTotalCount:0,specialistsPage:1,specialistsPageSize:he,specialistsTotalPages:0}),[m,Re]=t.useState(1),[y,Te]=t.useState(0),[Ee,Pe]=t.useState(0),[c,F]=t.useState(null),[E,C]=t.useState([]),[P,D]=t.useState(""),[ze,Y]=t.useState(!0),[Ae,ee]=t.useState(!1),[S,se]=t.useState(!1),[N,Le]=t.useState(""),[k,Oe]=t.useState(!1),[$e,q]=t.useState(!1),[f,z]=t.useState(null),[A,te]=t.useState(!1),[ae,fs]=t.useState(!1),[g,V]=t.useState("support"),L=t.useRef(null);t.useEffect(()=>{const s=()=>{Oe(window.innerWidth<768)};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]);const M=t.useCallback(()=>{setTimeout(()=>{var s;(s=Z.current)==null||s.scrollIntoView({behavior:"smooth"})},100)},[]),p=t.useCallback(async(s=1,a=!1)=>{try{a&&Y(!0);const i=await Ke({page:s,pageSize:he});X(i),Re(i.specialistsPage),Te(i.specialistsTotalPages),Pe(i.specialistsTotalCount)}catch(i){console.error("Error loading conversations:",i),v({title:"Ошибка",description:"Не удалось загрузить беседы",variant:"destructive"})}finally{a&&Y(!1)}},[v]);t.useEffect(()=>{n!=null&&n.id&&p(1,!0)},[n==null?void 0:n.id,p]);const Be=t.useCallback(()=>{m>1&&p(m-1,!1)},[m,p]),Fe=t.useCallback(()=>{m<y&&p(m+1,!1)},[m,y,p]),O=t.useMemo(()=>Ue(()=>{p(m,!1)},2e3),[p,m]);t.useEffect(()=>{const s=()=>{n!=null&&n.id&&O()};return window.addEventListener("focus",s),()=>window.removeEventListener("focus",s)},[n==null?void 0:n.id,O]),t.useEffect(()=>{B.current=c},[c]);const ne=t.useMemo(()=>[...u.support,...u.specialists],[u]);t.useEffect(()=>{J.current=ne},[ne]);const I=t.useCallback((s,a)=>{X(i=>({...i,support:i.support.map(r=>r.recipientId===s?a(r):r),specialists:i.specialists.map(r=>r.recipientId===s?a(r):r)}))},[]);t.useEffect(()=>{if(!(n!=null&&n.id))return;const s=Ze(n.id,async a=>{var i;try{const r=a.sender_id,l=B.current,w=a.is_support_message===!0,o=await ye(a),_=((i=B.current)==null?void 0:i.recipientId)===(l==null?void 0:l.recipientId),h=w?j:r;if(l&&_&&(l.recipientId===h||w&&l.recipientId===j))C(d=>[...d,o]),M(),w?await Ce():await Se(r),I(h,d=>({...d,lastMessage:o,unreadCount:0}));else{if(w)$("Служба поддержки",o.content);else{const d=J.current.find(We=>We.recipientId===r);d&&$(d.recipientName,o.content)}I(h,d=>({...d,lastMessage:o,unreadCount:d.unreadCount+1}))}O()}catch(r){console.error("Error processing message:",r)}});return()=>s()},[n==null?void 0:n.id,M,$,I,O]),t.useEffect(()=>{E.length>0&&M()},[E,M]);const ie=async s=>{const a=++T.current,i=s===j;try{ee(!0);const r=i?await is():await rs(s);if(a!==T.current)return;C(r),i?await Ce():await Se(s),I(s,l=>({...l,unreadCount:0}))}catch(r){if(a!==T.current)return;console.error("Error loading messages:",r),v({title:"Ошибка",description:"Не удалось загрузить сообщения",variant:"destructive"})}finally{a===T.current&&ee(!1)}},re=s=>{F(s),ie(s.recipientId),k&&q(!0)},De=()=>{q(!1),F(null)},qe=s=>{var i;const a=(i=s.target.files)==null?void 0:i[0];if(a){if(a.size>10*1024*1024){v({title:"Файл слишком большой",description:"Максимальный размер файла — 10 МБ",variant:"destructive"});return}z(a),L.current&&(L.current.value="")}},le=async()=>{if(!P.trim()&&!f||!c||!(n!=null&&n.id)||S)return;const s=P.trim()||(f?`Файл: ${f.name}`:""),a=`temp-${Date.now()}`,i=c.recipientId,r=i===j,l=f,w={id:a,sender_id:n.id,recipient_id:i,content:s,is_read:!1,read_at:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_support_message:r,attachment_name:l==null?void 0:l.name,attachment_type:l==null?void 0:l.type,attachment_size:l==null?void 0:l.size};C(o=>[...o,w]),D(""),z(null),M(),se(!0);try{let o;if(l){te(!0);try{o=await ts(r?"support":i,l)}finally{te(!1)}}const _=r?await as(s,o):await ns(i,s,o),h=await ye(_);C(R=>R.map(d=>d.id===a?h:d)),I(i,R=>({...R,lastMessage:h}))}catch(o){console.error("Error sending message:",o),C(_=>_.filter(h=>h.id!==a)),D(s),l&&z(l),v({title:"Ошибка",description:"Не удалось отправить сообщение. Попробуйте ещё раз.",variant:"destructive"})}finally{se(!1)}},ce=t.useDeferredValue(N),Q=t.useMemo(()=>g==="specialists"?u.specialists:u.support,[g,u]),oe=t.useMemo(()=>{const s=ce.toLowerCase();return s?Q.filter(a=>{var i,r;return a.recipientName.toLowerCase().includes(s)||((i=a.specialization)==null?void 0:i.toLowerCase().includes(s))||((r=a.adminRole)==null?void 0:r.toLowerCase().includes(s))}):Q},[Q,ce]),de=s=>s.recipientType==="specialist"?s.specialization||"Специалист":s.recipientType==="admin"?s.adminRole||"Поддержка":"Клиент",ue=s=>{switch(s){case"specialist":return{textClass:"text-foreground"};case"admin":return{textClass:"text-foreground"};default:return{textClass:"text-muted-foreground"}}},b=t.useMemo(()=>({specialists:u.specialists.reduce((s,a)=>s+a.unreadCount,0),support:u.support.reduce((s,a)=>s+a.unreadCount,0)}),[u]);t.useMemo(()=>b.specialists+b.support,[b]);const Ve=()=>{const s=u.support.find(a=>a.recipientId===j);s?re(s):(F({recipientId:j,recipientName:"Служба поддержки",recipientAvatar:null,recipientType:"admin",adminRole:"Поддержка",lastMessage:null,unreadCount:0}),ie(j),V("support"),k&&q(!0))};if(ze)return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b border-border bg-background px-4 py-3",children:e.jsxs("div",{className:"container mx-auto flex items-center gap-3",children:[e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>Ie("/cabinet"),children:e.jsx(xe,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Сообщения"})]})}),e.jsx("div",{className:"container mx-auto max-w-6xl p-4",children:e.jsx(fe,{className:"h-[calc(100vh-8rem)]",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"w-full md:w-80 md:border-r p-4 space-y-4",children:[e.jsx(K,{className:"h-10 w-full"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsx(K,{className:"h-16 w-full"},s))})]}),e.jsx("div",{className:"hidden md:flex flex-1 items-center justify-center",children:e.jsx(K,{className:"h-8 w-48"})})]})})})]});const me=e.jsxs("div",{className:`flex flex-col ${k?"h-full w-full":"w-80 border-r shrink-0"}`,children:[e.jsxs("div",{className:"p-4 border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h2",{className:"font-bold text-2xl flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5 text-honey"}),"Сообщения"]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:bg-cloud/50 rounded-full",onClick:_e,title:U==="granted"?"Уведомления включены":"Включить уведомления",children:U==="granted"?e.jsx(Je,{className:"h-4 w-4 text-honey"}):e.jsx(ms,{className:"h-4 w-4 text-muted-foreground"})})]}),e.jsxs("div",{className:"flex rounded-xl bg-cloud p-1 mb-3",children:[e.jsxs("button",{onClick:()=>V("support"),className:`flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg transition-all ${g==="support"?"bg-white text-foreground shadow-soft":"text-muted-foreground hover:text-foreground hover:bg-white/50"}`,children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{children:"Поддержка"}),b.support>0&&e.jsx(G,{variant:"secondary",className:"ml-1 h-5 min-w-5 px-1 bg-honey text-ink font-light hover:bg-honey",children:b.support})]}),e.jsxs("button",{onClick:()=>V("specialists"),className:`flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg transition-all ${g==="specialists"?"bg-white text-foreground shadow-soft":"text-muted-foreground hover:text-foreground hover:bg-white/50"}`,children:[e.jsx(be,{className:"h-4 w-4"}),e.jsx("span",{children:"Специалисты"}),b.specialists>0&&e.jsx(G,{variant:"secondary",className:"ml-1 h-5 min-w-5 px-1 bg-honey text-ink font-light hover:bg-honey",children:b.specialists})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ps,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground z-10"}),e.jsx(je,{placeholder:"Поиск...",value:N,onChange:s=>Le(s.target.value),className:"pl-10 rounded-full"})]})]}),e.jsxs(Ne,{className:"flex-1",children:[g==="support"&&u.hasNewSupportOption&&e.jsx("div",{className:"p-2 border-b",children:e.jsxs(x,{variant:"outline",className:"w-full justify-start gap-2 rounded-full font-light",onClick:Ve,disabled:ae,children:[ae?e.jsx(H,{className:"h-4 w-4 animate-spin"}):e.jsx(hs,{className:"h-4 w-4"}),"Написать в поддержку"]})}),oe.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:g==="specialists"?e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"mx-auto h-12 w-12 mb-3 opacity-50 text-lavender"}),e.jsx("p",{className:"text-sm font-medium mb-1",children:N?"Ничего не найдено":"Нет назначенных специалистов"}),e.jsx("p",{className:"text-xs font-light",children:!N&&"Специалист будет назначен после консультации"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"mx-auto h-12 w-12 mb-3 opacity-50 text-lavender"}),e.jsx("p",{className:"text-sm font-medium mb-1",children:N?"Ничего не найдено":"Нет активных обращений"}),e.jsx("p",{className:"text-xs font-light",children:!N&&'Нажмите "Написать в поддержку" чтобы задать вопрос'})]})}):e.jsx("div",{className:"p-2",children:oe.map(s=>e.jsx("button",{onClick:()=>re(s),className:`w-full p-3 rounded-xl text-left transition-all ${(c==null?void 0:c.recipientId)===s.recipientId?"bg-lavender-pale/50 border border-lavender/30 shadow-soft":"hover:bg-cloud/50 border border-transparent"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[s.recipientAvatar?e.jsx("img",{src:s.recipientAvatar,alt:s.recipientName,className:"w-12 h-12 rounded-full object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-lavender-pale flex items-center justify-center text-sm font-bold text-lavender",children:we(s.recipientName)}),s.recipientType==="admin"&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center bg-lavender text-ink shadow-soft",children:e.jsx(Me,{className:"w-3 h-3"})}),s.recipientType==="specialist"&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center bg-honey text-ink shadow-soft",children:e.jsx(ke,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-bold truncate",children:s.recipientName}),s.lastMessage&&e.jsx("span",{className:"text-xs text-muted-foreground font-light",children:ve(s.lastMessage.created_at)})]}),e.jsx("p",{className:`text-xs truncate mb-1 font-light ${ue(s.recipientType).textClass}`,children:de(s)}),s.lastMessage&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate font-light",children:[s.lastMessage.sender_id===(n==null?void 0:n.id)?"Вы: ":"",s.lastMessage.content]})]}),s.unreadCount>0&&e.jsx(G,{className:"ml-2 bg-honey text-ink font-light hover:bg-honey",children:s.unreadCount})]})},s.recipientId))})]}),g==="specialists"&&y>1&&e.jsxs("div",{className:"p-2 border-t flex items-center justify-between",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:Be,disabled:m<=1,className:"h-8 px-2",children:e.jsx(Xe,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[m," / ",y," (",Ee,")"]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:Fe,disabled:m>=y,className:"h-8 px-2",children:e.jsx(Ye,{className:"h-4 w-4"})})]})]}),pe=e.jsx("div",{className:"flex-1 flex flex-col h-full",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border/50 flex items-center gap-3 bg-white/50 backdrop-blur-sm",children:[k&&e.jsx(x,{variant:"ghost",size:"icon",onClick:De,className:"mr-1 rounded-full hover:bg-cloud/50",children:e.jsx(xe,{className:"h-5 w-5"})}),e.jsxs("div",{className:"relative",children:[c.recipientAvatar?e.jsx("img",{src:c.recipientAvatar,alt:c.recipientName,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-lavender-pale flex items-center justify-center text-sm font-bold text-lavender",children:we(c.recipientName)}),c.recipientType==="admin"&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center bg-lavender text-ink shadow-soft",children:e.jsx(Me,{className:"w-3 h-3"})}),c.recipientType==="specialist"&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center bg-honey text-ink shadow-soft",children:e.jsx(ke,{className:"w-3 h-3"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:c.recipientName}),e.jsx("p",{className:`text-sm font-light ${ue(c.recipientType).textClass}`,children:de(c)})]})]}),e.jsx(Ne,{className:"flex-1 p-4",children:Ae?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(H,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):E.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(W,{className:"h-12 w-12 mb-4 opacity-50 text-lavender"}),e.jsx("p",{className:"text-lg font-bold",children:"Начните беседу"}),e.jsx("p",{className:"text-sm mt-1 text-center max-w-xs font-light",children:c.recipientType==="admin"?"Напишите в службу поддержки - мы рады помочь!":"Напишите вашему специалисту первым или дождитесь его сообщения"})]}):e.jsxs("div",{className:"space-y-4",children:[E.map(s=>{const a=s.sender_id===(n==null?void 0:n.id);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] md:max-w-[70%] rounded-xl px-4 py-2 shadow-soft ${a?"bg-honey text-ink rounded-br-sm":"bg-white border border-border/30 rounded-bl-sm"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:s.content}),s.attachment_url&&s.attachment_name&&s.attachment_type&&s.attachment_size&&e.jsx(cs,{url:s.attachment_url,name:s.attachment_name,type:s.attachment_type,size:s.attachment_size,isOwn:a}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1",children:[e.jsx("span",{className:`text-xs ${a?"opacity-70":"text-muted-foreground"}`,children:ve(s.created_at)}),a&&(s.is_read?e.jsx(es,{className:"h-3 w-3"}):e.jsx(ss,{className:"h-3 w-3"}))]})]})},s.id)}),e.jsx("div",{ref:Z})]})}),e.jsxs("div",{className:"p-4 border-t border-border/50 bg-white/50 backdrop-blur-sm space-y-2",children:[f&&e.jsx(os,{file:f,onRemove:()=>z(null)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:L,onChange:qe,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>{var s;return(s=L.current)==null?void 0:s.click()},disabled:S||A,title:"Прикрепить файл",className:"rounded-full hover:bg-cloud/50",children:e.jsx(ds,{className:"h-4 w-4"})}),e.jsx(je,{placeholder:"Напишите сообщение...",value:P,onChange:s=>D(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),le())},disabled:S||A,className:"flex-1 rounded-full"}),e.jsx(x,{onClick:le,disabled:!P.trim()&&!f||S||A,size:"icon",className:"rounded-full bg-honey text-ink hover:bg-honey-dark shadow-soft",children:S||A?e.jsx(H,{className:"h-4 w-4 animate-spin"}):e.jsx(xs,{className:"h-4 w-4"})})]})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-muted-foreground p-4",children:[e.jsx(W,{className:"h-16 w-16 mb-4 opacity-50 text-lavender"}),e.jsx("p",{className:"text-lg font-bold",children:"Выберите беседу"}),e.jsx("p",{className:"text-sm mt-1 text-center max-w-xs font-light",children:"Выберите собеседника из списка слева, чтобы начать или продолжить беседу"})]})}),Qe={background:"var(--bg-golden-hour)",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundAttachment:"fixed"};return e.jsx("div",{className:"min-h-screen flex flex-col",style:Qe,children:e.jsx("div",{className:"flex-1 container mx-auto max-w-6xl p-4",children:e.jsx(fe,{className:"h-[calc(100vh-4rem)] overflow-hidden rounded-xl shadow-soft border-2",style:{background:"linear-gradient(108deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.5) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)"},children:k?$e&&c?pe:me:e.jsxs("div",{className:"flex h-full",children:[me,pe]})})})})}export{Ts as default};
