const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Dt6uKTGi.js","assets/vendor-radix-CDHcN1cP.js","assets/vendor-charts-DMFz3Lzq.js","assets/vendor-query-DyYoeD25.js","assets/vendor-react-D0zZO7ze.js","assets/index-WbV8wJG0.css"])))=>i.map(i=>d[i]);
import{ag as q,v as c,R as i}from"./index-Dt6uKTGi.js";async function C(s,t,e){try{const n=await A(s,t);if(n)return e&&n.total_steps!==e&&(await i.from("assessments").update({total_steps:e}).eq("id",n.id),n.total_steps=e),{id:n.id,assessment:n};const{getProfiles:u}=await q(async()=>{const{getProfiles:l}=await import("./index-Dt6uKTGi.js").then(p=>p.bi);return{getProfiles:l}},__vite__mapDeps([0,1,2,3,4,5])),d=await u(),o=d.find(l=>l.id===s&&l.type==="child"),r=d.find(l=>l.type==="parent"),a=d.find(l=>l.type==="partner"),m={};if(o!=null&&o.worry_tags&&(m.child=o.worry_tags),r!=null&&r.worry_tags){const l=["Выгорание","Тревожность","Пониженное настроение","Трудности с концентрацией внимания","Общий стресс"],p=["Разделение/развод","Семейный стресс","Отношения с партнером","Психическое здоровье партнера","Воспитание","Семейный конфликт"];m.personal=r.worry_tags.filter(g=>l.includes(g)),m.family=r.worry_tags.filter(g=>p.includes(g))}a!=null&&a.worry_tags&&(m.family=a.worry_tags);const{data:w,error:_}=await i.from("assessments").insert({profile_id:s,assessment_type:t,status:"in_progress",current_step:1,total_steps:e||null,worry_tags:Object.keys(m).length>0?m:null}).select("*").single();if(_)throw c.error("Error creating assessment:",_),_;const{data:f}=await i.from("assessments").select("*").eq("profile_id",s).eq("assessment_type",t).eq("status","in_progress").order("created_at",{ascending:!0});if(!f||f.length===0)return{id:w.id,assessment:w};if(f.length===1)return{id:f[0].id,assessment:f[0]};const[h,...E]=f,y=E.map(l=>l.id);return c.warn(`Race condition detected: found ${f.length} in_progress assessments. Keeping earliest, deleting ${y.length} duplicates.`),await i.from("assessments").delete().in("id",y),{id:h.id,assessment:h}}catch(n){throw c.error("Error getting/creating assessment:",n),n}}async function A(s,t){try{const{data:e,error:n}=await i.from("assessments").select("*").eq("profile_id",s).eq("assessment_type",t).eq("status","in_progress").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(n)throw n;return e}catch(e){return c.error("Error getting active assessment:",e),null}}async function D(s,t){try{const{error:e}=await i.from("assessments").update({current_step:t,updated_at:new Date().toISOString()}).eq("id",s);if(e)throw e}catch(e){throw c.error("Error updating assessment step:",e),e}}async function P(s,t){try{const e={assessment_id:s,question_code:t.questionCode,question_id:t.questionId,category:t.category,value:t.value,answer_type:t.answerType||null,step_number:t.stepNumber},{error:n}=await i.from("answers").upsert(e,{onConflict:"assessment_id,question_id"}).select();if(n)throw n}catch(e){throw c.error("Error saving answer:",e),e}}async function k(s){try{const{data:t,error:e}=await i.from("answers").select("*").eq("assessment_id",s).order("question_id",{ascending:!0});if(e)throw e;return t||[]}catch(t){throw c.error("Error getting answers:",t),t}}async function x(s){try{const{data:t,error:e}=await i.rpc("complete_assessment",{assessment_uuid:s});if(e)throw e;return t}catch(t){throw c.error("Error completing assessment:",t),t}}async function O(s,t){try{const{data:e,error:n}=await i.from("assessments").select("*").eq("profile_id",s).eq("assessment_type",t).eq("status","completed").order("completed_at",{ascending:!1}).limit(1).maybeSingle();if(n)throw n;return e}catch(e){return c.error("Error getting completed assessment:",e),null}}async function R(s){try{const{data:t,error:e}=await i.rpc("complete_assessment",{assessment_uuid:s});if(e)throw e;return t}catch(t){return c.error("Error recalculating assessment results:",t),null}}async function v(s,t){if(s.length===0)return{};try{const{data:e,error:n}=await i.from("assessments").select("*").in("profile_id",s).eq("assessment_type",t).eq("status","completed").order("completed_at",{ascending:!1});if(n)throw n;const u=(e==null?void 0:e.reduce((o,r)=>{if(!r.profile_id)return o;const a=o[r.profile_id];return(!a||!a.completed_at&&r.completed_at||a.completed_at&&r.completed_at&&new Date(r.completed_at)>new Date(a.completed_at))&&(o[r.profile_id]=r),o},{}))||{},d={};for(const o of s)d[o]=u[o]||null;return d}catch(e){throw c.error("Error getting assessments for profiles:",e),e}}async function W(s,t){if(s.length===0)return{};try{const{data:e,error:n}=await i.from("assessments").select("*").in("profile_id",s).eq("assessment_type",t).eq("status","in_progress").order("created_at",{ascending:!1});if(n)throw n;const u=(e==null?void 0:e.reduce((o,r)=>{if(!r.profile_id)return o;const a=o[r.profile_id];return(!a||!a.created_at&&r.created_at||a.created_at&&r.created_at&&new Date(r.created_at)>new Date(a.created_at))&&(o[r.profile_id]=r),o},{}))||{},d={};for(const o of s)d[o]=u[o]||null;return d}catch(e){throw c.error("Error getting active assessments for profiles:",e),e}}async function F(s){try{const{getProfiles:t}=await q(async()=>{const{getProfiles:r}=await import("./index-Dt6uKTGi.js").then(a=>a.bi);return{getProfiles:r}},__vite__mapDeps([0,1,2,3,4,5])),n=(await t()).filter(r=>r.type==="child"&&r.id!==s);if(n.length===0)return null;const u=n.map(r=>r.id),d=await v(u,"checkup");return n.find(r=>{const a=d[r.id];return!a||a.status!=="completed"})||null}catch(t){return c.error("Error finding next child without checkup:",t),null}}export{k as a,O as b,x as c,v as d,W as e,F as f,C as g,R as r,P as s,D as u};
