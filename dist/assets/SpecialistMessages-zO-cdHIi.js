import{r as a,j as e}from"./vendor-radix-htwXsPHy.js";import{c as Ms}from"./vendor-react-CI8wve7f.js";import{E as _s,b4 as Is,bs as ks,aH as Ae,aI as Rs,a4 as Es,aK as Gs,aL as zs,C as De,B as h,a5 as Ls,a9 as J,ai as O,o as U,U as Fe,aC as q,aM as he,aN as ee,r as $e,x as Oe,y as qe,aO as Be,G as B,aP as Ps,a2 as Ts,V as As,W as Ds,X as Fs,Y as $s,L as Ke,aQ as Os,a0 as qs,aR as se,aS as Ve,aW as Bs,aX as We,aT as Qe,aY as Ks,aZ as Vs,aV as Ws,b0 as Qs}from"./index-Dv2C02zj.js";import{S as te}from"./skeleton-_MojRjq8.js";import{u as Hs,S as He,M as Xe,A as Ye,P as Ze}from"./MessageAttachment-CWLS7d3f.js";import{T as Xs,a as Ys,b as Je}from"./tabs-BqI5JGIV.js";import{P as Zs}from"./plus-CrCC_Tdd.js";import{B as Js}from"./bell-off-BuZ_taXD.js";import{S as Us}from"./search-BPVVDSxP.js";import{S as Ue}from"./shield-Cx4EwisG.js";import{S as es}from"./send-CfHFoQor.js";import"./vendor-charts-DjioKZbK.js";import"./vendor-query-BNGVDYIL.js";import"./download-B3icIhd6.js";import"./image-DNnGKu0q.js";function ft(){const{toast:g}=_s(),{specialistUser:i}=Is(),{permission:fe,requestPermission:ss,notifyNewMessage:pe}=Hs(),[ts,ge]=Ms(),ae=a.useRef(null),K=a.useRef(0),re=ts.get("client"),ne=a.useRef(null),je=a.useRef(null),Ne=a.useRef([]),[j,G]=a.useState([]),[o,ie]=a.useState(null),[V,z]=a.useState([]),[w,R]=a.useState(""),[as,ye]=a.useState(!0),[rs,be]=a.useState(!1),[y,W]=a.useState(!1),[le,ns]=a.useState(""),[C,Q]=a.useState("all"),[p,_]=a.useState(null),[b,L]=a.useState(!1),E=a.useRef(null),[N,is]=a.useState(1),[P,ls]=a.useState(1),[ce,cs]=a.useState(0),[v,ds]=a.useState(1),[T,os]=a.useState(1),[us,ms]=a.useState(0),[I,xs]=a.useState("direct"),[ve,de]=a.useState([]),[x,we]=a.useState(null),[Ce,A]=a.useState([]),[oe,Se]=a.useState(!1),[hs,Me]=a.useState(!1),[_e,fs]=a.useState(!1),D=a.useRef(0),[ps,F]=a.useState(!1),[H,X]=a.useState(""),[$,Y]=a.useState([]),[ue,Ie]=a.useState(!1),S=a.useCallback(()=>{setTimeout(()=>{var s;(s=ae.current)==null||s.scrollIntoView({behavior:"smooth"})},100)},[]),M=a.useCallback(async(s=1,t=!1)=>{try{t&&ye(!0);const n=await ks({page:s,pageSize:Ae});G(n.conversations),is(n.page),ls(n.totalPages),cs(n.totalCount)}catch(n){console.error("Error loading conversations:",n),g({title:"Ошибка",description:"Не удалось загрузить беседы",variant:"destructive"})}finally{t&&ye(!1)}},[g]);a.useEffect(()=>{i!=null&&i.id&&M(1,!0)},[i==null?void 0:i.id,M]);const gs=a.useCallback(()=>{N>1&&M(N-1,!1)},[N,M]),js=a.useCallback(()=>{N<P&&M(N+1,!1)},[N,P,M]),ke=a.useMemo(()=>Rs(()=>{M(N,!1)},2e3),[M,N]);a.useEffect(()=>{const s=()=>{i!=null&&i.id&&ke()};return window.addEventListener("focus",s),()=>window.removeEventListener("focus",s)},[i==null?void 0:i.id,ke]),a.useEffect(()=>{if(re&&j.length>0&&!o){const s=j.find(t=>t.recipientId===re);s&&(ie(s),ge({},{replace:!0}))}},[re,j,o,ge]),a.useEffect(()=>{ne.current=o},[o]),a.useEffect(()=>{je.current=x},[x]),a.useEffect(()=>{Ne.current=j},[j]),a.useEffect(()=>{if(!(i!=null&&i.id))return;const s=Es(i.id,async t=>{var n;try{const r=t.sender_id,u=ne.current,l=await se(t),f=((n=ne.current)==null?void 0:n.recipientId)===(u==null?void 0:u.recipientId);if(u&&r===u.recipientId&&f)z(d=>[...d,l]),S(),await Ve(r),G(d=>d.map(m=>m.recipientId===r?{...m,lastMessage:l,unreadCount:0}:m));else{const d=Ne.current.find(m=>m.recipientId===r);d&&pe(d.recipientName,l.content),G(m=>m.map(c=>c.recipientId===r?{...c,lastMessage:l,unreadCount:c.unreadCount+1}:c))}}catch(r){console.error("Error processing message:",r)}});return()=>s()},[i==null?void 0:i.id,S,pe]),a.useEffect(()=>{V.length>0&&S()},[V,S]);const Ns=async s=>{const t=++K.current;try{be(!0);const n=await Qs(s);if(t!==K.current)return;z(n),await Ve(s),G(r=>r.map(u=>u.recipientId===s?{...u,unreadCount:0}:u))}catch(n){if(t!==K.current)return;console.error("Error loading messages:",n),g({title:"Ошибка",description:"Не удалось загрузить сообщения",variant:"destructive"})}finally{t===K.current&&be(!1)}},ys=s=>{ie(s),we(null),Ns(s.recipientId)},k=a.useCallback(async(s=1)=>{try{Se(!0);const t=await Gs({page:s,pageSize:Ae});de(t.conversations),ds(t.page),os(t.totalPages),ms(t.totalCount),fs(!0)}catch(t){console.error("Error loading group conversations:",t),g({title:"Ошибка",description:"Не удалось загрузить групповые чаты",variant:"destructive"})}finally{Se(!1)}},[g]);a.useEffect(()=>{I==="groups"&&!_e&&!oe&&k(1)},[I,_e,oe,k]);const bs=a.useCallback(()=>{v>1&&k(v-1)},[v,k]),vs=a.useCallback(()=>{v<T&&k(v+1)},[v,T,k]),ws=async s=>{we(s),ie(null);const t=++D.current;try{Me(!0);const n=await Bs(s.group.id);if(t!==D.current)return;if(A(n),n.length>0){const r=n[n.length-1];if(await We(s.group.id,r.id),t!==D.current)return}de(r=>r.map(u=>u.group.id===s.group.id?{...u,unreadCount:0}:u))}catch(n){if(t!==D.current)return;console.error("Error loading group messages:",n),g({title:"Ошибка",description:"Не удалось загрузить сообщения группы",variant:"destructive"})}finally{t===D.current&&Me(!1)}},Re=async()=>{if(!w.trim()&&!p||!x||!(i!=null&&i.id)||y||b)return;const s=w.trim(),t=`temp-${Date.now()}`,n=x.group.id,r=p,u={id:t,group_id:n,sender_id:i.id,content:s,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),senderName:"Вы",attachment_url:r?URL.createObjectURL(r):null,attachment_name:(r==null?void 0:r.name)||null,attachment_type:(r==null?void 0:r.type)||null,attachment_size:(r==null?void 0:r.size)||null};A(l=>[...l,u]),R(""),_(null),S(),W(!0);try{let l;r&&(L(!0),l=await Qe(n,r),L(!1));const f=await Ks(n,s,l),d=await se(f);A(m=>m.map(c=>{var Te;return c.id===t?((Te=c.attachment_url)!=null&&Te.startsWith("blob:")&&URL.revokeObjectURL(c.attachment_url),{...d,senderName:"Вы"}):c})),de(m=>m.map(c=>c.group.id===n?{...c,lastMessage:{...d,senderName:"Вы"}}:c))}catch(l){console.error("Error sending group message:",l),A(f=>{var m;const d=f.find(c=>c.id===t);return(m=d==null?void 0:d.attachment_url)!=null&&m.startsWith("blob:")&&URL.revokeObjectURL(d.attachment_url),f.filter(c=>c.id!==t)}),R(s),r&&_(r),L(!1),g({title:"Ошибка",description:"Не удалось отправить сообщение",variant:"destructive"})}finally{W(!1)}};a.useEffect(()=>{if(!x||!(i!=null&&i.id))return;const s=x.group.id,t=x.members,n=zs(s,async r=>{var u;try{if(r.sender_id===i.id)return;const l=t.find(d=>d.user_id===r.sender_id);let f={...r,senderName:(l==null?void 0:l.userName)||"Пользователь",senderAvatar:(l==null?void 0:l.userAvatar)||null};if(f=await se(f),((u=je.current)==null?void 0:u.group.id)!==s)return;A(d=>[...d,f]),S(),await We(s,r.id)}catch(l){console.error("Error processing group message:",l)}});return()=>n()},[x==null?void 0:x.group.id,i==null?void 0:i.id,S]);const Cs=async()=>{if(!(!H.trim()||$.length===0||ue)){Ie(!0);try{await Vs(H.trim(),$),F(!1),X(""),Y([]),await k(),g({title:"Группа создана",description:"Групповой чат успешно создан"})}catch(s){console.error("Error creating group:",s),g({title:"Ошибка",description:"Не удалось создать группу",variant:"destructive"})}finally{Ie(!1)}}},Ss=s=>{Y(t=>t.includes(s)?t.filter(n=>n!==s):[...t,s])},Ee=s=>{var n;const t=(n=s.target.files)==null?void 0:n[0];if(t){if(t.size>10*1024*1024){g({title:"Файл слишком большой",description:"Максимальный размер файла — 10 МБ",variant:"destructive"});return}_(t),E.current&&(E.current.value="")}},Ge=async()=>{if(!w.trim()&&!p||!o||!(i!=null&&i.id)||y)return;const s=w.trim()||(p?`Файл: ${p.name}`:""),t=`temp-${Date.now()}`,n=o.recipientId,r=p,u={id:t,sender_id:i.id,recipient_id:n,content:s,is_read:!1,read_at:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),attachment_name:r==null?void 0:r.name,attachment_type:r==null?void 0:r.type,attachment_size:r==null?void 0:r.size};z(l=>[...l,u]),R(""),_(null),S(),W(!0);try{let l;if(r){L(!0);try{l=await Qe(n,r)}finally{L(!1)}}const f=await Ws(n,s,l),d=await se(f);z(m=>m.map(c=>c.id===t?d:c)),G(m=>m.map(c=>c.recipientId===n?{...c,lastMessage:d}:c))}catch(l){console.error("Error sending message:",l),z(f=>f.filter(d=>d.id!==t)),R(s),r&&_(r),g({title:"Ошибка",description:"Не удалось отправить сообщение. Попробуйте ещё раз.",variant:"destructive"})}finally{W(!1)}},ze=a.useDeferredValue(le),me=a.useMemo(()=>{const s={all:j.length,client:0,specialist:0,admin:0};for(const t of j){const n=t.recipientType;(n==="client"||n==="specialist"||n==="admin")&&s[n]++}return s},[j]),Le=a.useMemo(()=>{const s=ze.toLowerCase();return j.filter(t=>{var n,r;return C!=="all"&&t.recipientType!==C?!1:s?t.recipientName.toLowerCase().includes(s)||((n=t.specialization)==null?void 0:n.toLowerCase().includes(s))||((r=t.adminRole)==null?void 0:r.toLowerCase().includes(s)):!0})},[j,ze,C]),xe=s=>s.recipientType==="specialist"?s.specialization||"Коллега":s.recipientType==="admin"?s.adminRole||"Администратор":"Клиент",Z=s=>{switch(s){case"specialist":return{bgClass:"bg-blue-100 text-blue-600",textClass:"text-blue-600"};case"admin":return{bgClass:"bg-purple-100 text-purple-600",textClass:"text-purple-600"};default:return{bgClass:"bg-green-100 text-green-600",textClass:"text-green-600"}}},Pe=s=>{switch(s){case"specialist":return He;case"admin":return Ue;default:return Fe}};return as?e.jsx("div",{className:"h-[calc(100vh-12rem)]",children:e.jsx(De,{className:"h-full",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"w-80 border-r p-4 space-y-4",children:[e.jsx(te,{className:"h-10 w-full"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsx(te,{className:"h-16 w-full"},s))})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(te,{className:"h-8 w-48"})})]})})}):e.jsxs("div",{className:"h-[calc(100vh-12rem)]",children:[e.jsx(De,{className:"h-full",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"w-80 border-r flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"font-semibold",children:"Сообщения"}),e.jsxs("div",{className:"flex items-center gap-1",children:[I==="groups"&&e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>F(!0),title:"Создать группу",children:e.jsx(Zs,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:ss,title:fe==="granted"?"Уведомления включены":"Включить уведомления",children:fe==="granted"?e.jsx(Ls,{className:"h-4 w-4 text-primary"}):e.jsx(Js,{className:"h-4 w-4 text-muted-foreground"})})]})]}),e.jsx(Xs,{value:I,onValueChange:s=>xs(s),className:"mb-3",children:e.jsxs(Ys,{className:"w-full",children:[e.jsxs(Je,{value:"direct",className:"flex-1",children:[e.jsx(J,{className:"h-4 w-4 mr-1"}),"Личные"]}),e.jsxs(Je,{value:"groups",className:"flex-1",children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),"Группы"]})]})}),I==="direct"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative mb-3",children:[e.jsx(Us,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(U,{placeholder:"Поиск...",value:le,onChange:s=>ns(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-1 flex-wrap",children:[e.jsxs(h,{variant:C==="all"?"default":"outline",size:"sm",onClick:()=>Q("all"),className:"text-xs h-7",children:["Все ",ce>0&&`(${ce})`]}),e.jsxs(h,{variant:C==="client"?"default":"outline",size:"sm",onClick:()=>Q("client"),className:"text-xs h-7",children:[e.jsx(Fe,{className:"w-3 h-3 mr-1"}),me.client]}),e.jsxs(h,{variant:C==="specialist"?"default":"outline",size:"sm",onClick:()=>Q("specialist"),className:"text-xs h-7",children:[e.jsx(He,{className:"w-3 h-3 mr-1"}),me.specialist]}),e.jsxs(h,{variant:C==="admin"?"default":"outline",size:"sm",onClick:()=>Q("admin"),className:"text-xs h-7",children:[e.jsx(Ue,{className:"w-3 h-3 mr-1"}),me.admin]})]})]})]}),I==="direct"&&e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"flex-1",children:Le.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(J,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:le||C!=="all"?"Ничего не найдено":"Нет собеседников"})]}):e.jsx("div",{className:"p-2",children:Le.map(s=>e.jsx("button",{onClick:()=>ys(s),className:`w-full p-3 rounded-lg text-left transition-colors ${(o==null?void 0:o.recipientId)===s.recipientId?"bg-primary/10":"hover:bg-muted"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[s.recipientAvatar?e.jsx("img",{src:s.recipientAvatar,alt:s.recipientName,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:he(s.recipientName)}),(()=>{const t=Z(s.recipientType),n=Pe(s.recipientType);return e.jsx("div",{className:`absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center ${t.bgClass}`,children:e.jsx(n,{className:"w-3 h-3"})})})()]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium truncate",children:s.recipientName}),s.lastMessage&&e.jsx("span",{className:"text-xs text-muted-foreground",children:ee(s.lastMessage.created_at)})]}),e.jsx("p",{className:`text-xs truncate mb-0.5 ${Z(s.recipientType).textClass}`,children:xe(s)}),s.lastMessage&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.lastMessage.sender_id===(i==null?void 0:i.id)?"Вы: ":"",s.lastMessage.content]})]}),s.unreadCount>0&&e.jsx($e,{className:"ml-2",children:s.unreadCount})]})},s.recipientId))})}),P>1&&e.jsxs("div",{className:"p-2 border-t flex items-center justify-between",children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:gs,disabled:N<=1,className:"h-8 px-2",children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[N," / ",P," (",ce,")"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:js,disabled:N>=P,className:"h-8 px-2",children:e.jsx(qe,{className:"h-4 w-4"})})]})]}),I==="groups"&&e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"flex-1",children:oe?e.jsx("div",{className:"p-4 space-y-3",children:[1,2,3].map(s=>e.jsx(te,{className:"h-16 w-full"},s))}):ve.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(O,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Нет групповых чатов"}),e.jsx(h,{variant:"link",size:"sm",onClick:()=>F(!0),className:"mt-2",children:"Создать группу"})]}):e.jsx("div",{className:"p-2",children:ve.map(s=>e.jsx("button",{onClick:()=>ws(s),className:`w-full p-3 rounded-lg text-left transition-colors ${(x==null?void 0:x.group.id)===s.group.id?"bg-primary/10":"hover:bg-muted"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(O,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium truncate",children:s.group.name}),s.lastMessage&&e.jsx("span",{className:"text-xs text-muted-foreground",children:ee(s.lastMessage.created_at)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate mb-0.5",children:[s.members.length," ",Be(s.members.length,"участник","участника","участников")]}),s.lastMessage&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[s.lastMessage.senderName||"Пользователь",": ",s.lastMessage.content]})]}),s.unreadCount>0&&e.jsx($e,{className:"ml-2",children:s.unreadCount})]})},s.group.id))})}),T>1&&e.jsxs("div",{className:"p-2 border-t flex items-center justify-between",children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:bs,disabled:v<=1,className:"h-8 px-2",children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[v," / ",T," (",us,")"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:vs,disabled:v>=T,className:"h-8 px-2",children:e.jsx(qe,{className:"h-4 w-4"})})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[o.recipientAvatar?e.jsx("img",{src:o.recipientAvatar,alt:o.recipientName,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium",children:he(o.recipientName)}),(()=>{const s=Z(o.recipientType),t=Pe(o.recipientType);return e.jsx("div",{className:`absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center ${s.bgClass}`,children:e.jsx(t,{className:"w-3 h-3"})})})()]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:o.recipientName}),e.jsx("p",{className:`text-sm ${Z(o.recipientType).textClass}`,children:xe(o)})]})]}),e.jsx(q,{className:"flex-1 p-4",children:rs?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(B,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):V.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(J,{className:"h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Нет сообщений"}),e.jsx("p",{className:"text-sm mt-1",children:o.recipientType==="specialist"?"Начните беседу с коллегой":o.recipientType==="admin"?"Начните беседу с администратором":"Начните беседу с клиентом"})]}):e.jsxs("div",{className:"space-y-4",children:[V.map(s=>{const t=s.sender_id===(i==null?void 0:i.id);return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${t?"bg-primary text-primary-foreground":"bg-muted"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.attachment_url&&s.attachment_name&&s.attachment_type&&s.attachment_size&&e.jsx(Xe,{url:s.attachment_url,name:s.attachment_name,type:s.attachment_type,size:s.attachment_size,isOwn:t}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:ee(s.created_at)}),t&&(s.is_read?e.jsx(Ps,{className:"h-3 w-3"}):e.jsx(Ts,{className:"h-3 w-3"}))]})]})},s.id)}),e.jsx("div",{ref:ae})]})}),e.jsxs("div",{className:"p-4 border-t space-y-2",children:[p&&e.jsx(Ye,{file:p,onRemove:()=>_(null)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:E,onChange:Ee,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"}),e.jsx(h,{variant:"outline",size:"icon",onClick:()=>{var s;return(s=E.current)==null?void 0:s.click()},disabled:y||b,title:"Прикрепить файл",children:e.jsx(Ze,{className:"h-4 w-4"})}),e.jsx(U,{placeholder:"Введите сообщение...",value:w,onChange:s=>R(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),Ge())},disabled:y||b,className:"flex-1"}),e.jsx(h,{onClick:Ge,disabled:!w.trim()&&!p||y||b,children:y||b?e.jsx(B,{className:"h-4 w-4 animate-spin"}):e.jsx(es,{className:"h-4 w-4"})})]})]})]}):x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(O,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:x.group.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[x.members.length," ",Be(x.members.length,"участник","участника","участников")]})]})]}),e.jsx(q,{className:"flex-1 p-4",children:hs?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(B,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):Ce.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(O,{className:"h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Нет сообщений"}),e.jsx("p",{className:"text-sm mt-1",children:"Начните беседу в группе"})]}):e.jsxs("div",{className:"space-y-4",children:[Ce.map(s=>{const t=s.sender_id===(i==null?void 0:i.id);return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${t?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!t&&e.jsx("p",{className:"text-xs font-medium mb-1 opacity-70",children:s.senderName||"Пользователь"}),s.content&&e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.attachment_url&&s.attachment_name&&s.attachment_type&&s.attachment_size&&e.jsx(Xe,{url:s.attachment_url,name:s.attachment_name,type:s.attachment_type,size:s.attachment_size,isOwn:t}),e.jsx("div",{className:"flex items-center justify-end gap-1 mt-1",children:e.jsx("span",{className:"text-xs opacity-70",children:ee(s.created_at)})})]})},s.id)}),e.jsx("div",{ref:ae})]})}),e.jsxs("div",{className:"p-4 border-t space-y-2",children:[p&&e.jsx(Ye,{file:p,onRemove:()=>_(null)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:E,onChange:Ee,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"}),e.jsx(h,{variant:"outline",size:"icon",onClick:()=>{var s;return(s=E.current)==null?void 0:s.click()},disabled:y||b,title:"Прикрепить файл",children:e.jsx(Ze,{className:"h-4 w-4"})}),e.jsx(U,{placeholder:"Введите сообщение...",value:w,onChange:s=>R(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),Re())},disabled:y||b,className:"flex-1"}),e.jsx(h,{onClick:Re,disabled:!w.trim()&&!p||y||b,children:y||b?e.jsx(B,{className:"h-4 w-4 animate-spin"}):e.jsx(es,{className:"h-4 w-4"})})]})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-muted-foreground",children:[e.jsx(J,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Выберите беседу"}),e.jsx("p",{className:"text-sm mt-1",children:"Выберите собеседника из списка слева"})]})})]})}),e.jsx(As,{open:ps,onOpenChange:s=>{F(s),s||(X(""),Y([]))},children:e.jsxs(Ds,{children:[e.jsx(Fs,{children:e.jsx($s,{children:"Создать групповой чат"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ke,{htmlFor:"groupName",children:"Название группы"}),e.jsx(U,{id:"groupName",placeholder:"Введите название...",value:H,onChange:s=>X(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Ke,{children:["Участники (",$.length," выбрано)"]}),e.jsx(q,{className:"h-48 border rounded-md p-2",children:j.map(s=>e.jsxs("div",{className:"flex items-center gap-2 p-2 hover:bg-muted rounded cursor-pointer",onClick:()=>Ss(s.recipientId),children:[e.jsx(Os,{checked:$.includes(s.recipientId)}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[s.recipientAvatar?e.jsx("img",{src:s.recipientAvatar,alt:s.recipientName,className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-xs font-medium",children:he(s.recipientName)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.recipientName}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:xe(s)})]})]})]},s.recipientId))})]})]}),e.jsxs(qs,{children:[e.jsx(h,{variant:"outline",onClick:()=>{F(!1),X(""),Y([])},children:"Отмена"}),e.jsxs(h,{onClick:Cs,disabled:!H.trim()||$.length===0||ue,children:[ue?e.jsx(B,{className:"h-4 w-4 animate-spin mr-2"}):null,"Создать"]})]})]})})]})}export{ft as default};
