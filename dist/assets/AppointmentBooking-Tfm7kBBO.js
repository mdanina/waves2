import{r as h,j as e}from"./vendor-radix-htwXsPHy.js";import{u as Se,c as De}from"./vendor-react-CI8wve7f.js";import{X as _e,Y as Ce,Z as Te,_ as ke,a0 as Ae,i as Me,Q as Fe,R as Ie,T as Ee,U as Pe,a4 as Le,s as Oe,B as f,H as M,K as te,C as v,a6 as ae,m as ne,ab as Ue,G as He,L as I,a as U,b as H,c as B,d as Y,e as $,E as Be}from"./index-Bu4m9iDU.js";import{C as Ye}from"./calendar-DcQXifvg.js";import{f as $e,u as ze,d as Re,e as Ve,g as Ke}from"./useAppointments-ddne6K8C.js";import{u as Ze}from"./useProfiles-CiC7oZdw.js";import{b as qe}from"./vendor-query-BNGVDYIL.js";import{g as Ge,F as Qe,m as Xe}from"./appointmentStorage-C-Jgm17Y.js";import{f as Je}from"./payment-CN1B_dAK.js";import{g as We,a as es,f as re,T as ss,b as ts,c as ie}from"./moscowTime-Bf471xDt.js";import{r as le}from"./ru-DXu8W4Lf.js";import{G as as}from"./globe-DF8hBNzR.js";import{f as ns}from"./vendor-date-CR4liJ_d.js";import"./vendor-charts-DjioKZbK.js";import"./profileStorage-B9P4N8Co.js";function rs(n,c){return qe({queryKey:["assigned-specialists",n,c],queryFn:()=>n?Ge(n,c):Promise.resolve([]),enabled:!!n,staleTime:5*60*1e3,gcTime:10*60*1e3})}function is(n){switch(n){case"primary":return"Основной специалист";case"consultant":return"Консультант";case"temporary":return"Временная замена";default:return n}}function ls(n){switch(n){case"primary":return"default";case"consultant":return"secondary";case"temporary":return"outline";default:return"outline"}}function os({open:n,onOpenChange:c,specialists:m,onSelect:l,title:E="Выберите специалиста",description:S="У вас несколько назначенных специалистов с данной специализацией. Выберите, к кому хотите записаться."}){const[j,o]=h.useState(null),P=()=>{j&&(l(j),c(!1))},L=t=>{const D=t.split(" ");return D.length>=2?(D[0][0]+D[1][0]).toUpperCase():t.slice(0,2).toUpperCase()};return e.jsx(_e,{open:n,onOpenChange:c,children:e.jsxs(Ce,{className:"sm:max-w-md",children:[e.jsxs(Te,{children:[e.jsx(ke,{children:E}),e.jsx(Ae,{children:S})]}),e.jsx("div",{className:"space-y-3 py-4",children:m.map(t=>e.jsxs("button",{onClick:()=>o(t.specialist_id),className:Me("w-full flex items-center gap-4 p-4 rounded-lg border-2 transition-all text-left",j===t.specialist_id?"border-primary bg-primary/5":"border-border hover:border-primary/50 hover:bg-muted/50"),children:[e.jsxs(Fe,{className:"h-12 w-12",children:[t.avatar_url?e.jsx(Ie,{src:t.avatar_url,alt:t.display_name}):null,e.jsx(Ee,{className:"bg-primary/10 text-primary",children:t.avatar_url?e.jsx(Pe,{className:"h-6 w-6"}):L(t.display_name)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:t.display_name}),j===t.specialist_id&&e.jsx(Le,{className:"h-4 w-4 text-primary flex-shrink-0"})]}),e.jsx("div",{className:"mt-1",children:e.jsx(Oe,{variant:ls(t.assignment_type),children:is(t.assignment_type)})})]})]},t.specialist_id))}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(f,{variant:"outline",onClick:()=>c(!1),children:"Отмена"}),e.jsx(f,{onClick:P,disabled:!j,children:"Выбрать"})]})]})})}const cs=()=>{const n=[];for(let c=9;c<=18;c++)for(let m=0;m<60;m+=30){const l=`${c.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;n.push(l)}return n},z=cs();function _s(){const n=Se(),[c]=De(),m=c.get("type"),{data:l,isLoading:E}=$e(m),{data:S,isLoading:j}=Ze(),{data:o,isLoading:P}=ze(),{data:L}=Re(),{data:t,isLoading:D}=Ve(),O=Ke(),[d,oe]=h.useState(void 0),[y,ce]=h.useState(""),[_,me]=h.useState(""),[b,de]=h.useState(()=>localStorage.getItem("appointment_timezone")||We()),[ue,R]=h.useState(!1),[V,K]=h.useState(null),xe=_==="__parent__"?null:_||null,{data:Z=[]}=rs(m,xe);h.useEffect(()=>{localStorage.setItem("appointment_timezone",b)},[b]);const pe=E||j||P||D,N=l&&l.price>0,F=l&&l.price===0,q=(t==null?void 0:t.expired)??!1,he=N&&!o&&!L&&!q,fe=F&&q,G=h.useMemo(()=>S?[{id:"__parent__",name:"Для меня (родитель)"},...S.filter(s=>s.type==="child").map(s=>({id:s.id,name:`${s.first_name}${s.last_name?` ${s.last_name}`:""}`}))]:[],[S]),ge=h.useMemo(()=>s=>{const a=es();a.setHours(0,0,0,0);const r=new Date(s);r.setHours(0,0,0,0);const i=new Date(r.getFullYear(),r.getMonth(),r.getDate()),u=new Date(a.getFullYear(),a.getMonth(),a.getDate());if(i<u)return!0;if(F&&(t!=null&&t.expiryDate)){const x=new Date(t.expiryDate);if(x.setHours(23,59,59,999),i>x)return!0}if(N&&o){const x=new Date(o.scheduled_at),w=new Date(x.getFullYear(),x.getMonth(),x.getDate());if(i<w)return!0}return!1},[N,F,o,t]),Q=h.useMemo(()=>{var A,g,W,ee,se;if(!N||!o||!d)return z;const s=new Date(o.scheduled_at),a=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Moscow",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(s),r=parseInt(((A=a.find(p=>p.type==="year"))==null?void 0:A.value)||"0"),i=parseInt(((g=a.find(p=>p.type==="month"))==null?void 0:g.value)||"0")-1,u=parseInt(((W=a.find(p=>p.type==="day"))==null?void 0:W.value)||"0"),x=parseInt(((ee=a.find(p=>p.type==="hour"))==null?void 0:ee.value)||"0"),w=parseInt(((se=a.find(p=>p.type==="minute"))==null?void 0:se.value)||"0"),T=new Date(d);T.setHours(0,0,0,0);const k=new Date(r,i,u);if(k.setHours(0,0,0,0),T.getTime()===k.getTime()){const p=x*60+w;return z.filter(ve=>{const[be,we]=ve.split(":").map(Number);return be*60+we>p})}return z},[N,o,d]),X=async(s,a,r)=>{const i=await O.mutateAsync({appointmentTypeId:m,scheduledAt:s,profileId:a,specialistId:r});if(!i||!i.id)throw new Error("Не удалось создать запись на консультацию");try{await Xe()}catch(u){console.error("Error marking free consultation as used:",u)}await new Promise(u=>setTimeout(u,200)),n(`/appointments/confirmation?appointment_id=${i.id}`,{replace:!0})},J=(s,a,r)=>{const i=new URLSearchParams({appointment_type_id:m,scheduled_at:s,type:"appointment"});a&&i.set("profile_id",a),r&&i.set("specialist_id",r),n(`/payment?${i.toString()}`)},je=async s=>{if(!V)return;const{scheduledAt:a,profileId:r}=V;K(null);try{l&&l.price===0?await X(a,r,s):J(a,r,s)}catch(i){console.error("Error creating appointment:",i)}},ye=async()=>{if(!m||!d||!y)return;const[s,a]=y.split(":").map(Number),r=ie(d,s,a),i=_==="__parent__"?null:_||null;try{if(Z.length>1){K({scheduledAt:r,profileId:i}),R(!0);return}l&&l.price===0?await X(r,i):J(r,i)}catch(u){console.error("Error creating appointment:",u)}},Ne=d&&y&&m,C={background:"var(--bg-golden-hour)",backgroundAttachment:"fixed"};return pe?e.jsxs("div",{className:"min-h-screen bg-background",style:C,children:[e.jsx(M,{}),e.jsx("div",{className:"container mx-auto px-4 py-20 flex items-center justify-center",children:e.jsx(te,{className:"h-8 w-8 animate-spin text-primary"})})]}):l?he?e.jsxs("div",{className:"min-h-screen bg-background",style:C,children:[e.jsx(M,{}),e.jsxs("div",{className:"container mx-auto max-w-4xl px-4 py-8",children:[e.jsxs(f,{variant:"ghost",onClick:()=>n("/appointments"),className:"mb-6",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Назад"]}),e.jsxs(v,{className:"p-8 text-center",children:[e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx(ne,{className:"h-12 w-12 text-destructive"})}),e.jsx("h2",{className:"text-2xl font-bold text-foreground mb-4",children:"Сначала запишитесь на бесплатную консультацию"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Платные консультации доступны только после записи на бесплатную консультацию."}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Или напишите нам, расскажите о своём запросе, и мы подберём подходящего специалиста."}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx(f,{variant:"outline",onClick:()=>n("/appointments"),children:"Назад"}),e.jsxs(f,{onClick:()=>n("/cabinet/messages"),children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Написать в поддержку"]})]})]})]})]}):fe?e.jsxs("div",{className:"min-h-screen bg-background",style:C,children:[e.jsx(M,{}),e.jsxs("div",{className:"container mx-auto max-w-4xl px-4 py-8",children:[e.jsxs(f,{variant:"ghost",onClick:()=>n("/appointments"),className:"mb-6",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Назад"]}),e.jsxs(v,{className:"p-8 text-center",children:[e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx(ne,{className:"h-12 w-12 text-destructive"})}),e.jsx("h2",{className:"text-2xl font-bold text-foreground mb-4",children:"Срок бесплатной консультации истёк"}),e.jsxs("p",{className:"text-muted-foreground mb-6",children:["Бесплатная 30-минутная консультация с координатором была доступна в течение ",Qe," дней после завершения чекапа. Для записи к специалисту, пожалуйста, свяжитесь с нашей поддержкой."]}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx(f,{variant:"outline",onClick:()=>n("/appointments"),children:"Назад"}),e.jsx(f,{onClick:()=>n("/cabinet/messages"),children:"Написать в поддержку"})]})]})]})]}):e.jsxs("div",{className:"min-h-screen bg-background",style:C,children:[e.jsx(M,{}),e.jsxs("div",{className:"container mx-auto max-w-4xl px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-foreground mb-2",children:"Выберите дату и время"}),e.jsxs("p",{className:"text-muted-foreground",children:[l.name," • ",l.duration_minutes," минут • ",Je(l.price)]})]}),e.jsxs("div",{className:"mb-8 flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-muted text-muted-foreground text-sm font-medium",children:"1"}),e.jsx("span",{children:"Выберите тип консультации"})]}),e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-medium",children:"2"}),e.jsx("span",{className:"font-medium",children:"Выберите дату и время"})]})]}),e.jsxs("div",{className:"grid gap-8 md:grid-cols-2",children:[e.jsxs(v,{className:"p-6",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx(He,{className:"h-5 w-5 text-primary"}),e.jsx(I,{className:"text-lg font-semibold",children:"Выберите дату"})]}),e.jsx(Ye,{mode:"single",selected:d,onSelect:oe,disabled:ge,locale:le,className:"rounded-md border"}),N&&o&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-4",children:["Минимальная доступная дата: ",re(o.scheduled_at,b).split(" в ")[0]]}),F&&(t==null?void 0:t.expiryDate)&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-4",children:["Бесплатная консультация доступна до: ",ns(t.expiryDate,"d MMMM yyyy",{locale:le})]}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsxs(I,{className:"text-sm flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4"}),"Временная зона для отображения"]}),e.jsxs(U,{value:b,onValueChange:de,children:[e.jsx(H,{children:e.jsx(B,{})}),e.jsx(Y,{children:ss.map(s=>e.jsx($,{value:s.value,children:s.label},s.value))})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Время записи сохраняется в московском времени (MSK, UTC+3)"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(v,{className:"p-6",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx(Be,{className:"h-5 w-5 text-primary"}),e.jsx(I,{className:"text-lg font-semibold",children:"Выберите время"})]}),e.jsxs(U,{value:y,onValueChange:ce,children:[e.jsx(H,{children:e.jsx(B,{placeholder:"Выберите время"})}),e.jsx(Y,{children:Q.length>0?Q.map(s=>e.jsx($,{value:s,children:s},s)):e.jsx("div",{className:"px-2 py-1.5 text-sm text-muted-foreground",children:"Нет доступного времени для выбранной даты"})})]}),N&&o&&d&&(()=>{var T,k,A;const s=new Date(o.scheduled_at),a=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Moscow",year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(s),r=parseInt(((T=a.find(g=>g.type==="year"))==null?void 0:T.value)||"0"),i=parseInt(((k=a.find(g=>g.type==="month"))==null?void 0:k.value)||"0")-1,u=parseInt(((A=a.find(g=>g.type==="day"))==null?void 0:A.value)||"0"),x=new Date(d);x.setHours(0,0,0,0);const w=new Date(r,i,u);return w.setHours(0,0,0,0),x.getTime()===w.getTime()?e.jsxs("p",{className:"text-sm text-muted-foreground mt-2",children:["Минимальное доступное время: ",ts(o.scheduled_at,b)]}):null})()]}),G.length>1&&e.jsxs(v,{className:"p-6",children:[e.jsx(I,{className:"text-lg font-semibold mb-4 block",children:"Для кого консультация?"}),e.jsxs(U,{value:_,onValueChange:me,children:[e.jsx(H,{children:e.jsx(B,{placeholder:"Выберите профиль"})}),e.jsx(Y,{children:G.map(s=>e.jsx($,{value:s.id,children:s.name},s.id))})]})]}),d&&y&&e.jsxs(v,{className:"p-6 bg-muted/50",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Выбранное время:"}),e.jsx("p",{className:"text-muted-foreground",children:(()=>{const[s,a]=y.split(":").map(Number),r=ie(d,s,a);return re(r,b)})()}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Время будет сохранено как ",y," (MSK, UTC+3)"]})]})]})]}),e.jsxs("div",{className:"mt-8 flex flex-col items-center gap-3",children:[e.jsx(f,{size:"lg",onClick:ye,disabled:!Ne||O.isPending,className:"min-w-[200px]",children:O.isPending?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4 mr-2 animate-spin"}),"Запись..."]}):"Подтвердить запись"}),e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>n("/appointments"),className:"text-muted-foreground hover:text-foreground hover:bg-muted/50 font-light",children:"Назад"})]})]}),e.jsx(os,{open:ue,onOpenChange:R,specialists:Z,onSelect:je,title:"Выберите специалиста",description:"У вас несколько назначенных специалистов. Выберите, к кому хотите записаться на эту консультацию."})]}):e.jsxs("div",{className:"min-h-screen bg-background",style:C,children:[e.jsx(M,{}),e.jsx("div",{className:"container mx-auto max-w-4xl px-4 py-8",children:e.jsxs(v,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Тип консультации не найден"}),e.jsx(f,{onClick:()=>n("/appointments"),children:"Вернуться к выбору типа"})]})})]})}export{_s as default};
