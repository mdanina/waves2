const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/profileStorage-CNyPVPjQ.js","assets/index-Dv2C02zj.js","assets/vendor-radix-htwXsPHy.js","assets/vendor-charts-DjioKZbK.js","assets/vendor-query-BNGVDYIL.js","assets/vendor-react-CI8wve7f.js","assets/index-DjiP0NCn.css"])))=>i.map(i=>d[i]);
import{v as a,m as n,ac as E}from"./index-Dv2C02zj.js";import{getCurrentUser as p}from"./profileStorage-CNyPVPjQ.js";async function S(){try{const{data:t,error:e}=await a.from("appointment_types").select("*").eq("is_active",!0).eq("admin_only",!1).order("duration_minutes",{ascending:!0});if(e)throw e;return t||[]}catch(t){throw n.error("Error getting appointment types:",t),t}}async function A(t){try{const{data:e,error:r}=await a.from("appointment_types").select("*").eq("id",t).single();if(r){if(r.code==="PGRST116")return null;throw r}return e}catch(e){return n.error("Error getting appointment type:",e),null}}async function D(t,e){try{const r=await p();if(!r)return[];const{data:i,error:o}=await a.rpc("get_all_assigned_specialists_for_appointment",{p_user_id:r.id,p_profile_id:e||null,p_appointment_type_id:t});return o?(n.error("Error getting assigned specialists:",o),[]):i||[]}catch(r){return n.error("Error getting assigned specialists:",r),[]}}async function T(t,e){try{const r=await D(t,e);return r.length===0?null:r.length===1?r[0].specialist_id:(n.info(`Multiple specialists found (${r.length}), user selection required`),null)}catch(r){return n.error("Error getting assigned specialist:",r),null}}async function k(t){try{const{data:e,error:r}=await a.from("appointments").select("*").eq("id",t).single();if(r){if(r.code==="PGRST116")return null;throw r}return e}catch(e){return n.error("Error getting appointment:",e),null}}async function W(t,e,r,i,o,s){try{const l=await p();if(!l)throw new Error("User not authenticated");const{data:c,error:f}=await a.from("appointment_types").select("price").eq("id",t).single();f&&n.warn("Could not get appointment type price, assuming paid:",f);const h=(c==null?void 0:c.price)===0;let u=s;u||(u=await T(t,r),u&&n.info(`Auto-assigned specialist ${u} for appointment type ${t}`));const _=!!u;let d,m=null;_?d="scheduled":h?(d="scheduled",n.info("Free consultation created without specialist - coordinator will assign manually")):(d="pending_specialist",m=new Date(Date.now()+24*60*60*1e3).toISOString());const y={user_id:l.id,appointment_type_id:t,scheduled_at:e,profile_id:r||null,status:d,notes:i||null,payment_id:o||null,specialist_id:u||null,specialist_assignment_expires_at:m},{data:w,error:g}=await a.from("appointments").insert(y).select().single();if(g)throw g;return w}catch(l){throw n.error("Error creating appointment:",l),l}}async function q(t,e){try{const{data:r,error:i}=await a.from("appointments").update(e).eq("id",t).select().single();if(i)throw i;return r}catch(r){throw n.error("Error updating appointment:",r),r}}async function P(t){try{const e=await k(t);if(!e)throw new Error("Appointment not found");const r=await A(e.appointment_type_id),i=await q(t,{status:"cancelled"});if(r&&r.price===0){const o=await p();if(o){const{error:s}=await a.from("users").update({free_consultation_created:!1}).eq("id",o.id);s?n.error("Error resetting free_consultation_created flag:",s):n.info("Free consultation flag reset after cancellation")}}return i}catch(e){throw n.error("Error cancelling appointment:",e),e}}async function b(t){try{let e;if(t?e={id:t}:e=await p(),!e)throw n.warn("getAppointmentsWithType: User not authenticated"),new Error("User not authenticated");n.log("getAppointmentsWithType: Fetching appointments for user:",e.id);const{data:r,error:i}=await a.from("appointments").select(`
        *,
        appointment_type:appointment_types(*),
        specialist:specialists(
          id,
          display_name,
          avatar_url,
          bio,
          experience_years,
          specialization_codes,
          video_intro_url,
          is_available
        )
      `).eq("user_id",e.id).order("scheduled_at",{ascending:!1});if(i)throw n.error("getAppointmentsWithType: Supabase error:",i),n.error("getAppointmentsWithType: Error details:",{message:i.message,code:i.code,details:i.details,hint:i.hint}),i;return n.log("getAppointmentsWithType: Query completed. Data:",r),n.log("getAppointmentsWithType: Successfully loaded",(r==null?void 0:r.length)||0,"appointments"),r&&r.length>0?n.log("getAppointmentsWithType: Appointment IDs:",r.map(o=>o.id)):n.warn("getAppointmentsWithType: No appointments found for user:",e.id),(r||[]).map(o=>({...o,appointment_type:o.appointment_type}))}catch(e){throw n.error("Error getting appointments with type:",e),e}}async function U(){try{const t=await p();if(!t)return null;const{data:e,error:r}=await a.from("appointments").select(`
        *,
        appointment_type:appointment_types(*)
      `).eq("user_id",t.id).in("status",["pending_specialist","scheduled","in_progress"]).order("scheduled_at",{ascending:!0});if(r)throw r;if(!e||e.length===0)return null;for(const i of e){const o=i.appointment_type;if(o&&o.price===0)return{...i,appointment_type:o}}return null}catch(t){return n.error("Error getting active free consultation:",t),null}}async function L(){try{const t=await p();if(!t)return!1;const{data:e,error:r}=await a.from("users").select("free_consultation_created").eq("id",t.id).single();return r?(n.error("Error checking free consultation:",r),!1):!(e!=null&&e.free_consultation_created)}catch(t){return n.error("Error checking free consultation availability:",t),!1}}async function R(){try{const t=await p();if(!t)return!1;const{data:e,error:r}=await a.from("appointments").select(`
        id,
        status,
        appointment_type:appointment_types(price)
      `).eq("user_id",t.id).eq("status","completed");if(r)return n.error("Error checking completed free consultation:",r),!1;if(!e||e.length===0)return!1;for(const i of e){const o=i.appointment_type;if(o&&o.price===0)return!0}return!1}catch(t){return n.error("Error checking completed free consultation:",t),!1}}const C=14;async function F(){try{if(!await p())return null;const{getProfiles:e}=await E(async()=>{const{getProfiles:c}=await import("./profileStorage-CNyPVPjQ.js");return{getProfiles:c}},__vite__mapDeps([0,1,2,3,4,5,6])),i=(await e()).filter(c=>c.type==="child");if(i.length===0)return null;const o=i.map(c=>c.id),{data:s,error:l}=await a.from("assessments").select("completed_at").in("profile_id",o).eq("assessment_type","checkup").eq("status","completed").not("completed_at","is",null).order("completed_at",{ascending:!0}).limit(1);return l?(n.error("Error getting first completed checkup date:",l),null):!s||s.length===0||!s[0].completed_at?null:new Date(s[0].completed_at)}catch(t){return n.error("Error getting first completed checkup date:",t),null}}async function O(){try{const t=await F();if(!t)return{expired:!1,expiryDate:null,daysLeft:null};const e=new Date(t);e.setDate(e.getDate()+C);const r=new Date,i=r>e,o=e.getTime()-r.getTime(),s=i?0:Math.ceil(o/(1e3*60*60*24));return{expired:i,expiryDate:e,daysLeft:s}}catch(t){return n.error("Error checking free consultation expiry:",t),{expired:!1,expiryDate:null,daysLeft:null}}}async function N(){try{const t=await p();if(!t)throw new Error("User not authenticated");const{error:e}=await a.from("users").update({free_consultation_created:!0}).eq("id",t.id);if(e)throw n.error("Error marking free consultation as used:",e),e;n.info("Free consultation marked as used")}catch(t){throw n.error("Error marking free consultation as used:",t),t}}export{C as F,P as a,S as b,W as c,A as d,b as e,k as f,D as g,L as h,U as i,R as j,O as k,N as m};
