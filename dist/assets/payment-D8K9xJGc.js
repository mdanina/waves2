import{R as s,v as a,ah as d}from"./index-Dt6uKTGi.js";async function l(r){try{const t=await d();if(!t)throw new Error("User not authenticated");const e={user_id:t.id,amount:r.amount,currency:r.currency||"RUB",payment_method:r.paymentMethod,status:"pending",metadata:r.metadata||null},{data:n,error:o}=await s.from("payments").insert(e).select().single();if(o)throw o;let i;return r.paymentMethod==="yookassa"?i=await m(n,r):r.paymentMethod==="stripe"&&(i=await f(n,r)),{payment:n,paymentUrl:i}}catch(t){throw a.error("Error creating payment:",t),t}}async function p(r,t,e){try{const n={status:t,...e&&{external_payment_id:e}},{data:o,error:i}=await s.from("payments").update(n).eq("id",r).select().single();if(i)throw i;return o}catch(n){throw a.error("Error updating payment status:",n),n}}async function w(r){try{const{data:t,error:e}=await s.from("payments").select("*").eq("id",r).single();if(e){if(e.code==="PGRST116")return null;throw e}return t}catch(t){return a.error("Error getting payment:",t),null}}function y(r){let t=r.replace(/\/$/,"");if(!t.startsWith("http://")&&!t.startsWith("https://")){const e=typeof window<"u"?window.location.origin:"",n=t.startsWith("/")?t:`/${t}`;t=`${e}${n}`}return t.endsWith("/api")?t:`${t}/api`}async function m(r,t){try{const n=y("http://localhost:3001"),{data:{session:o}}=await s.auth.getSession();if(!o)throw a.error("User not authenticated"),new Error("User not authenticated");a.info(`Creating YooKassa payment via API: ${r.id}`);const i=await fetch(`${n}/payments/create`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`},body:JSON.stringify({amount:t.amount,currency:t.currency||"RUB",metadata:t.metadata})});if(!i.ok){const u=await i.json().catch(()=>({error:"Unknown error"}));throw a.error("Error creating payment via API:",u),new Error(u.error||"Failed to create payment")}const c=await i.json();return a.info("Payment created successfully, confirmation_token received"),c.confirmation_token}catch(e){throw a.error("Error creating YooKassa payment:",e),e}}async function f(r,t){try{a.warn("Stripe credentials not configured. Payment URL will not be generated.");return}catch(e){a.error("Error creating Stripe payment:",e);return}}async function g(r){try{const e=y("http://localhost:3001"),{data:{session:n}}=await s.auth.getSession();if(!n)throw a.error("User not authenticated"),new Error("User not authenticated");a.info(`Verifying payment via API: ${r}`);const o=await fetch(`${e}/payments/verify`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.access_token}`},body:JSON.stringify({payment_id:r})});if(!o.ok){const c=await o.json().catch(()=>({error:"Unknown error"}));throw a.error("Error verifying payment via API:",c),new Error(c.error||"Failed to verify payment")}const i=await o.json();return await p(r,i.status),a.info(`Payment verified, status: ${i.status}`),i.status}catch(t){throw a.error("Error verifying payment:",t),t}}function U(r,t="RUB"){return new Intl.NumberFormat("ru-RU",{style:"currency",currency:t,minimumFractionDigits:0,maximumFractionDigits:2}).format(r)}export{l as c,U as f,w as g,g as v};
