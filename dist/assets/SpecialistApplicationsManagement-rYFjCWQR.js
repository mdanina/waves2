import{r,j as e}from"./vendor-radix-CDHcN1cP.js";import{c as ue}from"./vendor-react-D0zZO7ze.js";import{R as b,f as D,Z as U,B as u,a6 as ge,C as c,i as d,$ as Q,a0 as W,x as pe,a as X,b as Z,c as $,d as G,e as l,ak as fe,a5 as Y,s as Ne,D as f,V as ve,L as t,a8 as we,aP as be,ad as k}from"./index-Dt6uKTGi.js";import{T as _e,a as ye,b as L,c as h,d as Ce,e as o}from"./table-B5n0484N.js";import{D as Se,a as De,b as ke,c as Le,d as Te,e as ze}from"./dialog-Bj2cYqgx.js";import{S as Ae}from"./search--cxoAvO3.js";import{E as ee}from"./eye-MTBUaJjA.js";import{C as Ee}from"./chevron-left-DS2GCxVv.js";import{C as Me}from"./circle-x-DOQ05Pc2.js";import{f as J}from"./vendor-date-CR4liJ_d.js";import{r as K}from"./ru-DXu8W4Lf.js";import"./vendor-charts-DMFz3Lzq.js";import"./vendor-query-DyYoeD25.js";const T={new:{label:"Новая",color:"bg-blue-100 text-blue-800",icon:e.jsx(k,{className:"h-3 w-3"})},reviewing:{label:"На рассмотрении",color:"bg-yellow-100 text-yellow-800",icon:e.jsx(ee,{className:"h-3 w-3"})},approved:{label:"Одобрена",color:"bg-green-100 text-green-800",icon:e.jsx(Y,{className:"h-3 w-3"})},rejected:{label:"Отклонена",color:"bg-red-100 text-red-800",icon:e.jsx(Me,{className:"h-3 w-3"})},waiting_interview:{label:"Ожидает собеседование",color:"bg-purple-100 text-purple-800",icon:e.jsx(k,{className:"h-3 w-3"})},waiting_demo:{label:"Ожидает демо-сессию",color:"bg-indigo-100 text-indigo-800",icon:e.jsx(k,{className:"h-3 w-3"})}};function Ze(){const[z,A]=ue(),x=parseInt(z.get("page")||"1",10),_=20,j=z.get("status")||"all",[se,ae]=r.useState([]),[m,te]=r.useState(null),[le,re]=r.useState([]),[E,ie]=r.useState(0),[ne,M]=r.useState(!0),[N,ce]=r.useState(""),[a,de]=r.useState(null),[oe,v]=r.useState(!1),[q,I]=r.useState(""),[V,F]=r.useState(""),[H,P]=r.useState(!1),y=Math.ceil(E/_);r.useEffect(()=>{C()},[x,j]);const C=async()=>{M(!0);try{const{data:s}=await b.rpc("get_specialist_applications_stats");s&&s[0]&&te(s[0]);const{data:i}=await b.from("specializations").select("code, name").eq("is_active",!0);re(i||[]);let n=b.from("specialist_applications").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range((x-1)*_,x*_-1);j!=="all"&&(n=n.eq("status",j));const{data:g,error:p,count:w}=await n;if(p)throw p;ae(g||[]),ie(w||0)}catch(s){console.error("Error loading data:",s),D.error("Не удалось загрузить данные")}finally{M(!1)}},R=s=>{A({page:s.toString(),...j!=="all"?{status:j}:{}})},xe=s=>{A({page:"1",...s!=="all"?{status:s}:{}})},me=s=>{de(s),I(s.admin_notes||""),F(s.status),v(!0)},he=async()=>{if(a){P(!0);try{const{error:s}=await b.from("specialist_applications").update({status:V,admin_notes:q,reviewed_at:new Date().toISOString()}).eq("id",a.id);if(s)throw s;D.success("Заявка обновлена"),v(!1),C()}catch(s){console.error("Error updating application:",s),D.error("Не удалось обновить заявку")}finally{P(!1)}}},B=s=>{const i=le.find(n=>n.code===s);return(i==null?void 0:i.name)||s},je=s=>s.map(i=>{var n;return((n=be.find(g=>g.value===i))==null?void 0:n.label)||i}).join(", "),S=se.filter(s=>s.full_name.toLowerCase().includes(N.toLowerCase())||s.email.toLowerCase().includes(N.toLowerCase())||s.phone.includes(N));return ne?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(U,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Заявки специалистов"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Управление заявками от внешних специалистов"})]}),e.jsxs(u,{onClick:C,variant:"outline",size:"sm",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Обновить"]})]}),m&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4",children:[e.jsx(c,{children:e.jsxs(d,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold",children:m.total_count}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Всего"})]})}),e.jsx(c,{className:"border-blue-200 bg-blue-50",children:e.jsxs(d,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-700",children:m.new_count}),e.jsx("p",{className:"text-xs text-blue-600",children:"Новые"})]})}),e.jsx(c,{className:"border-yellow-200 bg-yellow-50",children:e.jsxs(d,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-700",children:m.reviewing_count}),e.jsx("p",{className:"text-xs text-yellow-600",children:"На рассмотрении"})]})}),e.jsx(c,{className:"border-purple-200 bg-purple-50",children:e.jsxs(d,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-700",children:m.waiting_interview_count}),e.jsx("p",{className:"text-xs text-purple-600",children:"Ожидают собеседование"})]})}),e.jsx(c,{className:"border-indigo-200 bg-indigo-50",children:e.jsxs(d,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-indigo-700",children:m.waiting_demo_count}),e.jsx("p",{className:"text-xs text-indigo-600",children:"Ожидают демо"})]})}),e.jsx(c,{className:"border-green-200 bg-green-50",children:e.jsxs(d,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-green-700",children:m.approved_count}),e.jsx("p",{className:"text-xs text-green-600",children:"Одобрены"})]})}),e.jsx(c,{className:"border-red-200 bg-red-50",children:e.jsxs(d,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-red-700",children:m.rejected_count}),e.jsx("p",{className:"text-xs text-red-600",children:"Отклонены"})]})})]}),e.jsxs(c,{children:[e.jsx(Q,{children:e.jsx(W,{children:"Фильтры"})}),e.jsx(d,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ae,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(pe,{placeholder:"Поиск по ФИО, email или телефону...",value:N,onChange:s=>ce(s.target.value),className:"pl-10"})]}),e.jsxs(X,{value:j,onValueChange:xe,children:[e.jsx(Z,{className:"w-full sm:w-[200px]",children:e.jsx($,{placeholder:"Статус"})}),e.jsxs(G,{children:[e.jsx(l,{value:"all",children:"Все статусы"}),e.jsx(l,{value:"new",children:"Новые"}),e.jsx(l,{value:"reviewing",children:"На рассмотрении"}),e.jsx(l,{value:"waiting_interview",children:"Ожидают собеседование"}),e.jsx(l,{value:"waiting_demo",children:"Ожидают демо"}),e.jsx(l,{value:"approved",children:"Одобренные"}),e.jsx(l,{value:"rejected",children:"Отклонённые"})]})]})]})})]}),e.jsxs(c,{children:[e.jsxs(Q,{children:[e.jsx(W,{children:"Список заявок"}),e.jsxs(fe,{children:["Показано ",S.length," из ",E," заявок"]})]}),e.jsx(d,{children:e.jsxs(_e,{children:[e.jsx(ye,{children:e.jsxs(L,{children:[e.jsx(h,{children:"ФИО"}),e.jsx(h,{children:"Контакты"}),e.jsx(h,{children:"Специализация"}),e.jsx(h,{children:"Образование"}),e.jsx(h,{children:"Опыт"}),e.jsx(h,{children:"Статус"}),e.jsx(h,{children:"Дата"}),e.jsx(h,{children:"Действия"})]})}),e.jsxs(Ce,{children:[S.map(s=>{var p,w,O;const i=s.base_education_hours>=1100,n=s.certification_hours>=700,g=i&&n;return e.jsxs(L,{children:[e.jsx(o,{className:"font-medium",children:s.full_name}),e.jsxs(o,{children:[e.jsx("div",{className:"text-sm",children:s.email}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.phone})]}),e.jsxs(o,{children:[e.jsx("div",{className:"text-sm",children:B(s.specialization_code)}),e.jsx("div",{className:"text-xs text-muted-foreground truncate max-w-[150px]",children:s.primary_method})]}),e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[g?e.jsx(Y,{className:"h-4 w-4 text-green-500"}):e.jsx(Ne,{className:"h-4 w-4 text-amber-500"}),e.jsxs("span",{className:"text-sm",children:[s.base_education_hours,"ч / ",s.certification_hours,"ч"]})]})}),e.jsxs(o,{children:[s.experience_years," лет"]}),e.jsx(o,{children:e.jsx(f,{className:(p=T[s.status])==null?void 0:p.color,children:e.jsxs("span",{className:"flex items-center gap-1",children:[(w=T[s.status])==null?void 0:w.icon,(O=T[s.status])==null?void 0:O.label]})})}),e.jsx(o,{className:"text-sm text-muted-foreground",children:J(new Date(s.created_at),"dd.MM.yyyy",{locale:K})}),e.jsx(o,{children:e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>me(s),children:e.jsx(ee,{className:"h-4 w-4"})})})]},s.id)}),S.length===0&&e.jsx(L,{children:e.jsx(o,{colSpan:8,className:"text-center py-8 text-muted-foreground",children:"Заявки не найдены"})})]})]})})]}),y>1&&e.jsx(c,{children:e.jsxs(d,{className:"flex items-center justify-between py-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Страница ",x," из ",y]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:()=>R(x-1),disabled:x===1,children:e.jsx(Ee,{className:"h-4 w-4"})}),e.jsx(u,{variant:"outline",size:"sm",onClick:()=>R(x+1),disabled:x===y,children:e.jsx(ve,{className:"h-4 w-4"})})]})]})}),e.jsx(Se,{open:oe,onOpenChange:v,children:e.jsxs(De,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ke,{children:[e.jsx(Le,{children:"Заявка специалиста"}),e.jsxs(Te,{children:["Подана ",a&&J(new Date(a.created_at),"d MMMM yyyy, HH:mm",{locale:K})]})]}),a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"ФИО"}),e.jsx("p",{className:"font-medium",children:a.full_name})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Специализация"}),e.jsx("p",{className:"font-medium",children:B(a.specialization_code)})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Email"}),e.jsx("p",{children:a.email})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Телефон"}),e.jsx("p",{children:a.phone})]})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Основной метод работы"}),e.jsx("p",{children:a.primary_method})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Базовое образование"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold",children:a.base_education_hours}),e.jsx("span",{className:"text-muted-foreground",children:"часов"}),a.base_education_hours>=1100?e.jsx(f,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:"Соответствует"}):e.jsx(f,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:"Мало (мин. 1100)"})]})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Сертификации в методе"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold",children:a.certification_hours}),e.jsx("span",{className:"text-muted-foreground",children:"часов"}),a.certification_hours>=700?e.jsx(f,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:"Соответствует"}):e.jsx(f,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:"Мало (мин. 700)"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Стаж работы"}),e.jsxs("p",{className:"font-medium",children:[a.experience_years," лет"]})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Всего клиентов"}),e.jsx("p",{className:"font-medium",children:a.total_clients_count||"—"})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Сейчас в работе"}),e.jsx("p",{className:"font-medium",children:a.current_clients_count||"—"})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Готовы взять ещё"}),e.jsx("p",{className:"font-medium",children:a.available_capacity||"—"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Частота терапии"}),e.jsx("p",{children:a.therapy_frequency||"—"})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Часов терапии"}),e.jsx("p",{children:a.therapy_hours||"—"})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Частота супервизии"}),e.jsx("p",{children:a.supervision_frequency||"—"})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Часов супервизии"}),e.jsx("p",{children:a.supervision_hours||"—"})]})]}),a.work_formats&&a.work_formats.length>0&&e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Форматы работы"}),e.jsx("p",{children:je(a.work_formats)})]}),e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Опыт работы с психиатром"}),e.jsx("p",{children:a.psychiatrist_experience?"Да":"Нет"})]}),a.social_links&&e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Ссылки на соцсети"}),e.jsx("p",{className:"whitespace-pre-wrap",children:a.social_links})]}),a.additional_info&&e.jsxs("div",{children:[e.jsx(t,{className:"text-muted-foreground",children:"Дополнительная информация"}),e.jsx("p",{className:"whitespace-pre-wrap",children:a.additional_info})]}),e.jsxs("div",{className:"border-t pt-4 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Статус заявки"}),e.jsxs(X,{value:V,onValueChange:F,children:[e.jsx(Z,{children:e.jsx($,{})}),e.jsxs(G,{children:[e.jsx(l,{value:"new",children:"Новая"}),e.jsx(l,{value:"reviewing",children:"На рассмотрении"}),e.jsx(l,{value:"waiting_interview",children:"Ожидает собеседование"}),e.jsx(l,{value:"waiting_demo",children:"Ожидает демо-сессию"}),e.jsx(l,{value:"approved",children:"Одобрена"}),e.jsx(l,{value:"rejected",children:"Отклонена"})]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Заметки администратора"}),e.jsx(we,{value:q,onChange:s=>I(s.target.value),placeholder:"Добавьте заметки по заявке...",rows:3})]})]})]}),e.jsxs(ze,{children:[e.jsx(u,{variant:"outline",onClick:()=>v(!1),children:"Закрыть"}),e.jsx(u,{onClick:he,disabled:H,children:H?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),"Сохранение..."]}):"Сохранить изменения"})]})]})})]})}export{Ze as default};
