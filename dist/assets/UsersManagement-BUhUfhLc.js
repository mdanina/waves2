import{r as l,j as e,S as Y}from"./vendor-radix-CDHcN1cP.js";import{c as ee}from"./vendor-react-D0zZO7ze.js";import{f as z,R as q,am as se,an as re,j as D,L as ne,ao as ae,ap as te,aq as oe,ar as ie,as as $,at as X,au as le,Z as ce,C as E,$ as H,a0 as V,ak as de,i as R,x as I,B as f,a as me,b as xe,c as he,d as ue,e as _,V as je,av as pe}from"./index-Dt6uKTGi.js";import{a as ge,u as fe,c as Ce}from"./vendor-query-DyYoeD25.js";import{T as ye,a as ve,b as A,c as u,d as be,e as j}from"./table-B5n0484N.js";import{D as we,f as Fe,a as Ne,b as Se,c as Ie,d as _e,e as De}from"./dialog-Bj2cYqgx.js";import{S as ke}from"./search--cxoAvO3.js";import{S as Te}from"./square-pen-DClxkTk9.js";import{C as Le}from"./chevron-left-DS2GCxVv.js";import{f as Me}from"./vendor-date-CR4liJ_d.js";import"./vendor-charts-DMFz3Lzq.js";function Pe(n={}){const t=n.page||1,r=n.limit||20,a=(t-1)*r,o=a+r-1;return ge({queryKey:["admin-users",t,r],queryFn:async()=>{const{count:c,error:h}=await q.from("users").select("*",{count:"exact",head:!0});if(h)throw h;const{data:b,error:N}=await q.from("users").select("*").order("created_at",{ascending:!1}).range(a,o);if(N)throw N;const p=c||0,d=Math.ceil(p/r);return{users:b||[],total:p,page:t,limit:r,totalPages:d}}})}function $e(){const n=fe();return Ce({mutationFn:async({id:t,updates:r})=>{const{error:a}=await q.from("users").update(r).eq("id",t);if(a)throw a},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),z.success("Пользователь обновлен")},onError:t=>{z.error(`Ошибка обновления: ${t.message}`)}})}const Xe=se,B=l.createContext({}),w=({...n})=>e.jsx(B.Provider,{value:{name:n.name},children:e.jsx(re,{...n})}),k=()=>{const n=l.useContext(B),t=l.useContext(O),{getFieldState:r,formState:a}=ae(),o=r(n.name,a);if(!n)throw new Error("useFormField should be used within <FormField>");const{id:c}=t;return{id:c,name:n.name,formItemId:`${c}-form-item`,formDescriptionId:`${c}-form-item-description`,formMessageId:`${c}-form-item-message`,...o}},O=l.createContext({}),C=l.forwardRef(({className:n,...t},r)=>{const a=l.useId();return e.jsx(O.Provider,{value:{id:a},children:e.jsx("div",{ref:r,className:D("space-y-2",n),...t})})});C.displayName="FormItem";const y=l.forwardRef(({className:n,...t},r)=>{const{error:a,formItemId:o}=k();return e.jsx(ne,{ref:r,className:D(a&&"text-destructive",n),htmlFor:o,...t})});y.displayName="FormLabel";const v=l.forwardRef(({...n},t)=>{const{error:r,formItemId:a,formDescriptionId:o,formMessageId:c}=k();return e.jsx(Y,{ref:t,id:a,"aria-describedby":r?`${o} ${c}`:`${o}`,"aria-invalid":!!r,...n})});v.displayName="FormControl";const K=l.forwardRef(({className:n,...t},r)=>{const{formDescriptionId:a}=k();return e.jsx("p",{ref:r,id:a,className:D("text-sm text-muted-foreground",n),...t})});K.displayName="FormDescription";const F=l.forwardRef(({className:n,children:t,...r},a)=>{const{error:o,formMessageId:c}=k(),h=o?String(o==null?void 0:o.message):t;return h?e.jsx("p",{ref:a,id:c,className:D("text-sm font-medium text-destructive",n),...r,children:h}):null});F.displayName="FormMessage";const Ee=te({email:$().email("Некорректный email").optional().or(X("")),phone:$().regex(/^\+?[1-9]\d{1,14}$/,"Некорректный номер телефона").optional().or(X("")),region:$().max(100,"Регион слишком длинный").optional().or(X("")),role:ie(["user","support","admin","super_admin"],{errorMap:()=>({message:"Выберите роль"})}),marketing_consent:oe()});function Ze(){const[n,t]=ee(),r=parseInt(n.get("page")||"1",10),a=parseInt(n.get("limit")||"20",10),[o,c]=l.useState(""),[h,b]=l.useState(null),[N,p]=l.useState(!1),{data:d,isLoading:S}=Pe({page:r,limit:a}),T=$e(),x=le({resolver:pe(Ee),defaultValues:{email:"",phone:"",region:"",role:"user",marketing_consent:!1}}),Z=(d==null?void 0:d.users)||[],L=(d==null?void 0:d.total)||0,g=(d==null?void 0:d.totalPages)||1,M=Z.filter(s=>{var i,m,U,Q;return((i=s.email)==null?void 0:i.toLowerCase().includes(o.toLowerCase()))||((m=s.phone)==null?void 0:m.includes(o))||s.id.toLowerCase().includes(o.toLowerCase())||((U=s.first_name)==null?void 0:U.toLowerCase().includes(o.toLowerCase()))||((Q=s.last_name)==null?void 0:Q.toLowerCase().includes(o.toLowerCase()))}),P=s=>{t({page:s.toString(),limit:a.toString()})},G=s=>{b(s.id),x.reset({email:s.email||"",phone:s.phone||"",region:s.region||"",role:s.role||"user",marketing_consent:s.marketing_consent||!1}),p(!0)},J=async s=>{h&&(await T.mutateAsync({id:h,updates:{email:s.email||null,phone:s.phone||null,region:s.region||null,role:s.role,marketing_consent:s.marketing_consent}}),b(null),p(!1),x.reset())},W=()=>{b(null),p(!1),x.reset()};return S?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(ce,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Управление пользователями"}),e.jsxs("p",{className:"text-muted-foreground mt-1",children:["Всего пользователей: ",L," | Страница ",r," из ",g]})]}),e.jsxs(E,{children:[e.jsxs(H,{children:[e.jsx(V,{children:"Поиск пользователей"}),e.jsx(de,{children:"Найдите пользователя по email, телефону, ФИО или ID"})]}),e.jsx(R,{children:e.jsxs("div",{className:"relative",children:[e.jsx(ke,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(I,{placeholder:"Поиск по email, телефону или ФИО...",value:o,onChange:s=>c(s.target.value),className:"pl-10"})]})})]}),e.jsxs(E,{children:[e.jsx(H,{children:e.jsx(V,{children:"Список пользователей"})}),e.jsx(R,{children:e.jsxs(ye,{children:[e.jsx(ve,{children:e.jsxs(A,{children:[e.jsx(u,{children:"ФИО"}),e.jsx(u,{children:"Email"}),e.jsx(u,{children:"Телефон"}),e.jsx(u,{children:"Регион"}),e.jsx(u,{children:"Роль"}),e.jsx(u,{children:"Маркетинг"}),e.jsx(u,{children:"Дата регистрации"}),e.jsx(u,{children:"Действия"})]})}),e.jsx(be,{children:M==null?void 0:M.map(s=>e.jsxs(A,{children:[e.jsx(j,{children:s.first_name||s.last_name?`${s.first_name||""} ${s.last_name||""}`.trim():"—"}),e.jsx(j,{children:s.email||"—"}),e.jsx(j,{children:s.phone||"—"}),e.jsx(j,{children:s.region||"—"}),e.jsx(j,{children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${s.role==="super_admin"?"bg-purple-100 text-purple-800":s.role==="admin"?"bg-red-100 text-red-800":s.role==="support"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:s.role})}),e.jsx(j,{children:s.marketing_consent?"Да":"Нет"}),e.jsx(j,{children:Me(new Date(s.created_at),"dd.MM.yyyy")}),e.jsx(j,{children:e.jsxs(we,{open:N&&h===s.id,onOpenChange:p,children:[e.jsx(Fe,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>G(s),children:e.jsx(Te,{className:"h-4 w-4"})})}),e.jsxs(Ne,{children:[e.jsxs(Se,{children:[e.jsx(Ie,{children:"Редактировать пользователя"}),e.jsx(_e,{children:"Измените данные пользователя"})]}),e.jsx(Xe,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(J),className:"space-y-4 py-4",children:[e.jsx(w,{control:x.control,name:"email",render:({field:i})=>e.jsxs(C,{children:[e.jsx(y,{children:"Email"}),e.jsx(v,{children:e.jsx(I,{...i,placeholder:"user@example.com"})}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"phone",render:({field:i})=>e.jsxs(C,{children:[e.jsx(y,{children:"Телефон"}),e.jsx(v,{children:e.jsx(I,{...i,placeholder:"+79991234567"})}),e.jsx(K,{children:"Формат: +7XXXXXXXXXX"}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"region",render:({field:i})=>e.jsxs(C,{children:[e.jsx(y,{children:"Регион"}),e.jsx(v,{children:e.jsx(I,{...i,placeholder:"Москва"})}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"role",render:({field:i})=>e.jsxs(C,{children:[e.jsx(y,{children:"Роль"}),e.jsxs(me,{onValueChange:i.onChange,value:i.value,children:[e.jsx(v,{children:e.jsx(xe,{children:e.jsx(he,{})})}),e.jsxs(ue,{children:[e.jsx(_,{value:"user",children:"Пользователь"}),e.jsx(_,{value:"support",children:"Поддержка"}),e.jsx(_,{value:"admin",children:"Администратор"}),e.jsx(_,{value:"super_admin",children:"Супер-администратор"})]})]}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"marketing_consent",render:({field:i})=>e.jsxs(C,{className:"flex flex-row items-start space-x-3 space-y-0",children:[e.jsx(v,{children:e.jsx("input",{type:"checkbox",checked:i.value,onChange:i.onChange,className:"mt-1"})}),e.jsx("div",{className:"space-y-1 leading-none",children:e.jsx(y,{children:"Согласие на маркетинг"})})]})}),e.jsxs(De,{children:[e.jsx(f,{type:"button",variant:"outline",onClick:W,children:"Отмена"}),e.jsx(f,{type:"submit",disabled:T.isPending,children:T.isPending?"Сохранение...":"Сохранить"})]})]})})]})]})})]},s.id))})]})})]}),g>1&&e.jsx(E,{children:e.jsxs(R,{className:"flex items-center justify-between py-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Показано ",(r-1)*a+1," - ",Math.min(r*a,L)," из ",L]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>P(r-1),disabled:r===1||S,children:[e.jsx(Le,{className:"h-4 w-4"}),"Предыдущая"]}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,g)},(s,i)=>{let m;return g<=5||r<=3?m=i+1:r>=g-2?m=g-4+i:m=r-2+i,e.jsx(f,{variant:r===m?"default":"outline",size:"sm",onClick:()=>P(m),disabled:S,children:m},m)})}),e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>P(r+1),disabled:r===g||S,children:["Следующая",e.jsx(je,{className:"h-4 w-4"})]})]})]})})]})}export{Ze as default};
