import{r as l,j as e,S as Z}from"./vendor-radix-htwXsPHy.js";import{c as ee}from"./vendor-react-CI8wve7f.js";import{g as z,v as q,aj as se,ak as re,j as D,L as ne,al as ae,am as te,an as oe,ao as ie,ap as X,aq as $,ar as le,G as ce,C as E,J as H,K as V,af as de,i as R,o as I,V as me,a1 as xe,B as f,W as he,X as ue,Y as je,_ as pe,b as ge,c as fe,d as ye,e as Ce,f as _,a0 as ve,x as be,y as we,as as Fe}from"./index-Dv2C02zj.js";import{b as Ne,u as Se,c as Ie}from"./vendor-query-BNGVDYIL.js";import{T as _e,a as De,b as A,c as u,d as ke,e as j}from"./table-Dp3rzXzr.js";import{S as Te}from"./search-BPVVDSxP.js";import{S as Le}from"./square-pen-zPyIDgWu.js";import{f as Me}from"./vendor-date-CR4liJ_d.js";import"./vendor-charts-DjioKZbK.js";function Pe(n={}){const t=n.page||1,r=n.limit||20,a=(t-1)*r,o=a+r-1;return Ne({queryKey:["admin-users",t,r],queryFn:async()=>{const{count:c,error:h}=await q.from("users").select("*",{count:"exact",head:!0});if(h)throw h;const{data:b,error:N}=await q.from("users").select("*").order("created_at",{ascending:!1}).range(a,o);if(N)throw N;const p=c||0,d=Math.ceil(p/r);return{users:b||[],total:p,page:t,limit:r,totalPages:d}}})}function Xe(){const n=Se();return Ie({mutationFn:async({id:t,updates:r})=>{const{error:a}=await q.from("users").update(r).eq("id",t);if(a)throw a},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),z.success("Пользователь обновлен")},onError:t=>{z.error(`Ошибка обновления: ${t.message}`)}})}const $e=se,B=l.createContext({}),w=({...n})=>e.jsx(B.Provider,{value:{name:n.name},children:e.jsx(re,{...n})}),k=()=>{const n=l.useContext(B),t=l.useContext(K),{getFieldState:r,formState:a}=ae(),o=r(n.name,a);if(!n)throw new Error("useFormField should be used within <FormField>");const{id:c}=t;return{id:c,name:n.name,formItemId:`${c}-form-item`,formDescriptionId:`${c}-form-item-description`,formMessageId:`${c}-form-item-message`,...o}},K=l.createContext({}),y=l.forwardRef(({className:n,...t},r)=>{const a=l.useId();return e.jsx(K.Provider,{value:{id:a},children:e.jsx("div",{ref:r,className:D("space-y-2",n),...t})})});y.displayName="FormItem";const C=l.forwardRef(({className:n,...t},r)=>{const{error:a,formItemId:o}=k();return e.jsx(ne,{ref:r,className:D(a&&"text-destructive",n),htmlFor:o,...t})});C.displayName="FormLabel";const v=l.forwardRef(({...n},t)=>{const{error:r,formItemId:a,formDescriptionId:o,formMessageId:c}=k();return e.jsx(Z,{ref:t,id:a,"aria-describedby":r?`${o} ${c}`:`${o}`,"aria-invalid":!!r,...n})});v.displayName="FormControl";const O=l.forwardRef(({className:n,...t},r)=>{const{formDescriptionId:a}=k();return e.jsx("p",{ref:r,id:a,className:D("text-sm text-muted-foreground",n),...t})});O.displayName="FormDescription";const F=l.forwardRef(({className:n,children:t,...r},a)=>{const{error:o,formMessageId:c}=k(),h=o?String(o==null?void 0:o.message):t;return h?e.jsx("p",{ref:a,id:c,className:D("text-sm font-medium text-destructive",n),...r,children:h}):null});F.displayName="FormMessage";const Ee=te({email:X().email("Некорректный email").optional().or($("")),phone:X().regex(/^\+?[1-9]\d{1,14}$/,"Некорректный номер телефона").optional().or($("")),region:X().max(100,"Регион слишком длинный").optional().or($("")),role:ie(["user","support","admin","super_admin"],{errorMap:()=>({message:"Выберите роль"})}),marketing_consent:oe()});function Ke(){const[n,t]=ee(),r=parseInt(n.get("page")||"1",10),a=parseInt(n.get("limit")||"20",10),[o,c]=l.useState(""),[h,b]=l.useState(null),[N,p]=l.useState(!1),{data:d,isLoading:S}=Pe({page:r,limit:a}),T=Xe(),x=le({resolver:Fe(Ee),defaultValues:{email:"",phone:"",region:"",role:"user",marketing_consent:!1}}),G=(d==null?void 0:d.users)||[],L=(d==null?void 0:d.total)||0,g=(d==null?void 0:d.totalPages)||1,M=G.filter(s=>{var i,m,U,Q;return((i=s.email)==null?void 0:i.toLowerCase().includes(o.toLowerCase()))||((m=s.phone)==null?void 0:m.includes(o))||s.id.toLowerCase().includes(o.toLowerCase())||((U=s.first_name)==null?void 0:U.toLowerCase().includes(o.toLowerCase()))||((Q=s.last_name)==null?void 0:Q.toLowerCase().includes(o.toLowerCase()))}),P=s=>{t({page:s.toString(),limit:a.toString()})},J=s=>{b(s.id),x.reset({email:s.email||"",phone:s.phone||"",region:s.region||"",role:s.role||"user",marketing_consent:s.marketing_consent||!1}),p(!0)},W=async s=>{h&&(await T.mutateAsync({id:h,updates:{email:s.email||null,phone:s.phone||null,region:s.region||null,role:s.role,marketing_consent:s.marketing_consent}}),b(null),p(!1),x.reset())},Y=()=>{b(null),p(!1),x.reset()};return S?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(ce,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Управление пользователями"}),e.jsxs("p",{className:"text-muted-foreground mt-1",children:["Всего пользователей: ",L," | Страница ",r," из ",g]})]}),e.jsxs(E,{children:[e.jsxs(H,{children:[e.jsx(V,{children:"Поиск пользователей"}),e.jsx(de,{children:"Найдите пользователя по email, телефону, ФИО или ID"})]}),e.jsx(R,{children:e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(I,{placeholder:"Поиск по email, телефону или ФИО...",value:o,onChange:s=>c(s.target.value),className:"pl-10"})]})})]}),e.jsxs(E,{children:[e.jsx(H,{children:e.jsx(V,{children:"Список пользователей"})}),e.jsx(R,{children:e.jsxs(_e,{children:[e.jsx(De,{children:e.jsxs(A,{children:[e.jsx(u,{children:"ФИО"}),e.jsx(u,{children:"Email"}),e.jsx(u,{children:"Телефон"}),e.jsx(u,{children:"Регион"}),e.jsx(u,{children:"Роль"}),e.jsx(u,{children:"Маркетинг"}),e.jsx(u,{children:"Дата регистрации"}),e.jsx(u,{children:"Действия"})]})}),e.jsx(ke,{children:M==null?void 0:M.map(s=>e.jsxs(A,{children:[e.jsx(j,{children:s.first_name||s.last_name?`${s.first_name||""} ${s.last_name||""}`.trim():"—"}),e.jsx(j,{children:s.email||"—"}),e.jsx(j,{children:s.phone||"—"}),e.jsx(j,{children:s.region||"—"}),e.jsx(j,{children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${s.role==="super_admin"?"bg-purple-100 text-purple-800":s.role==="admin"?"bg-red-100 text-red-800":s.role==="support"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:s.role})}),e.jsx(j,{children:s.marketing_consent?"Да":"Нет"}),e.jsx(j,{children:Me(new Date(s.created_at),"dd.MM.yyyy")}),e.jsx(j,{children:e.jsxs(me,{open:N&&h===s.id,onOpenChange:p,children:[e.jsx(xe,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>J(s),children:e.jsx(Le,{className:"h-4 w-4"})})}),e.jsxs(he,{children:[e.jsxs(ue,{children:[e.jsx(je,{children:"Редактировать пользователя"}),e.jsx(pe,{children:"Измените данные пользователя"})]}),e.jsx($e,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(W),className:"space-y-4 py-4",children:[e.jsx(w,{control:x.control,name:"email",render:({field:i})=>e.jsxs(y,{children:[e.jsx(C,{children:"Email"}),e.jsx(v,{children:e.jsx(I,{...i,placeholder:"user@example.com"})}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"phone",render:({field:i})=>e.jsxs(y,{children:[e.jsx(C,{children:"Телефон"}),e.jsx(v,{children:e.jsx(I,{...i,placeholder:"+79991234567"})}),e.jsx(O,{children:"Формат: +7XXXXXXXXXX"}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"region",render:({field:i})=>e.jsxs(y,{children:[e.jsx(C,{children:"Регион"}),e.jsx(v,{children:e.jsx(I,{...i,placeholder:"Москва"})}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"role",render:({field:i})=>e.jsxs(y,{children:[e.jsx(C,{children:"Роль"}),e.jsxs(ge,{onValueChange:i.onChange,value:i.value,children:[e.jsx(v,{children:e.jsx(fe,{children:e.jsx(ye,{})})}),e.jsxs(Ce,{children:[e.jsx(_,{value:"user",children:"Пользователь"}),e.jsx(_,{value:"support",children:"Поддержка"}),e.jsx(_,{value:"admin",children:"Администратор"}),e.jsx(_,{value:"super_admin",children:"Супер-администратор"})]})]}),e.jsx(F,{})]})}),e.jsx(w,{control:x.control,name:"marketing_consent",render:({field:i})=>e.jsxs(y,{className:"flex flex-row items-start space-x-3 space-y-0",children:[e.jsx(v,{children:e.jsx("input",{type:"checkbox",checked:i.value,onChange:i.onChange,className:"mt-1"})}),e.jsx("div",{className:"space-y-1 leading-none",children:e.jsx(C,{children:"Согласие на маркетинг"})})]})}),e.jsxs(ve,{children:[e.jsx(f,{type:"button",variant:"outline",onClick:Y,children:"Отмена"}),e.jsx(f,{type:"submit",disabled:T.isPending,children:T.isPending?"Сохранение...":"Сохранить"})]})]})})]})]})})]},s.id))})]})})]}),g>1&&e.jsx(E,{children:e.jsxs(R,{className:"flex items-center justify-between py-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Показано ",(r-1)*a+1," - ",Math.min(r*a,L)," из ",L]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>P(r-1),disabled:r===1||S,children:[e.jsx(be,{className:"h-4 w-4"}),"Предыдущая"]}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,g)},(s,i)=>{let m;return g<=5||r<=3?m=i+1:r>=g-2?m=g-4+i:m=r-2+i,e.jsx(f,{variant:r===m?"default":"outline",size:"sm",onClick:()=>P(m),disabled:S,children:m},m)})}),e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>P(r+1),disabled:r===g||S,children:["Следующая",e.jsx(we,{className:"h-4 w-4"})]})]})]})})]})}export{Ke as default};
